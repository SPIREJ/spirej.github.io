<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ç­‰é£æ¥ï¼Œç­‰èŠ±å¼€â€~</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-03-25T03:28:45.053Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>ã±ã‚ãšã Î¹Î¿Î½Îµã‚œ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·è½¬åœºåŠ¨ç”»</title>
    <link href="http://yoursite.com/2019/02/17/%E3%80%8AiOS%E5%8A%A8%E7%94%BB%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%C2%B7%E5%89%8D%E5%BA%8F%E7%9A%84%E5%89%AF%E6%9C%AC%203/"/>
    <id>http://yoursite.com/2019/02/17/ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å‰åºçš„å‰¯æœ¬ 3/</id>
    <published>2019-02-17T14:46:40.000Z</published>
    <updated>2019-03-25T03:28:45.053Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://upload-images.jianshu.io/upload_images/1276164-9b7a71161b7e8517.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·è½¬åœºåŠ¨ç”».jpg"></p><a id="more"></a><p><a href="https://www.jianshu.com/p/bc6e3e175a37" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å‰åº</a><br><a href="https://www.jianshu.com/p/4e95c596dfa9" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·æ˜¾ç¤ºå±‚åŠ¨ç”»</a><br><a href="https://www.jianshu.com/p/3b469f7ba311" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å†…å®¹å±‚åŠ¨ç”»</a><br><a href="https://www.jianshu.com/p/0c5be91642cd" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·è½¬åœºåŠ¨ç”»</a></p><h2 id="è½¬åœºåŠ¨ç”»"><a href="#è½¬åœºåŠ¨ç”»" class="headerlink" title="è½¬åœºåŠ¨ç”»"></a>è½¬åœºåŠ¨ç”»</h2><p>è½¬åœºåŠ¨ç”»ä¸»è¦ç”¨äºä¸åŒè§†å›¾åœºæ™¯ä¹‹é—´çš„åˆ‡æ¢ã€‚</p><h2 id="CoreAnimation-CATransitionè½¬åœºåŠ¨ç”»"><a href="#CoreAnimation-CATransitionè½¬åœºåŠ¨ç”»" class="headerlink" title="CoreAnimation:CATransitionè½¬åœºåŠ¨ç”»"></a>CoreAnimation:CATransitionè½¬åœºåŠ¨ç”»</h2><h3 id="CATransitionç†è®ºåˆè¯†"><a href="#CATransitionç†è®ºåˆè¯†" class="headerlink" title="CATransitionç†è®ºåˆè¯†"></a>CATransitionç†è®ºåˆè¯†</h3><p><code>CATransition</code>åŒ<code>CoreAnimation</code>æ ¸å¿ƒåŠ¨ç”»ä¸­<code>CABasicAnimation</code>ç­‰ç›¸å…³ç±»çš„ä½¿ç”¨æ–¹æ³•ç±»ä¼¼ã€‚ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š<br>(1) å®ä¾‹åŒ–<code>CATransition</code>ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„è½¬åœºåŠ¨ç”»<code>key</code><br>(2) è®¾ç½®åˆé€‚çš„è½¬åœºåŠ¨ç”»å±æ€§ï¼Œå¦‚åŠ¨ç”»å‘¨æœŸã€è¿‡åº¦æ–¹å‘ã€åŠ¨ç”»ä¿æŒçŠ¶æ€ç­‰<br>(3) å°†åŠ¨ç”»æ•ˆæœæ·»åŠ åˆ°ç›¸åº”çš„è§†å›¾çš„<code>Layer</code>å›¾å±‚ä¸­</p><p>åœ¨ç¬¬ä¸€æ­¥è®¾ç½®åŠ¨ç”»æ•ˆæœæ—¶éœ€<strong>æ³¨æ„</strong>ï¼ŒiOSæä¾›äº†å¤§é‡çš„é…·ç‚«åŠ¨ç”»æ•ˆæœã€‚ä¸è¿‡æ€»ä½“ä¸Šæ¥è¯´å¯ä»¥åˆ†ä¸ºå…¬æœ‰APIå’Œç§æœ‰APIï¼Œç§æœ‰APPåˆ¶ä½œçš„APPæœ‰è¢«æ‹’çš„é£é™©ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ—¶éœ€è¦å°¤ä¸ºæ³¨æ„ã€‚</p><p><strong>å…¬æœ‰API:</strong></p><ul><li><code>fade</code>   æ·¡å…¥æ·¡å‡ºæ•ˆæœï¼Œå¯ç”¨ <code>CATransitionType.fade</code> è¡¨ç¤º</li><li><code>push</code>   æ¨é€æ•ˆæœï¼Œå¯ç”¨ <code>CATransitionType.push</code> è¡¨ç¤º</li><li><code>reveal</code> æ­å¼€æ•ˆæœï¼Œå¯ç”¨ <code>CATransitionType.reveal</code> è¡¨ç¤º</li><li><code>movein</code> ç§»åŠ¨æ•ˆæœï¼Œå¯ç”¨ <code>CATransitionType.movein</code> è¡¨ç¤º</li></ul><p><strong>ç§æœ‰API:</strong></p><ul><li><code>pageCurl</code>                   å‘ä¸Šç¿»ä¸€é¡µ</li><li><code>pageUnCurl</code>                 å‘ä¸‹ç¿»ä¸€é¡µ</li><li><code>rippleEffect</code>               æ»´æ°´æ•ˆæœ</li><li><code>suckEffect</code>                 æ”¶ç¼©æ•ˆæœï¼Œå¦‚ä¸€å—å¸ƒè¢«æŠ½èµ°</li><li><code>cube</code>                       ç«‹æ–¹ä½“æ•ˆæœ</li><li><code>oglFlip</code>                    ä¸Šä¸‹ç¿»è½¬æ•ˆæœ</li><li><code>cameraIrisHollowOpen</code>       ç›¸æœºæ‰“å¼€</li><li><code>cameraIrisHollowClose</code>      ç›¸æœºå…³é—­</li></ul><h3 id="åŠ¨ç”»æ•ˆæœç®€å•ç¤ºä¾‹"><a href="#åŠ¨ç”»æ•ˆæœç®€å•ç¤ºä¾‹" class="headerlink" title="åŠ¨ç”»æ•ˆæœç®€å•ç¤ºä¾‹"></a>åŠ¨ç”»æ•ˆæœç®€å•ç¤ºä¾‹</h3><p><strong>1ã€å…ˆæ¥çœ‹ä¸€ä¸‹ç¤ºä¾‹çš„åŠ¨ç”»æ•ˆæœ</strong><br><img src="https://upload-images.jianshu.io/upload_images/1276164-2c01456bd011ab37.gif?imageMogr2/auto-orient/strip" alt="è½¬åœºåŠ¨ç”»ç¤ºä¾‹.gif"></p><p><strong>2ã€ä»£ç å®ç°éƒ¨åˆ†</strong><br>å…·ä½“ä»£ç ç‚¹å‡»è¿™é‡ŒğŸ‘‰<a href="https://github.com/SPIREJ/AnimationTransitionSwift" target="_blank" rel="noopener">https://github.com/SPIREJ/AnimationTransitionSwift</a><br>æ³¨ï¼šç›¸åº”çš„buttonæ˜¯åœ¨storyboardé‡Œé¢ç”»çš„</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> kScreenW = <span class="type">UIScreen</span>.main.bounds.size.width</span><br><span class="line"><span class="keyword">let</span> kScreenH = <span class="type">UIScreen</span>.main.bounds.size.height</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> imageView:<span class="type">UIImageView</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> str:<span class="type">String</span> = <span class="string">"aaa.jpg"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        imageView = <span class="type">UIImageView</span>(frame: <span class="type">CGRect</span>(x: <span class="number">20</span>, y: <span class="number">0</span>, width: kScreenW-<span class="number">40</span>, height: <span class="number">200</span>))</span><br><span class="line">        imageView?.center = <span class="keyword">self</span>.view.center</span><br><span class="line">        imageView?.image = <span class="type">UIImage</span>(named: <span class="string">"aaa.jpg"</span>)</span><br><span class="line">        <span class="keyword">self</span>.view.addSubview(imageView!)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·¡å…¥æ·¡å‡ºæ•ˆæœï¼Œå¯ç”¨ CATransitionType.fade è¡¨ç¤º</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_fade</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"fade"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¨é€æ•ˆæœï¼Œå¯ç”¨ CATransitionType.push è¡¨ç¤º</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_push</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"push"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ­å¼€æ•ˆæœï¼Œå¯ç”¨ CATransitionType.reveal è¡¨ç¤º</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_reveal</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"reveal"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç§»åŠ¨æ•ˆæœï¼Œå¯ç”¨ CATransitionType.movein è¡¨ç¤º</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_movein</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"movein"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘ä¸Šç¿»é¡µæ•ˆæœ</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_pageCurl</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"pageCurl"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘ä¸‹ç¿»é¡µæ•ˆæœ</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_pageUnCurl</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"pageUnCurl"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç«‹æ–¹ä½“ç¿»è½¬æ•ˆæœ</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_cube</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"cube"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¿»è½¬æ•ˆæœ</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_oglFlip</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"oglFlip"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ”¶ç¼©æ•ˆæœ</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_suckEffect</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"suckEffect"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ°´æ»´æ³¢çº¹æ•ˆæœ</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_rippleEffect</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"rippleEffect"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›¸æœºæ‰“å¼€æ•ˆæœ</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_cameraIrisHollowOpen</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"cameraIrisHollowOpen"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›¸æœºå…³é—­æ•ˆæœ</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">animation_cameraIrisHollowClose</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.animationType(<span class="string">"cameraIrisHollowClose"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">animationType</span><span class="params">(<span class="number">_</span> animationType:String)</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> str == <span class="string">"aaa.jpg"</span> &#123;</span><br><span class="line">            str = <span class="string">"bbb.jpg"</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            str = <span class="string">"aaa.jpg"</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        imageView?.image = <span class="type">UIImage</span>(named: str)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> animation:<span class="type">CATransition</span> = <span class="type">CATransition</span>.<span class="keyword">init</span>()</span><br><span class="line">        animation.duration = <span class="number">1</span></span><br><span class="line">        animation.type = <span class="type">CATransitionType</span>(rawValue: animationType)</span><br><span class="line">        imageView?.layer.add(animation, forKey: <span class="literal">nil</span>)</span><br><span class="line">        </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>å¯ä»¥æŠŠåŠ¨ç”»æ·»åŠ åˆ°ä¸åŒçš„<code>UIView</code>ä¸Šï¼Œå°†çœ‹åˆ°ä¸ä¸€æ ·çš„æ•ˆæœã€‚æ¯”å¦‚è¿™é‡ŒæŠŠåŠ¨ç”»æ·»åŠ åˆ°æ§åˆ¶å™¨viewä¸Šï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self<span class="selector-class">.view</span><span class="selector-class">.layer</span><span class="selector-class">.add</span>(<span class="attribute">animation</span>, forKey: nil)</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°å¦‚ä¸‹é¢çš„æ•ˆæœï¼š<br><img src="https://upload-images.jianshu.io/upload_images/1276164-5431ce29400ce9b0.gif?imageMogr2/auto-orient/strip" alt="åŠ è½½åˆ°ä¸åŒè§†å›¾ä¸Šçš„æ•ˆæœ.gif"></p><h2 id="è§†å›¾è¿‡æ¸¡åŠ¨ç”»"><a href="#è§†å›¾è¿‡æ¸¡åŠ¨ç”»" class="headerlink" title="è§†å›¾è¿‡æ¸¡åŠ¨ç”»"></a>è§†å›¾è¿‡æ¸¡åŠ¨ç”»</h2><p>åœ¨ä½¿ç”¨è§†å›¾æ§åˆ¶å™¨çš„æ—¶å€™ï¼Œé™¤äº†<code>Push</code>å’Œ<code>Pop</code>ä¸¤ç§æ“ä½œå¤–ï¼ŒiOSè¿˜æä¾›äº†ä¸€å¥—è§†å›¾æ§åˆ¶å™¨è¿‡æ¸¡åŠ¨ç”»APIï¼Œå¯ä»¥å…è®¸ç”¨æˆ·è‡ªå®šä¹‰è§†å›¾è¿‡æ¸¡åŠ¨ç”»ã€‚</p><p>è¦æƒ³è‡ªå®šä¹‰è§†å›¾æ§åˆ¶å™¨çš„è¿‡æ¸¡åŠ¨ç”»ï¼Œé¦–å…ˆéœ€è¦äº†è§£ä»¥ä¸‹ä¸¤ä¸ªåè®®ï¼š<br>ï¼ˆ1ï¼‰<code>UINavigationControllerDelegate</code><br>ï¼ˆ2ï¼‰<code>UIViewControllerAnimatedTransitioning</code></p><p><code>UINavigationControllerDelegate</code>æ˜¯è§†å›¾æ§åˆ¶å™¨ä½¿ç”¨çš„å§”æ‰˜ä»£ç†åè®®ï¼Œè¯¥åè®®å¯ä»¥ä»£ç†è§†å›¾çš„ä»¥ä¸‹åŠŸèƒ½ï¼š<br>ï¼ˆ1ï¼‰æ‹¦æˆªå¯¼èˆªæ è§†å›¾æ§åˆ¶å™¨<br>ï¼ˆ2ï¼‰æ‹¦æˆªè§†å›¾æ§åˆ¶å™¨<code>ç›®æ ‡viewController</code>å’Œ<code>æºviewController</code></p><p>åœ¨è¿‡æ¸¡åŠ¨ç”»ä¸­ä½¿ç”¨ç¬¬äºŒä¸ªåŠŸèƒ½ï¼Œå³æ‹¦æˆªè§†å›¾æ§åˆ¶å™¨<code>ç›®æ ‡viewController</code>å’Œ<code>æºviewController</code>ã€‚è¯¥åŠŸèƒ½çš„å›è°ƒæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">navigationController</span><span class="params">(<span class="number">_</span> navigationController: UINavigationController, animationControllerFor operation: UINavigationController.Operation, from fromVC: UIViewController, to toVC: UIViewController)</span></span> -&gt; <span class="type">UIViewControllerAnimatedTransitioning</span>?</span><br></pre></td></tr></table></figure><p><code>fromVC</code> : è¡¨æ˜è¯¥è§†å›¾æ§åˆ¶å™¨åœ¨è·³è½¬è¿‡ç¨‹ä¸­æ¥è‡ªå“ªä¸ªè§†å›¾æ§åˆ¶å™¨<br><code>toVC</code> : è¡¨æ˜è¯¥è§†å›¾æ§åˆ¶å™¨åœ¨è·³è½¬è¿‡ç¨‹ä¸­æœ€ç»ˆè·³è½¬åˆ°ä½•å¤„å»</p><p>å®é™…ä¸Šä»¥ä¸Šçš„æ‰€æœ‰æ“ä½œéƒ½å€ŸåŠ©äº<code>UIViewControllerAnimatedTransitioning</code>åè®®ï¼Œå°†æ‰€æœ‰åŠ¨ç”»æ•ˆæœæœ€ç»ˆå°è£…æˆä¸€ä¸ªå¯¹è±¡è¿”å›ç»™è¯•å›¾æ§åˆ¶ï¼Œå®ƒæœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„å›è°ƒæ–¹æ³•ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›åŠ¨ç”»æ‰§è¡Œå‘¨æœŸ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transitionDuration</span><span class="params">(using transitionContext: UIViewControllerContextTransitioning?)</span></span> -&gt; <span class="type">TimeInterval</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„å»ºè½¬åœºåŠ¨ç”»å†…å®¹ï¼Œè¯¥æ–¹æ³•å¯ä»¥é€šè¿‡transitionContextè·å–å½“å‰çš„fromVCå’ŒtoVCï¼Œæ‹¿åˆ°è¿™ä¸¤ä¸ªè§†å›¾æ§åˆ¶å™¨åå°±å¯ä»¥è®¾ç½®å½“å‰è§†å›¾æ§åˆ¶å™¨çš„å„ç§åŠ¨ç”»æ•ˆæœ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">animateTransition</span><span class="params">(using transitionContext: UIViewControllerContextTransitioning)</span></span></span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/1276164-953751a8fa977906.gif?imageMogr2/auto-orient/strip" alt="è§†å›¾è¿‡æ¸¡åŠ¨ç”»pop.gif"></p><p>å…·ä½“å¯ä»¥çœ‹ä»£ç <a href="https://github.com/SPIREJ/AnimationTransitionSwift" target="_blank" rel="noopener">https://github.com/SPIREJ/AnimationTransitionSwift</a></p><p>###è§†å›¾è¿‡æ¸¡åŠ¨ç”»ä¹‹ä¾§æ»‘</p><p><img src="https://upload-images.jianshu.io/upload_images/1276164-9bc0fb24775488b7.gif?imageMogr2/auto-orient/strip" alt="è§†å›¾è¿‡æ¸¡åŠ¨ç”»ä¾§æ»‘.gif"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-9b7a71161b7e8517.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·è½¬åœºåŠ¨ç”».jpg&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOSåŠ¨ç”»" scheme="http://yoursite.com/tags/iOS%E5%8A%A8%E7%94%BB/"/>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://yoursite.com/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å†…å®¹å±‚åŠ¨ç”»</title>
    <link href="http://yoursite.com/2019/02/16/%E3%80%8AiOS%E5%8A%A8%E7%94%BB%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%C2%B7%E5%89%8D%E5%BA%8F%E7%9A%84%E5%89%AF%E6%9C%AC%202/"/>
    <id>http://yoursite.com/2019/02/16/ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å‰åºçš„å‰¯æœ¬ 2/</id>
    <published>2019-02-16T14:46:40.000Z</published>
    <updated>2019-03-25T03:24:45.297Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://upload-images.jianshu.io/upload_images/1276164-99df471d98fa9d89.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å†…å®¹å±‚åŠ¨ç”».jpg"></p><a id="more"></a><p><a href="https://www.jianshu.com/p/bc6e3e175a37" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å‰åº</a><br><a href="https://www.jianshu.com/p/4e95c596dfa9" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·æ˜¾ç¤ºå±‚åŠ¨ç”»</a><br><a href="https://www.jianshu.com/p/3b469f7ba311" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å†…å®¹å±‚åŠ¨ç”»</a><br><a href="https://www.jianshu.com/p/0c5be91642cd" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·è½¬åœºåŠ¨ç”»</a></p><h3 id="UIViewå’ŒCALayerçš„åŒºåˆ«ï¼š"><a href="#UIViewå’ŒCALayerçš„åŒºåˆ«ï¼š" class="headerlink" title="UIViewå’ŒCALayerçš„åŒºåˆ«ï¼š"></a>UIViewå’ŒCALayerçš„åŒºåˆ«ï¼š</h3><p> ï¼ˆ1ï¼‰UIViewç»§æ‰¿<code>UIResponder</code>ï¼Œå› æ­¤UIViewå¯ä»¥å¤„ç†å“åº”äº‹ä»¶ï¼Œè€ŒCALayerç»§æ‰¿<code>NSObject</code>ï¼Œæ‰€ä»¥å®ƒåªè´Ÿè´£å†…å®¹çš„åˆ›å»ºã€ç»˜åˆ¶ã€‚<br> ï¼ˆ2ï¼‰UIViewè´Ÿè´£å¯¹å†…å®¹çš„ç®¡ç†ï¼Œè€ŒCALayerè´Ÿè´£å¯¹å†…å®¹çš„ç»˜åˆ¶<br> ï¼ˆ3ï¼‰UIViewä¸­çš„ä½ç½®å±æ€§åªæœ‰<code>frameï¼Œboundsï¼Œcenter</code>ï¼Œè€ŒCALayeré™¤äº†è¿™äº›ä¹‹å¤–è¿˜æœ‰<code>anchorPointï¼Œposition</code><br> ï¼ˆ4ï¼‰é€šè¿‡ä¿®æ”¹CALayerå¯ä»¥å®ç°UIViewæ— æ³•å®ç°çš„å¾ˆå¤š<strong>é«˜çº§åŠŸèƒ½</strong></p><h3 id="Core-Animationæ ¸å¿ƒåŠ¨ç”»"><a href="#Core-Animationæ ¸å¿ƒåŠ¨ç”»" class="headerlink" title="Core Animationæ ¸å¿ƒåŠ¨ç”»"></a>Core Animationæ ¸å¿ƒåŠ¨ç”»</h3><p> <code>Core Animation</code>ä¸ºiOSæ ¸å¿ƒåŠ¨ç”»ï¼Œå®ƒæä¾›äº†ä¸€ç»„ä¸°å¯Œçš„APIå¯ä»¥ç”¨äºåˆ¶ä½œå„ç§é«˜çº§ç‚«é…·çš„åŠ¨ç”»æ•ˆæœã€‚<code>CoreAnimation</code>æ¥è‡ªiOSçš„<code>QuartzCore.framework</code>æ¡†æ¶ï¼Œå®ƒå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š<br> ï¼ˆ1ï¼‰ç›´æ¥ä½œç”¨äºCALayerå›¾å±‚ä¸Š<br> ï¼ˆ2ï¼‰Core Animationçš„æ‰§è¡Œè¿‡ç¨‹åœ¨åå°æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹<br> ï¼ˆ3ï¼‰å¯ç”¨CALayerç»å¤§å¤šæ•°å±æ€§ç»˜åˆ¶é«˜çº§åŠ¨ç”»æ•ˆæœ</p><p> <strong><code>Core Animation</code>ä¸‹å„ç§å¸¸ç”¨åŠ¨ç”»ç±»çš„ç»§æ‰¿å…³ç³»å›¾</strong></p><p><img src="https://upload-images.jianshu.io/upload_images/1276164-0da51098581a3821.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Core Animationä¸‹å„ç§å¸¸ç”¨åŠ¨ç”»ç±»çš„ç»§æ‰¿å…³ç³»å›¾"></p><ul><li><code>@protocol CAMediaTiming</code>æœ‰å¾ˆå¤šåŠ¨ç”»å…¬å…±çš„å±æ€§ï¼Œæ¯”å¦‚å¸¸è§çš„ <code>duration / speed / repeatCount</code>ç­‰</li><li><code>CAAnimation</code> ä¸»è¦ç”¨äºå®ç°åŠ¨ç”»çš„å§”æ‰˜ä»£ç†æ–¹æ³•ï¼Œæ¯”å¦‚åŠ¨ç”»çš„å¼€å§‹äº‹ä»¶å’Œç»“æŸäº‹ä»¶</li><li><code>CAPropertyAnimation</code> ä¸ºåŠ¨ç”»å±æ€§ï¼Œåˆ†ä¸º<code>CABasicAnimation</code>åŸºç¡€åŠ¨ç”»å’Œ<code>CAKeyframeAnimation</code>å…³é”®å¸§åŠ¨ç”»</li><li><code>CAAnimationGroup</code> ç»„åˆåŠ¨ç”»<br>-<code>CATransition</code> è½¬åœºåŠ¨ç”»</li></ul><h3 id="CABasicAnimationåŸºç¡€åŠ¨ç”»åˆé›†"><a href="#CABasicAnimationåŸºç¡€åŠ¨ç”»åˆé›†" class="headerlink" title="CABasicAnimationåŸºç¡€åŠ¨ç”»åˆé›†"></a>CABasicAnimationåŸºç¡€åŠ¨ç”»åˆé›†</h3><p><strong>ï¼ˆ1ï¼‰ä½ç½®åŠ¨ç”»</strong><br>        <code>posion</code><br>    æ³¨æ„animation.toValueå±æ€§è¡¨æ˜æ”¹å˜äº†æ§ä»¶çš„ä½ç½®ï¼Œæ‰€ä»¥ç»™ä¸€ä¸ªæ–°çš„positionçš„x,yåæ ‡ animation.byValueè¡¨æ˜åœ¨æ§ä»¶åŸæ¥ä½ç½®çš„åŸºç¡€ä¸Šï¼Œæ²¿x,yåæ ‡åˆ†åˆ«ç§»åŠ¨äº†å¤šå°‘</p><p> <strong>ï¼ˆ2ï¼‰ç¼©æ”¾åŠ¨ç”»</strong><br>    <code>transform.scale.x / transform.scale.y</code>ï¼Œscaleæœ‰<code>x,y</code>ä¸¤ä¸ªå±æ€§è¡¨æ˜å½“å‰UIæ§ä»¶çš„width/heightçš„ç¼©æ”¾ç³»æ•°</p><p><strong>ï¼ˆ3ï¼‰æ—‹è½¬åŠ¨ç”»</strong><br>   <code>transform.rotation</code></p><p><strong>ï¼ˆ4ï¼‰ä½ç§»åŠ¨ç”»</strong><br>   <code>transform.translation.x / transform.translation.y</code> è¡¨ç¤ºåœ¨<code>x/y</code>æ–¹å‘ä¸Šç§»åŠ¨</p><p><strong>ï¼ˆ5ï¼‰è¾¹æ¡†åŠ¨ç”»</strong><br>    <code>animation.keyPath = &quot;borderWidth&quot;</code></p><p> <strong>ï¼ˆ6ï¼‰é¢œè‰²æ¸å˜</strong><br>    <code>animation.keyPath = &quot;backgroundColor&quot;</code><br>   <code>animation.keyPath = &quot;borderColor&quot;</code></p><p> <strong>ï¼ˆ7ï¼‰æ·¡å…¥æ·¡å‡º</strong><br>    <code>animation.keyPath = &quot;opacity&quot;</code></p><p> <strong>ï¼ˆ8ï¼‰é˜´å½±æ¸å˜</strong><br>    <code>animation.keyPath = &quot;shadowOffset&quot;</code></p><p>è¿™é‡Œå°±ä¸ä¸¾å…·ä½“çš„ä¾‹å­äº†ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡â†’_â†’<a href="https://www.jianshu.com/p/fc9be72adc9f" target="_blank" rel="noopener">æ ¸å¿ƒåŠ¨ç”»-Core Animation</a></p><h3 id="Core-Animation"><a href="#Core-Animation" class="headerlink" title="Core Animation"></a>Core Animation</h3><p> å…³é”®å­— <code>CAKeyframeAnimation</code><br> <code>CAKeyframeAnimation</code>ï¼šæ˜¯<code>CALayer</code>å±‚ä¸‹çš„å…³é”®å¸§åŠ¨ç”»ç±»ï¼Œå®ç°ç±»ä¼¼UIViewçš„å…³é”®å¸§åŠ¨ç”»æ•ˆæœï¼ˆå‰é¢æœ‰ä»‹ç»ï¼‰ã€‚<code>ACKeyframeAnimation</code>æ˜¯<code>CAPropertyAnimation</code>çš„ä¸€ä¸ªå­ç±»ï¼Œä¸<code>CABasicAnimation</code>åŸç†ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ä¿®æ”¹å½“å‰<code>CALayer</code>å›¾å±‚çš„<code>value</code>å±æ€§å®ç°åŠ¨ç”»æ•ˆæœã€‚ä¸åŒçš„æ˜¯<code>CABasicAnimation</code>ä¸€èˆ¬åªä½¿ç”¨<code>fromeValue/toValue/byValue</code>ï¼Œå³åªèƒ½ä¿®æ”¹ä¸€ä¸ª<code>value</code>å€¼ã€‚è€Œ<code>CAKeyframeAnimation</code>åˆ™å¯ä»¥ä¿®æ”¹ä¸€ç»„<code>value</code>å€¼æ¥å®ç°å¯¹åŠ¨ç”»çš„æ›´ç²¾ç¡®ç»†è…»çš„æ§åˆ¶ã€‚</p><p> <code>CAAnimation Group</code>ï¼šç»„åˆåŠ¨ç”»ï¼ŒæŠŠå„ç§åŠ¨ç”»ç»„åˆèµ·æ¥å½¢æˆå„ç§æ•ˆæœ</p><p> <code>CAKeyframeAnimation</code>åŠ¨ç”»å±æ€§è¦ç‚¹ï¼š<br> <code>ï¼ˆ1ï¼‰values</code><br>    æ•°ç»„ç±»å‹ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æè¿°äº†ä¸€ä¸ªå…³é”®å¸§çš„ç›¸å…³å±æ€§ã€‚æ¯”å¦‚æè¿°å…³é”®å¸§ä½ç½®çš„åŠ¨ç”»æ—¶ï¼Œvaluesæè¿°çš„æ˜¯ä½ç½®ä¿¡æ¯ï¼›æ¯”å¦‚æè¿°å…³é”®å¸§ç¼©æ”¾åŠ¨ç”»æ—¶ï¼Œvaluesæè¿°çš„æ˜¯ç¼©æ”¾æ¯”ä¾‹ä¿¡æ¯<br> <code>ï¼ˆ2ï¼‰keyTimes</code><br>    å…³é”®å¸§åœ¨åŠ¨ç”»å‘¨æœŸé»˜è®¤æ˜¯åŒ€é€Ÿçš„ã€‚å¦‚æœè®¾ç½®äº†è¯¥å±æ€§ï¼Œé‚£ä¹ˆæ¯ä¸ªå…³é”®å¸§æ˜¾ç¤ºçš„å‘¨æœŸä¸º<code>keyTimes*duration</code><br> <code>ï¼ˆ3ï¼‰path</code><br>    æ§åˆ¶åŠ¨ç”»è·¯å¾„ï¼Œé€šè¿‡è®¾ç½®<code>CGPathRef/CGMutablePathRef</code>å¯ä»¥è®©åŠ¨ç”»æŒ‰ç…§è‡ªå·±ç»˜åˆ¶çš„è·¯å¾„è¿è¡Œ</p><h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p>å…·ä½“ç¤ºä¾‹ä»£ç çœ‹è¿™é‡Œâ†’_â†’<a href="https://github.com/SPIREJ/AnimationLayerSwift" target="_blank" rel="noopener">https://github.com/SPIREJ/AnimationLayerSwift</a></p><h4 id="1ã€CAEmitterCellç²’å­ç«ç„°æ•ˆæœ"><a href="#1ã€CAEmitterCellç²’å­ç«ç„°æ•ˆæœ" class="headerlink" title="1ã€CAEmitterCellç²’å­ç«ç„°æ•ˆæœ"></a>1ã€CAEmitterCellç²’å­ç«ç„°æ•ˆæœ</h4><p> å…³é”®å­—ï¼š<code>CAEmitterLayer / ACEmitterCell</code></p><blockquote><p>ç²’å­ç³»ç»Ÿç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š<code>CAEmitterLayer</code> <code>CAEmitterCell</code><br> <code>(1)CAEmitterLayer</code>ä¸ºç²’å­å‘å°„å›¾å±‚ã€‚è¯¥å›¾å±‚ä¸»è¦ç”¨äºæ§åˆ¶ç²’å­å±•ç°èŒƒå›´ã€ç²’å­å‘å°„ä½ç½®ã€ç²’å­å‘å°„å½¢çŠ¶ã€æ¸²æŸ“æ¨¡å¼ç­‰ã€‚é€šè¿‡CAEmitterCellæ„å»ºçš„å‘å°„å•å…ƒéƒ½å—åˆ°CAEmitterLayerå›¾å±‚èŠ‚åˆ¶ã€‚<br> <code>(2)CAEmitterCell</code>ç²’å­å‘å°„å•å…ƒï¼Œæ§åˆ¶ç²’å­çš„ç§»åŠ¨é€Ÿåº¦ã€æ–¹å‘ã€èŒƒå›´ç­‰ç­‰ï¼Œè¿™äº›å±æ€§å¯ä»¥åˆ¶ä½œé…·ç‚«çš„ç²’å­ç‰¹æ•ˆåŠ¨ç”»</p></blockquote><p><img src="https://upload-images.jianshu.io/upload_images/1276164-c58a2b8c0b34cc91.gif?imageMogr2/auto-orient/strip" alt="ç²’å­ç«ç„°æ•ˆæœ.gif"></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmitterFireVC</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> emitterCell = <span class="type">CAEmitterCell</span>() <span class="comment">//ç²’å­å•å…ƒcell</span></span><br><span class="line">    <span class="keyword">let</span> emitterLayer = <span class="type">CAEmitterLayer</span>()<span class="comment">//ç²’å­å‘å°„å›¾å±‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.view.backgroundColor = <span class="type">UIColor</span>.black;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">        <span class="keyword">self</span>.navigationItem.title = <span class="string">"ç²’å­ç«ç„°æ•ˆæœ"</span></span><br><span class="line">        </span><br><span class="line">        emitterCell.name = <span class="string">"fire"</span><span class="comment">//ç²’å­å•å…ƒåç§°</span></span><br><span class="line">        emitterCell.emissionLongitude = <span class="type">CGFloat</span>(<span class="type">Double</span>.pi)<span class="comment">//è¯¥dç²’å­ç³»ç»Ÿåœ¨xyå¹³é¢çš„å‘å°„è§’åº¦</span></span><br><span class="line">        emitterCell.velocity = -<span class="number">1</span><span class="comment">//ç²’å­é€Ÿåº¦1ï¼Œè´Ÿè¡¨ç¤ºæ²¿yåæ–¹å‘è¿åŠ¨</span></span><br><span class="line">        emitterCell.velocityRange = <span class="number">50</span><span class="comment">//ç²’å­é€Ÿåº¦èŒƒå›´</span></span><br><span class="line">        emitterCell.emissionRange = <span class="number">1.1</span><span class="comment">//ç²’å­å‘å°„è§’åº¦</span></span><br><span class="line">        emitterCell.yAcceleration = -<span class="number">200</span><span class="comment">//ç²’å­yæ–¹å‘çš„åŠ é€Ÿåº¦åˆ†é‡</span></span><br><span class="line">        emitterCell.scaleSpeed = <span class="number">0.3</span><span class="comment">//ç¼©æ”¾æ¯”ä¾‹ï¼Œè¶…å¤§ç«è‹—</span></span><br><span class="line">        emitterCell.birthRate = <span class="number">500</span><span class="comment">//ç²’å­æ•°</span></span><br><span class="line">        emitterCell.lifetime = <span class="number">1</span><span class="comment">//ç²’å­ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">        <span class="comment">// ç«ç„°é¢œè‰²</span></span><br><span class="line">        emitterCell.color = <span class="type">UIColor</span>(red: <span class="number">0.8</span>, green: <span class="number">0.4</span>, blue: <span class="number">0.2</span>, alpha: <span class="number">0.1</span>).cgColor</span><br><span class="line">        <span class="comment">// å¿…é¡»è¦è®¾ç½®ç²’å­çš„â€œç§å­â€å†…å®¹</span></span><br><span class="line">        emitterCell.contents = <span class="type">UIImage</span>(named: <span class="string">"fire.png"</span>)!.cgImage</span><br><span class="line">        </span><br><span class="line">        emitterLayer.position = <span class="keyword">self</span>.view.center<span class="comment">//ç²’å­å‘å°„ä½ç½®</span></span><br><span class="line">        emitterLayer.emitterSize = <span class="type">CGSize</span>(width: <span class="number">50</span>, height: <span class="number">10</span>)<span class="comment">//å½“å‰ç«è‹—å¤§å°</span></span><br><span class="line">        <span class="comment">// å½“å‰ç²’å­æ¸²æŸ“æ¨¡å¼ å’Œ å‘å°„æºæ¨¡å¼</span></span><br><span class="line">        emitterLayer.renderMode = .additive</span><br><span class="line">        emitterLayer.emitterMode = .outline</span><br><span class="line">        emitterLayer.emitterShape = .line</span><br><span class="line">        <span class="comment">// ç²’å­å•å…ƒéƒ¨ç½²åˆ°ç²’å­å‘å°„å›¾å±‚ä¸­</span></span><br><span class="line">        emitterLayer.emitterCells = [emitterCell]</span><br><span class="line">        <span class="keyword">self</span>.view.layer.addSublayer(emitterLayer)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç²’å­é€Ÿåº¦</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">velocityChanged</span><span class="params">(<span class="number">_</span> sender: UISlider)</span></span> &#123;</span><br><span class="line">        <span class="comment">// é‡ç½®ç²’å­é€Ÿåº¦</span></span><br><span class="line">        emitterLayer.setValue(sender.value, forKeyPath: <span class="string">"emitterCells.fire.velocity"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç²’å­æ•°</span></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">birthRateChanged</span><span class="params">(<span class="number">_</span> sender: UISlider)</span></span> &#123;</span><br><span class="line">        <span class="comment">// é‡ç½®ç²’å­ç”Ÿæˆé€Ÿåº¦ï¼Œå³ç²’å­æ•°</span></span><br><span class="line">        emitterLayer.setValue(sender.value, forKeyPath: <span class="string">"emitterCells.fire.birthRate"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2ã€CAEmitterCellç²’å­éœ“è™¹æ•ˆæœ"><a href="#2ã€CAEmitterCellç²’å­éœ“è™¹æ•ˆæœ" class="headerlink" title="2ã€CAEmitterCellç²’å­éœ“è™¹æ•ˆæœ"></a>2ã€CAEmitterCellç²’å­éœ“è™¹æ•ˆæœ</h4><p> å…³é”®å­—ï¼š<code>CAEmitterLayer / ACEmitterCell</code></p><p><img src="https://upload-images.jianshu.io/upload_images/1276164-2c46cf78efd79c14.gif?imageMogr2/auto-orient/strip" alt="ç²’å­éœ“è™¹æ•ˆæœ.gif"></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">class EmitterNenoVC: UIViewController &#123;</span><br><span class="line"></span><br><span class="line">    override func viewDidLoad() &#123;</span><br><span class="line">        super.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">        self<span class="selector-class">.navigationItem</span><span class="selector-class">.title</span> = <span class="string">"éœ“è™¹æ•ˆæœ"</span></span><br><span class="line"></span><br><span class="line">        self<span class="selector-class">.view</span><span class="selector-class">.backgroundColor</span> = UIColor.black</span><br><span class="line">        </span><br><span class="line">        let emitterCell = CAEmitterCell()</span><br><span class="line">        emitterCell<span class="selector-class">.name</span> = <span class="string">"neonlight"</span></span><br><span class="line">        emitterCell<span class="selector-class">.emissionLongitude</span>  = CGFloat(Double.pi*<span class="number">2</span>)<span class="comment">// emissionLongitude:x-y å¹³é¢çš„ å‘ å°„æ–¹å‘</span></span><br><span class="line">        emitterCell<span class="selector-class">.velocity</span> = <span class="number">50</span><span class="comment">// ç²’å­é€Ÿåº¦</span></span><br><span class="line">        emitterCell<span class="selector-class">.velocityRange</span> = <span class="number">50</span><span class="comment">// ç²’å­é€Ÿåº¦èŒƒå›´</span></span><br><span class="line">        emitterCell<span class="selector-class">.scaleSpeed</span> = -<span class="number">0.2</span><span class="comment">// ç¼©æ”¾æ¯”ä¾‹ è¶…å¤§ç«è‹—</span></span><br><span class="line">        emitterCell<span class="selector-class">.scale</span> = <span class="number">0.1</span><span class="comment">//ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">        <span class="comment">//R G B alphaçš„é¢œè‰²é€Ÿåº¦æ¸å˜æ•ˆæœ</span></span><br><span class="line">        emitterCell<span class="selector-class">.redSpeed</span> = -<span class="number">0.2</span></span><br><span class="line">        emitterCell<span class="selector-class">.greenSpeed</span> = -<span class="number">0.1</span></span><br><span class="line">        emitterCell<span class="selector-class">.blueSpeed</span> = <span class="number">0.1</span></span><br><span class="line">        emitterCell<span class="selector-class">.alphaSpeed</span> = -<span class="number">0.2</span></span><br><span class="line">        emitterCell<span class="selector-class">.birthRate</span> = <span class="number">100</span><span class="comment">//ç²’å­ç”Ÿæˆé€Ÿåº¦</span></span><br><span class="line">        emitterCell<span class="selector-class">.lifetime</span> = <span class="number">4</span><span class="comment">//ç²’å­ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">        emitterCell<span class="selector-class">.color</span> = UIColor<span class="selector-class">.white</span><span class="selector-class">.cgColor</span><span class="comment">//ç²’å­èƒŒæ™¯é¢œè‰²</span></span><br><span class="line">        <span class="comment">//ç²’å­æ•ˆæœå†…å®¹</span></span><br><span class="line">        emitterCell<span class="selector-class">.contents</span> = UIImage(named: <span class="string">"neonlight.png"</span>)!.cgImage</span><br><span class="line">        </span><br><span class="line">        let emitterLayer = CAEmitterLayer()</span><br><span class="line">        emitterLayer<span class="selector-class">.position</span> = self<span class="selector-class">.view</span><span class="selector-class">.center</span><span class="comment">// ç²’å­å‘å°„ä½ç½®</span></span><br><span class="line">        emitterLayer<span class="selector-class">.emitterSize</span> = CGSize(<span class="attribute">width</span>: <span class="number">2</span>, height: <span class="number">2</span>)// æ§åˆ¶ç²’å­å¤§å°</span><br><span class="line">        emitterLayer<span class="selector-class">.renderMode</span> = CAEmitterLayerRenderMode.backToFront<span class="comment">//ç€è‰²(æ¸²æŸ“)æ¨¡å¼</span></span><br><span class="line">        emitterLayer<span class="selector-class">.emitterMode</span> = CAEmitterLayerEmitterMode.<span class="attribute">outline</span>// æ§åˆ¶å‘å°„æºæ¨¡å¼ å³å½¢çŠ¶</span><br><span class="line">        emitterLayer<span class="selector-class">.emitterShape</span> = CAEmitterLayerEmitterShape.circle<span class="comment">//å½¢çŠ¶</span></span><br><span class="line">        </span><br><span class="line">        emitterLayer<span class="selector-class">.emitterCells</span> = [emitterCell]</span><br><span class="line">        self<span class="selector-class">.view</span><span class="selector-class">.layer</span><span class="selector-class">.addSublayer</span>(emitterLayer)</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3ã€CAGradientLayer-é¢œè‰²æ¢¯åº¦-ä½ç½®æ¢¯åº¦"><a href="#3ã€CAGradientLayer-é¢œè‰²æ¢¯åº¦-ä½ç½®æ¢¯åº¦" class="headerlink" title="3ã€CAGradientLayer é¢œè‰²æ¢¯åº¦/ä½ç½®æ¢¯åº¦"></a>3ã€CAGradientLayer é¢œè‰²æ¢¯åº¦/ä½ç½®æ¢¯åº¦</h4><p><code>CAGradientLayer</code>å¯ä»¥æ‹†è§£ä¸ºä¸‰ä¸ªä¸»è¦ç»„æˆéƒ¨åˆ†<br> <code>CA</code>:CoreAnimationçš„ç¼©å†™ï¼Œè¡¨æ˜ä½¿ç”¨çš„æ˜¯iOSæ¡†æ¶ä¸‹çš„æ ¸å¿ƒåŠ¨ç”»éƒ¨åˆ†<br> <code>Gradient</code>:æ¢¯åº¦çš„æ„æ€ï¼Œæè¿°å½“å‰åŠ¨ç”»çš„ç‰¹ç‚¹ï¼Œå®ç°ä¸€äº›æ¢¯åº¦åŠŸèƒ½çš„åŠ¨ç”»æ•ˆæœã€‚æ¯”å¦‚ä½ç½®çš„æ¢¯åº¦å˜åŒ–ã€é¢œè‰²çš„æ¢¯åº¦æ¸å˜ç­‰<br><code>Layer</code>:å½“å‰åŠ¨ç”»ä½œç”¨åœ¨Layerå†…å®¹å±‚</p><ul><li><strong>CALayeråæ ‡ç³»</strong><br><img src="https://upload-images.jianshu.io/upload_images/1276164-28fe38a837ec2aba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="frameåæ ‡ç³»ä¸â€œæ¢¯åº¦â€åæ ‡ç³»å¯¹åº”å…³ç³»"></li></ul><h5 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h5><ul><li><strong>colors</strong><br><code>var colors: [AnyObject]?</code><br>ä¸€ä¸ªå†…éƒ¨æ˜¯<code>CGColorRef</code>çš„æ•°ç»„,è§„å®šæ‰€æœ‰çš„æ¢¯åº¦æ‰€æ˜¾ç¤ºçš„é¢œè‰²,é»˜è®¤ä¸º<code>nil</code></li><li><strong>locations</strong><br><code>var locations: [NSNumber]?</code><br>ä¸€ä¸ªå†…éƒ¨æ˜¯<code>NSNumber</code>çš„å¯é€‰æ•°ç»„,è§„å®šæ‰€æœ‰çš„é¢œè‰²æ¢¯åº¦çš„åŒºé—´èŒƒå›´,é€‰å€¼åªèƒ½åœ¨<code>0åˆ°1ä¹‹é—´</code>,å¹¶ä¸”æ•°ç»„çš„æ•°æ®å¿…é¡»å•å¢,é»˜è®¤å€¼ä¸º<code>nil</code></li><li><strong>endPoint</strong><br><code>var endPoint: CGPoint</code><br>å›¾å±‚é¢œè‰²ç»˜åˆ¶çš„ç»ˆç‚¹åæ ‡,ä¹Ÿå°±æ˜¯é˜¶æ¢¯å›¾å±‚ç»˜åˆ¶çš„ç»“æŸç‚¹,é»˜è®¤å€¼æ˜¯<code>(0.5,1.0)</code></li><li><strong>startPoint</strong><br><code>var startPoint: CGPoint</code><br>ä¸<code>endPoint</code>ç›¸äº’å¯¹åº”,å°±æ˜¯ç»˜åˆ¶é˜¶æ¢¯å›¾å±‚çš„èµ·ç‚¹åæ ‡,ç»˜åˆ¶é¢œè‰²çš„èµ·ç‚¹,é»˜è®¤å€¼æ˜¯<code>(0.5,0.0)</code></li><li><strong>type</strong><br><code>var type:String</code><br>ç»˜åˆ¶ç±»å‹,é»˜è®¤å€¼æ˜¯<code>kCAGradientLayerAxial</code>,ä¹Ÿå°±æ˜¯çº¿æ€§ç»˜åˆ¶,å„ä¸ªé¢œè‰²é˜¶å±‚ç›´æ¥çš„å˜åŒ–æ˜¯çº¿æ€§çš„</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/1276164-60b3175fb3b98bdd.gif?imageMogr2/auto-orient/strip" alt="GradientLayeré¢œè‰²æ¢¯åº¦å˜åŒ–.gif"></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">override func viewDidLoad() &#123;</span><br><span class="line">    super.viewDidLoad()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">    </span><br><span class="line">    self<span class="selector-class">.view</span><span class="selector-class">.backgroundColor</span> = UIColor.black</span><br><span class="line">    </span><br><span class="line">    let view = UIView(frame: CGRect(x: <span class="number">0</span>, y: <span class="number">0</span>, <span class="attribute">width</span>: <span class="number">100</span>, height: <span class="number">200</span>))</span><br><span class="line">    view<span class="selector-class">.center</span> = self<span class="selector-class">.view</span><span class="selector-class">.center</span></span><br><span class="line">    self<span class="selector-class">.view</span><span class="selector-class">.addSubview</span>(view)</span><br><span class="line">    </span><br><span class="line">    let gradientLayer:CAGradientLayer = CAGradientLayer()</span><br><span class="line">    gradientLayer<span class="selector-class">.frame</span> = view.bounds</span><br><span class="line">    gradientLayer<span class="selector-class">.startPoint</span> = CGPoint(x: <span class="number">0</span>, y: <span class="number">0</span>)</span><br><span class="line">    gradientLayer<span class="selector-class">.endPoint</span> = CGPoint(x: <span class="number">0</span>, y: <span class="number">1</span>)</span><br><span class="line">    gradientLayer<span class="selector-class">.colors</span> = [UIColor<span class="selector-class">.clear</span><span class="selector-class">.cgColor</span>,UIColor<span class="selector-class">.white</span><span class="selector-class">.cgColor</span>,UIColor<span class="selector-class">.clear</span><span class="selector-class">.cgColor</span>]</span><br><span class="line">    gradientLayer<span class="selector-class">.locations</span> = [<span class="number">0.0</span>, <span class="number">0.5</span>, <span class="number">1.0</span>]</span><br><span class="line">    view<span class="selector-class">.layer</span><span class="selector-class">.addSublayer</span>(gradientLayer)</span><br><span class="line">    </span><br><span class="line">    let gradientAnimation:CABasicAnimation = CABasicAnimation()</span><br><span class="line">    gradientAnimation<span class="selector-class">.keyPath</span> = <span class="string">"colors"</span></span><br><span class="line">    gradientAnimation<span class="selector-class">.fromValue</span> = [UIColor<span class="selector-class">.clear</span><span class="selector-class">.cgColor</span>,UIColor<span class="selector-class">.white</span><span class="selector-class">.cgColor</span>,UIColor<span class="selector-class">.clear</span><span class="selector-class">.cgColor</span>]</span><br><span class="line">    gradientAnimation<span class="selector-class">.toValue</span> = [UIColor<span class="selector-class">.blue</span><span class="selector-class">.cgColor</span>,UIColor<span class="selector-class">.red</span><span class="selector-class">.cgColor</span>,UIColor<span class="selector-class">.cyan</span><span class="selector-class">.cgColor</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¦ä¸€ç§æ–¹å¼ ä½ç½®</span></span><br><span class="line">    <span class="comment">//gradientLayer.locations = [0.0, 0.05, 0.1]</span></span><br><span class="line">    <span class="comment">//gradientAnimation.keyPath = "locations"</span></span><br><span class="line">    <span class="comment">//gradientAnimation.fromValue = [0.0, 0.05, 0.1]</span></span><br><span class="line">    <span class="comment">//gradientAnimation.toValue = [0.9, 0.95, 1.0]</span></span><br><span class="line">    </span><br><span class="line">    gradientAnimation<span class="selector-class">.duration</span> = <span class="number">3.0</span></span><br><span class="line">    <span class="comment">// åŠ¨ç”»ç»“æŸåä¿æŒç»“æŸåçš„çŠ¶æ€</span></span><br><span class="line">    gradientAnimation<span class="selector-class">.isRemovedOnCompletion</span> = false</span><br><span class="line">    gradientAnimation<span class="selector-class">.fillMode</span> = .forwards</span><br><span class="line">    </span><br><span class="line">    gradientLayer.add(gradientAnimation, forKey: nil)</span><br></pre></td></tr></table></figure><blockquote><p><code>CAGradientLayer</code>ç»“åˆ<code>CoreAnimation</code>å¯ä»¥å®ç°å¾ˆå¤šé…·ç‚«çš„æ•ˆæœï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªè¡Œç ”ç©¶</p></blockquote><h4 id="4ã€CAReplicatorLayerå›¾å±‚å¤åˆ¶"><a href="#4ã€CAReplicatorLayerå›¾å±‚å¤åˆ¶" class="headerlink" title="4ã€CAReplicatorLayerå›¾å±‚å¤åˆ¶"></a>4ã€CAReplicatorLayerå›¾å±‚å¤åˆ¶</h4><p><code>#å…³é”®å­— CAReplicatorLayer</code><br> ä¸»è¦ç”¨äºå›¾å±‚çš„å¿«é€Ÿå¤åˆ¶ï¼Œå¹¶ä¸”å¤åˆ¶ä¼šä¿æŒè¢«å¤åˆ¶å›¾å±‚çš„å„ç§åŸºç¡€å±æ€§åŠåŠ¨ç”»</p><p><strong>åŸºæœ¬å±æ€§</strong></p><ul><li><p><strong>instanceCount</strong><br><code>var instanceCount: Int</code><br>æ‹·è´å›¾å±‚çš„æ¬¡æ•°,åŒ…æ‹¬å…¶æ‰€æœ‰çš„å­å›¾å±‚,é»˜è®¤å€¼æ˜¯1,ä¹Ÿå°±æ˜¯æ²¡æœ‰ä»»ä½•å­å›¾å±‚è¢«å¤åˆ¶</p><ul><li><p><strong>instanceDelay</strong><br><code>var instanceDelay: CFTimeInterval</code><br>åœ¨çŸ­æ—¶é—´å†…çš„å¤åˆ¶å»¶æ—¶,ä¸€èˆ¬ç”¨åœ¨åŠ¨ç”»ä¸Š(æ”¯æŒåŠ¨ç”»çš„å»¶æ—¶)</p></li><li><p><strong>instanceTransform</strong><br><code>var instanceTransform: CATransform3D</code><br>å¤åˆ¶å›¾å±‚åœ¨è¢«åˆ›å»ºæ—¶äº§ç”Ÿçš„å’Œä¸Šä¸€ä¸ªå¤åˆ¶å›¾å±‚çš„ä½ç§»(ä½ç§»çš„é”šç‚¹æ˜¯CAReplicatorlayerçš„ä¸­å¿ƒç‚¹)</p></li><li><p><strong>preservesDepth</strong><br><code>var preservesDepth: Bool</code><br>å¦‚æœè®¾ç½®ä¸ºYES,å›¾å±‚å°†ä¿æŒäºCATransformLayerç±»ä¼¼çš„æ€§è´¨å’Œç›¸åŒçš„é™åˆ¶</p></li><li><p><strong>instanceColor</strong><br><code>var instanceColor: CGColor?</code><br>è®¾ç½®å¤šä¸ªå¤åˆ¶å›¾å±‚çš„é¢œè‰²,é»˜è®¤ä½ç™½è‰²</p></li></ul></li><li><p><strong>instanceRedOffset</strong><br><code>var instanceRedOffset: Float</code><br>è®¾ç½®æ¯ä¸ªå¤åˆ¶å›¾å±‚ç›¸å¯¹ä¸Šä¸€ä¸ªå¤åˆ¶å›¾å±‚çš„çº¢è‰²åç§»é‡</p><ul><li><p><strong>instanceGreenOffset</strong><br><code>var instanceGreenOffset: Float</code><br>è®¾ç½®æ¯ä¸ªå¤åˆ¶å›¾å±‚ç›¸å¯¹ä¸Šä¸€ä¸ªå¤åˆ¶å›¾å±‚çš„ç»¿è‰²åç§»é‡</p></li><li><p><strong>instanceBlueOffset</strong><br><code>var instanceBlueOffset: Float</code><br>è®¾ç½®æ¯ä¸ªå¤åˆ¶å›¾å±‚ç›¸å¯¹ä¸Šä¸€ä¸ªå¤åˆ¶å›¾å±‚çš„è“è‰²åç§»é‡</p></li><li><p><strong>instanceAlphaOffset</strong><br><code>var instanceAlphaOffset: Float</code><br>è®¾ç½®æ¯ä¸ªå¤åˆ¶å›¾å±‚ç›¸å¯¹ä¸Šä¸€ä¸ªå¤åˆ¶å›¾å±‚çš„é€æ˜åº¦åç§»é‡</p></li></ul></li></ul><h5 id="1-å›¾å±‚å¤åˆ¶-é›·è¾¾æ•ˆæœ"><a href="#1-å›¾å±‚å¤åˆ¶-é›·è¾¾æ•ˆæœ" class="headerlink" title="(1) å›¾å±‚å¤åˆ¶ - é›·è¾¾æ•ˆæœ"></a>(1) å›¾å±‚å¤åˆ¶ - é›·è¾¾æ•ˆæœ</h5><p><img src="https://upload-images.jianshu.io/upload_images/1276164-78028cf557c7cbf8.gif?imageMogr2/auto-orient/strip" alt="å›¾å±‚å¤åˆ¶ - é›·è¾¾æ•ˆæœ.gif"></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">override func viewDidLoad() &#123;</span><br><span class="line">    super.viewDidLoad()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">    self<span class="selector-class">.view</span><span class="selector-class">.backgroundColor</span> = UIColor.white</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èƒŒæ™¯è§†å›¾</span></span><br><span class="line">    let bgView = UIView(frame: CGRect(x: <span class="number">0</span>, y: <span class="number">0</span>, <span class="attribute">width</span>: kWidth, height: <span class="number">200</span>))</span><br><span class="line">    bgView<span class="selector-class">.center</span> = self<span class="selector-class">.view</span><span class="selector-class">.center</span></span><br><span class="line">    bgView<span class="selector-class">.backgroundColor</span> = UIColor.lightGray</span><br><span class="line">    self<span class="selector-class">.view</span><span class="selector-class">.addSubview</span>(bgView)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ¨ç”»åŸå›¾å±‚ï¼Œå°±æ˜¯ä¸æ–­å˜å¤§çš„é‚£ä¸ªåœ†</span></span><br><span class="line">    let animationLayer = CAShapeLayer()</span><br><span class="line">    animationLayer<span class="selector-class">.backgroundColor</span> = UIColor<span class="selector-class">.red</span><span class="selector-class">.cgColor</span></span><br><span class="line">    animationLayer<span class="selector-class">.bounds</span> = CGRect(x: <span class="number">0</span>, y: <span class="number">0</span>, <span class="attribute">width</span>: <span class="number">20</span>, height: <span class="number">20</span>)</span><br><span class="line">    animationLayer<span class="selector-class">.cornerRadius</span> = <span class="number">10</span></span><br><span class="line">    animationLayer<span class="selector-class">.position</span> = CGPoint(x: kWidth/<span class="number">2.0</span>, y: <span class="number">100</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ¨ç”» - æ”¾å¤§</span></span><br><span class="line">    let transformScaleAnim = CABasicAnimation(keyPath: <span class="string">"transform"</span>)</span><br><span class="line">    let value = NSValue.init(caTransform3D:CATransform3DMakeScale(<span class="number">10</span>, <span class="number">10</span>, <span class="number">1</span>))</span><br><span class="line">    transformScaleAnim<span class="selector-class">.toValue</span> = value</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ¨ç”» - é€æ˜åº¦</span></span><br><span class="line">    let alphaAnim = CABasicAnimation(keyPath: <span class="string">"opacity"</span>)</span><br><span class="line">    alphaAnim<span class="selector-class">.toValue</span> = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ å…¥åˆ°åŠ¨ç”»ç»„</span></span><br><span class="line">    let animGroup = CAAnimationGroup()</span><br><span class="line">    animGroup<span class="selector-class">.animations</span> = [transformScaleAnim, alphaAnim]</span><br><span class="line">    animGroup<span class="selector-class">.duration</span> = <span class="number">2</span></span><br><span class="line">    animGroup<span class="selector-class">.repeatCount</span> = HUGE</span><br><span class="line">    animationLayer.add(animGroup, forKey: nil)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤åˆ¶å›¾å±‚</span></span><br><span class="line">    let replicatorLayer = CAReplicatorLayer()</span><br><span class="line">    replicatorLayer.addSublayer(animationLayer)</span><br><span class="line">    replicatorLayer<span class="selector-class">.instanceCount</span> = <span class="number">3</span> <span class="comment">//å¤åˆ¶å›¾å±‚æ•°</span></span><br><span class="line">    replicatorLayer<span class="selector-class">.instanceDelay</span> = <span class="number">0.3</span><span class="comment">//å¤åˆ¶é—´éš”æ—¶é—´</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ è½½åˆ°è§†å›¾ä¸­æ˜¾ç¤º</span></span><br><span class="line">    bgView<span class="selector-class">.layer</span><span class="selector-class">.addSublayer</span>(replicatorLayer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-å›¾å±‚å¤åˆ¶-åŠ è½½åŠ¨ç”»æ•ˆæœ"><a href="#2-å›¾å±‚å¤åˆ¶-åŠ è½½åŠ¨ç”»æ•ˆæœ" class="headerlink" title="(2) å›¾å±‚å¤åˆ¶ - åŠ è½½åŠ¨ç”»æ•ˆæœ"></a>(2) å›¾å±‚å¤åˆ¶ - åŠ è½½åŠ¨ç”»æ•ˆæœ</h5><p><img src="https://upload-images.jianshu.io/upload_images/1276164-6d9429bb6ed8235b.gif?imageMogr2/auto-orient/strip" alt="å›¾å±‚å¤åˆ¶ - åŠ è½½åŠ¨ç”»æ•ˆæœ.gif"></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">func ui_circle() &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èƒŒæ™¯è§†å›¾</span></span><br><span class="line">    let bgView = UIView(frame: CGRect(x: <span class="number">0</span>, y: <span class="number">0</span>, <span class="attribute">width</span>: kWidth, height: <span class="number">200</span>))</span><br><span class="line">    bgView<span class="selector-class">.center</span> = self<span class="selector-class">.view</span><span class="selector-class">.center</span></span><br><span class="line">    bgView<span class="selector-class">.backgroundColor</span> = UIColor.lightGray</span><br><span class="line">    self<span class="selector-class">.view</span><span class="selector-class">.addSubview</span>(bgView)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ¨ç”»åŸå›¾å±‚ï¼Œå°±æ˜¯ä¸æ–­è½¬åœˆçš„åœ†</span></span><br><span class="line">    let animationLayer = CAShapeLayer()</span><br><span class="line">    animationLayer<span class="selector-class">.backgroundColor</span> = UIColor<span class="selector-class">.red</span><span class="selector-class">.cgColor</span></span><br><span class="line">    animationLayer<span class="selector-class">.bounds</span> = CGRect(x: <span class="number">0</span>, y: <span class="number">0</span>, <span class="attribute">width</span>: <span class="number">20</span>, height: <span class="number">20</span>)</span><br><span class="line">    animationLayer<span class="selector-class">.cornerRadius</span> = <span class="number">10</span></span><br><span class="line">    animationLayer<span class="selector-class">.position</span> = CGPoint(x: kWidth/<span class="number">2.0</span>, y: <span class="number">50</span>)</span><br><span class="line">    animationLayer<span class="selector-class">.transform</span> = CATransform3DMakeScale(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)<span class="comment">//åˆå§‹éšè—</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ¨ç”» - ç¼©æ”¾</span></span><br><span class="line">    let transformAnim = CABasicAnimation(keyPath: <span class="string">"transform"</span>)</span><br><span class="line">    transformAnim<span class="selector-class">.duration</span> = <span class="number">2</span></span><br><span class="line">    transformAnim<span class="selector-class">.repeatCount</span> = HUGE</span><br><span class="line">    transformAnim<span class="selector-class">.fromValue</span> = NSValue.init(caTransform3D: CATransform3DMakeScale(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">    transformAnim<span class="selector-class">.toValue</span> = NSValue.init(caTransform3D: CATransform3DMakeScale(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.1</span>))</span><br><span class="line">    animationLayer.add(transformAnim, forKey: nil)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤åˆ¶å›¾å±‚</span></span><br><span class="line">    let replicatorLayer = CAReplicatorLayer()</span><br><span class="line">    replicatorLayer<span class="selector-class">.frame</span> = bgView.bounds</span><br><span class="line">    replicatorLayer.addSublayer(animationLayer)</span><br><span class="line">    replicatorLayer<span class="selector-class">.instanceCount</span> = <span class="number">10</span> <span class="comment">//å¤åˆ¶å›¾å±‚æ•°</span></span><br><span class="line">    replicatorLayer<span class="selector-class">.instanceDelay</span> = <span class="number">0.2</span><span class="comment">//å¤åˆ¶é—´éš”æ—¶é—´</span></span><br><span class="line">    replicatorLayer<span class="selector-class">.instanceTransform</span> = CATransform3DMakeRotation(CGFloat(Double.pi*<span class="number">2</span>/Double(<span class="number">10</span>)), <span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ è½½åˆ°è§†å›¾ä¸­æ˜¾ç¤º</span></span><br><span class="line">    bgView<span class="selector-class">.layer</span><span class="selector-class">.addSublayer</span>(replicatorLayer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæ•´ç¤ºä¾‹ä»£ç <a href="https://github.com/SPIREJ/AnimationLayerSwift" target="_blank" rel="noopener">https://github.com/SPIREJ/AnimationLayerSwift</a></p><p>å¦‚æœæ‚¨æœ‰å…´è¶£çš„è¯<br>ä¸Šä¸€èŠ‚<a href="https://www.jianshu.com/p/4e95c596dfa9" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·æ˜¾ç¤ºå±‚åŠ¨ç”»</a><br>ä¸‹ä¸€èŠ‚<a href="https://www.jianshu.com/p/0c5be91642cd" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·è½¬åœºåŠ¨ç”»</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-99df471d98fa9d89.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å†…å®¹å±‚åŠ¨ç”».jpg&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOSåŠ¨ç”»" scheme="http://yoursite.com/tags/iOS%E5%8A%A8%E7%94%BB/"/>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://yoursite.com/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·æ˜¾ç¤ºå±‚åŠ¨ç”»</title>
    <link href="http://yoursite.com/2019/02/15/%E3%80%8AiOS%E5%8A%A8%E7%94%BB%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%C2%B7%E6%98%BE%E7%A4%BA%E5%B1%82%E5%8A%A8%E7%94%BB/"/>
    <id>http://yoursite.com/2019/02/15/ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·æ˜¾ç¤ºå±‚åŠ¨ç”»/</id>
    <published>2019-02-15T14:46:40.000Z</published>
    <updated>2019-03-25T03:20:02.897Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://upload-images.jianshu.io/upload_images/1276164-b94babab7532c2f9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·æ˜¾ç¤ºå±‚åŠ¨ç”».jpg"></p><a id="more"></a><p><a href="https://www.jianshu.com/p/bc6e3e175a37" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å‰åº</a><br><a href="https://www.jianshu.com/p/4e95c596dfa9" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·æ˜¾ç¤ºå±‚åŠ¨ç”»</a><br><a href="https://www.jianshu.com/p/3b469f7ba311" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å†…å®¹å±‚åŠ¨ç”»</a><br><a href="https://www.jianshu.com/p/0c5be91642cd" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·è½¬åœºåŠ¨ç”»</a></p><h2 id="UIViewå¸¸ç”¨åŠ¨ç”»åˆé›†å›¾è§£"><a href="#UIViewå¸¸ç”¨åŠ¨ç”»åˆé›†å›¾è§£" class="headerlink" title="UIViewå¸¸ç”¨åŠ¨ç”»åˆé›†å›¾è§£"></a>UIViewå¸¸ç”¨åŠ¨ç”»åˆé›†å›¾è§£</h2><p><img src="https://upload-images.jianshu.io/upload_images/1276164-a532af031b0e2be0.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="UIViewå¸¸ç”¨åŠ¨ç”»åˆé›†.jpg"></p><blockquote><p>UIViewæ˜¾ç¤ºå±‚åŠ¨ç”»æ•ˆæœçš„å®è´¨è¿˜æ˜¯é€šè¿‡ä¿®æ”¹UIViewçš„å„ç§å±æ€§æ¥å®ç°çš„ã€‚</p></blockquote><h3 id="UIViewåŠ¨ç”»æ•ˆæœç»å¸¸æ¶‰åŠçš„å±æ€§"><a href="#UIViewåŠ¨ç”»æ•ˆæœç»å¸¸æ¶‰åŠçš„å±æ€§" class="headerlink" title="UIViewåŠ¨ç”»æ•ˆæœç»å¸¸æ¶‰åŠçš„å±æ€§"></a>UIViewåŠ¨ç”»æ•ˆæœç»å¸¸æ¶‰åŠçš„å±æ€§</h3><p><code>frame</code> <code>bounds</code> <code>center</code><br><code>alpha</code> <code>backgroundColor</code> <code>transform</code></p><p>è¿™é‡Œè¯´ä¸€ä¸‹ï¼štransform</p><p><code>UIView</code>æœ‰ä¸€ä¸ªç‰¹åˆ«é‡è¦çš„å±æ€§<code>transform</code>ï¼Œè¯¥å±æ€§ç»§æ‰¿è‡ª<code>CGAffineTransform</code>ï¼Œâ€œCGâ€å®é™…ä¸Šæ˜¯<code>CoreGraphics</code>æ¡†æ¶çš„ç¼©å†™ã€‚å¯è§<code>transform</code>å±æ€§æ˜¯æ ¸å¿ƒç»˜å›¾æ¡†æ¶ä¸<code>UIView</code>ä¹‹é—´çš„æ¡¥æ¢ã€‚<code>transform</code>æœ€å¸¸ç”¨çš„ä¸‰ç§åŠ¨ç”»åˆ†åˆ«æ˜¯<code>ç¼©æ”¾ã€æ—‹è½¬ã€ä½ç§»</code>ã€‚</p><h3 id="åŠ¨ç”»è®¾ç½®ï¼šé—­åŒ…å½¢å¼"><a href="#åŠ¨ç”»è®¾ç½®ï¼šé—­åŒ…å½¢å¼" class="headerlink" title="åŠ¨ç”»è®¾ç½®ï¼šé—­åŒ…å½¢å¼"></a>åŠ¨ç”»è®¾ç½®ï¼šé—­åŒ…å½¢å¼</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">UIView.animate(withDuration</span>: 0.5) &#123;</span><br><span class="line"></span><br><span class="line">    self.loginBT?.center = CGPoint(x: kScreenW/2.0, y: kScreenH/2.0)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">UIView.animate(withDuration</span>: 0.5, animations: &#123;</span><br><span class="line">    </span><br><span class="line">&#125;) &#123; (true) in</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">UIView.animate(withDuration</span>: 0.5, delay: 0.2, options: UIView.AnimationOptions.curveEaseOut, animations: &#123;</span><br><span class="line">    </span><br><span class="line">&#125;) &#123; (true) in</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŠ¨ç”»è®¾ç½®ï¼šæ–¹æ³•å½¢å¼"><a href="#åŠ¨ç”»è®¾ç½®ï¼šæ–¹æ³•å½¢å¼" class="headerlink" title="åŠ¨ç”»è®¾ç½®ï¼šæ–¹æ³•å½¢å¼"></a>åŠ¨ç”»è®¾ç½®ï¼šæ–¹æ³•å½¢å¼</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIView</span>.beginAnimations(<span class="literal">nil</span>, context: <span class="literal">nil</span>)<span class="comment">//åŠ¨ç”»å¼€å§‹</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UIView</span>.setAnimationDuration(<span class="number">0.5</span>)<span class="comment">//åŠ¨ç”»å‘¨æœŸè®¾ç½®</span></span><br><span class="line">     </span><br><span class="line"><span class="built_in">UIView</span>.setAnimationCurve(<span class="built_in">UIView</span>.AnimationCurve.easeInOut)<span class="comment">//åŠ¨ç”»å±æ€§</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UIView</span>.setAnimationDelay(<span class="number">1</span>)<span class="comment">//åŠ¨ç”»å»¶è¿Ÿæ‰§è¡Œæ—¶é—´ï¼Œæ¯”å¦‚åŠ¨ç”»å¯åŠ¨ä¹‹åï¼Œå®é™…å±•ç¤ºæ•ˆæœè¦ç­‰1sä¹‹åæ‰æ˜¾ç¤ºå‡ºæ¥</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UIView</span>.setAnimationsEnabled(<span class="literal">true</span>)<span class="comment">//åŠ¨ç”»æ˜¯å¦èƒ½ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UIView</span>.setAnimationRepeatAutoreverses(<span class="literal">true</span>)<span class="comment">//åŠ¨ç”»æ˜¯å¦æœ‰é‡å¤è¿”å›æ•ˆæœ</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UIView</span>.setAnimationRepeatCount(<span class="number">5</span>)<span class="comment">//åŠ¨ç”»é‡å¤æ¬¡æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¨ç”»å…·ä½“è¦åšçš„å¤„ç†</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIView</span>.commitAnimations()<span class="comment">//åŠ¨ç”»æäº¤</span></span><br></pre></td></tr></table></figure><h3 id="åŠ¨ç”»å±æ€§è®¾ç½®åŠ é€Ÿã€å‡é€Ÿæ•ˆæœ"><a href="#åŠ¨ç”»å±æ€§è®¾ç½®åŠ é€Ÿã€å‡é€Ÿæ•ˆæœ" class="headerlink" title="åŠ¨ç”»å±æ€§è®¾ç½®åŠ é€Ÿã€å‡é€Ÿæ•ˆæœ"></a>åŠ¨ç”»å±æ€§è®¾ç½®åŠ é€Ÿã€å‡é€Ÿæ•ˆæœ</h3><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">enum</span> <span class="title">AnimationCurve</span> : <span class="title">Int</span> &#123;</span></span><br><span class="line">    <span class="keyword">case</span> easeInOut  /<span class="regexp">/åŠ¨ç”»å¼€å§‹å’Œç»“æŸæ—¶å‘ˆç°å‡é€Ÿæ•ˆæœ</span></span><br><span class="line"><span class="regexp">    </span></span><br><span class="line"><span class="regexp">    case easeIn     /</span><span class="regexp">/åŠ¨ç”»å¼€å§‹æ—¶å‘ˆç°å‡é€Ÿæ•ˆæœ</span></span><br><span class="line"><span class="regexp">    </span></span><br><span class="line"><span class="regexp">    case easeOut    /</span><span class="regexp">/åŠ¨ç”»ç»“æŸæ—¶å‘ˆç°å‡é€Ÿæ•ˆæœ</span></span><br><span class="line"><span class="regexp">    </span></span><br><span class="line"><span class="regexp">    case linear     /</span><span class="regexp">/åŠ¨ç”»æ•´ä¸ªå‘¨æœŸå†…é€Ÿåº¦ä¸€è‡´ã€åŒ€é€Ÿè¿åŠ¨</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="åŠ¨ç”»å›è°ƒæ–¹æ³•"><a href="#åŠ¨ç”»å›è°ƒæ–¹æ³•" class="headerlink" title="åŠ¨ç”»å›è°ƒæ–¹æ³•"></a>åŠ¨ç”»å›è°ƒæ–¹æ³•</h3><h4 id="delegate-å›è°ƒæ–¹æ³•"><a href="#delegate-å›è°ƒæ–¹æ³•" class="headerlink" title="delegate å›è°ƒæ–¹æ³•"></a>delegate å›è°ƒæ–¹æ³•</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">optional</span> <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">animationDidStart</span><span class="params">(<span class="number">_</span> anim: CAAnimation)</span></span></span><br><span class="line"><span class="keyword">optional</span> <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">animationDidStop</span><span class="params">(<span class="number">_</span> anim: CAAnimation, finished flag: Bool)</span></span></span><br></pre></td></tr></table></figure><h4 id="setAnimationDidStopè‡ªå®šä¹‰å›è°ƒæ–¹æ³•"><a href="#setAnimationDidStopè‡ªå®šä¹‰å›è°ƒæ–¹æ³•" class="headerlink" title="setAnimationDidStopè‡ªå®šä¹‰å›è°ƒæ–¹æ³•"></a>setAnimationDidStopè‡ªå®šä¹‰å›è°ƒæ–¹æ³•</h4><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UIView.setAnimationDidStop(<span class="function"><span class="keyword">#</span><span class="title">selector</span><span class="params">(<span class="variable">self</span>.<span class="variable">animationEnd</span>)</span></span>)</span><br><span class="line">    </span><br><span class="line">@objc func animationEnd() &#123;</span><br><span class="line">//...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆçº§åŠ¨ç”»åˆé›†-å®æˆ˜"><a href="#åˆçº§åŠ¨ç”»åˆé›†-å®æˆ˜" class="headerlink" title="åˆçº§åŠ¨ç”»åˆé›† - å®æˆ˜"></a>åˆçº§åŠ¨ç”»åˆé›† - å®æˆ˜</h2><p>è¿™éƒ¨åˆ†å†…å®¹æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œä¸»è¦åšä»‹ç»ï¼Œæœ€åæä¾›ä¸€ä¸ªç®€å•çš„ç»„åˆåŠ¨ç”»å±•ç¤ºä¸€ä¸‹ï¼ˆæ•ˆæœå¦‚ä¸‹ï¼‰ï¼š</p><p><img src="https://upload-images.jianshu.io/upload_images/1276164-0c4889a49d547139.gif?imageMogr2/auto-orient/strip" alt="ç»„åˆåŠ¨ç”»ç¤ºä¾‹.gif"></p><p>å¼€å§‹å‰ï¼Œå®šä¹‰å…¨å±€å¸¸é‡:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let kScreenW = UIScreen<span class="selector-class">.main</span><span class="selector-class">.bounds</span><span class="selector-class">.size</span><span class="selector-class">.width</span> <span class="comment">//å±å¹•å®½</span></span><br><span class="line">let kScreenH = UIScreen<span class="selector-class">.main</span><span class="selector-class">.bounds</span><span class="selector-class">.size</span><span class="selector-class">.height</span><span class="comment">//å±å¹•é«˜</span></span><br></pre></td></tr></table></figure><h3 id="ä½ç½®åŠ¨ç”»"><a href="#ä½ç½®åŠ¨ç”»" class="headerlink" title="ä½ç½®åŠ¨ç”»"></a>ä½ç½®åŠ¨ç”»</h3><p>åœºæ™¯ï¼šç•Œé¢ä¸Šæœ‰ä¸€ä¸ªæŒ‰é’®ï¼Œé¡µé¢åŠ è½½å®Œæˆæ—¶æŒ‰é’®ä»åº•éƒ¨å¼¹å‡ºã€‚é¦–å…ˆ<code>viewDidLoad()</code>é‡Œé¢åˆå§‹åŒ–ä¸€ä¸ª<code>button</code>,ç„¶ååœ¨<code>viewDidAppear()</code>æ–¹æ³•é‡Œä½¿ç”¨é—­åŒ…å½¢å¼æ”¹å˜<code>button</code>çš„<code>frame</code>å’Œ<code>center</code>ä¸¤ç§æ–¹å¼å®ç°è¿™ä¸ªæ•ˆæœã€‚</p><blockquote><p>viewDidAppear() è¡¨æ˜æ‰€æœ‰çš„è§†å›¾å·²ç»å¯è§</p></blockquote><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">var loginBT:UIButton?</span><br><span class="line">    </span><br><span class="line">override func viewDidLoad() &#123;</span><br><span class="line">   <span class="attribute">super.viewDidLoad()</span></span><br><span class="line"><span class="attribute">   </span></span><br><span class="line"><span class="attribute">   // Do any additional setup after loading the view.</span></span><br><span class="line"><span class="attribute">   </span></span><br><span class="line"><span class="attribute">   self.view.backgroundColor = UIColor.white</span></span><br><span class="line"><span class="attribute">   </span></span><br><span class="line"><span class="attribute">   loginBT = UIButton.init(frame</span>: CGRect(x: 20, y: kScreenH, width: self<span class="variable">.view</span><span class="variable">.bounds</span><span class="variable">.width-</span>40</span><br><span class="line">       , height: 50))</span><br><span class="line">   loginBT?<span class="variable">.backgroundColor</span> = UIColor(red: 50/255.0, green: 185/255.0, blue: 170/255.0, alpha: 1.0)</span><br><span class="line">   loginBT?<span class="variable">.setTitle</span>("ç™»å½•", for: <span class="variable">.normal</span>)</span><br><span class="line">   self<span class="variable">.view</span><span class="variable">.addSubview</span>(loginBT!)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">override func viewDidAppear(_ animated: Bool) &#123;</span><br><span class="line">   super<span class="variable">.viewDidAppear</span>(animated)</span><br><span class="line">   </span><br><span class="line">   //1. æ”¹å˜frameçš„å½¢å¼</span><br><span class="line">   UIView<span class="variable">.animate</span>(withDuration: 0.5) &#123;</span><br><span class="line">       self<span class="variable">.loginBT</span>?<span class="variable">.frame</span> = CGRect(x: self<span class="variable">.loginBT</span>!<span class="variable">.frame</span><span class="variable">.origin</span><span class="variable">.x</span>, y: kScreenH - 200, width: self<span class="variable">.loginBT</span>!<span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.width</span>, height: self<span class="variable">.loginBT</span>!<span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.height</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   //2. æ”¹å˜centerçš„å½¢å¼</span><br><span class="line">UIView<span class="variable">.animate</span>(withDuration: 0.5) &#123;</span><br><span class="line">   self<span class="variable">.loginBT</span>?<span class="variable">.center</span> = CGPoint(x: kScreenW/2.0, y: kScreenH/2.0)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‡ ä½•å½¢çŠ¶åŠ¨ç”»"><a href="#å‡ ä½•å½¢çŠ¶åŠ¨ç”»" class="headerlink" title="å‡ ä½•å½¢çŠ¶åŠ¨ç”»"></a>å‡ ä½•å½¢çŠ¶åŠ¨ç”»</h3><p>è®¾ç½®å±æ€§<code>bounds</code> æˆ–<code>transform(scaleX:)</code></p><h3 id="ä½ç½®-å½¢çŠ¶åŠ¨ç”»"><a href="#ä½ç½®-å½¢çŠ¶åŠ¨ç”»" class="headerlink" title="ä½ç½® + å½¢çŠ¶åŠ¨ç”»"></a>ä½ç½® + å½¢çŠ¶åŠ¨ç”»</h3><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func animateFrame() &#123;</span><br><span class="line">   <span class="attribute">UIView.animate(withDuration</span>: 0.5) &#123;</span><br><span class="line">       self<span class="variable">.loginBT</span>?<span class="variable">.frame</span> = CGRect(x: 50, y:  400, width: self<span class="variable">.loginBT</span>!<span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.width</span>*0.7, height: self<span class="variable">.loginBT</span>!<span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.height</span>*1.2)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ·¡å…¥æ·¡å‡ºåŠ¨ç”»"><a href="#æ·¡å…¥æ·¡å‡ºåŠ¨ç”»" class="headerlink" title="æ·¡å…¥æ·¡å‡ºåŠ¨ç”»"></a>æ·¡å…¥æ·¡å‡ºåŠ¨ç”»</h3><p>è®¾ç½®<code>alpha</code>é€æ˜åº¦å®ç°è¿™ä¸€æ•ˆæœï¼šåˆå§‹æ—¶é€æ˜åº¦è®¾ç½®ä¸º0ï¼Œå³éšè—çŠ¶æ€ï¼Œåœ¨åŠ¨ç”»æ‰§è¡Œæ•ˆæœä¸­å°†é€æ˜åº¦è®¾ç½®ä¸º1.0</p><h3 id="é¢œè‰²æ¸å˜åŠ¨ç”»"><a href="#é¢œè‰²æ¸å˜åŠ¨ç”»" class="headerlink" title="é¢œè‰²æ¸å˜åŠ¨ç”»"></a>é¢œè‰²æ¸å˜åŠ¨ç”»</h3><p>è®¾ç½®<code>backgroundColor</code>å®ç°è¿™ä¸€æ•ˆæœï¼šåœ¨åŠ¨ç”»æ‰§è¡Œæ•ˆæœä¸­æ”¹å˜é¢œè‰²å€¼</p><h3 id="ç¼©æ”¾åŠ¨ç”»"><a href="#ç¼©æ”¾åŠ¨ç”»" class="headerlink" title="ç¼©æ”¾åŠ¨ç”»"></a>ç¼©æ”¾åŠ¨ç”»</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func transformScale() &#123;</span><br><span class="line">   <span class="built_in">UIView</span>.beginAnimations(<span class="literal">nil</span>, context: <span class="literal">nil</span>)</span><br><span class="line">   <span class="built_in">UIView</span>.setAnimationDuration(<span class="number">1.0</span>)</span><br><span class="line">   <span class="keyword">self</span>.loginBT?.transform = <span class="built_in">CGAffineTransform</span>(scaleX: <span class="number">0.7</span>, y: <span class="number">1.2</span>)</span><br><span class="line">   <span class="built_in">UIView</span>.commitAnimations()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ—‹è½¬åŠ¨ç”»"><a href="#æ—‹è½¬åŠ¨ç”»" class="headerlink" title="æ—‹è½¬åŠ¨ç”»"></a>æ—‹è½¬åŠ¨ç”»</h3><p>swiftä¸­<code>pi</code>è¡¨ç¤ºä¸€ä¸ªåœ†360Â°ï¼Œ<code>.pi/4</code>å°±æ˜¯æ—‹è½¬90Â°</p><blockquote><p>public static var pi: CGFloat { get }</p></blockquote><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func transformAngle() &#123;</span><br><span class="line"></span><br><span class="line">   <span class="attribute">UIView.animate(withDuration</span>: 1) &#123;</span><br><span class="line">       </span><br><span class="line">       self<span class="variable">.loginBT</span>?<span class="variable">.transform</span> = CGAffineTransform(rotationAngle: <span class="variable">.pi</span>/4)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½ç§»åŠ¨ç”»"><a href="#ä½ç§»åŠ¨ç”»" class="headerlink" title="ä½ç§»åŠ¨ç”»"></a>ä½ç§»åŠ¨ç”»</h3><p>è®¾ç½®å½“å‰viewç›¸å¯¹äº<code>X,Y</code>è½´åç§»äº†å¤šå°‘ã€‚å¦‚ <code>CGAffineTransform(translationX: 0, y: -200)</code>ï¼ŒXè½´æ–¹å‘æ²¡æœ‰åç§»ï¼ŒYè½´æ–¹å‘å‘ä¸Šåç§»äº†200</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transformXY</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="type">UIView</span>.animate(withDuration: <span class="number">1</span>) &#123;</span><br><span class="line">       <span class="keyword">self</span>.loginBT?.transform = <span class="type">CGAffineTransform</span>(translationX: <span class="number">0</span>, y: -<span class="number">200</span>)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»„åˆåŠ¨ç”»"><a href="#ç»„åˆåŠ¨ç”»" class="headerlink" title="ç»„åˆåŠ¨ç”»"></a>ç»„åˆåŠ¨ç”»</h3><p>æƒ³è®©è¿™ä¸ªviewé£åˆ°å±å¹•å¤–é¢å»ï¼Œåœ¨é£è¡Œè¿‡ç¨‹ä¸­æ—‹è½¬å®ƒï¼Œæ”¹å˜å®ƒçš„å¤§å°å’Œé€æ˜åº¦</p><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func groupAnimation() &#123;</span><br><span class="line">   </span><br><span class="line">   <span class="attribute">UIView.animate(withDuration</span>: 1) &#123;</span><br><span class="line">       self<span class="variable">.loginBT</span>?<span class="variable">.frame</span> = CGRect(x: kScreenW, y: 0, width: self<span class="variable">.loginBT</span>!<span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.width</span>*0.1, height: self<span class="variable">.loginBT</span>!<span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.height</span>*0.1)</span><br><span class="line">       self<span class="variable">.loginBT</span>?<span class="variable">.transform</span> = CGAffineTransform(rotationAngle: <span class="variable">.pi</span>)</span><br><span class="line">       self<span class="variable">.loginBT</span>?<span class="variable">.alpha</span> = 0</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…³é”®å¸§åŠ¨ç”»"><a href="#å…³é”®å¸§åŠ¨ç”»" class="headerlink" title="å…³é”®å¸§åŠ¨ç”»"></a>å…³é”®å¸§åŠ¨ç”»</h2><p><code>UIView</code>åˆçº§åŠ¨ç”»ä¸­éƒ½æ˜¯é€šè¿‡ä¿®æ”¹å½“å‰UIæ§ä»¶çš„å„ç§å±æ€§æ¥å®ç°æƒ³è¦çš„åŠ¨ç”»æ•ˆæœï¼Œè€Œå…³é”®å¸§åŠ¨ç”»åªéœ€è¦è®¾ç½®åŠ¨ç”»çš„å‡ ä¸ªå…³é”®çš„æ˜¾ç¤ºå¸§ã€‚</p><h3 id="å…³é”®æ–¹æ³•"><a href="#å…³é”®æ–¹æ³•" class="headerlink" title="å…³é”®æ–¹æ³•"></a>å…³é”®æ–¹æ³•</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@available</span>(iOS <span class="number">7.0</span>, *)</span><br><span class="line">    open class func animateKeyframes(withDuration <span class="attribute">duration</span>: TimeInterval, <span class="attribute">delay</span>: TimeInterval, <span class="attribute">options</span>: UIView.KeyframeAnimationOptions = [], <span class="attribute">animations</span>: <span class="variable">@escaping</span> () -&gt; Void, <span class="attribute">completion</span>: ((Bool) -&gt; Void)? = nil)</span><br><span class="line"></span><br><span class="line">duration<span class="comment">// åŠ¨ç”»æ‰§è¡Œå‘¨æœŸ</span></span><br><span class="line">delay<span class="comment">// åŠ¨ç”»å»¶è¿Ÿæ‰§è¡Œæ—¶é—´</span></span><br><span class="line">options<span class="comment">// åŠ¨ç”»æ‰§è¡Œæ•ˆæœ</span></span><br><span class="line">animations<span class="comment">// å…³é”®å¸§æ·»åŠ å¤„</span></span><br><span class="line">completion<span class="comment">// åŠ¨ç”»å®Œæˆå›è°ƒ</span></span><br></pre></td></tr></table></figure><h3 id="å®ç°å®ä¾‹ï¼šå°é£æœºé™è½"><a href="#å®ç°å®ä¾‹ï¼šå°é£æœºé™è½" class="headerlink" title="å®ç°å®ä¾‹ï¼šå°é£æœºé™è½"></a>å®ç°å®ä¾‹ï¼šå°é£æœºé™è½</h3><p>1ã€æ·»åŠ ä¸€å¼ é£æœºåœºèƒŒæ™¯å›¾ï¼Œæ·»åŠ ä¸€å¼ å°é£æœºå›¾<br>2ã€ä¸ºå°é£æœºæ·»åŠ å…³é”®å¸§åŠ¨ç”»</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">func addKeyframes() &#123;</span><br><span class="line">   </span><br><span class="line">   UIView.animateKeyframes(<span class="string">withDuration:</span> <span class="number">2</span>, <span class="string">delay:</span> <span class="number">0</span>, <span class="string">options:</span> .calculationModeCubic, <span class="string">animations:</span> &#123;</span><br><span class="line">       </span><br><span class="line">       UIView.addKeyframe(<span class="string">withRelativeStartTime:</span> <span class="number">0</span>, <span class="string">relativeDuration:</span> <span class="number">1</span>/<span class="number">2</span>, <span class="string">animations:</span> &#123;</span><br><span class="line">           </span><br><span class="line">           self.imageViewPlane.frame = CGRect(<span class="string">x:</span> kScreenW<span class="number">-50</span>, <span class="string">y:</span> <span class="number">300</span>, <span class="string">width:</span> <span class="number">30</span>, <span class="string">height:</span> <span class="number">30</span>)</span><br><span class="line">       &#125;)</span><br><span class="line">       </span><br><span class="line">       UIView.addKeyframe(<span class="string">withRelativeStartTime:</span> <span class="number">1</span><span class="regexp">/2, relativeDuration: 1/</span><span class="number">2</span>, <span class="string">animations:</span> &#123;</span><br><span class="line">           self.imageViewPlane.frame = CGRect(<span class="string">x:</span> kScreenW<span class="number">-100</span>, <span class="string">y:</span> <span class="number">300</span>, <span class="string">width:</span> <span class="number">100</span>, <span class="string">height:</span> <span class="number">100</span>)</span><br><span class="line">       &#125;)</span><br><span class="line">       </span><br><span class="line">   &#125;) &#123; (finish) <span class="keyword">in</span></span><br><span class="line">       </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¸¸è§çš„æ•ˆæœæœ‰ä¸‹é¢å‡ ç±»ï¼š"><a href="#å¸¸è§çš„æ•ˆæœæœ‰ä¸‹é¢å‡ ç±»ï¼š" class="headerlink" title="å¸¸è§çš„æ•ˆæœæœ‰ä¸‹é¢å‡ ç±»ï¼š"></a>å¸¸è§çš„æ•ˆæœæœ‰ä¸‹é¢å‡ ç±»ï¼š</h3><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿ç®—æ¨¡å¼ï¼šè¿ç»­</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> calculationModeLinear: UIView.KeyframeAnimationOptions &#123; <span class="keyword">get</span> &#125; <span class="comment">// default</span></span><br><span class="line"><span class="comment">// è¿ç®—æ¨¡å¼ï¼šç¦»æ•£</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> calculationModeDiscrete: UIView.KeyframeAnimationOptions &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"><span class="comment">// è¿ç®—æ¨¡å¼ï¼šå‡åŒ€æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> calculationModePaced: UIView.KeyframeAnimationOptions &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"><span class="comment">// è¿ç®—æ¨¡å¼ï¼šå¹³æ»‘</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> calculationModeCubic: UIView.KeyframeAnimationOptions &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"><span class="comment">// è¿ç®—æ¨¡å¼ï¼šå¹³æ»‘å‡åŒ€</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> calculationModeCubicPaced: UIView.KeyframeAnimationOptions &#123; <span class="keyword">get</span> &#125;</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ å…³é”®å¸§æ–¹æ³•ï¼šaddKeyframe"><a href="#æ·»åŠ å…³é”®å¸§æ–¹æ³•ï¼šaddKeyframe" class="headerlink" title="æ·»åŠ å…³é”®å¸§æ–¹æ³•ï¼šaddKeyframe()"></a>æ·»åŠ å…³é”®å¸§æ–¹æ³•ï¼šaddKeyframe()</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@available</span>(iOS <span class="number">7.0</span>, *)</span><br><span class="line">open class func addKeyframe(withRelativeStartTime <span class="attribute">frameStartTime</span>: Double, relativeDuration <span class="attribute">frameDuration</span>: Double, <span class="attribute">animations</span>: <span class="variable">@escaping</span> () -&gt; Void)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•æè¿°äº†åœ¨ä»€ä¹ˆä½ç½®æ·»åŠ ä¸€ä¸ªæŒç»­æ—¶é—´å¤šé•¿çš„å…³é”®å¸§ã€‚æ”¹æ–¹æ³•çš„å‡ ä¸ªå‚æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">withRelativeStartTime<span class="comment">// å…³é”®å¸§èµ·å§‹æ—¶é—´</span></span><br><span class="line">relativeDuration        <span class="comment">// å…³é”®å¸§ç›¸å¯¹æŒç»­æ—¶é—´</span></span><br><span class="line">animations              <span class="comment">// å…³é”®å¸§å…·ä½“å®ç°å†…å®¹</span></span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ï¼š<br><img src="https://upload-images.jianshu.io/upload_images/1276164-e136547f3d7bb6c1.gif?imageMogr2/auto-orient/strip" alt="å…³é”®å¸§åŠ¨ç”»ç¤ºä¾‹.gif"></p><h2 id="é€å¸§åŠ¨ç”»"><a href="#é€å¸§åŠ¨ç”»" class="headerlink" title="é€å¸§åŠ¨ç”»"></a>é€å¸§åŠ¨ç”»</h2><p>é€å¸§åŠ¨ç”»å®ç°çš„åŠ¨ç”»æ•ˆæœå°±æ˜¯å°†å›¾ç‰‡ä¸€å¸§å¸§çš„é€å¸§æ¸²æŸ“ã€‚è¿™é‡Œå‡†å¤‡äº†é£æœºé£è¡Œè¿‡ç¨‹ä¸­67å¼ é™æ€å›¾ç‰‡ã€‚</p><h3 id="åŸºäºNSTimerçš„é€å¸§åŠ¨ç”»æ•ˆæœ"><a href="#åŸºäºNSTimerçš„é€å¸§åŠ¨ç”»æ•ˆæœ" class="headerlink" title="åŸºäºNSTimerçš„é€å¸§åŠ¨ç”»æ•ˆæœ"></a>åŸºäºNSTimerçš„é€å¸§åŠ¨ç”»æ•ˆæœ</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZhuZhenVC</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> imageView:<span class="type">UIImageView</span>?</span><br><span class="line">    <span class="keyword">var</span> timer:<span class="type">Timer</span>?</span><br><span class="line">    <span class="keyword">var</span> index = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        imageView = <span class="type">UIImageView</span>(frame: <span class="type">UIScreen</span>.main.bounds)</span><br><span class="line">        imageView?.contentMode = <span class="type">UIView</span>.<span class="type">ContentMode</span>.scaleAspectFit</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">self</span>.view.addSubview(<span class="keyword">self</span>.imageView!)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillAppear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewWillAppear(animated)</span><br><span class="line">        </span><br><span class="line">       timer = <span class="type">Timer</span>.scheduledTimer(timeInterval: <span class="number">0.1</span>, target: <span class="keyword">self</span>, selector: #selector(<span class="keyword">self</span>.refushImage), userInfo: <span class="literal">nil</span>, repeats: <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidDisappear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidDisappear(animated)</span><br><span class="line">        timer?.invalidate()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">refushImage</span><span class="params">()</span></span> &#123;</span><br><span class="line">        imageView?.image = <span class="type">UIImage</span>(named: <span class="string">"<span class="subst">\(index)</span>.png"</span>)</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">67</span> &#123;</span><br><span class="line">            timer?.invalidate()</span><br><span class="line">            index = <span class="number">0</span></span><br><span class="line">            imageView?.image = <span class="type">UIImage</span>(named: <span class="string">"<span class="subst">\(index)</span>.png"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŸºäºCADisplayLinkçš„é€å¸§åŠ¨ç”»æ•ˆæœ"><a href="#åŸºäºCADisplayLinkçš„é€å¸§åŠ¨ç”»æ•ˆæœ" class="headerlink" title="åŸºäºCADisplayLinkçš„é€å¸§åŠ¨ç”»æ•ˆæœ"></a>åŸºäºCADisplayLinkçš„é€å¸§åŠ¨ç”»æ•ˆæœ</h3><p><strong>CADisplayLink å’Œ NSTimeræœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</strong><br><code>iOSè®¾å¤‡</code>çš„å±å¹•åˆ·æ–°é¢‘ç‡é»˜è®¤æ˜¯<code>60Hz</code>ï¼Œè€Œ<code>CADisplayLink</code>å¯ä»¥ä¿æŒå’Œå±å¹•åˆ·æ–°ç‡ç›¸åŒçš„é¢‘ç‡å°†å†…å®¹æ¸²æŸ“åˆ°å±å¹•ä¸Šï¼Œå› æ­¤å®ƒçš„ç²¾åº¦éå¸¸é«˜ã€‚<br><code>CADisplayLink</code>ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨å†Œåˆ° <code>runloop</code>ä¸­ï¼Œæ¯å½“åˆ·å¸§é¢‘ç‡åˆ°è¾¾çš„æ—¶å€™<code>runloop</code>å°±ä¼šå‘<code>CADisplayLink</code>æŒ‡å®šçš„<code>target</code>å‘é€ä¸€æ¬¡æŒ‡å®šçš„<code>selectoræ¶ˆæ¯</code>ï¼Œç›¸åº”çš„selectorä¸­çš„æ–¹æ³•ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> displayLink:<span class="type">CADisplayLink</span>?</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillAppear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</span><br><span class="line">   <span class="keyword">super</span>.viewWillAppear(animated)</span><br><span class="line">   </span><br><span class="line">   displayLink = <span class="type">CADisplayLink</span>(target: <span class="keyword">self</span>, selector: #selector(refushImage))</span><br><span class="line">   displayLink?.preferredFramesPerSecond = <span class="number">1</span></span><br><span class="line">   displayLink?.add(to: <span class="type">RunLoop</span>.current, forMode: .<span class="keyword">default</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹<br><img src="https://upload-images.jianshu.io/upload_images/1276164-2ed58af9f2e9bd73.gif?imageMogr2/auto-orient/strip" alt="104.gif"></p><h3 id="åŸºäºdrawæ–¹æ³•çš„é€å¸§åŠ¨ç”»æ•ˆæœ"><a href="#åŸºäºdrawæ–¹æ³•çš„é€å¸§åŠ¨ç”»æ•ˆæœ" class="headerlink" title="åŸºäºdrawæ–¹æ³•çš„é€å¸§åŠ¨ç”»æ•ˆæœ"></a>åŸºäºdrawæ–¹æ³•çš„é€å¸§åŠ¨ç”»æ•ˆæœ</h3><p>å½“åˆ›å»ºä¸€ä¸ªæ–°çš„viewæ—¶ï¼Œå…¶è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª<code>draw()</code>æ–¹æ³•ï¼Œä¸”æ­¤æ–¹æ³•å¯ä»¥è¢«<code>é‡å†™</code>ï¼Œä¸€æ—¦<code>draw()</code>è¢«è°ƒç”¨ï¼ŒCocoaå°±ä¼šä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>å›¾å½¢ä¸Šä¸‹æ–‡</code>ï¼Œåœ¨å›¾å½¢ä¸Šä¸‹æ–‡çš„æ‰€æœ‰æ“ä½œæœ€ç»ˆéƒ½ä¼šåæ˜ åœ¨å½“å‰çš„<code>UIView</code>ç•Œé¢ä¸Šã€‚æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œå¦‚æœå®šæœŸè°ƒç”¨<code>draw()</code>æ–¹æ³•ç»˜åˆ¶æ–°çš„å†…å®¹ï¼Œå°±å¯ä»¥å®ç°é€å¸§åŠ¨ç”»æ•ˆæœã€‚</p><blockquote><p>æ€»ç»“<code>draw()</code>è§¦å‘çš„æœºåˆ¶ï¼š<br>(1)ä½¿ç”¨<code>addSubview</code>ä¼šè§¦å‘<code>layoutSubviews</code><br>(2)ä½¿ç”¨<code>view</code>çš„<code>frame</code>å±æ€§ä¼šè§¦å‘<code>layoutSubviewsï¼ˆframeæ›´æ–°ï¼‰</code><br>(3)ç›´æ¥è°ƒç”¨<code>layoutSubviews</code>æ–¹æ³•ä¼šè§¦å‘<code>layoutSubviews</code></p></blockquote><p>æ–°å»ºä¸€ä¸ªUIviewç±»ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackHoleView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> blackHoleRadius:<span class="type">Float</span> = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">blackHoleIncrease</span><span class="params">(<span class="number">_</span> radius:Float)</span></span> &#123;</span><br><span class="line">        blackHoleRadius = radius</span><br><span class="line">        <span class="comment">// è°ƒç”¨setNeedsDisplay()æ–¹æ³•å®ç°draw()æ–¹æ³•çš„è°ƒç”¨</span></span><br><span class="line">        <span class="keyword">self</span>.setNeedsDisplay()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">draw</span><span class="params">(<span class="number">_</span> rect: CGRect)</span></span> &#123;</span><br><span class="line">        <span class="comment">// Drawing code</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> ctx = <span class="type">UIGraphicsGetCurrentContext</span>()!</span><br><span class="line">        ctx.addArc(center: <span class="type">CGPoint</span>(x: <span class="keyword">self</span>.center.x, y: <span class="keyword">self</span>.center.y),</span><br><span class="line">                   radius: <span class="type">CGFloat</span>(blackHoleRadius),</span><br><span class="line">                   startAngle: <span class="number">0</span>,</span><br><span class="line">                   endAngle: .pi*<span class="number">2</span>,</span><br><span class="line">                   clockwise: <span class="literal">false</span>)</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         public func addArc(center: CGPoint,    // å½“å‰ç»˜åˆ¶åœ†å½¢ä¸­å¿ƒç‚¹çš„x,yåæ ‡</span></span><br><span class="line"><span class="comment">                            radius: CGFloat,    // å½“å‰ç»˜åˆ¶åœ†å½¢åŠå¾„</span></span><br><span class="line"><span class="comment">                            startAngle: CGFloat,// å½“å‰ç»˜åˆ¶åœ†å½¢å¼€å§‹è§’åº¦</span></span><br><span class="line"><span class="comment">                            endAngle: CGFloat,  // ç»“æŸè§’åº¦</span></span><br><span class="line"><span class="comment">                            clockwise: Bool)    // trueé¡ºæ—¶é’ˆç»˜åˆ¶ falseé€†æ—¶é’ˆç»˜åˆ¶</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        ctx.fillPath()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨viewControlleré‡Œé¢çš„å®ç°ä»£ç ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> index = <span class="number">0</span>    </span><br><span class="line"><span class="keyword">var</span> blackHole:<span class="type">BlackHoleView</span>?</span><br><span class="line">    </span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">   </span><br><span class="line">   blackHole = <span class="type">BlackHoleView</span>()</span><br><span class="line">   blackHole?.frame = <span class="type">UIScreen</span>.main.bounds</span><br><span class="line">   blackHole?.backgroundColor = <span class="type">UIColor</span>.cyan</span><br><span class="line">   <span class="keyword">self</span>.view.addSubview(blackHole!)</span><br><span class="line">   timer = <span class="type">Timer</span>.scheduledTimer(timeInterval: <span class="number">1.0</span>/<span class="number">10</span>, target: <span class="keyword">self</span>, selector: #selector(<span class="keyword">self</span>.refushImage), userInfo:<span class="literal">nil</span>, repeats: <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">refushImage</span><span class="params">()</span></span> &#123;</span><br><span class="line">   blackHole?.blackHoleIncrease(<span class="type">Float</span>(index))</span><br><span class="line">   index += <span class="number">1</span></span><br><span class="line">   </span><br><span class="line">   <span class="keyword">if</span> index == <span class="number">30</span> &#123;</span><br><span class="line">       index = <span class="number">0</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ï¼š<br><img src="https://upload-images.jianshu.io/upload_images/1276164-d8f4c23e7844cfa6.gif?imageMogr2/auto-orient/strip" alt="é‡å†™draw()æ–¹æ³•çš„é€å¸§åŠ¨ç”»ç¤ºä¾‹.gif"></p><h2 id="GIFåŠ¨ç”»æ•ˆæœ"><a href="#GIFåŠ¨ç”»æ•ˆæœ" class="headerlink" title="GIFåŠ¨ç”»æ•ˆæœ"></a>GIFåŠ¨ç”»æ•ˆæœ</h2><blockquote><p>GIF åœ¨iOSä¸­çš„ä½¿ç”¨åœºæ™¯æœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢<br>(1)GIFå›¾ç‰‡åˆ†è§£ä¸ºå•å¸§å›¾ç‰‡<br>(2)ä¸€ç³»åˆ—å•å¸§å›¾ç‰‡åˆæˆGIFå›¾ç‰‡<br>(3)iOSç³»ç»Ÿä¸Šå±•ç¤ºGIFåŠ¨ç”»æ•ˆæœ</p></blockquote><h3 id="1-GIFå›¾ç‰‡åˆ†è§£ä¸ºå•å¸§å›¾ç‰‡"><a href="#1-GIFå›¾ç‰‡åˆ†è§£ä¸ºå•å¸§å›¾ç‰‡" class="headerlink" title="(1)GIFå›¾ç‰‡åˆ†è§£ä¸ºå•å¸§å›¾ç‰‡"></a>(1)GIFå›¾ç‰‡åˆ†è§£ä¸ºå•å¸§å›¾ç‰‡</h3><p><code>#å…³é”®è¿‡ç¨‹   GIF - NSData - ImageIO - UIImage - Jpg/Png</code></p><p><strong>æ•´ä¸ªè¿‡ç¨‹åˆ’åˆ†ä¸º5ä¸ªæ¨¡å—ã€4ä¸ªè¿‡ç¨‹ï¼Œåˆ†åˆ«å¦‚ä¸‹</strong><br>(1)æœ¬åœ°è¯»å–<code>GIF</code>å›¾ç‰‡ï¼Œå°†å…¶è½¬æ¢ä¸º<code>NSData</code>æ•°æ®ç±»å‹<br>(2)å°†<code>NSData</code>ä½œä¸º<code>ImageIO</code>æ¨¡å—çš„è¾“å…¥<br>(3)è·å–<code>ImageIO</code>çš„è¾“å‡ºæ•°æ®ï¼š<code>UIImage</code><br>(4)å°†è·å–åˆ°çš„<code>UIImage</code>æ•°æ®å­˜å‚¨ä¸ºJPGæˆ–PNGæ ¼å¼ä¿å­˜åˆ°æœ¬åœ°</p><p>æ•´ä¸ªGIFå›¾ç‰‡åˆ†è§£çš„è¿‡ç¨‹ä¸­ï¼Œ<code>ImageIO</code>æ˜¯å¤„ç†è¿‡ç¨‹çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å®ƒè´Ÿè´£å¯¹GIFæ–‡ä»¶æ ¼å¼è¿›è¡Œåˆ†è§£ï¼Œå¹¶å°†è§£æä¹‹åçš„æ•°æ®è½¬æ¢ä¸ºä¸€å¸§å¸§å›¾ç‰‡è¾“å‡ºã€‚æˆ‘ä»¬ä¸å»æ·±ç©¶GIFåˆ†è§£åˆæˆç®—æ³•çš„å…·ä½“å®ç°ï¼ŒæŒæ¡å¦‚ä½•ä½¿ç”¨å®ƒå°±OKã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fenJieGIF</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="comment">// (1)æœ¬åœ°è¯»å–GIFå›¾ç‰‡ï¼Œå°†å…¶è½¬æ¢ä¸ºNSDataæ•°æ®ç±»å‹</span></span><br><span class="line">   <span class="keyword">let</span> gifPath = <span class="type">Bundle</span>.main.path(forResource: <span class="string">"plane"</span>, ofType: <span class="string">"gif"</span>)!</span><br><span class="line">   <span class="keyword">let</span> gifData = <span class="keyword">try</span>! <span class="type">Data</span>(contentsOf: <span class="type">URL</span>(fileURLWithPath: gifPath))</span><br><span class="line">   <span class="comment">// (2)å°†NSDataä½œä¸ºImageIOæ¨¡å—çš„è¾“å…¥,éå†æ‰€æœ‰GIFå­å¸§</span></span><br><span class="line">   <span class="keyword">let</span> gifDataSource:<span class="type">CGImageSource</span> = <span class="type">CGImageSourceCreateWithData</span>(gifData <span class="keyword">as</span> <span class="type">CFData</span>, <span class="literal">nil</span>)!</span><br><span class="line">   <span class="keyword">let</span> gifImageCount:<span class="type">Int</span> = <span class="type">CGImageSourceGetCount</span>(gifDataSource)</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>...gifImageCount-<span class="number">1</span> &#123;</span><br><span class="line">       <span class="comment">// CGImageSourceCreateImageAtIndex è¿”å›GIFä¸­æŸä¸€å¸§å›¾åƒçš„CGImageç±»å‹æ•°æ®</span></span><br><span class="line">       <span class="keyword">let</span> imageref = <span class="type">CGImageSourceCreateImageAtIndex</span>(gifDataSource, i, <span class="literal">nil</span>)</span><br><span class="line">       <span class="comment">// UIImage ç±»æ–¹æ³•ï¼Œå®ä¾‹åŒ–UIImageå®ä¾‹å¯¹è±¡</span></span><br><span class="line">       <span class="keyword">let</span> image = <span class="type">UIImage</span>(cgImage: imageref!, scale: <span class="type">UIScreen</span>.main.scale, orientation: <span class="type">UIImage</span>.<span class="type">Orientation</span>.up)</span><br><span class="line">       <span class="keyword">let</span> imageData:<span class="type">Data</span> = image.pngData()!</span><br><span class="line">       <span class="keyword">var</span> docs = <span class="type">NSSearchPathForDirectoriesInDomains</span>(.documentDirectory, .userDomainMask, <span class="literal">true</span>)</span><br><span class="line">       <span class="keyword">let</span> documentsDirectory = docs[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">String</span></span><br><span class="line">       <span class="keyword">let</span> imagePath = documentsDirectory + <span class="string">"/<span class="subst">\(i)</span>"</span> + <span class="string">".png"</span></span><br><span class="line">       <span class="keyword">try</span>? imageData.write(to: <span class="type">URL</span>(fileURLWithPath: imagePath), options: .atomic)</span><br><span class="line">       <span class="built_in">print</span>(<span class="string">"<span class="subst">\(imagePath)</span>"</span>)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆåˆ†è§£<code>.gif</code>å›¾ç‰‡çš„æ¯å¸§å›¾ç‰‡å¯æ ¹æ®æ‰“å°å‡ºçš„è·¯å¾„å»æŸ¥çœ‹ã€‚</p><h3 id="2-ä¸€ç³»åˆ—å•å¸§å›¾ç‰‡åˆæˆGIFå›¾ç‰‡"><a href="#2-ä¸€ç³»åˆ—å•å¸§å›¾ç‰‡åˆæˆGIFå›¾ç‰‡" class="headerlink" title="(2)ä¸€ç³»åˆ—å•å¸§å›¾ç‰‡åˆæˆGIFå›¾ç‰‡"></a>(2)ä¸€ç³»åˆ—å•å¸§å›¾ç‰‡åˆæˆGIFå›¾ç‰‡</h3><p><strong>GIFåˆæˆåˆ†ä¸‰éƒ¨åˆ†ï¼š</strong><br>(1)åŠ è½½å¾…å¤„ç†çš„åºåˆ—åŸå§‹æ•°æ®æº<br>(2)åœ¨<code>Document</code>ç›®å½•ä¸‹æ„å»º<code>GIFæ–‡ä»¶</code><br>(3)è®¾ç½®GIFæ–‡ä»¶å±æ€§ï¼Œåˆ©ç”¨<code>ImageIO</code>ç¼–ç <code>GIFæ–‡ä»¶</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">func heChengGIF() &#123;</span><br><span class="line">   <span class="comment">// Part1:è¯»å–67å¼ å›¾ç‰‡</span></span><br><span class="line">   <span class="keyword">let</span> images:NSMutableArray = NSMutableArray()</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0.</span>.<span class="number">.66</span> &#123;</span><br><span class="line">       <span class="keyword">let</span> imagePath = <span class="string">"\(i).png"</span></span><br><span class="line">       <span class="keyword">let</span> image:UIImage = UIImage(named: imagePath)!</span><br><span class="line">       images.add(image)</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// Part2:åœ¨Documentç›®å½•ä¸‹åˆ›å»ºgifæ–‡ä»¶</span></span><br><span class="line">   <span class="keyword">var</span> docs = NSSearchPathForDirectoriesInDomains(.documentDirectory, .userDomainMask, <span class="literal">true</span>)</span><br><span class="line">   <span class="keyword">let</span> documentsDirectory = docs[<span class="number">0</span>] <span class="keyword">as</span> <span class="built_in">String</span></span><br><span class="line">   <span class="keyword">let</span> gifPath = documentsDirectory + <span class="string">"/plane.gif"</span></span><br><span class="line">   print(gifPath)</span><br><span class="line">   <span class="comment">// æ–‡ä»¶è·¯å¾„ç”±stringç±»å‹è½¬æ¢ä¸ºURLç±»å‹</span></span><br><span class="line">   <span class="keyword">let</span> url = CFURLCreateWithFileSystemPath(kCFAllocatorDefault, gifPath <span class="keyword">as</span> CFString, CFURLPathStyle.cfurlposixPathStyle, <span class="literal">false</span>)</span><br><span class="line">   <span class="keyword">let</span> destion = CGImageDestinationCreateWithURL(url!, kUTTypeGIF, images.count, nil)</span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">    CGImageDestinationCreateWithURL()</span></span><br><span class="line"><span class="comment">    æ–¹æ³•çš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªå›¾ç‰‡çš„ç›®æ ‡å¯¹è±¡ï¼Œè¿™é‡Œæ–¹ä¾¿ç†è§£å¯ä»¥æŠŠå›¾ç‰‡ç›®æ ‡å¯¹è±¡æ¯”å–»ä¸ºä¸€ä¸ªé›†åˆä½“ï¼Œ</span></span><br><span class="line"><span class="comment">    é›†åˆä½“ä¸­æè¿°äº†å½“å‰å›¾ç‰‡ç›®æ ‡å¯¹è±¡çš„ä¸€ç³»åˆ—å‚æ•°ï¼Œå¦‚å›¾ç‰‡çš„URLåœ°å€ã€å›¾ç‰‡ç±»å‹ã€å›¾ç‰‡å¸§æ•°ã€é…ç½®å‚æ•°ç­‰</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">// Part3:è®¾ç½®gifå›¾ç‰‡å±æ€§ï¼Œåˆ©ç”¨67å¼ pngå›¾ç‰‡æ„å»ºgif</span></span><br><span class="line">   <span class="keyword">let</span> cgimagePropertiesDic = [kCGImagePropertyGIFDelayTime <span class="keyword">as</span> <span class="built_in">String</span>:<span class="number">0.1</span>]<span class="comment">//è®¾ç½®æ¯å¸§ä¹‹é—´æ’­æ”¾æ—¶é—´</span></span><br><span class="line">   <span class="keyword">let</span> cgimagePropertiesDestDic = [kCGImagePropertyGIFDictionary <span class="keyword">as</span> <span class="built_in">String</span>:cgimagePropertiesDic];</span><br><span class="line">   <span class="keyword">for</span> cgimage <span class="keyword">in</span> images&#123;</span><br><span class="line">       CGImageDestinationAddImage(destion!, (cgimage <span class="keyword">as</span> AnyObject).cgImage!!,cgimagePropertiesDestDic <span class="keyword">as</span> CFDictionary?);</span><br><span class="line">   &#125;<span class="comment">// ä¾æ¬¡ä¸ºgifå›¾åƒå¯¹è±¡æ·»åŠ æ¯ä¸€å¸§å…ƒç´ </span></span><br><span class="line">   </span><br><span class="line">   <span class="keyword">let</span> gifPropertiesDic:NSMutableDictionary = NSMutableDictionary()</span><br><span class="line">   gifPropertiesDic.setValue(kCGImagePropertyColorModelRGB, <span class="attr">forKey</span>: kCGImagePropertyColorModel <span class="keyword">as</span> <span class="built_in">String</span>)<span class="comment">// è®¾ç½®å›¾åƒçš„å½©è‰²ç©ºé—´æ ¼å¼</span></span><br><span class="line">   gifPropertiesDic.setValue(<span class="number">16</span>, <span class="attr">forKey</span>: kCGImagePropertyDepth <span class="keyword">as</span> <span class="built_in">String</span>)<span class="comment">// è®¾ç½®å›¾åƒçš„é¢œè‰²æ·±åº¦</span></span><br><span class="line">   gifPropertiesDic.setValue(<span class="number">1</span>, <span class="attr">forKey</span>: kCGImagePropertyGIFLoopCount <span class="keyword">as</span> <span class="built_in">String</span>)<span class="comment">// è®¾ç½®Gifæ‰§è¡Œæ¬¡æ•°</span></span><br><span class="line">   <span class="keyword">let</span> gifDictionaryDestDic = [kCGImagePropertyGIFDictionary <span class="keyword">as</span> <span class="built_in">String</span>:gifPropertiesDic]</span><br><span class="line">   CGImageDestinationSetProperties(destion!,gifDictionaryDestDic <span class="keyword">as</span> CFDictionary?);<span class="comment">//ä¸ºgifå›¾åƒè®¾ç½®å±æ€§</span></span><br><span class="line">   CGImageDestinationFinalize(destion!);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>CGImageDestinationCreateWithURL()</code></strong><br>æ–¹æ³•çš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªå›¾ç‰‡çš„ç›®æ ‡å¯¹è±¡ï¼Œè¿™é‡Œæ–¹ä¾¿ç†è§£å¯ä»¥æŠŠå›¾ç‰‡ç›®æ ‡å¯¹è±¡æ¯”å–»ä¸ºä¸€ä¸ªé›†åˆä½“ï¼Œ<br>é›†åˆä½“ä¸­æè¿°äº†å½“å‰å›¾ç‰‡ç›®æ ‡å¯¹è±¡çš„ä¸€ç³»åˆ—å‚æ•°ï¼Œå¦‚å›¾ç‰‡çš„URLåœ°å€ã€å›¾ç‰‡ç±»å‹ã€å›¾ç‰‡å¸§æ•°ã€é…ç½®å‚æ•°ç­‰ã€‚</p><p>æœ¬ç¤ºä¾‹ä¸­ï¼Œå°†plane.gifçš„æœ¬åœ°æ–‡ä»¶è·¯å¾„ä½œä¸ºå‚æ•°1ä¼ é€’ç»™è¿™ä¸ªå›¾ç‰‡ç›®æ ‡å¯¹è±¡ï¼Œå‚æ•°2æè¿°äº†å›¾ç‰‡ç±»å‹ä¸ºGIFå›¾ç‰‡ï¼ˆéœ€è¦å¼•å…¥æ¡†æ¶ <code>import MobileCoreServices</code>ï¼‰ï¼Œå‚æ•°3è¡¨æ˜å½“å‰GIFå›¾ç‰‡æ„æˆçš„å¸§æ•°ï¼Œå‚æ•°4æš‚æ—¶ç»™ç©ºå€¼ã€‚<br><img src="https://upload-images.jianshu.io/upload_images/1276164-cb52527b9e6f16c9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="CGImageDestination.png"></p><p>æœ€ç»ˆåˆæˆçš„<code>.gif</code>å›¾ç‰‡å¯æ ¹æ®æ‰“å°å‡ºçš„è·¯å¾„å»æŸ¥çœ‹ã€‚</p><h3 id="3-iOSç³»ç»Ÿä¸Šå±•ç¤ºGIFåŠ¨ç”»æ•ˆæœ"><a href="#3-iOSç³»ç»Ÿä¸Šå±•ç¤ºGIFåŠ¨ç”»æ•ˆæœ" class="headerlink" title="(3)iOSç³»ç»Ÿä¸Šå±•ç¤ºGIFåŠ¨ç”»æ•ˆæœ"></a>(3)iOSç³»ç»Ÿä¸Šå±•ç¤ºGIFåŠ¨ç”»æ•ˆæœ</h3><p>iOSåŸç”Ÿä¸æ”¯æŒç›´æ¥æ˜¾ç¤ºGIFå›¾ç‰‡ï¼Œæ•…ï¼š<br>(1)å…ˆåˆ†è§£GIFå›¾ç‰‡ä¸ºå•å¸§å›¾ç‰‡<br>(2)å†å±•ç¤ºå¤šå¸§å›¾ç‰‡</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">func zhanShiGIF() &#123;</span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">    iOSåŸç”Ÿä¸æ”¯æŒç›´æ¥æ˜¾ç¤ºGIFå›¾ç‰‡ï¼Œæ•…ï¼š</span></span><br><span class="line"><span class="comment">    (1)å…ˆåˆ†è§£GIFå›¾ç‰‡ä¸ºå•å¸§å›¾ç‰‡</span></span><br><span class="line"><span class="comment">    (2)å†å±•ç¤ºå¤šå¸§å›¾ç‰‡</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   </span><br><span class="line">   <span class="selector-tag">var</span> images:[UIImage] = []</span><br><span class="line">   <span class="keyword">for</span> <span class="selector-tag">i</span> <span class="keyword">in</span> <span class="number">0</span>...<span class="number">66</span> &#123;</span><br><span class="line">       let imagePath = <span class="string">"\(i).png"</span></span><br><span class="line">       let image:UIImage = UIImage(named: imagePath)!</span><br><span class="line">       images.append(image)</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   let imageView = UIImageView(frame: self<span class="selector-class">.view</span><span class="selector-class">.bounds</span>)</span><br><span class="line">   imageView<span class="selector-class">.contentMode</span> = UIView<span class="selector-class">.ContentMode</span><span class="selector-class">.center</span></span><br><span class="line">   self<span class="selector-class">.view</span><span class="selector-class">.addSubview</span>(imageView)</span><br><span class="line">   imageView<span class="selector-class">.animationImages</span> = images</span><br><span class="line">   imageView<span class="selector-class">.animationDuration</span> = <span class="number">5</span></span><br><span class="line">   imageView<span class="selector-class">.animationRepeatCount</span> = <span class="number">1</span></span><br><span class="line">   imageView.startAnimating()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å¦‚æœæ‚¨æœ‰å…´è¶£çš„è¯<br>ä¸Šä¸€èŠ‚<a href="https://www.jianshu.com/p/bc6e3e175a37" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å‰åº</a><br>ä¸‹ä¸€èŠ‚<a href="https://www.jianshu.com/p/3b469f7ba311" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å†…å®¹å±‚åŠ¨ç”»</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-b94babab7532c2f9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·æ˜¾ç¤ºå±‚åŠ¨ç”».jpg&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOSåŠ¨ç”»" scheme="http://yoursite.com/tags/iOS%E5%8A%A8%E7%94%BB/"/>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://yoursite.com/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å‰åº</title>
    <link href="http://yoursite.com/2019/02/14/%E3%80%8AiOS%E5%8A%A8%E7%94%BB%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%C2%B7%E5%89%8D%E5%BA%8F/"/>
    <id>http://yoursite.com/2019/02/14/ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å‰åº/</id>
    <published>2019-02-14T14:46:40.000Z</published>
    <updated>2019-03-25T03:20:18.369Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://upload-images.jianshu.io/upload_images/1276164-e5bf0966eb9a011c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å‰åº.jpg"></p><a id="more"></a><p><a href="https://www.jianshu.com/p/bc6e3e175a37" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å‰åº</a><br><a href="https://www.jianshu.com/p/4e95c596dfa9" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·æ˜¾ç¤ºå±‚åŠ¨ç”»</a><br><a href="https://www.jianshu.com/p/3b469f7ba311" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å†…å®¹å±‚åŠ¨ç”»</a><br><a href="https://www.jianshu.com/p/0c5be91642cd" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·è½¬åœºåŠ¨ç”»</a></p><h3 id="iOSæ ¸å¿ƒåŠ¨ç”»ï¼ˆswiftï¼‰å‰åº"><a href="#iOSæ ¸å¿ƒåŠ¨ç”»ï¼ˆswiftï¼‰å‰åº" class="headerlink" title="iOSæ ¸å¿ƒåŠ¨ç”»ï¼ˆswiftï¼‰å‰åº"></a>iOSæ ¸å¿ƒåŠ¨ç”»ï¼ˆswiftï¼‰å‰åº</h3><p>ä¸€æ¬¾èµå¿ƒæ‚¦ç›®çš„APPç¡®å®èƒ½å¤Ÿè®©ä½¿ç”¨è€…æ›´åŠ å–œæ¬¢ï¼Œåˆç†çš„åˆ©ç”¨åŠ¨ç”»èƒ½åšåˆ°å‡ºå…¶ä¸æ„çš„æ•ˆæœã€‚æƒ³ç³»ç»Ÿçš„å­¦ä¹ ä¸€ä¸‹iOSåŠ¨ç”»ï¼Œæœ¬ç³»åˆ—çš„å†…å®¹éƒ½æ€»ç»“äºã€ŠiOSåŠ¨ç”»ã€‹è¿™æœ¬ä¹¦ï¼Œæœ¬ä¹¦æ˜¯åŸºäºswift 3.0çš„ã€‚æˆ‘çš„å®é™…ç¯å¢ƒæ˜¯<code>Xcode 10.0 swift 4.2</code></p><h3 id="å¼€å§‹çš„ç®€ä»‹"><a href="#å¼€å§‹çš„ç®€ä»‹" class="headerlink" title="å¼€å§‹çš„ç®€ä»‹"></a>å¼€å§‹çš„ç®€ä»‹</h3><p>æœ¬æ¬¡å†…å®¹ä¸»è¦åˆ†å››å¤§æ¨¡å—ï¼Œè‹¥å¹²å°å—ï¼š</p><ul><li>æ˜¾ç¤ºå±‚åŠ¨ç”»</li><li>å†…å®¹å±‚åŠ¨ç”»</li><li>3DåŠ¨ç”»åˆè¯†</li><li>è½¬åœºåŠ¨ç”»</li></ul><h3 id="æœ¬æ¬¡å†…å®¹æ„å›¾"><a href="#æœ¬æ¬¡å†…å®¹æ„å›¾" class="headerlink" title="æœ¬æ¬¡å†…å®¹æ„å›¾"></a>æœ¬æ¬¡å†…å®¹æ„å›¾</h3><p><img src="https://upload-images.jianshu.io/upload_images/1276164-09096bc0129017c1.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="iOSæ ¸å¿ƒåŠ¨ç”».jpg"></p><h3 id="æ ¹æ®ä¸åŒç»´åº¦å¯¹åŠ¨ç”»æ¶æ„è¿›è¡Œåˆ’åˆ†"><a href="#æ ¹æ®ä¸åŒç»´åº¦å¯¹åŠ¨ç”»æ¶æ„è¿›è¡Œåˆ’åˆ†" class="headerlink" title="æ ¹æ®ä¸åŒç»´åº¦å¯¹åŠ¨ç”»æ¶æ„è¿›è¡Œåˆ’åˆ†"></a>æ ¹æ®ä¸åŒç»´åº¦å¯¹åŠ¨ç”»æ¶æ„è¿›è¡Œåˆ’åˆ†</h3><p><img src="https://upload-images.jianshu.io/upload_images/1276164-5aef29fc1cc0eeb9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="iOSåŠ¨ç”»åˆ†å±‚ç»“æ„.jpg"></p><h3 id="UIViewå¸¸ç”¨åŠ¨ç”»åˆé›†"><a href="#UIViewå¸¸ç”¨åŠ¨ç”»åˆé›†" class="headerlink" title="UIViewå¸¸ç”¨åŠ¨ç”»åˆé›†"></a>UIViewå¸¸ç”¨åŠ¨ç”»åˆé›†</h3><p><img src="https://upload-images.jianshu.io/upload_images/1276164-a532af031b0e2be0.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="UIViewå¸¸ç”¨åŠ¨ç”»åˆé›†.jpg"></p><h3 id="Layerå¸¸ç”¨åŠ¨ç”»åˆé›†"><a href="#Layerå¸¸ç”¨åŠ¨ç”»åˆé›†" class="headerlink" title="Layerå¸¸ç”¨åŠ¨ç”»åˆé›†"></a>Layerå¸¸ç”¨åŠ¨ç”»åˆé›†</h3><p><img src="https://upload-images.jianshu.io/upload_images/1276164-2d2c0eecafb772ca.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Layerå¸¸ç”¨åŠ¨ç”»åˆé›†.jpg"></p><h3 id="å¸¸ç”¨è½¬åœºåŠ¨ç”»åˆé›†"><a href="#å¸¸ç”¨è½¬åœºåŠ¨ç”»åˆé›†" class="headerlink" title="å¸¸ç”¨è½¬åœºåŠ¨ç”»åˆé›†"></a>å¸¸ç”¨è½¬åœºåŠ¨ç”»åˆé›†</h3><p><img src="https://upload-images.jianshu.io/upload_images/1276164-e31ef8a0b4586a4c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å¸¸ç”¨è½¬åœºåŠ¨ç”»åˆé›†.jpg"></p><h3 id="æ ¸å¿ƒåŠ¨ç”»ç±»ç»“æ„"><a href="#æ ¸å¿ƒåŠ¨ç”»ç±»ç»“æ„" class="headerlink" title="æ ¸å¿ƒåŠ¨ç”»ç±»ç»“æ„"></a>æ ¸å¿ƒåŠ¨ç”»ç±»ç»“æ„</h3><p><img src="https://upload-images.jianshu.io/upload_images/1276164-30f58f28ca2cdadb.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="CAAnimation.jpg"></p><h3 id="QuartzCoreæ¡†æ¶ä¸‹å¸¸ç”¨å›¾å±‚"><a href="#QuartzCoreæ¡†æ¶ä¸‹å¸¸ç”¨å›¾å±‚" class="headerlink" title="QuartzCoreæ¡†æ¶ä¸‹å¸¸ç”¨å›¾å±‚"></a>QuartzCoreæ¡†æ¶ä¸‹å¸¸ç”¨å›¾å±‚</h3><p><img src="https://upload-images.jianshu.io/upload_images/1276164-58c18c480da3b871.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="QuartzCore.jpg"></p><p>å¦‚æœæ‚¨æœ‰å…´è¶£çš„è¯<br>ä¸‹ä¸€èŠ‚<a href="https://www.jianshu.com/p/4e95c596dfa9" target="_blank" rel="noopener">ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·æ˜¾ç¤ºå±‚åŠ¨ç”»</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-e5bf0966eb9a011c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;ã€ŠiOSåŠ¨ç”»ã€‹è¯»ä¹¦ç¬”è®°Â·å‰åº.jpg&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOSåŠ¨ç”»" scheme="http://yoursite.com/tags/iOS%E5%8A%A8%E7%94%BB/"/>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://yoursite.com/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>runtimeç³»åˆ—ä¹‹ï¼ˆ6ï¼‰runtimeé»‘é­”æ³•Method swizzling</title>
    <link href="http://yoursite.com/2018/06/15/runtime%E7%B3%BB%E5%88%97%E4%B9%8B%EF%BC%886%EF%BC%89runtime%E9%BB%91%E9%AD%94%E6%B3%95Method%20swizzling/"/>
    <id>http://yoursite.com/2018/06/15/runtimeç³»åˆ—ä¹‹ï¼ˆ6ï¼‰runtimeé»‘é­”æ³•Method swizzling/</id>
    <published>2018-06-15T06:16:20.000Z</published>
    <updated>2019-03-25T06:53:29.433Z</updated>
    
    <content type="html"><![CDATA[<p>æ‚¨å°†äº†è§£åˆ°ï¼š</p><ul><li>Method swizzlingåŸç†</li><li>Method swizzlingåº”ç”¨</li><li>Method swizzlingç±»ç°‡</li></ul><a id="more"></a><h2 id="ä»éœ€æ±‚å¼€å§‹è¯´èµ·ï¼š"><a href="#ä»éœ€æ±‚å¼€å§‹è¯´èµ·ï¼š" class="headerlink" title="ä»éœ€æ±‚å¼€å§‹è¯´èµ·ï¼š"></a>ä»éœ€æ±‚å¼€å§‹è¯´èµ·ï¼š</h2><p>ä¾‹å¦‚ï¼šæˆ‘ä»¬æƒ³è¦åœ¨ä¸€æ¬¾iOS APPä¸­è¿½è¸ªæ¯ä¸€ä¸ªè§†å›¾æ§åˆ¶å™¨è¢«ç”¨æˆ·å‘ˆç°äº†å‡ æ¬¡ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š<br><strong>æ‰‹åŠ¨æ·»åŠ </strong><br>ç›´æ¥ç®€å•ç²—æš´çš„åœ¨æ¯ä¸ªè§†å›¾æ§åˆ¶å™¨çš„viewDidAppear:æ–¹æ³•ä¸­æ·»åŠ è¿½è¸ªä»£ç æ¥å®ç°ï¼Œä½†è¿™æ ·ä¼šå¤§é‡é‡å¤çš„æ ·æ¿ä»£ç ï¼Œæ¶ˆè€—æ—¶é—´ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚</p><p><strong>ç»§æ‰¿</strong><br>ç»§æ‰¿æ˜¯å¦ä¸€ç§å¯è¡Œæ–¹å¼ï¼Œä½†æ˜¯è¿™è¦æ±‚æ‰€æœ‰è¢«ç»§æ‰¿çš„è§†å›¾æ§åˆ¶å™¨å¦‚<code>UIViewController</code>ï¼Œ<code>UITableViewController</code>ï¼Œ<code>UINavigationController</code>éƒ½åœ¨<code>viewDidAppear:</code>å®ç°è¿½è¸ªä»£ç ï¼Œè¿™åŒæ ·ä¼šå®šåˆ¶æ€§å·®ï¼Œé€ æˆå¾ˆå¤šé‡å¤ä»£ç ã€‚</p><p><strong>Category</strong><br>æˆ‘ä»¬å¯ä»¥ä¸º<code>UIViewController</code>å»ºä¸€ä¸ª<code>Category</code>ï¼Œç„¶ååœ¨æ‰€æœ‰æ§åˆ¶å™¨ä¸­å¼•å…¥è¿™ä¸ª<code>Category</code>ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ·»åŠ ä¸€ä¸ª<code>PCH</code>æ–‡ä»¶ï¼Œç„¶åå°†è¿™ä¸ª<code>Category</code>æ·»åŠ åˆ°<code>PCH</code>æ–‡ä»¶ä¸­ã€‚</p><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>Category</code>æ¥è¦†ç›–ç³»ç»Ÿæ–¹æ³•ï¼Œç³»ç»Ÿä¼šä¼˜å…ˆè°ƒç”¨<code>Category</code>ä¸­çš„ä»£ç ï¼Œç„¶åå†è°ƒç”¨åŸç±»ä¸­çš„ä»£ç ã€‚</p><p>ä¼ªä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"UIViewController+EventGather.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">EventGather</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"é¡µé¢ç»Ÿè®¡:%@"</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p><strong>Method swizzling</strong><br>å¯ä»¥ä½¿ç”¨è‹¹æœçš„â€œé»‘é­”æ³•â€<code>Method swizzling</code>ã€‚<code>Method swizzling</code>æœ¬è´¨ä¸Šå°±æ˜¯å¯¹<code>IMP</code>å’Œ<code>SEL</code>è¿›è¡Œäº¤æ¢ã€‚</p><h2 id="Method-swizzlingåŸç†"><a href="#Method-swizzlingåŸç†" class="headerlink" title="Method swizzlingåŸç†"></a>Method swizzlingåŸç†</h2><p>åœ¨Objective-Cä¸­è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œå…¶å®æ˜¯å‘ä¸€ä¸ªå¯¹è±¡å‘é€æ¶ˆæ¯ï¼ŒæŸ¥æ‰¾æ¶ˆæ¯çš„å”¯ä¸€ä¾æ®æ˜¯<code>selector</code>çš„åå­—ã€‚åˆ©ç”¨Objective-Cçš„åŠ¨æ€ç‰¹æ€§ï¼Œå¯ä»¥å®ç°åœ¨è¿è¡Œæ—¶å·æ¢<code>selector</code>å¯¹åº”çš„æ–¹æ³•å®ç°ã€‚å¦‚ä½•å®ç°ï¼Œå°±æ˜¯æ¥ä¸‹æ¥è¦è¯´çš„Objective-Cçš„è¿è¡Œæ—¶æœ€å…·äº‰è®®çš„é»‘é­”æ³•ï¼š<code>method swizzling</code>ã€‚</p><p><code>Method swizzling</code>ç”¨äºæ”¹å˜ä¸€ä¸ªå·²ç»å­˜åœ¨çš„<code>selector</code>çš„å®ç°ã€‚è¿™é¡¹æŠ€æœ¯ä½¿å¾—åœ¨è¿è¡Œæ—¶é€šè¿‡æ”¹å˜<code>selector</code>åœ¨ç±»çš„æ¶ˆæ¯åˆ†å‘åˆ—è¡¨ä¸­çš„æ˜ å°„ä»è€Œæ”¹å˜æ–¹æ³•çš„è°ƒç”¨æˆä¸ºå¯èƒ½ã€‚</p><p>é€šè¿‡ä¸¤å¼ å›¾ç‰‡æ¥äº†è§£ä¸€ä¸‹<code>Method swizzling</code>çš„å®ç°åŸç†ï¼š<br><img src="http://p9u62mso1.bkt.clouddn.com/r_method%20swizzling01.png" alt="äº¤æ¢å‰"><br><img src="http://p9u62mso1.bkt.clouddn.com/r_method%20swizzling02.png" alt="äº¤æ¢å"></p><p><code>method swizzling</code>æ²¡æœ‰ä½œç”¨å‰ï¼Œå›¾ä¸€ä¸­çš„<code>selector</code>åŸæœ¬å¯¹åº”ç€<code>IPM2</code>ï¼Œä½†æ˜¯ä¸ºäº†å®ç°ç‰¹å®šä¹Ÿæ— éœ€æ±‚ï¼Œæˆ‘ä»¬åœ¨å›¾äºŒä¸­æ·»åŠ äº†<code>selector2</code>å’Œ<code>IMP3</code>ï¼Œå¹¶ä¸”è®©<code>selector2</code>æŒ‡å‘äº†<code>IMP3</code>ï¼Œè€Œ<code>selector3</code>åˆ™æŒ‡å‘äº†<code>IMP2</code>ï¼Œè¿™æ ·å°±å®ç°äº†â€œæ–¹æ³•äº’æ¢â€ã€‚</p><p>åœ¨OCè¯­è¨€çš„runtimeç‰¹æ€§ä¸­ï¼Œè°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•å°±æ˜¯ç»™è¿™ä¸ªå¯¹è±¡å‘é€æ¶ˆæ¯ã€‚æ˜¯é€šè¿‡æŸ¥æ‰¾æ¥æ”¶æ¶ˆæ¯å¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨ï¼Œä»æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„<code>SEL</code>ï¼Œè¿™ä¸ª<code>SEL</code>å¯¹åº”ç€ä¸€ä¸ª<code>IMP</code>(ä¸€ä¸ªIMPå¯ä»¥å¯¹åº”å¤šä¸ªSEL)ï¼Œé€šè¿‡è¿™ä¸ª<code>IMP</code>æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•è°ƒç”¨ã€‚</p><p>åœ¨æ¯ä¸ªç±»ä¸­éƒ½æœ‰ä¸€ä¸ª<code>Dispatch Table</code>ï¼Œè¿™ä¸ª<code>Dispatch Table</code>æœ¬è´¨æ˜¯å°†ç±»ä¸­çš„<code>SEL</code>å’Œ<code>IMP</code>(å¯ä»¥ç†è§£ä¸ºå‡½æ•°æŒ‡é’ˆ)è¿›è¡Œå¯¹åº”ã€‚è€Œæˆ‘ä»¬çš„<code>Method Swizzling</code>å°±æ˜¯å¯¹è¿™ä¸ªtableè¿›è¡Œäº†æ“ä½œï¼Œè®©<code>SEL</code>å¯¹åº”å¦ä¸€ä¸ª<code>IMP</code>ã€‚</p><h2 id="Method-swizzlingåº”ç”¨"><a href="#Method-swizzlingåº”ç”¨" class="headerlink" title="Method swizzlingåº”ç”¨"></a>Method swizzlingåº”ç”¨</h2><p>ä¾‹ï¼šå¦‚ä¸Šé¢æåˆ°çš„è¿½è¸ªè§†å›¾æ§åˆ¶å™¨è¢«è®¿é—®çš„æ¬¡æ•°ç»Ÿè®¡ï¼Œå…ˆç»™UIViewControlleræ·»åŠ ä¸€ä¸ªCategoryï¼Œç„¶ååœ¨Categoryä¸­çš„<code>+ (void)load</code>æ–¹æ³•ä¸­æ·»åŠ <code>Method swizzling</code>æ–¹æ³•ï¼Œæˆ‘ä»¬ç”¨æ¥æ›¿æ¢çš„æ–¹æ³•ä¹Ÿå†™åœ¨è¿™ä¸ªCategoryä¸­ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"UIViewController+Tracking.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">Tracking</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        Class <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">        </span><br><span class="line">        SEL originalSelector = <span class="keyword">@selector</span>(viewWillAppear:);</span><br><span class="line">        SEL swizzledSelector = <span class="keyword">@selector</span>(xxx_viewWillAppear:);</span><br><span class="line">        </span><br><span class="line">        Method originalMethod = class_getInstanceMethod(<span class="keyword">class</span>, originalSelector);</span><br><span class="line">        Method swizzledMethod = class_getInstanceMethod(<span class="keyword">class</span>, swizzledSelector);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å½“äº¤æ¢çš„æ˜¯ç±»æ–¹æ³•æ—¶ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š</span></span><br><span class="line">        <span class="comment">// Class class = object_getClass((id)self);</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// Method originalMethod = class_getClassMethod(class, originalSelector);</span></span><br><span class="line">        <span class="comment">// Method swizzledMethod = class_getClassMethod(class, swizzledSelector);</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">BOOL</span> didAddMethod = class_addMethod(<span class="keyword">class</span>, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (didAddMethod) &#123;</span><br><span class="line">            class_replaceMethod(<span class="keyword">class</span>, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Method Swizzling</span></span><br><span class="line">- (<span class="keyword">void</span>)xxx_viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="keyword">self</span> xxx_viewWillAppear:animated];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"viewWillAppear: %@"</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h2 id="å¦‚ä½•ä½¿ç”¨Method-swizzling"><a href="#å¦‚ä½•ä½¿ç”¨Method-swizzling" class="headerlink" title="å¦‚ä½•ä½¿ç”¨Method swizzling"></a>å¦‚ä½•ä½¿ç”¨Method swizzling</h2><h4 id="void-load-vs-void-initialize"><a href="#void-load-vs-void-initialize" class="headerlink" title="+(void)load; vs +(void)initialize;"></a>+(void)load; vs +(void)initialize;</h4><p><strong>swizzlingåº”è¯¥åªåœ¨+(void)load;ä¸­å®Œæˆ</strong>ã€‚åœ¨Objective-Cçš„è¿è¡Œæ—¶ä¸­ï¼Œæ¯ä¸ªç±»æœ‰ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œ<code>+(void)load;</code>æ˜¯åœ¨ä¸€ä¸ªç±»è¢«åˆå§‹è£…è½½æ—¶è°ƒç”¨ï¼Œ<code>+(void)initialize;</code>æ˜¯åœ¨åº”ç”¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥ç±»çš„ç±»æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•å‰è°ƒç”¨çš„ã€‚ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯å¯é€‰çš„ï¼Œå¹¶ä¸”åªæœ‰åœ¨æ–¹æ³•è¢«å®ç°çš„æƒ…å†µä¸‹æ‰ä¼šè¢«è°ƒç”¨ã€‚</p><h4 id="dispatch-once"><a href="#dispatch-once" class="headerlink" title="dispatch_once"></a>dispatch_once</h4><p><strong>swizzlingåº”è¯¥åªåœ¨dispatch_onceä¸­å®Œæˆ</strong>ã€‚ç”±äºswizzlingæ”¹å˜äº†å…¨å±€çš„çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¡®ä¿æ¯ä¸ªé¢„é˜²æªæ–½åœ¨è¿è¡Œæ—¶éƒ½æ˜¯å¯ç”¨çš„ã€‚åœ¨<code>dispatch_once</code>ä¸­æ‰§è¡ŒMethod swizzlingæ˜¯ä¸€ç§é˜²æŠ¤æªæ–½ï¼Œä»¥ä¿è¯ä»£ç å—åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡å¹¶ä¸”çº¿ç¨‹å®‰å…¨ã€‚</p><h4 id="Selectorï¼ŒMethodsï¼Œ-amp-Implementations"><a href="#Selectorï¼ŒMethodsï¼Œ-amp-Implementations" class="headerlink" title="Selectorï¼ŒMethodsï¼Œ&amp; Implementations"></a>Selectorï¼ŒMethodsï¼Œ&amp; Implementations</h4><p>åœ¨ Objective-C çš„è¿è¡Œæ—¶ä¸­ï¼Œ<code>selectors</code>, <code>methods</code>, <code>implementations</code>æŒ‡ä»£äº†ä¸åŒæ¦‚å¿µï¼Œç„¶è€Œæˆ‘ä»¬é€šå¸¸ä¼šè¯´åœ¨æ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸‰ä¸ªæ¦‚å¿µæ˜¯å¯ä»¥ç›¸äº’è½¬æ¢çš„ã€‚</p><p>ç†è§£<code>selector</code>, <code>methods</code>, <code>implementation</code>è¿™ä¸‰ä¸ªæ¦‚å¿µä¹‹é—´å…³ç³»çš„æœ€å¥½æ–¹å¼æ˜¯ï¼šåœ¨è¿è¡Œæ—¶ï¼Œç±»ï¼ˆClassï¼‰ç»´æŠ¤äº†ä¸€ä¸ªæ¶ˆæ¯åˆ†å‘åˆ—è¡¨æ¥è§£å†³æ¶ˆæ¯çš„æ­£ç¡®å‘é€ã€‚æ¯ä¸€ä¸ªæ¶ˆæ¯åˆ—è¡¨çš„å…¥å£æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼ˆMethodï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•æ˜ å°„äº†ä¸€å¯¹é”®å€¼å¯¹ï¼Œå…¶ä¸­é”®å€¼æ˜¯è¿™ä¸ªæ–¹æ³•çš„åå­— selectorï¼ˆSELï¼‰ï¼Œå€¼æ˜¯æŒ‡å‘è¿™ä¸ªæ–¹æ³•å®ç°çš„å‡½æ•°æŒ‡é’ˆ implementationï¼ˆIMPï¼‰ã€‚ Method swizzling ä¿®æ”¹äº†ç±»çš„æ¶ˆæ¯åˆ†å‘åˆ—è¡¨ä½¿å¾—å·²ç»å­˜åœ¨çš„ selector æ˜ å°„äº†å¦ä¸€ä¸ªå®ç° implementationï¼ŒåŒæ—¶é‡å‘½åäº†åŸç”Ÿæ–¹æ³•çš„å®ç°ä¸ºä¸€ä¸ªæ–°çš„ selectorã€‚</p><h4 id="è°ƒç”¨-cmd"><a href="#è°ƒç”¨-cmd" class="headerlink" title="è°ƒç”¨ _cmd"></a>è°ƒç”¨ _cmd</h4><p>ä¸‹é¢ä»£ç åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¼šå‡ºç°å¾ªç¯ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)xxx_viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="keyword">self</span> xxx_viewWillAppear:animated];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"viewWillAppear: %@"</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œåœ¨äº¤æ¢äº†æ–¹æ³•å®ç°åå°±ä¸ä¼šå‡ºç°å¾ªç¯äº†ã€‚åœ¨äº¤æ¢äº†æ–¹æ³•çš„å®ç°åï¼Œ<code>xxx_viewWillAppear:</code>æ–¹æ³•çš„å®ç°å·²ç»è¢«æ›¿æ¢ä¸ºUIViewController <code>-viewWillAppear:</code>çš„åŸç”Ÿå®ç°ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸æ˜¯åœ¨é€’å½’è°ƒç”¨ã€‚</p><p>ç”±äº <code>xxx_viewWillAppear:</code> è¿™ä¸ªæ–¹æ³•çš„å®ç°å·²ç»è¢«æ›¿æ¢ä¸ºäº† <code>viewWillAppear:</code> çš„å®ç°ï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å†è°ƒç”¨ <code>viewWillAppear:</code> æ—¶ä¾¿ä¼šé€ æˆé€’å½’å¾ªç¯ã€‚</p><h2 id="Method-swizzlingç±»ç°‡"><a href="#Method-swizzlingç±»ç°‡" class="headerlink" title="Method swizzlingç±»ç°‡"></a>Method swizzlingç±»ç°‡</h2><p>åœ¨é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸å› ä¸º<code>NSArray</code>æ•°ç»„è¶Šç•Œæˆ–è€…<code>NSDictionary</code>çš„<code>key</code>æˆ–è€…<code>value</code>å€¼ä¸º<code>nil</code>ç­‰é—®é¢˜å¯¼è‡´çš„å´©æºƒï¼Œå¯¹äºè¿™äº›é—®é¢˜è‹¹æœå¹¶ä¸ä¼šæŠ¥ä¸€ä¸ªè­¦å‘Šï¼Œè€Œæ˜¯ç›´æ¥å´©æºƒã€‚</p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸Šé¢å¯¹<code>Method swizzling</code>çš„äº†è§£ï¼Œå¯¹<code>NSArray</code>ï¼Œ<code>NSMutableArray</code>ï¼Œ<code>NSDictionary</code>ï¼Œ<code>NSMutableDictionary</code>ç­‰ç±»è¿›è¡Œ<code>Method swizzling</code>ï¼Œå®ç°æ–¹å¼è¿˜æ˜¯æŒ‰ç…§ä¸Šé¢çš„ä¾‹å­æ¥åšã€‚ä½†æ˜¯â€¦å‘ç°<code>Method swizzling</code>æ ¹æœ¬ä¸èµ·ä½œç”¨ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸º<code>Method swizzling</code>å¯¹<code>NSArray</code>è¿™äº›<strong>ç±»ç°‡</strong>æ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œå› ä¸ºè¿™äº›ç±»ç°‡ç±»ï¼Œå…¶å®æ˜¯ä¸€ç§<strong>æŠ½è±¡å·¥å‚çš„è®¾è®¡æ¨¡å¼</strong>ã€‚æŠ½è±¡å·¥å‚å†…éƒ¨æœ‰å¾ˆå¤šå…¶å®ƒç»§æ‰¿è‡ªå½“å‰ç±»çš„å­ç±»ï¼ŒæŠ½è±¡å·¥å‚ä¼šæ ¹æ®ä¸åŒæƒ…å†µï¼Œåˆ›å»ºä¸åŒçš„æŠ½è±¡å¯¹è±¡æ¥è¿›è¡Œä½¿ç”¨ã€‚ä¾‹å¦‚æˆ‘ä»¬è°ƒç”¨<code>NSArray</code>çš„<code>objectAtIndex:</code>æ–¹æ³•ï¼Œè¿™ä¸ªç±»ä¼šåœ¨æ–¹æ³•å†…éƒ¨åˆ¤æ–­ï¼Œå†…éƒ¨åˆ›å»ºä¸åŒæŠ½è±¡ç±»è¿›è¡Œæ“ä½œã€‚</p><p>æ‰€ä»¥ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯¹<code>NSArray</code>ç±»è¿›è¡Œæ“ä½œå…¶å®åªæ˜¯å¯¹çˆ¶ç±»è¿›è¡Œäº†æ“ä½œï¼Œåœ¨<code>NSArray</code>å†…éƒ¨ä¼šåˆ›å»ºå…¶ä»–å­ç±»æ¥æ‰§è¡Œæ“ä½œï¼ŒçœŸæ­£æ‰§è¡Œæ“ä½œçš„å¹¶ä¸æ˜¯<code>NSArray</code>è‡ªèº«ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å¯¹å…¶<strong>â€œçœŸèº«â€</strong>è¿›è¡Œæ“ä½œã€‚</p><p><strong>ä¸‹é¢æˆ‘ä»¬å®ç°äº†é˜²æ­¢NSArrayå› ä¸ºè°ƒç”¨objectAtIndex:æ–¹æ³•ï¼Œå–ä¸‹æ ‡æ—¶æ•°ç»„è¶Šç•Œå¯¼è‡´çš„å´©æºƒï¼š</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">import</span> <span class="string">"NSArray+SafeArray.h"</span></span><br><span class="line"></span><br><span class="line">#<span class="keyword">import</span> &lt;objc/runtime.h&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">@implementation</span> NSArray (SafeArray)</span><br><span class="line"></span><br><span class="line">+ (void)load &#123;</span><br><span class="line">    [<span class="keyword">super</span> load];</span><br><span class="line">    </span><br><span class="line">    Class <span class="class"><span class="keyword">class</span> = <span class="title">objc_getClass</span></span>(<span class="string">"__NSArrayI"</span>);</span><br><span class="line">    </span><br><span class="line">    SEL fromSelector = <span class="meta">@selector(objectAtIndex:)</span>;</span><br><span class="line">    SEL toSelector = <span class="meta">@selector(safe_objectAtIndex:)</span>;</span><br><span class="line">    </span><br><span class="line">    Method fromMethod = class_getInstanceMethod(<span class="class"><span class="keyword">class</span>, <span class="type">fromSelector);</span></span></span><br><span class="line">    Method toMethod = class_getInstanceMethod(<span class="class"><span class="keyword">class</span>, <span class="type">toSelector);</span></span></span><br><span class="line">    </span><br><span class="line">    BOOL didAddMethod = class_addMethod(<span class="class"><span class="keyword">class</span>, <span class="type">fromSelector</span>, <span class="type">method_getImplementation</span></span>(toMethod), method_getTypeEncoding(toMethod));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (didAddMethod) &#123;</span><br><span class="line">        class_replaceMethod(<span class="class"><span class="keyword">class</span>, <span class="type">toSelector</span>, <span class="type">method_getImplementation</span></span>(fromMethod), method_getTypeEncoding(fromMethod));</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        method_exchangeImplementations(fromMethod, toMethod);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (id)safe_objectAtIndex:(NSUInteger)index &#123;</span><br><span class="line">    <span class="keyword">if</span> (self.count<span class="number">-1</span> &lt; index) &#123;</span><br><span class="line">        <span class="meta">@try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> [self safe_objectAtIndex:index];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@catch</span> (NSException *exception) &#123;</span><br><span class="line">            NSLog(@<span class="string">"------ %s Crash Because Method %s ------\n"</span>, class_getName(self.<span class="keyword">class</span>), __func__);</span><br><span class="line">            NSLog(@<span class="string">"%@"</span>, [exception callStackSymbols]);</span><br><span class="line">            <span class="keyword">return</span> nil;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@finally</span> &#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [self safe_objectAtIndex:index];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@end</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°<code>__NSArrayI</code>æ‰æ˜¯<code>NSArray</code>çœŸæ­£çš„ç±»<br>ä¸‹é¢åˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„ç±»ç°‡çš„<strong>â€œçœŸèº«â€</strong>ï¼š</p><table><thead><tr><th>ç±»</th><th>â€œçœŸèº«â€</th></tr></thead><tbody><tr><td>NSArray</td><td>__NSArrayI</td></tr><tr><td>NSMutableArray</td><td>__NSArrayM</td></tr><tr><td>NSDictionary</td><td>__NSDictionaryI</td></tr><tr><td>NSMutableDictionary</td><td>__NSDictionaryM</td></tr></tbody></table><p><strong>ä¸‹é¢è¿™ä¸ªç¤ºä¾‹æ˜¯ é€šè¿‡äº¤æ¢NSMutableDictionaryçš„setObject:forKey:æ–¹æ³•ï¼Œè®©è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶å½“å‚æ•°objectæˆ–keyä¸ºç©ºæ—¶ä¸ä¼šæŠ›å‡ºå¼‚å¸¸å¯¼è‡´ç¨‹åºå´©æºƒ</strong><br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"NSMutableDictionary+SafeMutableDictionary.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMutableDictionary</span> (<span class="title">SafeMutableDictionary</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        Class originalClass = <span class="built_in">NSClassFromString</span>(<span class="string">@"__NSDictionaryM"</span>);</span><br><span class="line">        Class swizzledClass = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">        </span><br><span class="line">        SEL originalSelector = <span class="keyword">@selector</span>(setObject:forKey:);</span><br><span class="line">        SEL swizzledSelector = <span class="keyword">@selector</span>(safe_setObject:forKey:);</span><br><span class="line">        </span><br><span class="line">        Method originalMethod = class_getInstanceMethod(originalClass, originalSelector);</span><br><span class="line">        Method swizzledMethod = class_getInstanceMethod(swizzledClass, swizzledSelector);</span><br><span class="line">        </span><br><span class="line">        IMP originalIMP = method_getImplementation(originalMethod);</span><br><span class="line">        IMP swizzledIMP = method_getImplementation(swizzledMethod);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *originalType = method_getTypeEncoding(originalMethod);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *swizzledType = method_getTypeEncoding(swizzledMethod);</span><br><span class="line">        </span><br><span class="line">        class_replaceMethod(originalClass,swizzledSelector,originalIMP,originalType);</span><br><span class="line">        class_replaceMethod(originalClass,originalSelector,swizzledIMP,swizzledType);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)safe_setObject:(<span class="keyword">id</span>)anObject forKey:(<span class="keyword">id</span>)aKey &#123;</span><br><span class="line">    <span class="keyword">if</span> (anObject &amp;&amp; aKey) &#123;</span><br><span class="line">        [<span class="keyword">self</span> safe_setObject:anObject forKey:aKey];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">@try</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span> safe_setObject:anObject forKey:aKey];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"------ %s Crash Because Method %s ------\n"</span>, class_getName(<span class="keyword">self</span>.class), __func__);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [exception callStackSymbols]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">@finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (aKey) &#123;</span><br><span class="line">                [(<span class="built_in">NSMutableDictionary</span> *)<span class="keyword">self</span> removeObjectForKey:aKey];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="åœ¨Method-swizzlingä¹‹åå¦‚ä½•æ¢å¤ï¼Ÿ"><a href="#åœ¨Method-swizzlingä¹‹åå¦‚ä½•æ¢å¤ï¼Ÿ" class="headerlink" title="åœ¨Method swizzlingä¹‹åå¦‚ä½•æ¢å¤ï¼Ÿ"></a>åœ¨Method swizzlingä¹‹åå¦‚ä½•æ¢å¤ï¼Ÿ</h2><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ä½¿ç”¨<code>Method swizzling</code>æœ€æ ¸å¿ƒçš„å…¶å®ä¹Ÿåªåšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</p><ul><li><code>class_addMethod</code>æ·»åŠ ä¸€ä¸ªæ–°çš„æ–¹æ³•, å¯èƒ½æ˜¯æŠŠå…¶å®ƒç±»ä¸­å®ç°çš„æ–¹æ³•æ·»åŠ åˆ°ç›®æ ‡ç±»ä¸­, ä¹Ÿå¯èƒ½æ˜¯æŠŠçˆ¶ç±»å®ç°çš„æ–¹æ³•æ·»åŠ ä¸€ä»½åœ¨å­ç±»ä¸­, å¯èƒ½æ˜¯æ·»åŠ çš„å®ä¾‹æ–¹æ³•, ä¹Ÿå¯èƒ½æ˜¯æ·»åŠ çš„ç±»æ–¹æ³•, æ€»ä¹‹å°±æ˜¯æ·»åŠ äº†æ–¹æ³•.</li><li>äº¤æ¢<code>IMP</code>,äº¤æ¢æ–¹æ³•çš„å®ç°<code>IMP</code>,å®Œæˆè¿™ä¸ªæ­¥éª¤é™¤äº†ä½¿ç”¨<code>method_exchangeImplementations</code>è¿™ä¸ªæ–¹æ³•å¤–, ä¹Ÿå¯ä»¥æ˜¯è°ƒç”¨äº†<code>method_setImplementation</code>æ–¹æ³•æ¥å•ç‹¬ä¿®æ”¹æŸä¸ªæ–¹æ³•çš„<code>IMP</code>, æˆ–è€…æ˜¯é‡‡ç”¨åœ¨è°ƒç”¨<code>class_addMethod</code>æ–¹æ³•ä¸­è®¾å®šäº†<code>IMP</code>è€Œç›´æ¥å°±å®Œæˆäº†<code>IMP</code>çš„äº¤æ¢, æ€»ä¹‹å°±æ˜¯å¯¹<code>IMP</code>çš„äº¤æ¢.</li></ul><p>é‚£æˆ‘ä»¬æ¥åˆ†åˆ«çœ‹ä¸€ä¸‹è¿™ä¸¤ä»¶äº‹æƒ…æ˜¯å¦éƒ½è¿˜èƒ½æ¢å¤:</p><ul><li>å¯¹äº<code>class_addMethod</code>, æˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„å¯èƒ½å°±æ˜¯æœ‰æ²¡æœ‰å¯¹åº”çš„<code>remove</code>æ–¹æ³•å‘¢, åœ¨Objective-C 1.0çš„æ—¶å€™æœ‰<code>class_removeMethods</code>è¿™ä¸ªæ–¹æ³•, ä¸è¿‡åœ¨2.0çš„æ—¶å€™å°±å·²ç»è¢«ç¦ç”¨äº†, ä¹Ÿå°±æ˜¯è‹¹æœå¹¶ä¸æ¨èæˆ‘ä»¬è¿™æ ·åš, æƒ³æƒ³ä¼¼ä¹ä¹Ÿæ˜¯æŒºæœ‰é“ç†çš„, æœ¬æ¥runtimeçš„æ¥å£çœ‹ç€å°±æŒºè®©äººå¿ƒæƒŠèƒ†æˆ˜çš„, åˆæ˜¯æ·»åŠ åˆæ˜¯åˆ é™¤æ€»è§‰å¾—ä¼šå‡ºå²”å­, æ‰€ä»¥åªèƒ½æ”¾å¼ƒremoveçš„æƒ³æ³•, åæ­£æ–¹æ³•æ·»åŠ åœ¨é‚£å„¿å€’ä¹Ÿæ²¡ä»€ä¹ˆå¤ªå¤§çš„å½±å“.</li><li>é’ˆå¯¹<code>IMP</code>çš„äº¤æ¢, åœ¨<code>Method Swizzling</code>æ—¶åšçš„äº¤æ¢åŠ¨ä½œ, å¦‚æœéœ€è¦æ¢å¤å…¶å®è¦åšçš„åŠ¨ä½œè¿˜æ˜¯äº¤æ¢å›æ¥ç½¢äº†, æ‰€ä»¥æ˜¯å¯ä»¥åšåˆ°çš„, ä¸è¿‡éœ€è¦æ€æ ·åšå‘¢? å¯¹äºåŒä¸€ä¸ªç±», åŒä¸€ä¸ªæ–¹æ³•, å¯èƒ½ä¼šåœ¨ä¸åŒçš„åœ°æ–¹è¢«å¤šæ¬¡åš<code>Method Swizzling</code>, æ‰€ä»¥è¦å›é€€æŸä¸€æ¬¡çš„<code>Method Swizzling</code>, æˆ‘ä»¬å°±éœ€è¦è®°å½•ä¸‹æ¥è¿™ä¸€æ¬¡äº¤æ¢çš„æ—¶å€™æ˜¯å“ªä¸¤ä¸ª<code>IMP</code>åšäº†äº¤æ¢, æ¢å¤çš„æ—¶å€™å†æ¢å›æ¥å³å¯. å¦ä¸€ä¸ªé—®é¢˜æ˜¯å¦‚æœå·²ç»ç»è¿‡å¤šæ¬¡äº¤æ¢, æˆ‘ä»¬æ€æ ·æ‰¾åˆ°è¿™ä¸¤ä¸ª<code>IMP</code>æ‰€å¯¹åº”çš„<code>Method</code>å‘¢, è¿˜å¥½runtimeæä¾›äº†ä¸€ä¸ª<code>class_copyMethodList</code>æ–¹æ³•, å¯ä»¥ç›´æ¥å–å‡º<code>Method</code>åˆ—è¡¨, ç„¶åæˆ‘ä»¬å°±å¯ä»¥é€ä¸ªéå†æ‰¾åˆ°<code>IMP</code>æ‰€å¯¹åº”çš„<code>Method</code>äº†, ä¸‹é¢æ˜¯å¯¹ä¸Šä¸€ä¸ªç¤ºä¾‹æ·»åŠ æ¢å¤ä¹‹åå®ç°çš„ä»£ç é€»è¾‘:</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import @interface MySafeDictionary : NSObject</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSLock</span> *kMySafeLock = <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">static</span> IMP kMySafeOriginalIMP = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> IMP kMySafeSwizzledIMP = <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MySafeDictionary</span></span></span><br><span class="line"> </span><br><span class="line">+ (<span class="keyword">void</span>)swizzlling &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        kMySafeLock = [[<span class="built_in">NSLock</span> alloc] init];</span><br><span class="line">    &#125;);</span><br><span class="line">     </span><br><span class="line">    [kMySafeLock lock];</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (kMySafeOriginalIMP || kMySafeSwizzledIMP) <span class="keyword">break</span>;</span><br><span class="line">         </span><br><span class="line">        Class originalClass = <span class="built_in">NSClassFromString</span>(<span class="string">@"__NSDictionaryM"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!originalClass) <span class="keyword">break</span>;</span><br><span class="line">         </span><br><span class="line">        Class swizzledClass = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">        SEL originalSelector = <span class="keyword">@selector</span>(setObject:forKey:);</span><br><span class="line">        SEL swizzledSelector = <span class="keyword">@selector</span>(safe_setObject:forKey:);</span><br><span class="line">        Method originalMethod = class_getInstanceMethod(originalClass, originalSelector);</span><br><span class="line">        Method swizzledMethod = class_getInstanceMethod(swizzledClass, swizzledSelector);</span><br><span class="line">        <span class="keyword">if</span> (!originalMethod || !swizzledMethod) <span class="keyword">break</span>;</span><br><span class="line">         </span><br><span class="line">        IMP originalIMP = method_getImplementation(originalMethod);</span><br><span class="line">        IMP swizzledIMP = method_getImplementation(swizzledMethod);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *originalType = method_getTypeEncoding(originalMethod);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *swizzledType = method_getTypeEncoding(swizzledMethod);</span><br><span class="line">         </span><br><span class="line">        kMySafeOriginalIMP = originalIMP;</span><br><span class="line">        kMySafeSwizzledIMP = swizzledIMP;</span><br><span class="line">         </span><br><span class="line">        class_replaceMethod(originalClass,swizzledSelector,originalIMP,originalType);</span><br><span class="line">        class_replaceMethod(originalClass,originalSelector,swizzledIMP,swizzledType);</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">NO</span>);</span><br><span class="line">     </span><br><span class="line">    [kMySafeLock unlock];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">+ (<span class="keyword">void</span>)restore &#123;</span><br><span class="line">    [kMySafeLock lock];</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!kMySafeOriginalIMP || !kMySafeSwizzledIMP) <span class="keyword">break</span>;</span><br><span class="line">         </span><br><span class="line">        Class originalClass = <span class="built_in">NSClassFromString</span>(<span class="string">@"__NSDictionaryM"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!originalClass) <span class="keyword">break</span>;</span><br><span class="line">         </span><br><span class="line">        Method originalMethod = <span class="literal">NULL</span>;</span><br><span class="line">        Method swizzledMethod = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">        Method *methodList = class_copyMethodList(originalClass, &amp;outCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> idx=<span class="number">0</span>; idx &lt; outCount; idx++) &#123;</span><br><span class="line">            Method aMethod = methodList[idx];</span><br><span class="line">            IMP aIMP = method_getImplementation(aMethod);</span><br><span class="line">            <span class="keyword">if</span> (aIMP == kMySafeSwizzledIMP) &#123;</span><br><span class="line">                originalMethod = aMethod;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (aIMP == kMySafeOriginalIMP) &#123;</span><br><span class="line">                swizzledMethod = aMethod;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°½å¯èƒ½ä½¿ç”¨exchange,å› ä¸ºå®ƒæ˜¯atomicçš„</span></span><br><span class="line">        <span class="keyword">if</span> (originalMethod &amp;&amp; swizzledMethod) &#123;</span><br><span class="line">            method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (originalMethod) &#123;</span><br><span class="line">            method_setImplementation(originalMethod, kMySafeOriginalIMP);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (swizzledMethod) &#123;</span><br><span class="line">            method_setImplementation(swizzledMethod, kMySafeSwizzledIMP);</span><br><span class="line">        &#125;</span><br><span class="line">        kMySafeOriginalIMP = <span class="literal">NULL</span>;</span><br><span class="line">        kMySafeSwizzledIMP = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">NO</span>);</span><br><span class="line">     </span><br><span class="line">    [kMySafeLock unlock];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">void</span>)safe_setObject:(<span class="keyword">id</span>)anObject forKey:(<span class="keyword">id</span>)aKey &#123;</span><br><span class="line">    <span class="keyword">if</span> (anObject &amp;&amp; aKey) &#123;</span><br><span class="line">        [<span class="keyword">self</span> safe_setObject:anObject forKey:aKey];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (aKey) &#123;</span><br><span class="line">        [(<span class="built_in">NSMutableDictionary</span> *)<span class="keyword">self</span> removeObjectForKey:aKey];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„:</strong> è¿™æ®µä»£ç çš„Method Swizzlingå’Œæ¢å¤éƒ½éœ€è¦ä¸»åŠ¨è°ƒç”¨, å¹¶ä¸”ç›¸æ¯”ä¸Šé¢å…¶å®ƒçš„ç¤ºä¾‹, è¿™æ®µä»£ç è¿˜æ·»åŠ å¦‚é”æœºåˆ¶æ¥åŠ ä¹‹ä¿æŠ¤. è¿™ä¸ªç¤ºä¾‹æ˜¯ä»¥ä¸åŒçš„ç±»æ¥å®ç°çš„Method Swizzlingå’Œæ¢å¤, å¦‚æœæ˜¯Categoryæˆ–è€…æ˜¯ç±»æ–¹æ³•, æ ¹æ®ä¹‹å‰çš„ç¤ºä¾‹ä¹Ÿéœ€è¦åšç›¸åº”çš„è°ƒæ•´.</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ‚¨å°†äº†è§£åˆ°ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Method swizzlingåŸç†&lt;/li&gt;
&lt;li&gt;Method swizzlingåº”ç”¨&lt;/li&gt;
&lt;li&gt;Method swizzlingç±»ç°‡&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="runtime" scheme="http://yoursite.com/tags/runtime/"/>
    
  </entry>
  
  <entry>
    <title>runtimeç³»åˆ—ä¹‹ï¼ˆ5ï¼‰å…³äºweakçš„æ€è€ƒ</title>
    <link href="http://yoursite.com/2018/06/10/runtime%E7%B3%BB%E5%88%97%E4%B9%8B%EF%BC%885%EF%BC%89%E5%85%B3%E4%BA%8Eweak%E7%9A%84%E6%80%9D%E8%80%83/"/>
    <id>http://yoursite.com/2018/06/10/runtimeç³»åˆ—ä¹‹ï¼ˆ5ï¼‰å…³äºweakçš„æ€è€ƒ/</id>
    <published>2018-06-10T13:16:23.000Z</published>
    <updated>2019-03-25T06:53:22.125Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="weak"><a href="#weak" class="headerlink" title="weak"></a>weak</h2><p>weakä¸è®ºæ˜¯ç”¨ä½œpropertyä¿®é¥°ç¬¦è¿˜æ˜¯ç”¨æ¥ä¿®é¥°ä¸€ä¸ªå˜é‡çš„å£°æ˜å…¶ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯ä¸å¢åŠ æ–°å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œè¢«é‡Šæ”¾æ—¶ä¹Ÿä¸ä¼šå‡å°‘æ–°å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼ŒåŒæ—¶åœ¨æ–°å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œweakä¿®é¥°çš„å±æ€§æˆ–å˜é‡å‡ä¼šè¢«è®¾ç½®ä¸ºnilï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢é‡æŒ‡é’ˆé”™è¯¯ï¼Œæœ¬æ–‡è¦è®²è§£çš„ä¹Ÿæ­£æ˜¯è¿™ä¸ªç‰¹æ€§ï¼Œruntimeå¦‚ä½•å°†weakä¿®é¥°çš„å˜é‡çš„å¯¹è±¡åœ¨é”€æ¯æ—¶è‡ªåŠ¨ç½®ä¸ºnilçš„ã€‚</p><h2 id="weakå®ç°åŸç†çš„æ¦‚æ‹¬"><a href="#weakå®ç°åŸç†çš„æ¦‚æ‹¬" class="headerlink" title="weakå®ç°åŸç†çš„æ¦‚æ‹¬"></a>weakå®ç°åŸç†çš„æ¦‚æ‹¬</h2><p>runtimeç»´æŠ¤äº†ä¸€ä¸ªweakè¡¨ï¼Œç”¨äºå­˜å‚¨æŒ‡å‘æŸä¸ªå¯¹è±¡çš„æ‰€æœ‰weakæŒ‡é’ˆã€‚weakè¡¨å…¶å®æ˜¯ä¸€ä¸ªhashè¡¨ï¼Œkeyæ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€ï¼Œvalueæ˜¯weakæŒ‡é’ˆçš„åœ°å€ï¼ˆè¿™ä¸ªåœ°å€çš„å€¼æ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€ï¼‰æ•°ç»„ã€‚</p><p><strong>weakçš„å®ç°åŸç†å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹3æ­¥ï¼š</strong></p><p>1ã€åˆå§‹åŒ–æ—¶ï¼šruntimeä¼šè°ƒç”¨objc_initWeakå‡½æ•°ï¼Œåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„weakæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€ã€‚</p><p>2ã€æ·»åŠ å¼•ç”¨æ—¶ï¼šobjc_initWeakå‡½æ•°ä¼šè°ƒç”¨objc_storeWeak()å‡½æ•°ï¼Œobjc_storeWeak()çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨ã€‚</p><p>3ã€é‡Šæ”¾æ—¶ï¼šè°ƒç”¨clearDeallocatingå‡½æ•°ã€‚clearDeallocatingå‡½æ•°é¦–å…ˆæ ¹æ®å¯¹è±¡åœ°å€è·å–æ‰€æœ‰weakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ï¼Œç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå…¶ä¸­çš„æ•°æ®è®¾ä¸ºnilï¼Œæœ€åæŠŠè¿™ä¸ªentryä»weakè¡¨ä¸­åˆ é™¤ï¼Œæœ€åæ¸…ç†å¯¹è±¡çš„è®°å½•ã€‚</p><p><strong>è¯¦ç»†ä»‹ç»æ¯ä¸€æ­¥ï¼š</strong></p><p><strong>1ã€åˆå§‹åŒ–æ—¶ï¼šruntimeä¼šè°ƒç”¨objc_initWeakå‡½æ•°ï¼Œåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„weakæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€ã€‚</strong></p><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="built_in">NSObject</span> *obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line"><span class="keyword">id</span> __<span class="keyword">weak</span> obj1 = obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åˆå§‹åŒ–ä¸€ä¸ªweakå˜é‡æ—¶ï¼Œruntimeä¼šè°ƒç”¨NSObject.mmä¸­çš„objc_initWeakå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°åœ¨Clangä¸­çš„å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span> objc_initWeak(<span class="built_in">id</span> *object, <span class="built_in">id</span> value);</span><br></pre></td></tr></table></figure><p>è€Œå¯¹äºobjc_initWeak()æ–¹æ³•çš„å®ç°</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">id objc_initWeak(id *location, id <span class="keyword">new</span><span class="type">Obj</span>) &#123;</span><br><span class="line"><span class="comment">// æŸ¥çœ‹å¯¹è±¡å®ä¾‹æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line"><span class="comment">// æ— æ•ˆå¯¹è±¡ç›´æ¥å¯¼è‡´æŒ‡é’ˆé‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">new</span><span class="type">Obj</span>) &#123;</span><br><span class="line">        *location = nil;</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä¼ é€’äº†ä¸‰ä¸ª bool æ•°å€¼</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ template è¿›è¡Œå¸¸é‡å‚æ•°ä¼ é€’æ˜¯ä¸ºäº†ä¼˜åŒ–æ€§èƒ½</span></span><br><span class="line">    <span class="keyword">return</span> storeWeakfalse<span class="comment">/*old*/</span>, <span class="literal">true</span><span class="comment">/*new*/</span>, <span class="literal">true</span><span class="comment">/*crash*/</span>&gt;</span><br><span class="line">    (location, (objc_object*)<span class="keyword">new</span><span class="type">Obj</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå‡½æ•°ä»…ä»…æ˜¯ä¸€ä¸ªæ·±å±‚å‡½æ•°çš„è°ƒç”¨å…¥å£ï¼Œè€Œä¸€èˆ¬çš„å…¥å£å‡½æ•°ä¸­ï¼Œéƒ½ä¼šåšä¸€ä¸ªç®€å•çš„åˆ¤æ–­ï¼ˆä¾‹å¦‚objc_msgSendä¸­çš„ç¼“å­˜åˆ¤æ–­ï¼‰ï¼Œè¿™é‡Œåˆ¤æ–­äº†å…¶æŒ‡é’ˆæŒ‡å‘çš„ç±»å¯¹è±¡æ˜¯å¦æœ‰æ•ˆï¼Œæ— æ•ˆç›´æ¥é‡Šæ”¾ï¼Œä¸å†å¾€æ·±å±‚è°ƒç”¨å‡½æ•°ã€‚å¦åˆ™ï¼Œobjectå°†è¢«æ³¨å†Œä¸ºä¸€ä¸ªæŒ‡å‘valueçš„__weakå¯¹è±¡ã€‚è€Œè¿™æ˜¯objc_storeWeakå‡½æ•°å¹²çš„ã€‚</p><blockquote><p>æ³¨æ„ï¼šobjc_initWeakå‡½æ•°æœ‰ä¸€ä¸ªå‰ææ¡ä»¶ï¼šå°±æ˜¯objectå¿…é¡»æ˜¯ä¸€ä¸ªæ²¡æœ‰è¢«æ³¨å†Œä¸º__weakå¯¹è±¡çš„æœ‰æ•ˆæŒ‡é’ˆã€‚è€Œvalueåˆ™å¯ä»¥æ˜¯nullï¼Œæˆ–è€…æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„å¯¹è±¡ã€‚</p></blockquote><p><strong>2ã€æ·»åŠ å¼•ç”¨æ—¶ï¼šobjc_initWeakå‡½æ•°ä¼šè°ƒç”¨objc_storeWeak()å‡½æ•°ï¼Œobjc_storeWeak()çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨ã€‚</strong></p><p>objc_storeWeak()å‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span> objc_storeWeak(<span class="built_in">id</span> *location, <span class="built_in">id</span> value);</span><br></pre></td></tr></table></figure><p>objc_storeWeak()çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HaveOld:     true - å˜é‡æœ‰å€¼</span></span><br><span class="line"><span class="comment">//             false - éœ€è¦è¢«åŠæ—¶æ¸…ç†ï¼Œå½“å‰å€¼å¯èƒ½ä¸º nil</span></span><br><span class="line"><span class="comment">// HaveNew:     true - éœ€è¦è¢«åˆ†é…çš„æ–°å€¼ï¼Œå½“å‰å€¼å¯èƒ½ä¸º nil</span></span><br><span class="line"><span class="comment">//             false - ä¸éœ€è¦åˆ†é…æ–°å€¼</span></span><br><span class="line"><span class="comment">// CrashIfDeallocating: true - è¯´æ˜ newObj å·²ç»é‡Šæ”¾æˆ–è€… newObj ä¸æ”¯æŒå¼±å¼•ç”¨ï¼Œè¯¥è¿‡ç¨‹éœ€è¦æš‚åœ</span></span><br><span class="line"><span class="comment">//             false - ç”¨ nil æ›¿ä»£å­˜å‚¨</span></span><br><span class="line">template bool HaveOld, bool HaveNew, bool CrashIfDeallocating&gt;</span><br><span class="line"><span class="keyword">static</span> id storeWeak(id *location, objc_object *<span class="keyword">new</span><span class="type">Obj</span>) &#123;</span><br><span class="line">    <span class="comment">// è¯¥è¿‡ç¨‹ç”¨æ¥æ›´æ–°å¼±å¼•ç”¨æŒ‡é’ˆçš„æŒ‡å‘</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– previouslyInitializedClass æŒ‡é’ˆ</span></span><br><span class="line">    Class previouslyInitializedClass = nil;</span><br><span class="line">    id oldObj;</span><br><span class="line">    <span class="comment">// å£°æ˜ä¸¤ä¸ª SideTable</span></span><br><span class="line">    <span class="comment">// â‘  æ–°æ—§æ•£åˆ—åˆ›å»º</span></span><br><span class="line">    SideTable *oldTable;</span><br><span class="line">    SideTable *<span class="keyword">new</span><span class="type">Table</span>;</span><br><span class="line">    <span class="comment">// è·å¾—æ–°å€¼å’Œæ—§å€¼çš„é”å­˜ä½ç½®ï¼ˆç”¨åœ°å€ä½œä¸ºå”¯ä¸€æ ‡ç¤ºï¼‰</span></span><br><span class="line">    <span class="comment">// é€šè¿‡åœ°å€æ¥å»ºç«‹ç´¢å¼•æ ‡å¿—ï¼Œé˜²æ­¢æ¡¶é‡å¤</span></span><br><span class="line">    <span class="comment">// ä¸‹é¢æŒ‡å‘çš„æ“ä½œä¼šæ”¹å˜æ—§å€¼</span></span><br><span class="line">retry:<span class="type"></span></span><br><span class="line"><span class="type">    if </span>(HaveOld) &#123;</span><br><span class="line">        <span class="comment">// æ›´æ”¹æŒ‡é’ˆï¼Œè·å¾—ä»¥ oldObj ä¸ºç´¢å¼•æ‰€å­˜å‚¨çš„å€¼åœ°å€</span></span><br><span class="line">        oldObj = *location;</span><br><span class="line">        oldTable = &amp;SideTables()[oldObj];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        oldTable = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (HaveNew) &#123;</span><br><span class="line">        <span class="comment">// æ›´æ”¹æ–°å€¼æŒ‡é’ˆï¼Œè·å¾—ä»¥ newObj ä¸ºç´¢å¼•æ‰€å­˜å‚¨çš„å€¼åœ°å€</span></span><br><span class="line">        <span class="keyword">new</span><span class="type">Table</span> = &amp;SideTables()[<span class="keyword">new</span><span class="type">Obj</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">new</span><span class="type">Table</span> = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŠ é”æ“ä½œï¼Œé˜²æ­¢å¤šçº¿ç¨‹ä¸­ç«äº‰å†²çª</span></span><br><span class="line">    SideTable:<span class="type"></span>:lockTwoHaveOld, HaveNew&gt;(oldTable, <span class="keyword">new</span><span class="type">Table</span>);</span><br><span class="line">    <span class="comment">// é¿å…çº¿ç¨‹å†²çªé‡å¤„ç†</span></span><br><span class="line">    <span class="comment">// location åº”è¯¥ä¸ oldObj ä¿æŒä¸€è‡´ï¼Œå¦‚æœä¸åŒï¼Œè¯´æ˜å½“å‰çš„ location å·²ç»å¤„ç†è¿‡ oldObj å¯æ˜¯åˆè¢«å…¶ä»–çº¿ç¨‹æ‰€ä¿®æ”¹</span></span><br><span class="line">    <span class="keyword">if</span> (HaveOld  &amp;&amp;  *location != oldObj) &#123;</span><br><span class="line">        SideTable:<span class="type"></span>:unlockTwoHaveOld, HaveNew&gt;(oldTable, <span class="keyword">new</span><span class="type">Table</span>);</span><br><span class="line">        goto retry;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é˜²æ­¢å¼±å¼•ç”¨é—´æ­»é”</span></span><br><span class="line">    <span class="comment">// å¹¶ä¸”é€šè¿‡ +initialize åˆå§‹åŒ–æ„é€ å™¨ä¿è¯æ‰€æœ‰å¼±å¼•ç”¨çš„ isa éç©ºæŒ‡å‘</span></span><br><span class="line">    <span class="keyword">if</span> (HaveNew  &amp;&amp;  <span class="keyword">new</span><span class="type">Obj</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å¾—æ–°å¯¹è±¡çš„ isa æŒ‡é’ˆ</span></span><br><span class="line">        Class cls = <span class="keyword">new</span><span class="type">Obj</span>-&gt;getIsa();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ isa éç©ºä¸”å·²ç»åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (cls != previouslyInitializedClass  &amp;&amp;</span><br><span class="line">            !((objc_class *)cls)-&gt;isInitialized()) &#123;</span><br><span class="line">            <span class="comment">// è§£é”</span></span><br><span class="line">            SideTable:<span class="type"></span>:unlockTwoHaveOld, HaveNew&gt;(oldTable, <span class="keyword">new</span><span class="type">Table</span>);</span><br><span class="line">            <span class="comment">// å¯¹å…¶ isa æŒ‡é’ˆè¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">            _class_initialize(_class_getNonMetaClass(cls, (id)<span class="keyword">new</span><span class="type">Obj</span>));</span><br><span class="line">            <span class="comment">// å¦‚æœè¯¥ç±»å·²ç»å®Œæˆæ‰§è¡Œ +initialize æ–¹æ³•æ˜¯æœ€ç†æƒ³æƒ…å†µ</span></span><br><span class="line">            <span class="comment">// å¦‚æœè¯¥ç±» +initialize åœ¨çº¿ç¨‹ä¸­</span></span><br><span class="line">            <span class="comment">// ä¾‹å¦‚ +initialize æ­£åœ¨è°ƒç”¨ storeWeak æ–¹æ³•</span></span><br><span class="line">            <span class="comment">// éœ€è¦æ‰‹åŠ¨å¯¹å…¶å¢åŠ ä¿æŠ¤ç­–ç•¥ï¼Œå¹¶è®¾ç½® previouslyInitializedClass æŒ‡é’ˆè¿›è¡Œæ ‡è®°</span></span><br><span class="line">            previouslyInitializedClass = cls;</span><br><span class="line">            <span class="comment">// é‡æ–°å°è¯•</span></span><br><span class="line">            goto retry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// â‘¡ æ¸…é™¤æ—§å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (HaveOld) &#123;</span><br><span class="line">        weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// â‘¢ åˆ†é…æ–°å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (HaveNew) &#123;</span><br><span class="line">        <span class="keyword">new</span><span class="type">Obj</span> = (objc_object *)weak_register_no_lock(&amp;<span class="keyword">new</span><span class="type">Table</span>-&gt;weak_table,</span><br><span class="line">                                                      (id)<span class="keyword">new</span><span class="type">Obj</span>, location,</span><br><span class="line">                                                      CrashIfDeallocating);</span><br><span class="line">        <span class="comment">// å¦‚æœå¼±å¼•ç”¨è¢«é‡Šæ”¾ weak_register_no_lock æ–¹æ³•è¿”å› nil</span></span><br><span class="line">        <span class="comment">// åœ¨å¼•ç”¨è®¡æ•°è¡¨ä¸­è®¾ç½®è‹¥å¼•ç”¨æ ‡è®°ä½</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span><span class="type">Obj</span>  &amp;&amp;  !<span class="keyword">new</span><span class="type">Obj</span>-&gt;isTaggedPointer()) &#123;</span><br><span class="line">            <span class="comment">// å¼±å¼•ç”¨ä½åˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">            <span class="comment">// å¼•ç”¨è®¡æ•°é‚£å¼ æ•£åˆ—è¡¨çš„weakå¼•ç”¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸­æ ‡è¯†ä¸ºweakå¼•ç”¨</span></span><br><span class="line">            <span class="keyword">new</span><span class="type">Obj</span>-&gt;setWeaklyReferenced_nolock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¹‹å‰ä¸è¦è®¾ç½® location å¯¹è±¡ï¼Œè¿™é‡Œéœ€è¦æ›´æ”¹æŒ‡é’ˆæŒ‡å‘</span></span><br><span class="line">        *location = (id)<span class="keyword">new</span><span class="type">Obj</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰æ–°å€¼ï¼Œåˆ™æ— éœ€æ›´æ”¹</span></span><br><span class="line">    &#125;</span><br><span class="line">    SideTable:<span class="type"></span>:unlockTwoHaveOld, HaveNew&gt;(oldTable, <span class="keyword">new</span><span class="type">Table</span>);</span><br><span class="line">    <span class="keyword">return</span> (id)<span class="keyword">new</span><span class="type">Obj</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ’‡å¼€æºç ä¸­å„ç§é”æ“ä½œï¼Œæ¥çœ‹çœ‹è¿™æ®µä»£ç éƒ½åšäº†äº›ä»€ä¹ˆï¼Ÿ</p><p>1ï¼‰ã€SideTable<br>SideTableè¿™ä¸ªç»“æ„ä½“ï¼Œæˆ‘ç»™ä»–èµ·åå¼•ç”¨è®¡æ•°å’Œå¼±å¼•ç”¨ä¾èµ–è¡¨ï¼Œå› ä¸ºå®ƒä¸»è¦ç”¨äºç®¡ç†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å’Œweakè¡¨ã€‚åœ¨NSObject.mmä¸­å£°æ˜å…¶æ•°æ®ç»“æ„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SideTable</span> &#123;</span></span><br><span class="line">  <span class="comment">// ä¿è¯åŸå­æ“ä½œçš„è‡ªæ—‹é”</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> slock;</span><br><span class="line">    <span class="comment">// å¼•ç”¨è®¡æ•°çš„ hash è¡¨</span></span><br><span class="line">    RefcountMap refcnts;</span><br><span class="line">    <span class="comment">// weak å¼•ç”¨å…¨å±€ hash è¡¨</span></span><br><span class="line">    <span class="keyword">weak_table_t</span> weak_table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºslockå’Œrefcntsä¸¤ä¸ªæˆå‘˜ä¸ç”¨å¤šè¯´ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä¸ºäº†é˜²æ­¢ç«äº‰é€‰æ‹©çš„è‡ªæ—‹é”ï¼Œç¬¬äºŒä¸ªæ˜¯ååŠ©å¯¹è±¡çš„isaæŒ‡é’ˆçš„extra_rcå…±åŒå¼•ç”¨è®¡æ•°çš„å˜é‡ã€‚è¿™é‡Œä¸»è¦çœ‹weakå…¨å±€hashè¡¨çš„ç»“æ„ä¸ä½œç”¨ã€‚</p><p>2)ã€weakè¡¨<br>weakè¡¨æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨è¡¨ï¼Œå®ç°ä¸ºä¸€ä¸ªweak_table_tç»“æ„ä½“ï¼Œå­˜å‚¨äº†æŸä¸ªå¯¹è±¡ç›¸å…³çš„æ‰€æœ‰çš„å¼±å¼•ç”¨ä¿¡æ¯ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼ˆå…·ä½“å®šä¹‰åœ¨objc_weak.hä¸­ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Â Â Â <span class="class"><span class="keyword">struct</span>Â <span class="title">weak_table_t</span>Â &#123;</span></span><br><span class="line">Â Â Â Â <span class="comment">//Â ä¿å­˜äº†æ‰€æœ‰æŒ‡å‘æŒ‡å®šå¯¹è±¡çš„Â weakÂ æŒ‡é’ˆ</span></span><br><span class="line">Â Â Â Â <span class="keyword">weak_entry_t</span>Â *weak_entries;</span><br><span class="line">Â Â Â Â <span class="comment">//Â å­˜å‚¨ç©ºé—´</span></span><br><span class="line">Â Â Â Â <span class="keyword">size_t</span>Â Â Â Â num_entries;</span><br><span class="line">Â Â Â Â <span class="comment">//Â å‚ä¸åˆ¤æ–­å¼•ç”¨è®¡æ•°è¾…åŠ©é‡</span></span><br><span class="line">Â Â Â Â <span class="keyword">uintptr_t</span>Â mask;</span><br><span class="line">Â Â Â Â <span class="comment">//Â hashÂ keyÂ æœ€å¤§åç§»å€¼</span></span><br><span class="line">Â Â Â Â <span class="keyword">uintptr_t</span>Â max_hash_displacement;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªå…¨å±€å¼±å¼•ç”¨hashè¡¨ã€‚ä½¿ç”¨ä¸å®šç±»å‹å¯¹è±¡çš„åœ°å€ä½œä¸ºkeyï¼Œç”¨weak_entry_tç±»å‹ç»“æ„ä½“å¯¹è±¡ä½œä¸ºvalueã€‚å…¶ä¸­çš„weak_entriesæˆå‘˜ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹ï¼Œå³ä¸ºå¼±å¼•ç”¨è¡¨å…¥å£ã€‚å…¶å®ç°ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚</p><p>å…¶ä¸­weak_entry_tæ˜¯å­˜å‚¨åœ¨å¼±å¼•ç”¨è¡¨ä¸­çš„ä¸€ä¸ªå†…éƒ¨ç»“æ„ä½“ï¼Œå®ƒè´Ÿè´£ç»´æŠ¤å’Œå­˜å‚¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å¼±å¼•ç”¨hashè¡¨ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> objc_object ** <span class="keyword">weak_referrer_t</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">weak_entry_t</span> &#123;</span></span><br><span class="line">    DisguisedPtrobjc_object&gt; referent;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="keyword">weak_referrer_t</span> *referrers;</span><br><span class="line">            <span class="keyword">uintptr_t</span>        out_of_line : <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">uintptr_t</span>        num_refs : PTR_MINUS_1;</span><br><span class="line">            <span class="keyword">uintptr_t</span>        mask;</span><br><span class="line">            <span class="keyword">uintptr_t</span>        max_hash_displacement;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="comment">// out_of_line=0 is LSB of one of these (don't care which)</span></span><br><span class="line">            <span class="keyword">weak_referrer_t</span>  inline_referrers[WEAK_INLINE_COUNT];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ weak_entry_t çš„ç»“æ„ä¸­ï¼ŒDisguisedPtr referent æ˜¯å¯¹æ³›å‹å¯¹è±¡çš„æŒ‡é’ˆåšäº†ä¸€ä¸ªå°è£…ï¼Œé€šè¿‡è¿™ä¸ªæ³›å‹ç±»æ¥è§£å†³å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚ä»æ³¨é‡Šä¸­å†™ out_of_line æˆå‘˜ä¸ºæœ€ä½æœ‰æ•ˆä½ï¼Œå½“å…¶ä¸º0çš„æ—¶å€™ï¼Œ weak_referrer_t æˆå‘˜å°†æ‰©å±•ä¸ºå¤šè¡Œé™æ€ hash tableã€‚å…¶å®å…¶ä¸­çš„ weak_referrer_t æ˜¯äºŒç»´ objc_object çš„åˆ«åï¼Œé€šè¿‡ä¸€ä¸ªäºŒç»´æŒ‡é’ˆåœ°å€åç§»ï¼Œç”¨ä¸‹æ ‡ä½œä¸º hash çš„ keyï¼Œåšæˆäº†ä¸€ä¸ªå¼±å¼•ç”¨æ•£åˆ—ã€‚</p><p>é‚£ä¹ˆåœ¨æœ‰æ•ˆä½æœªç”Ÿæ•ˆçš„æ—¶å€™ï¼Œout_of_line ã€ num_refsã€ mask ã€ max_hash_displacement æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿä»¥ä¸‹æ˜¯ç¬”è€…è‡ªèº«çš„çŒœæµ‹ï¼š</p><p>out_of_lineï¼šæœ€ä½æœ‰æ•ˆä½ï¼Œä¹Ÿæ˜¯æ ‡å¿—ä½ã€‚å½“æ ‡å¿—ä½ 0 æ—¶ï¼Œå¢åŠ å¼•ç”¨è¡¨æŒ‡é’ˆçº¬åº¦ã€‚</p><p>num_refsï¼šå¼•ç”¨æ•°å€¼ã€‚è¿™é‡Œè®°å½•å¼±å¼•ç”¨è¡¨ä¸­å¼•ç”¨æœ‰æ•ˆæ•°å­—ï¼Œå› ä¸ºå¼±å¼•ç”¨è¡¨ä½¿ç”¨çš„æ˜¯é™æ€ hash ç»“æ„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨å˜é‡æ¥è®°å½•æ•°ç›®ã€‚</p><p>maskï¼šè®¡æ•°è¾…åŠ©é‡ã€‚</p><p>max_hash_displacementï¼šhash å…ƒç´ ä¸Šé™é˜€å€¼ã€‚</p><p>å…¶å® out_of_line çš„å€¼é€šå¸¸æƒ…å†µä¸‹æ˜¯ç­‰äºé›¶çš„ï¼Œæ‰€ä»¥å¼±å¼•ç”¨è¡¨æ€»æ˜¯ä¸€ä¸ª objc_objective æŒ‡é’ˆäºŒç»´æ•°ç»„ã€‚ä¸€ç»´ objc_objective æŒ‡é’ˆå¯æ„æˆä¸€å¼ å¼±å¼•ç”¨æ•£åˆ—è¡¨ï¼Œé€šè¿‡ç¬¬ä¸‰çº¬åº¦å®ç°äº†å¤šå¼ æ•£åˆ—è¡¨ï¼Œå¹¶ä¸”è¡¨æ•°é‡ä¸º WEAK_INLINE_COUNT ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ StripedMap[] ï¼š StripedMap æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œåœ¨è¿™ä¸ªç±»ä¸­æœ‰ä¸€ä¸ª array æˆå‘˜ï¼Œç”¨æ¥å­˜å‚¨ PaddedT å¯¹è±¡ï¼Œå¹¶ä¸”å…¶ä¸­å¯¹äº [] ç¬¦çš„é‡è½½å®šä¹‰ä¸­ï¼Œä¼šè¿”å›è¿™ä¸ª PaddedT çš„ value æˆå‘˜ï¼Œè¿™ä¸ª value å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ T æ³›å‹æˆå‘˜ï¼Œä¹Ÿå°±æ˜¯ SideTable å¯¹è±¡ã€‚åœ¨ array çš„ä¸‹æ ‡ä¸­ï¼Œè¿™é‡Œä½¿ç”¨äº† indexForPointer æ–¹æ³•é€šè¿‡ä½è¿ç®—è®¡ç®—ä¸‹æ ‡ï¼Œå®ç°äº†é™æ€çš„ Hash Tableã€‚è€Œåœ¨ weak_table ä¸­ï¼Œå…¶æˆå‘˜ weak_entry ä¼šå°†ä¼ å…¥å¯¹è±¡çš„åœ°å€åŠ ä»¥å°è£…èµ·æ¥ï¼Œå¹¶ä¸”å…¶ä¸­ä¹Ÿæœ‰è®¿é—®å…¨å±€å¼±å¼•ç”¨è¡¨çš„å…¥å£ã€‚</p><p><img src="http://p9u62mso1.bkt.clouddn.com/r_weak02.png" alt=""></p><p><strong><em>æ—§å¯¹è±¡è§£é™¤æ³¨å†Œæ“ä½œ weak_unregister_no_lock</em></strong></p><p>è¯¥æ–¹æ³•ä¸»è¦ä½œç”¨æ˜¯å°†æ—§å¯¹è±¡åœ¨ weak_table ä¸­æ¥è§¦ weak æŒ‡é’ˆçš„å¯¹åº”ç»‘å®šã€‚æ ¹æ®å‡½æ•°åï¼Œç§°ä¹‹ä¸ºè§£é™¤æ³¨å†Œæ“ä½œã€‚ä»æºç ä¸­ï¼Œå¯ä»¥çŸ¥é“å…¶åŠŸèƒ½å°±æ˜¯ä» weak_table ä¸­æ¥è§¦ weak æŒ‡é’ˆçš„ç»‘å®šã€‚è€Œå…¶ä¸­çš„éå†æŸ¥è¯¢ï¼Œå°±æ˜¯é’ˆå¯¹äº weak_entry ä¸­çš„å¤šå¼ å¼±å¼•ç”¨æ•£åˆ—è¡¨ã€‚</p><p><strong><em>æ–°å¯¹è±¡æ·»åŠ æ³¨å†Œæ“ä½œ weak_register_no_lock</em></strong></p><p>è¿™ä¸€æ­¥ä¸ä¸Šä¸€æ­¥ç›¸åï¼Œé€šè¿‡ weak_register_no_lock å‡½æ•°æŠŠå¿ƒçš„å¯¹è±¡è¿›è¡Œæ³¨å†Œæ“ä½œï¼Œå®Œæˆä¸å¯¹åº”çš„å¼±å¼•ç”¨è¡¨è¿›è¡Œç»‘å®šæ“ä½œã€‚</p><p><strong><em>åˆå§‹åŒ–å¼±å¼•ç”¨å¯¹è±¡æµç¨‹ä¸€è§ˆ</em></strong></p><p>å¼±å¼•ç”¨çš„åˆå§‹åŒ–ï¼Œä»ä¸Šæ–‡çš„åˆ†æä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸»è¦çš„æ“ä½œéƒ¨åˆ†å°±åœ¨å¼±å¼•ç”¨è¡¨çš„å–é”®ã€æŸ¥è¯¢æ•£åˆ—ã€åˆ›å»ºå¼±å¼•ç”¨è¡¨ç­‰æ“ä½œï¼Œå¯ä»¥æ€»ç»“å‡ºå¦‚ä¸‹çš„æµç¨‹å›¾ï¼š</p><p><img src="http://p9u62mso1.bkt.clouddn.com/r_weak01.png" alt=""></p><p>è¿™ä¸ªå›¾ä¸­çœç•¥äº†å¾ˆå¤šæƒ…å†µçš„åˆ¤æ–­ï¼Œä½†æ˜¯å½“å£°æ˜ä¸€ä¸ª weak ä¼šè°ƒç”¨ä¸Šå›¾ä¸­çš„è¿™äº›æ–¹æ³•ã€‚å½“ç„¶ï¼Œ storeWeak æ–¹æ³•ä¸ä»…ä»…ç”¨åœ¨ weak çš„å£°æ˜ä¸­ï¼Œåœ¨ class å†…éƒ¨çš„æ“ä½œä¸­ä¹Ÿä¼šå¸¸å¸¸é€šè¿‡è¯¥æ–¹æ³•æ¥å¯¹ weak å¯¹è±¡è¿›è¡Œæ“ä½œã€‚</p><p><strong>3ã€é‡Šæ”¾æ—¶ï¼Œè°ƒç”¨clearDeallocatingå‡½æ•°ã€‚clearDeallocatingå‡½æ•°é¦–å…ˆæ ¹æ®å¯¹è±¡åœ°å€è·å–æ‰€æœ‰weakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ï¼Œç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå…¶ä¸­çš„æ•°æ®è®¾ä¸ºnilï¼Œæœ€åæŠŠè¿™ä¸ªentryä»weakè¡¨ä¸­åˆ é™¤ï¼Œæœ€åæ¸…ç†å¯¹è±¡çš„è®°å½•ã€‚</strong></p><p><strong><em>å½“weakå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œåˆæ˜¯å¦‚ä½•å»å¤„ç†weakæŒ‡é’ˆçš„å‘¢ï¼Ÿå½“é‡Šæ”¾å¯¹è±¡æ—¶ï¼Œå…¶åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</em></strong></p><p>1.è°ƒç”¨objc_release<br>2.å› ä¸ºå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º0ï¼Œæ‰€ä»¥æ‰§è¡Œdealloc<br>3.åœ¨deallocä¸­ï¼Œè°ƒç”¨äº†_objc_rootDeallocå‡½æ•°<br>4.åœ¨_objc_rootDeallocä¸­ï¼Œè°ƒç”¨äº†object_disposeå‡½æ•°<br>5.è°ƒç”¨objc_destructInstance<br>6.æœ€åè°ƒç”¨objc_clear_deallocating</p><p>é‡ç‚¹çœ‹å¯¹è±¡è¢«é‡Šæ”¾æ—¶è°ƒç”¨çš„objc_clear_deallocatingå‡½æ•°ã€‚è¯¥å‡½æ•°å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>  objc_clear_deallocating(id obj) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">assert</span>(obj);</span><br><span class="line">    <span class="keyword">assert</span>(!UseGC);</span><br><span class="line">    <span class="keyword">if</span> (obj-&gt;isTaggedPointer()) <span class="keyword">return</span>;</span><br><span class="line">   obj-&gt;clearDeallocating();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è°ƒç”¨äº†clearDeallocatingï¼Œç»§ç»­è¿½è¸ªå¯ä»¥å‘ç°ï¼Œå®ƒæœ€ç»ˆæ˜¯ä½¿ç”¨äº†è¿­ä»£å™¨æ¥å–weakè¡¨çš„valueï¼Œç„¶åè°ƒç”¨weak_clear_no_lock,ç„¶åæŸ¥æ‰¾å¯¹åº”çš„valueï¼Œå°†è¯¥weakæŒ‡é’ˆç½®ç©ºï¼Œweak_clear_no_lockå‡½æ•°çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Called by dealloc; nils out all weak pointers that point to the</span></span><br><span class="line"><span class="comment"> * provided object so that they can no longer be used.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param weak_table</span></span><br><span class="line"><span class="comment"> * @param referent The object being deallocated.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">weak_clear_no_lock</span><span class="params">(<span class="keyword">weak_table_t</span> *weak_table, id referent_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line">    <span class="keyword">weak_entry_t</span> *entry = weak_entry_for_referent(weak_table, referent);</span><br><span class="line">    <span class="keyword">if</span> (entry == nil) &#123;</span><br><span class="line">        <span class="comment">/// XXX shouldn't happen, but does with mismatched CF/objc</span></span><br><span class="line">        <span class="comment">//printf("XXX no entry for clear deallocating %p\n", referent);</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// zero out references</span></span><br><span class="line">    <span class="keyword">weak_referrer_t</span> *referrers;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;out_of_line) &#123;</span><br><span class="line">        referrers = entry-&gt;referrers;</span><br><span class="line">        count = TABLE_SIZE(entry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        referrers = entry-&gt;inline_referrers;</span><br><span class="line">        count = WEAK_INLINE_COUNT;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">        objc_object **referrer = referrers[i];</span><br><span class="line">        <span class="keyword">if</span> (referrer) &#123;</span><br><span class="line">            <span class="keyword">if</span> (*referrer == referent) &#123;</span><br><span class="line">                *referrer = nil;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (*referrer) &#123;</span><br><span class="line">                _objc_inform(<span class="string">"__weak variable at %p holds %p instead of %p. "</span></span><br><span class="line">                             <span class="string">"This is probably incorrect use of "</span></span><br><span class="line">                             <span class="string">"objc_storeWeak() and objc_loadWeak(). "</span></span><br><span class="line">                             <span class="string">"Break on objc_weak_error to debug.\n"</span>,</span><br><span class="line">                             referrer, (<span class="keyword">void</span>*)*referrer, (<span class="keyword">void</span>*)referent);</span><br><span class="line">                objc_weak_error();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    weak_entry_remove(weak_table, entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>objc_clear_deallocatingè¯¥å‡½æ•°çš„åŠ¨ä½œå¦‚ä¸‹ï¼š<br>    a. ä»weakè¡¨ä¸­è·å–åºŸå¼ƒå¯¹è±¡çš„åœ°å€ä¸ºé”®å€¼çš„è®°å½•<br>    b. å°†åŒ…å«åœ¨è®°å½•ä¸­çš„æ‰€æœ‰é™„æœ‰weakä¿®é¥°ç¬¦å˜é‡çš„åœ°å€ï¼Œèµ‹å€¼ä¸ºnil<br>    c. å°†weakè¡¨ä¸­è¯¥è®°å½•åˆ é™¤<br>    d. ä»å¼•ç”¨è®¡æ•°è¡¨ä¸­åˆ é™¤åºŸå¼ƒå¯¹è±¡çš„åœ°å€ä¸ºé”®å€¼çš„è®°å½•</p><p>çœ‹äº†objc-weak.mmçš„æºç å°±æ˜ç™½äº†ï¼šå…¶å®Weakè¡¨æ˜¯ä¸€ä¸ªhashï¼ˆå“ˆå¸Œï¼‰è¡¨ï¼Œç„¶åé‡Œé¢çš„keyæ˜¯æŒ‡å‘å¯¹è±¡çš„åœ°å€ï¼ŒValueæ˜¯WeakæŒ‡é’ˆçš„åœ°å€çš„æ•°ç»„ã€‚</p><p>è¡¥å……ï¼š.må’Œ.mmçš„åŒºåˆ«</p><p>.mï¼šæºä»£ç æ–‡ä»¶ï¼Œè¿™ä¸ªå…¸å‹çš„æºä»£ç æ–‡ä»¶æ‰©å±•åï¼Œå¯ä»¥åŒ…å«OCå’ŒCä»£ç ã€‚</p><p>.mmï¼šæºä»£ç æ–‡ä»¶ï¼Œå¸¦æœ‰è¿™ç§æ‰©å±•åçš„æºä»£ç æ–‡ä»¶ï¼Œé™¤äº†å¯ä»¥åŒ…å«OCå’ŒCä»£ç ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åŒ…å«C++ä»£ç ã€‚ä»…åœ¨ä½ çš„OCä»£ç ä¸­ç¡®å®éœ€è¦ä½¿ç”¨C++ç±»æˆ–è€…ç‰¹æ€§çš„æ—¶å€™æ‰ç”¨è¿™ç§æ‰©å±•åã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;weak&quot;&gt;&lt;a href=&quot;#weak&quot; class=&quot;headerlink&quot; title=&quot;weak&quot;&gt;&lt;/a&gt;weak&lt;/h2&gt;&lt;p&gt;weakä¸è®ºæ˜¯ç”¨ä½œpropertyä¿®é¥°ç¬¦è¿˜æ˜¯ç”¨æ¥ä¿®é¥°ä¸€ä¸ªå˜é‡çš„å£°æ˜å…¶ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯ä¸
      
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="runtime" scheme="http://yoursite.com/tags/runtime/"/>
    
  </entry>
  
  <entry>
    <title>runtimeç³»åˆ—ä¹‹ï¼ˆ4ï¼‰@property</title>
    <link href="http://yoursite.com/2018/06/10/runtime%E7%B3%BB%E5%88%97%E4%B9%8B%EF%BC%884%EF%BC%89@property/"/>
    <id>http://yoursite.com/2018/06/10/runtimeç³»åˆ—ä¹‹ï¼ˆ4ï¼‰@property/</id>
    <published>2018-06-10T13:16:23.000Z</published>
    <updated>2019-03-25T06:53:15.240Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="propertyä¿®é¥°ç¬¦"><a href="#propertyä¿®é¥°ç¬¦" class="headerlink" title="@propertyä¿®é¥°ç¬¦"></a>@propertyä¿®é¥°ç¬¦</h2><ul><li>atomic nonatomic</li><li>readwrite readonly</li><li>retain</li><li>assign</li><li>copy</li><li>strong</li><li>weak</li><li>unsafe_unretained</li><li>autoreleasing</li><li>setter getter</li></ul><p><strong>atomic nonatomic</strong><br><code>atomic</code>ï¼ˆé»˜è®¤å‚æ•°ï¼‰ï¼šåŸå­æ€§ï¼Œæ€§èƒ½ä½ï¼ˆä¸€èˆ¬å¼€å‘OCä¸­çš„APPä¸æ¨èä½¿ç”¨ï¼Œåšé‡‘èç­‰è¦æ±‚é«˜å®‰å…¨çš„æ—¶å€™ä½¿ç”¨ï¼‰</p><p>ï¼ˆåŸå­æ€§æ“ä½œï¼‰ï¼Œä¼šè¢«åŠ é”ï¼Œå°±æ˜¯ä¸€ä¸ªæ“ä½œæ‰§è¡Œè¿‡ç¨‹ä¸èƒ½è¢«ä¸­æ–­ï¼Œè¦ä¸å°±æ‰§è¡Œå®Œï¼Œè¦ä¸å°±ä¸æ‰§è¡Œï¼ˆä¸€ä¸ªæ“ä½œä¸å¯ä»¥åœ¨ä¸­é€”è¢«CPUæš‚åœç„¶åè°ƒåº¦ï¼‰ã€‚å¦‚æœä¸€ä¸ªæ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œé‚£ä¹ˆåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå°±ä¸ä¼šå‡ºç°å˜é‡è¢«ä¿®æ”¹ç­‰å¥‡æ€ªçš„é—®é¢˜ï¼ˆä¿è¯æ•°æ®åŒæ­¥ï¼‰ã€‚åŸå­æ“ä½œå°±æ˜¯ä¸å¯å†åˆ†çš„æ“ä½œï¼Œåœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­åŸå­æ“ä½œæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒå¸¸å¸¸ç”¨æ¥å®ç°ä¸€äº›åŒæ­¥æœºåˆ¶ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€äº›å¸¸è§çš„å¤šçº¿ç¨‹bugçš„æºå¤´ã€‚</p><p><code>nonatomic</code>ï¼šéåŸå­æ€§ï¼Œæ€§èƒ½é«˜ï¼ˆæ¨èä½¿ç”¨ï¼Œæ€§èƒ½é«˜ï¼‰</p><p>ï¼ˆéåŸå­æ€§æ“ä½œï¼‰æ“ä½œæ˜¯ç›´æ¥ä»å†…å­˜ä¸­å–æ•°å€¼ï¼ˆä¸è€ƒè™‘å…¶æ˜¯å¦è¢«å ç”¨ï¼‰ã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½æé«˜æ€§èƒ½ï¼Œä½†æ— æ³•ä¿è¯æ•°æ®åŒæ­¥ã€‚</p><p><strong>readwrite readonly</strong><br><code>readwrite</code>æ˜¯ç¼–è¯‘å™¨çš„é»˜è®¤é€‰é¡¹ï¼Œä¾¿æ˜¯è‡ªåŠ¨ç”Ÿæˆ<code>getter</code>å’Œ<code>setter</code>ï¼Œå¦‚æœéœ€è¦<code>getter</code>å’Œ<code>setter</code>ä¸å†™å³å¯ã€‚<br><code>readonly</code>è¡¨ç¤ºåªä¼šåˆæˆ<code>getter</code>è€Œä¸åˆæˆ<code>setter</code>ã€‚</p><p><strong>assign weak unsafe_unretained</strong><br><code>assign</code>è¡¨ç¤ºå¯¹å±æ€§åªè¿›è¡Œç®€å•çš„èµ‹å€¼æ“ä½œï¼Œä¸æ›´æ”¹æ‰€èµ‹å€¼çš„å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸æ”¹å˜æ—§çš„å¼•ç”¨è®¡æ•°ï¼Œå¸¸ç”¨äºæ ‡é‡ç±»å‹ï¼Œå¦‚<code>NSInteger</code> <code>NSUInteger</code> <code>CGFloat</code> <code>NSTimerInterval</code>ç­‰ã€‚</p><p><code>assign</code>ä¹Ÿå¯ä»¥ä¿®é¥°å¯¹è±¡å¦‚<code>NSString</code>ç­‰ç±»å‹å¯¹è±¡ï¼Œä¸Šé¢è¯´è¿‡ä½¿ç”¨<code>assign</code>ä¿®é¥°ä¸ä¼šæ›´æ”¹æ‰€èµ‹çš„æ–°å€¼çš„å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸æ”¹å˜æ—§å€¼çš„å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœå½“æ‰€èµ‹çš„æ–°å€¼å¼•ç”¨è®¡æ•°ä¸º0å¯¹è±¡è¢«é”€æ¯æ—¶å±æ€§å¹¶ä¸çŸ¥é“ï¼Œç¼–è¯‘å™¨ä¸ä¼šå°†è¯¥å±æ€§ç½®ä¸º<code>nil</code>ï¼ŒæŒ‡é’ˆä»æ—§æŒ‡å‘ä¹‹å‰è¢«é”€æ¯çš„å†…å­˜ï¼Œè¿™æ—¶è®¿é—®è¯¥å±æ€§ä¼šäº§ç”Ÿé‡æŒ‡é’ˆé”™è¯¯å¹¶å´©æºƒï¼Œå› æ­¤ä½¿ç”¨<code>assign</code>ä¿®é¥°çš„ç±»å‹ä¸€å®šè¦ä¸ºæ ‡é‡ç±»å‹ã€‚</p><p>ä½¿ç”¨<code>weak</code>ä¿®é¥°çš„æ—¶å€™åŒæ ·ä¸ä¼šå¢åŠ æ‰€èµ‹æ–°å€¼çš„å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸ä¼šå‡å°‘æ—§å€¼çš„å¼•ç”¨è®¡æ•°ï¼Œä½†å½“è¯¥å€¼è¢«é”€æ¯æ—¶ï¼Œ<code>weak</code>ä¿®é¥°çš„å±æ€§ä¼šè¢«è‡ªåŠ¨èµ‹å€¼ä¸º<code>nil</code>ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…é‡æŒ‡é’ˆé”™è¯¯ã€‚</p><p>ä½¿ç”¨<code>unsafe_unretained</code>ä¿®é¥°æ—¶æ•ˆæœä¸<code>assign</code>ç›¸åŒï¼Œä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå½“æ‰€èµ‹çš„å€¼è¢«é”€æ¯æ—¶ä¸ä¼šè¢«ç½®ä¸º<code>nil</code>å¯èƒ½ä¼šå‘ç”Ÿé‡æŒ‡é’ˆé”™è¯¯ã€‚<code>unsafe_unretained</code>ä¸<code>assign</code>çš„åŒºåˆ«åœ¨äºï¼Œ<code>unsafe_unretained</code>åªèƒ½ä¿®é¥°å¯¹è±¡ï¼Œä¸èƒ½ä¿®é¥°æ ‡é‡ç±»å‹ï¼Œè€Œ<code>assign</code>ä¸¤è€…å‡å¯ä¿®é¥°ã€‚</p><p><strong>strong weak</strong><br><code>strong</code>è¡¨ç¤ºå±æ€§å¯¹æ‰€èµ‹çš„å€¼æŒæœ‰å¼ºå¼•ç”¨è¡¨ç¤ºä¸€ç§â€œæ‹¥æœ‰å…³ç³»â€ï¼ˆowing relationshipï¼‰ï¼Œä¼šå…ˆä¿ç•™æ–°å€¼å³å¢åŠ æ–°å€¼çš„å¼•ç”¨è®¡æ•°ï¼Œç„¶åå†é‡Šæ”¾æ—§å€¼å³å‡å°‘æ—§å€¼çš„å¼•ç”¨è®¡æ•°ã€‚åªèƒ½ä¿®é¥°å¯¹è±¡ã€‚å¦‚æœå¯¹ä¸€äº›å¯¹è±¡éœ€è¦ä¿æŒå¼ºå¼•ç”¨åˆ™ä½¿ç”¨<code>strong</code>ã€‚</p><p><code>weak</code>è¡¨ç¤ºå¯¹æ‰€èµ‹çš„å€¼å¯¹è±¡æŒæœ‰å¼±å¼•ç”¨è¡¨ç¤ºä¸€ç§â€œéæ‹¥æœ‰å…³ç³»â€(nonowning relationship)ï¼Œå¯¹æ–°å€¼ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸ä¼šå‡å°‘æ—§å€¼çš„å¼•ç”¨è®¡æ•°ã€‚æ‰€èµ‹çš„å€¼åœ¨å¼•ç”¨è®¡æ•°ä¸º0è¢«é”€æ¯åï¼Œ<code>weak</code>ä¿®é¥°çš„å±æ€§ä¼šè¢«è‡ªåŠ¨ç½®ä¸º<code>nil</code>èƒ½å¤Ÿæœ‰æ•ˆé˜²æ­¢é‡æŒ‡é’ˆé”™è¯¯ã€‚<br><code>weak</code>å¸¸ç”¨åœ¨ä¿®é¥°<code>delegate</code>ç­‰é˜²æ­¢å¾ªç¯å¼•ç”¨çš„åœºæ™¯ã€‚</p><p><strong>copy</strong><br><code>copy</code>ä¿®é¥°çš„å±æ€§ä¼šåœ¨å†…å­˜é‡Œæ‹·è´ä¸€ä»½å¯¹è±¡ï¼Œä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸åŒçš„å†…å­˜åœ°å€ã€‚<br>ä¸€èˆ¬ç”¨æ¥ä¿®é¥°æœ‰å¯¹åº”å¯å˜ç±»å‹å­ç±»çš„å¯¹è±¡ã€‚<br>å¦‚ï¼š<code>NSString/NSMutableString</code> <code>NSArray/NSMutableArray</code> <code>NSDictionary/NSMutableDictionary</code>ç­‰ã€‚<br>ä¸ºç¡®ä¿è¿™äº›ä¸å¯å˜å¯¹è±¡å› ä¸ºå¯å˜å­ç±»å¯¹è±¡å½±å“ï¼Œéœ€è¦<code>copy</code>ä¸€ä»½å¤‡ä»½ï¼Œå¦‚æœä¸ä½¿ç”¨<code>copy</code>ä¿®é¥°ï¼Œä½¿ç”¨<code>strong</code>æˆ–è€…<code>assign</code>ç­‰ä¿®é¥°åˆ™ä¼šå› ä¸ºå¤šæ€å¯¼è‡´å±æ€§å€¼è¢«ä¿®æ”¹ã€‚<br>è¿™é‡Œçš„<code>copy</code>è¿˜ç‰µæ‰¯åˆ°<code>NSCopying</code>å’Œ<code>NSMutableCopying</code>åè®®ã€‚</p><p><code>copy</code>è¿˜è¢«ç”¨æ¥ä¿®é¥°<code>block</code>ï¼Œåœ¨ARCç¯å¢ƒä¸‹ç¼–è¯‘å™¨é»˜è®¤ä¼šç”¨<code>copy</code>ä¿®é¥°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åœ¨<code>block</code>éœ€è¦æ•è·å¤–ç•Œæ•°æ®æ—¶è¯¥<code>block</code>å°±ä¼šè¢«åˆ†é…åœ¨å †åŒºï¼Œä½†åœ¨MRCç¯å¢ƒä¸‹ç”±äºæ‰‹åŠ¨ç®¡ç†å¼•ç”¨è®¡æ•°ï¼Œ<code>block</code>ä¸€èˆ¬è¢«åˆ†é…åœ¨æ ˆåŒºï¼Œéœ€è¦<code>copy</code>åˆ°å †åŒºæ¥é˜²æ­¢é‡æŒ‡é’ˆé”™è¯¯ã€‚æœ‰ä¸€ä¸ªæ —å­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨copyä¿®é¥°NSMutableString</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSMutableString</span>* name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSUInteger</span> age;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@synthesize</span> name = _name;</span><br><span class="line"><span class="keyword">@synthesize</span> age = _age;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        Person *p = [[Person alloc] init];</span><br><span class="line">        <span class="built_in">NSMutableString</span> *s = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"Jiaming Chen"</span>];</span><br><span class="line">        <span class="comment">//å°†å¯å˜å­—ç¬¦ä¸²èµ‹å€¼ç»™p.name</span></span><br><span class="line">        p.name = s;</span><br><span class="line">        <span class="comment">//è¾“å‡ºçš„åœ°å€ä¸ä¸€è‡´ï¼Œå†…å®¹ä¸€è‡´</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %@ %@"</span>, p.name, s, p.name, s);</span><br><span class="line">        <span class="comment">//ä¿®æ”¹p.nameï¼Œæ­¤æ—¶æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        [p.name appendString:<span class="string">@" is a good guy."</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ —å­ä½¿ç”¨<code>copy</code>ä¿®é¥°å¯å˜å¯¹è±¡ï¼Œåœ¨è¿›è¡Œèµ‹å€¼çš„æ—¶å€™ä¼šé€šè¿‡<code>copy</code>æ–¹æ³•è·å–ä¸€ä¸ªä¸å¯å˜å¯¹è±¡ï¼Œå› æ­¤<code>p.name</code>çš„åœ°å€å’Œ<code>s</code>çš„åœ°å€ä¸åŒï¼Œè€Œ<code>p.name</code>è¿è¡Œæ—¶ç±»å‹ä¸º<code>NSString</code>ï¼Œè°ƒç”¨<code>appendString:</code>æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><p>æ‰€ä»¥ï¼Œé’ˆå¯¹ä¸å¯å˜å¯¹è±¡ä½¿ç”¨<code>copy</code>ä¿®é¥°ï¼Œé’ˆå¯¹å¯å˜å¯¹è±¡ä½¿ç”¨<code>strong</code>ä¿®é¥°ã€‚</p><p><strong>retain</strong><br>åœ¨ARCç¯å¢ƒä¸‹ä½¿ç”¨è¾ƒå°‘ï¼Œåœ¨MRCä¸‹ä½¿ç”¨æ•ˆæœä¸<code>strong</code>ä¸€è‡´ã€‚</p><h2 id="copyé¢˜å¤–è¯"><a href="#copyé¢˜å¤–è¯" class="headerlink" title="copyé¢˜å¤–è¯"></a>copyé¢˜å¤–è¯</h2><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦<code>copy</code>ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ–æ˜¯<code>mutableCopy</code>ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ—¶éœ€è¦éµå®ˆ<code>NSCopying</code>å’Œ<code>NSMutableCopying</code>åè®®ï¼Œæ¥å®ç°<code>copyWithZone:</code>å’Œ<code>mutableCopyWithZone:</code>ä¸¤ä¸ªæ–¹æ³•ï¼Œè€Œä¸æ˜¯é‡å†™<code>copy</code>å’Œ<code>mutableCopy</code>ä¸¤ä¸ªæ–¹æ³•ã€‚</p><p>Foundationæ¡†æ¶ä¸­çš„å¾ˆå¤šæ•°æ®ç±»å‹å·²ç»å¸®æˆ‘ä»¬å®ç°äº†ä¸Šè¿°ä¸¤ä¸ªæ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>copy</code>æ–¹æ³•å’Œ<code>mutableCopy</code>æ–¹æ³•æ¥å¤åˆ¶ä¸€ä¸ªå¯¹è±¡ï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äº<code>copy</code>çš„è¿”å›å€¼ä»æœªä¸å¯å˜å¯¹è±¡ï¼Œ<code>mutableCopy</code>çš„è¿”å›å€¼ä¸ºå¯å˜å¯¹è±¡ã€‚</p><table><thead><tr><th>type</th><th>copy</th><th>mutableCopy</th></tr></thead><tbody><tr><td>NS*</td><td>æµ…æ‹·è´ï¼Œåªæ‹·è´æŒ‡é’ˆï¼Œåœ°å€ç›¸åŒ</td><td>å•å±‚æ·±æ‹·è´ï¼Œæ‹·è´å†…å®¹ï¼Œåœ°å€ä¸åŒ</td></tr><tr><td>NSMutable*</td><td>å•å±‚æ·±æ‹·è´ï¼Œæ‹·è´å†…å®¹ï¼Œåœ°å€ä¸åŒ</td><td>å•å±‚æ·±æ‹·è´ï¼Œæ‹·è´å†…å®¹ï¼Œåœ°å€ä¸åŒ</td></tr></tbody></table><p>å¯¹äºä¸å¯å˜ç±»å‹ï¼Œä½¿ç”¨<code>copy</code>æ–¹æ³•æ—¶æ˜¯æµ…æ‹·è´ï¼Œåªæ‹·è´æŒ‡é’ˆï¼Œå› ä¸ºå†…å®¹æ˜¯ä¸ä¼šå˜åŒ–çš„ã€‚ä½¿ç”¨<code>mutableCopy</code>æ—¶ç”±äºè¿”å›å¯å˜å¯¹è±¡å› æ­¤éœ€è¦ä¸€ä»½æ‹·è´ï¼Œä¾›å…¶ä»–å¯¹è±¡ä½¿ç”¨ã€‚å¯¹äºå¯å˜ç±»å‹ï¼Œä¸ç®¡æ˜¯<code>copy</code>è¿˜æ˜¯<code>mutableCopy</code>å‡ä¼šè¿›è¡Œæ·±æ‹·è´ï¼Œæ‰€æŒ‡å‘æŒ‡é’ˆä¸åŒã€‚</p><p>å‰æ–‡ä»‹ç»<code>copy</code>ä¿®é¥°ç¬¦çš„æ—¶å€™è®²è¿‡ï¼Œåœ¨ä¿®é¥°<code>NSString</code>è¿™æ ·çš„ä¸å¯å˜å¯¹è±¡çš„æ—¶å€™ä½¿ç”¨<code>copy</code>ä¿®é¥°ï¼Œä½†å…¶å®å½“ç»™å¯¹è±¡èµ‹ä¸€ä¸ª<code>NSString</code>æ—¶ä»æ—§åªå¤åˆ¶äº†æŒ‡é’ˆè€Œä¸æ˜¯æ‹·è´å†…å®¹ï¼ŒåŸå› åŒä¸Šã€‚</p><h2 id="ä¸-propertyç›¸å…³çš„é—®é¢˜"><a href="#ä¸-propertyç›¸å…³çš„é—®é¢˜" class="headerlink" title="ä¸@propertyç›¸å…³çš„é—®é¢˜"></a>ä¸@propertyç›¸å…³çš„é—®é¢˜</h2><h3 id="1-propertyçš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿivarã€getterã€setteræ˜¯å¦‚ä½•ç”Ÿæˆå¹¶æ·»åŠ åˆ°è¿™ä¸ªç±»ä¸­çš„ï¼Ÿ"><a href="#1-propertyçš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿivarã€getterã€setteræ˜¯å¦‚ä½•ç”Ÿæˆå¹¶æ·»åŠ åˆ°è¿™ä¸ªç±»ä¸­çš„ï¼Ÿ" class="headerlink" title="1. @propertyçš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿivarã€getterã€setteræ˜¯å¦‚ä½•ç”Ÿæˆå¹¶æ·»åŠ åˆ°è¿™ä¸ªç±»ä¸­çš„ï¼Ÿ"></a>1. @propertyçš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿivarã€getterã€setteræ˜¯å¦‚ä½•ç”Ÿæˆå¹¶æ·»åŠ åˆ°è¿™ä¸ªç±»ä¸­çš„ï¼Ÿ</h3><p><strong>@propertyæœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">property</span><span class="title"> </span>= ivar + getter + setter</span><br></pre></td></tr></table></figure><p>ä¸‹é¢è§£é‡Šä¸‹ï¼š</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">â€å±æ€§â€ï¼ˆ<span class="keyword">property</span>ï¼‰æœ‰ä¸¤å¤§æ¦‚å¿µï¼šivarï¼ˆå®ä¾‹å˜é‡ï¼‰ã€å­˜å–æ–¹æ³•ï¼ˆaccess <span class="function"><span class="keyword">method</span> = <span class="title">getter</span> + <span class="title">setter</span>ï¼‰</span></span><br></pre></td></tr></table></figure><p>â€œå±æ€§â€ (property)ä½œä¸º Objective-C çš„ä¸€é¡¹ç‰¹æ€§ï¼Œä¸»è¦çš„ä½œç”¨å°±åœ¨äºå°è£…å¯¹è±¡ä¸­çš„æ•°æ®ã€‚ Objective-C å¯¹è±¡é€šå¸¸ä¼šæŠŠå…¶æ‰€éœ€è¦çš„æ•°æ®ä¿å­˜ä¸ºå„ç§å®ä¾‹å˜é‡ã€‚å®ä¾‹å˜é‡ä¸€èˆ¬é€šè¿‡â€œå­˜å–æ–¹æ³•â€(access method)æ¥è®¿é—®ã€‚å…¶ä¸­ï¼Œâ€œè·å–æ–¹æ³•â€ (getter)ç”¨äºè¯»å–å˜é‡å€¼ï¼Œè€Œâ€œè®¾ç½®æ–¹æ³•â€ (setter)ç”¨äºå†™å…¥å˜é‡å€¼ã€‚è¿™ä¸ªæ¦‚å¿µå·²ç»å®šå‹ï¼Œå¹¶ä¸”ç»ç”±â€œå±æ€§â€è¿™ä¸€ç‰¹æ€§è€Œæˆä¸º Objective-C 2.0 çš„ä¸€éƒ¨åˆ†ã€‚</p><p>è€Œåœ¨æ­£è§„çš„ Objective-C ç¼–ç é£æ ¼ä¸­ï¼Œå­˜å–æ–¹æ³•æœ‰ç€ä¸¥æ ¼çš„å‘½åè§„èŒƒã€‚<br>æ­£å› ä¸ºæœ‰äº†è¿™ç§ä¸¥æ ¼çš„å‘½åè§„èŒƒï¼Œæ‰€ä»¥ Objective-C è¿™é—¨è¯­è¨€æ‰èƒ½æ ¹æ®åç§°è‡ªåŠ¨åˆ›å»ºå‡ºå­˜å–æ–¹æ³•ã€‚å…¶å®ä¹Ÿå¯ä»¥æŠŠå±æ€§å½“åšä¸€ç§å…³é”®å­—ï¼Œå…¶è¡¨ç¤º:</p><blockquote><p>ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å†™å‡ºä¸€å¥—å­˜å–æ–¹æ³•ï¼Œç”¨ä»¥è®¿é—®ç»™å®šç±»å‹ä¸­å…·æœ‰ç»™å®šåç§°çš„å˜é‡ã€‚<br>æ‰€ä»¥ä½ ä¹Ÿå¯ä»¥è¿™ä¹ˆè¯´ï¼š<br>@property = getter + setter;</p></blockquote><p>ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªç±»ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> NSString *firstNamel;</span><br><span class="line"><span class="variable">@property</span> NSString *lastNamel;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å†™å‡ºæ¥çš„ç±»ä¸ä¸‹é¢è¿™ç§å†™æ³•ç­‰æ•ˆï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></span><br><span class="line">- (<span class="built_in">NSString</span> *)firstName;</span><br><span class="line">- (<span class="keyword">void</span>)setFirstName:(<span class="built_in">NSString</span> *)firstName;</span><br><span class="line">- (<span class="built_in">NSString</span> *)lastName;</span><br><span class="line">- (<span class="keyword">void</span>)setLastName:(<span class="built_in">NSString</span> *)lastName;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p><strong>ivarã€getterã€setteræ˜¯å¦‚ä½•ç”Ÿæˆå¹¶æ·»åŠ åˆ°è¿™ä¸ªç±»ä¸­çš„ï¼Ÿ</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">â€œè‡ªåŠ¨åˆæˆâ€ï¼ˆautosynthesisï¼‰</span><br></pre></td></tr></table></figure><p>å®Œæˆå±æ€§å®šä¹‰åï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç¼–å†™è®¿é—®è¿™äº›å±æ€§æ‰€éœ€çš„æ–¹æ³•ï¼Œæ­¤è¿‡ç¨‹å«åšâ€œè‡ªåŠ¨åˆæˆâ€(autosynthesis)ã€‚éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œè¿™ä¸ªè¿‡ç¨‹ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸæ‰§è¡Œï¼Œæ‰€ä»¥ç¼–è¾‘å™¨é‡Œçœ‹ä¸åˆ°è¿™äº›â€œåˆæˆæ–¹æ³•â€(synthesized method)çš„æºä»£ç ã€‚é™¤äº†ç”Ÿæˆæ–¹æ³•ä»£ç  getterã€setter ä¹‹å¤–ï¼Œç¼–è¯‘å™¨è¿˜è¦è‡ªåŠ¨å‘ç±»ä¸­æ·»åŠ é€‚å½“ç±»å‹çš„å®ä¾‹å˜é‡ï¼Œå¹¶ä¸”åœ¨å±æ€§åå‰é¢åŠ ä¸‹åˆ’çº¿ï¼Œä»¥æ­¤ä½œä¸ºå®ä¾‹å˜é‡çš„åå­—ã€‚åœ¨å‰ä¾‹ä¸­ï¼Œä¼šç”Ÿæˆä¸¤ä¸ªå®ä¾‹å˜é‡ï¼Œå…¶åç§°åˆ†åˆ«ä¸º<code>_firstName</code> ä¸ <code>_lastName</code>ã€‚ä¹Ÿå¯ä»¥åœ¨ç±»çš„å®ç°ä»£ç é‡Œé€šè¿‡<code>@synthesize</code> è¯­æ³•æ¥æŒ‡å®šå®ä¾‹å˜é‡çš„åå­—.</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@implementation</span> Person</span><br><span class="line"><span class="variable">@synthesize</span> firstName = _myFirstName;</span><br><span class="line"><span class="variable">@synthesize</span> lastName = _myLastName;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure><p>å±æ€§æ˜¯æ€ä¹ˆç”Ÿæˆçš„ï¼Ÿå¢åŠ ä¸€ä¸ªå±æ€§ï¼Œåº•å±‚å¤§è‡´ç”Ÿæˆäº”ä¸ªä¸œè¥¿ï¼š</p><ol><li><code>OBJC_IVAR_$ç±»å$å±æ€§å</code>ï¼šè¯¥å±æ€§çš„â€œåç§»é‡â€œï¼ˆoffsetï¼‰ï¼Œè¿™ä¸ªåç§»é‡æ˜¯â€ç¡¬ç¼–ç â€œï¼ˆhardcodeï¼‰ï¼Œè¡¨ç¤ºè¯¥å˜é‡è·ç¦»å­˜æ”¾å¯¹è±¡çš„å†…å­˜åŒºåŸŸçš„èµ·å§‹åœ°å€æœ‰å¤šè¿œã€‚</li><li><code>getter</code>å’Œ<code>setter</code>æ–¹æ³•å¯¹åº”çš„å®ç°å‡½æ•°</li><li><code>ivar_list</code>ï¼šæˆå‘˜å˜é‡åˆ—è¡¨</li><li><code>method_list</code>ï¼šæ–¹æ³•åˆ—è¡¨</li><li><code>prop_list</code>ï¼šå±æ€§åˆ—è¡¨</li></ol><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ¯æ¬¡åœ¨å¢åŠ ä¸€ä¸ªå±æ€§ï¼Œç³»ç»Ÿéƒ½ä¼šåœ¨ivar_listä¸­æ·»åŠ ä¸€ä¸ªæˆå‘˜å˜é‡çš„æè¿°ï¼Œåœ¨method_listä¸­å¢åŠ setterå’Œgetteræ–¹æ³•çš„æè¿°ï¼Œåœ¨å±æ€§åˆ—è¡¨ä¸­å¢åŠ ä¸€ä¸ªå±æ€§çš„æè¿°ï¼Œç„¶åè®¡ç®—è¯¥å±æ€§åœ¨å¯¹è±¡ä¸­çš„åç§»é‡ï¼Œç„¶åç»™å‡ºsetterä¸getteræ–¹æ³•å¯¹åº”çš„å®ç°ï¼Œåœ¨setteræ–¹æ³•ä¸­ä»åç§»é‡çš„ä½ç½®å¼€å§‹èµ‹å€¼ï¼Œåœ¨getteræ–¹æ³•ä¸­ä»åç§»é‡çš„å¼€å§‹å–å€¼ï¼Œä¸ºäº†èƒ½å¤Ÿè¯»å–æ­£ç¡®å­—èŠ‚æ•°ï¼Œç³»ç»Ÿå¯¹è±¡åç§»é‡çš„æŒ‡é’ˆç±»å‹è¿›è¡Œäº†å¼ºè½¬ã€‚</p><h3 id="2-propertyä¸­æœ‰å“ªäº›å±æ€§å…³é”®å­—ï¼Ÿï¼ˆæˆ–-propertyåé¢å¯ä»¥æœ‰å“ªäº›ä¿®é¥°ç¬¦ï¼Ÿï¼‰"><a href="#2-propertyä¸­æœ‰å“ªäº›å±æ€§å…³é”®å­—ï¼Ÿï¼ˆæˆ–-propertyåé¢å¯ä»¥æœ‰å“ªäº›ä¿®é¥°ç¬¦ï¼Ÿï¼‰" class="headerlink" title="2. @propertyä¸­æœ‰å“ªäº›å±æ€§å…³é”®å­—ï¼Ÿï¼ˆæˆ–@propertyåé¢å¯ä»¥æœ‰å“ªäº›ä¿®é¥°ç¬¦ï¼Ÿï¼‰"></a>2. @propertyä¸­æœ‰å“ªäº›å±æ€§å…³é”®å­—ï¼Ÿï¼ˆæˆ–@propertyåé¢å¯ä»¥æœ‰å“ªäº›ä¿®é¥°ç¬¦ï¼Ÿï¼‰</h3><p>å±æ€§å¯ä»¥æ‹¥æœ‰çš„ç‰¹è´¨åˆ†ä¸ºå››ç±»ï¼š<br>1ã€åŸå­æ€§ â€” <code>nonatomic</code>ç‰¹è´¨<br>2ã€è¯»å†™æƒé™ â€” <code>readwrite</code> <code>readonly</code><br>3ã€å†…å­˜ç®¡ç†è¯­ä¹‰ â€” <code>assign</code> <code>strong</code> <code>weak</code> <code>unsafe_unretained</code> <code>copy</code><br>4ã€æ–¹æ³•å â€” <code>getter=&lt;name&gt;</code> <code>setter=&lt;name&gt;</code></p><p><code>getter=&lt;name&gt;</code>çš„æ ·å­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">getter</span>=isOn) <span class="built_in">BOOL</span> on;</span><br></pre></td></tr></table></figure><p>ï¼ˆ<code>setter=&lt;name&gt;</code>è¿™ç§ä¸å¸¸ç”¨ï¼Œä¹Ÿä¸æ¨èä½¿ç”¨ï¼‰<br>5ã€ä¸å¸¸ç”¨çš„ï¼š<code>nonnull</code>ï¼Œ<code>null_resettable</code>ï¼Œ<code>nullable</code></p><h3 id="3-ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨weakå…³é”®å­—ï¼Œç›¸æ¯”assignæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ"><a href="#3-ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨weakå…³é”®å­—ï¼Œç›¸æ¯”assignæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ" class="headerlink" title="3. ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨weakå…³é”®å­—ï¼Œç›¸æ¯”assignæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ"></a>3. ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨weakå…³é”®å­—ï¼Œç›¸æ¯”assignæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ</h3><p>ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨<code>weak</code>å…³é”®å­—ï¼Ÿ</p><ol><li>åœ¨ARCä¸­ï¼Œåœ¨æœ‰å¯èƒ½å‡ºç°å¾ªç¯å¼•ç”¨çš„æ—¶å€™ï¼Œå¾€å¾€è¦é€šè¿‡è®©å…¶ä¸­ä¸€ç«¯ä½¿ç”¨<code>weak</code>æ¥è§£å†³ï¼Œæ¯”å¦‚ï¼š<code>delegate</code>ä»£ç†å±æ€§</li><li>è‡ªèº«å·²ç»å¯¹å®ƒè¿›è¡Œä¸€æ¬¡å¼ºå¼•ç”¨ï¼Œæ²¡å¿…è¦å†å¼ºå¼•ç”¨ä¸€æ¬¡ï¼Œæ­¤æ—¶ä¹Ÿä¼šä½¿ç”¨<code>weak</code>ï¼Œè‡ªå®šä¹‰<code>IBOutlet</code>æ§ä»¶å±æ€§ä¸€èˆ¬ä¹Ÿä½¿ç”¨<code>weak</code>ï¼›å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>strong</code>ã€‚</li></ol><p>ä¸åŒç‚¹ï¼š</p><ol><li><code>weak</code>æ­¤ç‰¹è´¨è¡¨æ˜è¯¥å±æ€§å®šä¹‰äº†ä¸€ç§â€œéæ‹¥æœ‰å…³ç³»â€ (nonowning relationship)ã€‚ä¸ºè¿™ç§å±æ€§è®¾ç½®æ–°å€¼æ—¶ï¼Œè®¾ç½®æ–¹æ³•æ—¢ä¸ä¿ç•™æ–°å€¼ï¼Œä¹Ÿä¸é‡Šæ”¾æ—§å€¼ã€‚æ­¤ç‰¹è´¨åŒ<code>assign</code>ç±»ä¼¼ï¼Œç„¶è€Œåœ¨å±æ€§æ‰€æŒ‡çš„å¯¹è±¡é­åˆ°é”€æ¯æ—¶ï¼Œå±æ€§å€¼ä¹Ÿä¼šæ¸…ç©º(nil out)ã€‚<br> è€Œ<code>assign</code>çš„â€œè®¾ç½®æ–¹æ³•â€åªä¼šæ‰§è¡Œé’ˆå¯¹â€œçº¯é‡ç±»å‹â€ (scalar typeï¼Œä¾‹å¦‚ CGFloat æˆ–<br> NSlnteger ç­‰)çš„ç®€å•èµ‹å€¼æ“ä½œã€‚å±æ€§æ‰€æŒ‡çš„å¯¹è±¡é”€æ¯æ—¶ï¼Œç¼–è¯‘å™¨ä¸ä¼šå°†è¯¥å±æ€§ç½®ä¸º<code>nil</code>ï¼ŒæŒ‡é’ˆä»    æ—§æŒ‡å‘ä¹‹å‰è¢«é”€æ¯çš„å†…å­˜ï¼Œè¿™æ—¶è®¿é—®è¯¥å±æ€§ä¼šäº§ç”Ÿé‡æŒ‡é’ˆé”™è¯¯å¹¶å´©æºƒï¼Œ</li><li>assigin å¯ä»¥ç”¨é OC å¯¹è±¡,è€Œ weak å¿…é¡»ç”¨äº OC å¯¹è±¡</li></ol><h3 id="4-æ€ä¹ˆç”¨copyå…³é”®å­—ï¼Ÿ"><a href="#4-æ€ä¹ˆç”¨copyå…³é”®å­—ï¼Ÿ" class="headerlink" title="4. æ€ä¹ˆç”¨copyå…³é”®å­—ï¼Ÿ"></a>4. æ€ä¹ˆç”¨copyå…³é”®å­—ï¼Ÿ</h3><ol><li><code>NSString/NSArray/NSDictiony</code>ç­‰ç­‰ç»å¸¸ä½¿ç”¨<code>copy</code>å…³é”®å­—ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æœ‰å¯¹åº”çš„å¯å˜ç±»å‹ï¼š<code>NSMutableString/NSMutableArray/NSMutableDictionary</code>;</li><li><code>block</code>ä¹Ÿç»å¸¸ä½¿ç”¨<code>copy</code>å…³é”®å­—<br> <code>block</code>ä½¿ç”¨<code>copy</code>æ˜¯ä»MRCé—ç•™ä¸‹æ¥çš„â€œä¼ ç»Ÿâ€ï¼Œåœ¨MRCä¸­ï¼Œæ–¹æ³•å†…éƒ¨çš„<code>block</code>æ˜¯åœ¨æ ˆåŒºçš„ï¼Œä½¿ç”¨<code>copy</code>å¯ä»¥æŠŠå®ƒæ”¾åˆ°å †åŒºã€‚åœ¨ARCä¸­å†™ä¸å†™éƒ½è¡Œï¼šå¯¹äº<code>block</code>ä½¿ç”¨<code>copy</code>è¿˜æ˜¯<code>strong</code>æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œä½†å†™ä¸Š<code>copy</code>ä¹Ÿæ— ä¼¤å¤§é›…ï¼Œè¿˜èƒ½æ—¶åˆ»æé†’æˆ‘ä»¬ï¼šç¼–è¯‘å™¨è‡ªåŠ¨å¯¹<code>block</code>è¿›è¡Œäº†<code>copy</code>æ“ä½œã€‚å¦‚æœä¸å†™<code>copy</code>ï¼Œè¯¥ç±»çš„è°ƒç”¨è€…æœ‰å¯èƒ½ä¼šå¿˜è®°æˆ–è€…æ ¹æœ¬ä¸çŸ¥é“â€œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¯¹<code>block</code>è¿›è¡Œäº†<code>copy</code>æ“ä½œâ€ï¼Œä»–ä»¬æœ‰å¯èƒ½ä¼šåœ¨è°ƒç”¨ä¹‹å‰è‡ªè¡Œæ‹·è´å±æ€§å€¼ã€‚è¿™ç§æ“ä½œå¤šä½™è€Œä½æ•ˆã€‚</li></ol><p>ä¸‹é¢åšè§£é‡Šï¼š<br><code>copy</code>æ­¤ç‰¹è´¨æ‰€è¡¨è¾¾çš„æ‰€å±å…³ç³»ä¸<code>strong</code>ç±»ä¼¼ã€‚ç„¶è€Œè®¾ç½®æ–¹æ³•å¹¶ä¸ä¿ç•™æ–°å€¼ï¼Œè€Œæ˜¯å°†å…¶â€œæ‹·è´â€ï¼ˆcopyï¼‰ã€‚<br>å½“å±æ€§ç±»å‹ä¸º<code>NSString</code>æ—¶ï¼Œç»å¸¸ç”¨æ­¤ç‰¹è´¨æ¥ä¿æŠ¤å…¶å°è£…æ€§ï¼Œå› ä¸ºä¼ é€’ç»™è®¾ç½®æ–¹æ³•çš„æ–°å€¼æœ‰å¯èƒ½æŒ‡å‘ä¸€ä¸ª<code>NSMutableString</code>ç±»çš„å®ä¾‹ã€‚è¿™ä¸ªç±»æ˜¯<code>NSString</code>çš„å­ç±»ï¼Œè¡¨ç¤ºä¸€ç§å¯ä¿®æ”¹å…¶å€¼çš„å­—ç¬¦ä¸²ï¼Œæ­¤æ—¶è‹¥æ˜¯ä¸æ‹·è´å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè®¾ç½®å®Œå±æ€§ä¹‹åï¼Œå­—ç¬¦ä¸²çš„å€¼å°±å¯èƒ½ä¼šåœ¨å¯¹è±¡ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹é­äººæ›´æ”¹ã€‚æ‰€ä»¥ï¼Œè¿™æ˜¯å°±è¦æ‹·è´ä¸€ä»½â€œä¸å¯å˜â€ï¼ˆimmutableï¼‰çš„å­—ç¬¦ä¸²ï¼Œç¡®ä¿å¯¹è±¡ä¸­çš„å­—ç¬¦ä¸²å€¼ä¸ä¼šæ— æ„é—´å˜åŠ¨ã€‚åªè¦å®ç°å±æ€§æ‰€ç”¨çš„å¯¹è±¡æ˜¯â€œå¯å˜çš„â€œï¼ˆmutableï¼‰ï¼Œå°±åº”è¯¥åœ¨è®¾ç½®æ–°å€¼æ—¶æ‹·è´ä¸€ä»½ã€‚</p><blockquote><p>ç”¨ @property å£°æ˜ NSStringã€NSArrayã€NSDictionary ç»å¸¸ä½¿ç”¨ copy å…³é”®å­—ï¼Œæ˜¯å› ä¸ºä»–ä»¬æœ‰å¯¹åº”çš„å¯å˜ç±»å‹ï¼šNSMutableStringã€NSMutableArrayã€NSMutableDictionaryï¼Œä»–ä»¬ä¹‹é—´å¯èƒ½è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œä¸ºç¡®ä¿å¯¹è±¡ä¸­çš„å­—ç¬¦ä¸²å€¼ä¸ä¼šæ— æ„é—´å˜åŠ¨ï¼Œåº”è¯¥åœ¨è®¾ç½®æ–°å±æ€§å€¼æ—¶æ‹·è´ä¸€ä»½ã€‚</p></blockquote><h3 id="5-ç”¨-propertyå£°æ˜çš„NSStringï¼ˆæˆ–NSArrayï¼ŒNSDictionaryï¼‰ç»å¸¸ä½¿ç”¨copyå…³é”®å­—ï¼Œä¸ºä»€ä¹ˆï¼Ÿå¦‚æœæ”¹ç”¨strongå…³é”®å­—ï¼Œå¯èƒ½é€ æˆä»€ä¹ˆé—®é¢˜ï¼Ÿ"><a href="#5-ç”¨-propertyå£°æ˜çš„NSStringï¼ˆæˆ–NSArrayï¼ŒNSDictionaryï¼‰ç»å¸¸ä½¿ç”¨copyå…³é”®å­—ï¼Œä¸ºä»€ä¹ˆï¼Ÿå¦‚æœæ”¹ç”¨strongå…³é”®å­—ï¼Œå¯èƒ½é€ æˆä»€ä¹ˆé—®é¢˜ï¼Ÿ" class="headerlink" title="5. ç”¨@propertyå£°æ˜çš„NSStringï¼ˆæˆ–NSArrayï¼ŒNSDictionaryï¼‰ç»å¸¸ä½¿ç”¨copyå…³é”®å­—ï¼Œä¸ºä»€ä¹ˆï¼Ÿå¦‚æœæ”¹ç”¨strongå…³é”®å­—ï¼Œå¯èƒ½é€ æˆä»€ä¹ˆé—®é¢˜ï¼Ÿ"></a>5. ç”¨@propertyå£°æ˜çš„NSStringï¼ˆæˆ–NSArrayï¼ŒNSDictionaryï¼‰ç»å¸¸ä½¿ç”¨copyå…³é”®å­—ï¼Œä¸ºä»€ä¹ˆï¼Ÿå¦‚æœæ”¹ç”¨strongå…³é”®å­—ï¼Œå¯èƒ½é€ æˆä»€ä¹ˆé—®é¢˜ï¼Ÿ</h3><ol><li>å› ä¸ºçˆ¶ç±»æŒ‡é’ˆå¯ä»¥æŒ‡å‘å­ç±»å¯¹è±¡ï¼Œä½¿ç”¨<code>copy</code>çš„ç›®çš„æ˜¯ä¸ºäº†è®©æœ¬å¯¹è±¡çš„å±æ€§ä¸å—å¤–ç•Œå½±å“ï¼Œä½¿ç”¨<code>copy</code>æ— è®ºç»™æˆ‘ä¼ å…¥æ˜¯ä¸€ä¸ªå¯å˜å¯¹è±¡è¿˜æ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œæˆ‘æœ¬èº«æŒæœ‰çš„å°±æ˜¯ä¸€ä¸ªä¸å¯å˜çš„å‰¯æœ¬ã€‚</li><li>å¦‚æœæˆ‘ä»¬ä½¿ç”¨æ˜¯<code>strong</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§å°±æœ‰å¯èƒ½æŒ‡å‘ä¸€ä¸ªå¯å˜å¯¹è±¡ï¼Œå¦‚æœè¿™ä¸ªå¯å˜å¯¹è±¡åœ¨å¤–éƒ¨è¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆä¼šå½±å“è¯¥å±æ€§ã€‚</li></ol><p><code>copy</code>æ­¤ç‰¹è´¨æ‰€è¡¨è¾¾çš„æ‰€å±å…³ç³»ä¸<code>strong</code>ç±»ä¼¼ã€‚ç„¶è€Œè®¾ç½®æ–¹æ³•å¹¶ä¸ä¿ç•™æ–°å€¼ï¼Œè€Œæ˜¯å°†å…¶â€æ‹·è´â€œï¼ˆcopyï¼‰ã€‚<br><code>copy</code> æ­¤ç‰¹è´¨æ‰€è¡¨è¾¾çš„æ‰€å±å…³ç³»ä¸<code>strong</code>ç±»ä¼¼ã€‚ç„¶è€Œè®¾ç½®æ–¹æ³•å¹¶ä¸ä¿ç•™æ–°å€¼ï¼Œè€Œæ˜¯å°†å…¶â€œæ‹·è´â€ (copy)ã€‚<br>å½“å±æ€§ç±»å‹ä¸º<code>NSString</code>æ—¶ï¼Œç»å¸¸ç”¨æ­¤ç‰¹è´¨æ¥ä¿æŠ¤å…¶å°è£…æ€§ï¼Œå› ä¸ºä¼ é€’ç»™è®¾ç½®æ–¹æ³•çš„æ–°å€¼æœ‰å¯èƒ½æŒ‡å‘ä¸€ä¸ª <code>NSMutableString</code>ç±»çš„å®ä¾‹ã€‚è¿™ä¸ªç±»æ˜¯<code>NSString</code>çš„å­ç±»ï¼Œè¡¨ç¤ºä¸€ç§å¯ä¿®æ”¹å…¶å€¼çš„å­—ç¬¦ä¸²ï¼Œæ­¤æ—¶è‹¥æ˜¯ä¸æ‹·è´å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè®¾ç½®å®Œå±æ€§ä¹‹åï¼Œå­—ç¬¦ä¸²çš„å€¼å°±å¯èƒ½ä¼šåœ¨å¯¹è±¡ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹é­äººæ›´æ”¹ã€‚æ‰€ä»¥ï¼Œè¿™æ—¶å°±è¦æ‹·è´ä¸€ä»½â€œä¸å¯å˜â€ (immutable)çš„å­—ç¬¦ä¸²ï¼Œç¡®ä¿å¯¹è±¡ä¸­çš„å­—ç¬¦ä¸²å€¼ä¸ä¼šæ— æ„é—´å˜åŠ¨ã€‚åªè¦å®ç°å±æ€§æ‰€ç”¨çš„å¯¹è±¡æ˜¯â€œå¯å˜çš„â€ (mutable)ï¼Œå°±åº”è¯¥åœ¨è®¾ç½®æ–°å±æ€§å€¼æ—¶æ‹·è´ä¸€ä»½ã€‚</p><p>ä¸¾ä¾‹è¯´æ˜ï¼š</p><p>å®šä¹‰ä¸€ä¸ªä»¥strongä¿®é¥°çš„arrayï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readwrite</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> *marray;</span><br></pre></td></tr></table></figure><p>ç„¶åè¿›è¡Œä¸‹é¢çš„æ“ä½œï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableArray</span> *mutableArray = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">    <span class="built_in">NSArray</span> *array = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>, @<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">self</span>.marray = mutableArray;</span><br><span class="line">    [mutableArray removeAllObjects];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="keyword">self</span>.marray);</span><br><span class="line">    </span><br><span class="line">    [mutableArray addObjectsFromArray:array];</span><br><span class="line">    <span class="keyword">self</span>.marray = [mutableArray <span class="keyword">copy</span>];</span><br><span class="line">    [mutableArray removeAllObjects];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="keyword">self</span>.marray);</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">2018-06-15</span> <span class="selector-tag">15</span><span class="selector-pseudo">:35</span><span class="selector-pseudo">:43.292506+0800</span> <span class="selector-tag">getIP</span><span class="selector-attr">[49185:2440314]</span> (</span><br><span class="line">)</span><br><span class="line"><span class="selector-tag">2018-06-15</span> <span class="selector-tag">15</span><span class="selector-pseudo">:35</span><span class="selector-pseudo">:43.292805+0800</span> <span class="selector-tag">getIP</span><span class="selector-attr">[49185:2440314]</span> (</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    <span class="number">4</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä¸ºäº†ç†è§£è¿™ç§åšæ³•ï¼Œé¦–å…ˆè¦çŸ¥é“ï¼Œä¸¤ç§æƒ…å†µï¼š</p><ol><li>å¯¹<strong>éé›†åˆç±»å¯¹è±¡</strong>çš„<code>copy</code>ä¸<code>mutableCopy</code>æ“ä½œ</li><li>å¯¹<strong>é›†åˆç±»å¯¹è±¡</strong>çš„<code>copy</code>ä¸<code>mutableCopy</code>æ“ä½œ</li></ol><p><strong>1. å¯¹éé›†åˆç±»å¯¹è±¡çš„copyä¸mutableCopyæ“ä½œ</strong></p><p>åœ¨éé›†åˆç±»å¯¹è±¡ä¸­ï¼šå¯¹immutableå¯¹è±¡è¿›è¡Œcopyæ“ä½œï¼Œæ˜¯æŒ‡é’ˆå¤åˆ¶ï¼ŒmutableCopyæ“ä½œæ—¶æ—¶å†…å®¹å¤åˆ¶ï¼›<br>å¯¹mutableå¯¹è±¡è¿›è¡Œcopyå’ŒmutableCopyéƒ½æ˜¯å†…å®¹å¤åˆ¶ã€‚ç”¨ä»£ç ç®€å•è¡¨ç¤ºä¸ºï¼š</p><ul><li>[immutableObject copy]    //æµ…å¤åˆ¶</li><li>[immutableObject mutableCopy]//æ·±å¤åˆ¶</li><li>[mutableObject copy]    //æ·±å¤åˆ¶</li><li>[mutableObject mutableCopy]//æ·±å¤åˆ¶</li></ul><p>æ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableString</span> *string = [<span class="built_in">NSMutableString</span> stringWithString:<span class="string">@"origin"</span>];<span class="comment">//copy</span></span><br><span class="line"><span class="built_in">NSString</span> *stringCopy = [string <span class="keyword">copy</span>];</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å†…å­˜ï¼Œä¼šå‘ç°<code>string</code>ï¼Œ<code>stringCopy</code>å†…å­˜åœ°å€éƒ½ä¸ä¸€æ ·ï¼Œè¯´æ˜æ­¤æ—¶éƒ½æ˜¯åšäº†å†…å®¹æ‹·è´ã€æ·±æ‹·è´ã€‚å³ä½¿ä½ è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name"><span class="builtin-name">string</span></span> appendString:@<span class="string">"origion!"</span>]<span class="comment">;</span></span><br></pre></td></tr></table></figure><p><code>stringCopy</code>çš„å€¼ä¹Ÿä¸ä¼šå› æ­¤æ”¹å˜ï¼Œä½†æ˜¯å¦‚æœä¸ä½¿ç”¨<code>copy</code>ï¼Œ<code>stringCopy</code>çš„å€¼å°±ä¼šè¢«æ”¹å˜ã€‚</p><p>é›†åˆç±»å¯¹è±¡ä»¥æ­¤ç±»æ¨ã€‚</p><p>æ‰€ä»¥ï¼Œ</p><blockquote><p>ç”¨ @property å£°æ˜ NSStringã€NSArrayã€NSDictionary ç»å¸¸ä½¿ç”¨ copy å…³é”®å­—ï¼Œæ˜¯å› ä¸ºä»–ä»¬æœ‰å¯¹åº”çš„å¯å˜ç±»å‹ï¼šNSMutableStringã€NSMutableArrayã€NSMutableDictionaryï¼Œä»–ä»¬ä¹‹é—´å¯èƒ½è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œä¸ºç¡®ä¿å¯¹è±¡ä¸­çš„å­—ç¬¦ä¸²å€¼ä¸ä¼šæ— æ„é—´å˜åŠ¨ï¼Œåº”è¯¥åœ¨è®¾ç½®æ–°å±æ€§å€¼æ—¶æ‹·è´ä¸€ä»½ã€‚</p></blockquote><p><strong>2. å¯¹é›†åˆç±»å¯¹è±¡çš„copyä¸mutableCopyæ“ä½œ</strong></p><p>é›†åˆç±»å¯¹è±¡æ˜¯æŒ‡<code>NSArray</code>ã€<code>NSDictory</code>ã€<code>NSSet</code>â€¦ä¹‹ç±»çš„å¯¹è±¡ã€‚ä¸‹é¢å…ˆçœ‹é›†åˆç±»<code>immutable</code>å¯¹è±¡ä½¿ç”¨<code>copy</code>å’Œ<code>mutableCopy</code>çš„ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">NSArray</span> *array = @[@[@<span class="string">"a"</span>, @<span class="string">"b"</span>], @[@<span class="string">"c"</span>, @<span class="string">"d"</span>]];</span><br><span class="line"><span class="symbol">NSArray</span> *copyArray = [array copy];</span><br><span class="line"><span class="symbol">NSMutableArray</span> *mCopyArray = [array mutableCopy];</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ° copyArray å’Œ array çš„åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œè€Œ mCopyArray å’Œ array çš„åœ°å€æ˜¯ä¸åŒçš„ã€‚è¯´æ˜ copy æ“ä½œè¿›è¡Œäº†æŒ‡é’ˆæ‹·è´ï¼ŒmutableCopyè¿›è¡Œäº†å†…å®¹æ‹·è´ã€‚ä½†éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼šæ­¤å¤„çš„å†…å®¹æ‹·è´ï¼Œä»…ä»…æ˜¯æ‹·è´ array è¿™ä¸ªå¯¹è±¡ï¼Œarrayé›†åˆå†…éƒ¨çš„å…ƒç´ ä»ç„¶æ˜¯æŒ‡é’ˆæ‹·è´ã€‚è¿™å’Œä¸Šé¢çš„éé›†åˆ immutable å¯¹è±¡çš„æ‹·è´è¿˜æ˜¯æŒºç›¸ä¼¼çš„ï¼Œé‚£ä¹ˆmutableå¯¹è±¡çš„æ‹·è´ä¼šä¸ä¼šç±»ä¼¼å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å¾€ä¸‹ï¼Œçœ‹ mutable å¯¹è±¡æ‹·è´çš„ä¾‹å­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableArray</span> *array = [<span class="built_in">NSMutableArray</span> arrayWithObjects:[<span class="built_in">NSMutableString</span> stringWithString:<span class="string">@"a"</span>],<span class="string">@"b"</span>,<span class="string">@"c"</span>,<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *copyArray = [array <span class="keyword">copy</span>];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *mCopyArray = [array mutableCopy];</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å†…å­˜ï¼Œå¦‚æˆ‘ä»¬æ‰€æ–™ï¼ŒcopyArrayã€mCopyArrayå’Œ array çš„å†…å­˜åœ°å€éƒ½ä¸ä¸€æ ·ï¼Œè¯´æ˜ copyArrayã€mCopyArray éƒ½å¯¹ array è¿›è¡Œäº†å†…å®¹æ‹·è´ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š</p><p>åœ¨é›†åˆç±»å¯¹è±¡ä¸­ï¼Œå¯¹ immutable å¯¹è±¡è¿›è¡Œ copyï¼Œæ˜¯æŒ‡é’ˆå¤åˆ¶ï¼Œ mutableCopy æ˜¯å†…å®¹å¤åˆ¶ï¼›å¯¹ mutable å¯¹è±¡è¿›è¡Œ copy å’Œ mutableCopy éƒ½æ˜¯å†…å®¹å¤åˆ¶ã€‚ä½†æ˜¯ï¼šé›†åˆå¯¹è±¡çš„å†…å®¹å¤åˆ¶ä»…é™äºå¯¹è±¡æœ¬èº«ï¼Œå¯¹è±¡å…ƒç´ ä»ç„¶æ˜¯æŒ‡é’ˆå¤åˆ¶ã€‚ç”¨ä»£ç ç®€å•è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">immutableObject copy</span>] <span class="comment">// æµ…å¤åˆ¶</span></span><br><span class="line">[<span class="meta">immutableObject mutableCopy</span>] <span class="comment">//å•å±‚æ·±å¤åˆ¶</span></span><br><span class="line">[<span class="meta">mutableObject copy</span>] <span class="comment">//å•å±‚æ·±å¤åˆ¶</span></span><br><span class="line">[<span class="meta">mutableObject mutableCopy</span>] <span class="comment">//å•å±‚æ·±å¤åˆ¶</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä»£ç ç»“è®ºä¸éé›†åˆç±»çš„éå¸¸ç›¸ä¼¼ã€‚</p><p>##æ€»ç»“<br>å…³äº@propertyçš„é—®é¢˜ï¼Œé—®æ³•æ¯”è¾ƒå¤šï¼Œä½†æ˜¯ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œææ¸…æ¥šåº•å±‚åŸç†ï¼Œè¿åˆƒè€Œè§£ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;propertyä¿®é¥°ç¬¦&quot;&gt;&lt;a href=&quot;#propertyä¿®é¥°ç¬¦&quot; class=&quot;headerlink&quot; title=&quot;@propertyä¿®é¥°ç¬¦&quot;&gt;&lt;/a&gt;@propertyä¿®é¥°ç¬¦&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;atomic n
      
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="runtime" scheme="http://yoursite.com/tags/runtime/"/>
    
  </entry>
  
  <entry>
    <title>runtimeç³»åˆ—ä¹‹ï¼ˆ3ï¼‰æ·±å…¥ç†è§£OCçš„æ¶ˆæ¯å’Œæ¶ˆæ¯è½¬å‘æœºåˆ¶</title>
    <link href="http://yoursite.com/2018/06/08/runtime%E7%B3%BB%E5%88%97%E4%B9%8B%EF%BC%883%EF%BC%89%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3OC%E7%9A%84%E6%B6%88%E6%81%AF%E5%92%8C%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91%E6%9C%BA%E5%88%B6/"/>
    <id>http://yoursite.com/2018/06/08/runtimeç³»åˆ—ä¹‹ï¼ˆ3ï¼‰æ·±å…¥ç†è§£OCçš„æ¶ˆæ¯å’Œæ¶ˆæ¯è½¬å‘æœºåˆ¶/</id>
    <published>2018-06-08T12:16:23.000Z</published>
    <updated>2019-03-25T06:53:04.712Z</updated>
    
    <content type="html"><![CDATA[<p>æ‚¨å°†äº†è§£åˆ°äº†<code>runtime</code>æ˜¯å¦‚ä½•é€šè¿‡<code>objc_msgSend</code>åœ¨è¿è¡Œæ—¶æŠŠæ–¹æ³•å’Œæ–¹æ³•å®ç°è¿›è¡ŒåŠ¨æ€ç»‘å®šçš„ï¼›<br>ä¹Ÿå°†äº†è§£åˆ°runtimeä¸‹åŠ¨æ€æ–¹æ³•è§£æå’Œæ¶ˆæ¯è½¬å‘çš„æœºåˆ¶æ˜¯æ€æ ·çš„ã€‚</p><a id="more"></a><h2 id="æ¶ˆæ¯"><a href="#æ¶ˆæ¯" class="headerlink" title="æ¶ˆæ¯"></a>æ¶ˆæ¯</h2><p>æœ¬ç« æè¿°äº†ä»£ç çš„æ¶ˆæ¯è¡¨è¾¾å¼å¦‚ä½•è½¬æ¢ä¸ºå¯¹<code>objc_msgSend</code>å‡½æ•°çš„è°ƒç”¨ï¼Œå¦‚ä½•é€šè¿‡åå­—æ¥æŒ‡å®šä¸€ä¸ªæ–¹æ³•ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨<code>objc_msgSend</code>å‡½æ•°ã€‚</p><h3 id="è·å¾—æ–¹æ³•åœ°å€"><a href="#è·å¾—æ–¹æ³•åœ°å€" class="headerlink" title="è·å¾—æ–¹æ³•åœ°å€"></a>è·å¾—æ–¹æ³•åœ°å€</h3><p>é¿å…åŠ¨æ€ç»‘å®šçš„å”¯ä¸€åŠæ³•å°±æ˜¯å–å¾—æ–¹æ³•çš„åœ°å€ï¼Œå¹¶ä¸”ç›´æ¥è±¡å‡½æ•°è°ƒç”¨ä¸€æ ·è°ƒç”¨å®ƒã€‚<br>å½“ä¸€ä¸ªæ–¹æ³•ä¼šè¢«è¿ç»­è°ƒç”¨å¾ˆå¤šæ¬¡ï¼Œè€Œä¸”æ‚¨å¸Œæœ›èŠ‚çœæ¯æ¬¡è°ƒç”¨æ–¹æ³•éƒ½è¦å‘é€æ¶ˆæ¯çš„å¼€é”€æ—¶ï¼Œä½¿ç”¨æ–¹æ³•åœ°å€æ¥è°ƒç”¨æ–¹æ³•å°±æ˜¾å¾—å¾ˆæœ‰æ•ˆã€‚<br>åˆ©ç”¨NSObjectç±»ä¸­çš„<code>methodForSelector:</code>æ–¹æ³•ï¼Œæ‚¨å¯ä»¥è·å¾—ä¸€ä¸ªæŒ‡å‘æ–¹æ³•å®ç°çš„æŒ‡é’ˆï¼Œå¹¶å¯ä»¥ä½¿ç”¨è¯¥æŒ‡é’ˆç›´æ¥è°ƒç”¨æ–¹æ³•å®ç°ã€‚<code>methodForSelector:</code>è¿”å›çš„æŒ‡é’ˆå’Œèµ‹å€¼çš„å˜é‡ç±»å‹å¿…é¡»å®Œå…¨ä¸€è‡´ï¼ŒåŒ…æ‹¬æ–¹æ³•çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹éƒ½åœ¨ç±»å‹è¯†åˆ«çš„è€ƒè™‘èŒƒå›´ä¸­ã€‚</p><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†æ€ä¹ˆä½¿ç”¨æŒ‡é’ˆæ¥è°ƒç”¨<code>setFilled:</code>çš„æ–¹æ³•å®ç°:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (*<span class="keyword">setter</span>)(<span class="keyword">id</span>, SEL, <span class="built_in">BOOL</span>);<span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">setter</span> = (<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="built_in">BOOL</span>))[targetmethodForSelector:<span class="keyword">@selector</span>(setFilled:)];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">1000</span>, i++ ) <span class="keyword">setter</span>(targetList[i], <span class="keyword">@selector</span>(setFilled:), <span class="literal">YES</span>);</span><br></pre></td></tr></table></figure><p>æ–¹æ³•æŒ‡é’ˆçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¥æ”¶æ¶ˆæ¯çš„å¯¹è±¡(<code>self</code>)ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ–¹æ³•é€‰æ ‡(<code>_cmd</code>)ã€‚è¿™ä¸¤ä¸ªå‚æ•°åœ¨æ–¹æ³•ä¸­æ˜¯<strong>éšè—å‚æ•°</strong>ï¼Œä½†ä½¿ç”¨å‡½æ•°çš„å½¢å¼æ¥è°ƒç”¨æ–¹æ³•æ—¶å¿…é¡»æ˜¾ç¤ºçš„ç»™å‡ºã€‚<br>ä½¿ç”¨<code>methodForSelector:</code>æ¥é¿å…åŠ¨æ€ç»‘å®šå°†å‡å°‘å¤§éƒ¨åˆ†æ¶ˆæ¯çš„å¼€é”€ï¼Œä½†æ˜¯è¿™åªæœ‰åœ¨æŒ‡å®šçš„æ¶ˆæ¯è¢«é‡å¤å‘é€å¾ˆå¤šæ¬¡æ—¶æ‰æœ‰æ„ä¹‰ï¼Œä¾‹å¦‚ä¸Šé¢çš„ for å¾ªç¯ã€‚<br>æ³¨æ„ï¼Œ<code>methodForSelector:</code>æ˜¯ Cocoa è¿è¡Œæ—¶ç³»ç»Ÿçš„æä¾›çš„åŠŸèƒ½ï¼Œè€Œä¸æ˜¯ Objective-C è¯­è¨€æœ¬èº«çš„åŠŸ èƒ½ã€‚</p><h3 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h3><p>åœ¨objective-Cä¸­ï¼Œæ¶ˆæ¯æ—¶çŸ¥é“è¿è¡Œæ—¶æ‰ä¼šä¸æ–¹æ³•å®ç°è¿›è¡Œç»‘å®šçš„ã€‚ç¼–è¯‘å™¨ä¼šæŠŠä¸€ä¸ªæ¶ˆæ¯è¡¨è¾¾å¼ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[receiver message]</span><br></pre></td></tr></table></figure><p>è½¬æ¢æˆä¸€ä¸ªå¯¹æ¶ˆæ¯å‡½æ•°<code>objc_msgSend</code>çš„è°ƒç”¨ã€‚è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªä¸»è¦å‚æ•°ï¼šæ¶ˆæ¯æ¥æ”¶è€…å’Œæ¶ˆæ¯å¯¹åº”çš„æ–¹æ³•åå­—â€”å³æ–¹æ³•é€‰æ ‡ã€‚</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">objc_msgSend</span><span class="params">(receive, selector)</span></span></span><br></pre></td></tr></table></figure><p>åŒæ—¶æ¥æ”¶æ¶ˆæ¯ä¸­çš„ä»»æ„æ•°ç›®çš„å‚æ•°:</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">objc_msgSend</span>(<span class="params">receive, select, arg1, arg2, ...</span>)</span></span><br></pre></td></tr></table></figure><p>è¯¥æ¶ˆæ¯å‡½æ•°åšäº†åŠ¨æ€ç»‘å®šæ‰€éœ€è¦çš„ä¸€åˆ‡ï¼š<br>å®ƒé¦–å…ˆæ‰¾åˆ°é€‰æ ‡æ‰€å¯¹åº”çš„æ–¹æ³•å®çº¿ã€‚å› ä¸ºä¸åŒçš„ç±»å¯¹åŒä¸€æ–¹æ³•å¯èƒ½ä¼šæœ‰ä¸åŒçš„å®ç°ï¼Œæ‰€ä»¥æ‰¾åˆ°çš„æ–¹æ³•å®çº¿ä¾èµ–äºæ¶ˆæ¯æ¥æ”¶è€…çš„ç±»å‹ã€‚<br>ç„¶åå°†æ¶ˆæ¯æ¥å—è€…å¯¹è±¡ï¼ˆæŒ‡å‘æ¶ˆæ¯æ¥å—è€…å¯¹è±¡çš„æŒ‡é’ˆï¼‰ä»¥åŠæ–¹æ³•ä¸­æŒ‡å®šçš„å‚æ•°ä¼ ç»™æ‰¾åˆ°çš„æ–¹æ³•å®ç°ã€‚<br>æœ€åï¼Œå°†æ–¹æ³•å®ç°çš„è¿”å›å€¼ä½œä¸ºè¯¥å‡½æ•°çš„è¿”å›å€¼è¿”å›ã€‚</p><blockquote><p>æ³¨æ„ï¼šobjc_msgSendæ–¹æ³•çœ‹èµ·æ¥å¥½åƒè¿”å›äº†æ•°æ®ï¼Œå…¶å®objc_msgSendä»ä¸è¿”å›æ•°æ®ï¼Œè€Œæ˜¯ä½ çš„æ–¹æ³•åœ¨è¿è¡Œæ—¶æ–¹æ³•å®ç°è¢«è°ƒç”¨åæ‰ä¼šè¿”å›æ•°æ®ã€‚ä¸‹é¢è¯¦ç»†å™è¿°æ¶ˆæ¯å‘é€çš„æ­¥éª¤ï¼ˆå¦‚ä¸‹å›¾ï¼‰:</p></blockquote><p>æ¶ˆæ¯æ¡†æ¶ï¼š<br><img src="http://p9u62mso1.bkt.clouddn.com/r_runtimeMsg.gif" alt="æ¶ˆæ¯æ¡†æ¶"></p><p>è¿™æ ·å°±èƒ½è§£é‡Š<code>objc_msgSend</code>å·¥ä½œåŸç†äº†ï¼Œå½“å¯¹è±¡æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œä¸ºäº†åŒ¹é…æ¶ˆæ¯çš„æ¥æ”¶è€…å’Œé€‰æ‹©å­:</p><ol><li>æ¶ˆæ¯å‡½æ•°é¦–å…ˆæ ¹æ®å¯¹è±¡çš„<code>isa</code>æŒ‡é’ˆæ‰¾åˆ°è¯¥å¯¹è±¡æ‰€å¯¹åº”çš„ç±»çš„æ–¹æ³•åˆ—è¡¨<code>objc_method_list</code>ï¼Œå¹¶ä»æ–¹æ³•åˆ—è¡¨ä¸­å¯»æ‰¾è¯¥æ¶ˆæ¯å¯¹åº”çš„æ–¹æ³•é€‰æ ‡ã€‚å¦‚æœèƒ½æ‰¾åˆ°å°±å¯ä»¥ç›´æ¥è·³è½¬åˆ°ç›¸å…³çš„å…·ä½“å®ç°ä¸­å»è°ƒç”¨ã€‚</li><li>å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°†ä¼šé€šè¿‡<code>super_class</code>æŒ‡é’ˆæ²¿ç€ç»§æ‰¿æ ‘å‘ä¸Šå»æœç´¢ï¼Œç›´åˆ°ç»§æ‰¿æ ‘æ ¹éƒ¨ï¼ˆé€šå¸¸ä¸ºNSObjectç±»ï¼‰ã€‚ä¸€æ—¦æ‰¾åˆ°äº†æ–¹æ³•é€‰æ ‡ï¼Œ<code>objc_msgSend</code>åˆ™ä»¥æ¶ˆæ¯æ¥æ”¶è€…å¯¹è±¡ä¸ºå‚æ•°è°ƒç”¨ï¼Œè°ƒç”¨è¯¥é€‰æ ‡å¯¹åº”çš„æ–¹æ³•å®ç°ã€‚</li><li>å¦‚æœåˆ°äº†ç»§æ‰¿æ ‘æ ¹éƒ¨è¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ä¼šè¿›è¡Œ<strong>æ¶ˆæ¯è½¬å‘</strong>ï¼Œè¿˜æœ‰ä¸‰æ¬¡æœºä¼šæ¥å¤„ç†ã€‚ï¼ˆæ¶ˆæ¯è½¬å‘åœ¨ä¸‹æ–‡æœ‰ä»‹ç»ï¼‰</li></ol><p>è¿™å°±æ˜¯åœ¨è¿è¡Œæ—¶ç³»ç»Ÿä¸­é€‰æ‹©æ–¹æ³•å®ç°çš„æ–¹å¼ã€‚åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œä¸€èˆ¬ç§°ä½œ<strong>æ–¹æ³•å’Œæ¶ˆæ¯åŠ¨æ€ç»‘å®šçš„è¿‡ç¨‹</strong>ã€‚</p><p>ä¸ºäº†åŠ å¿«æ¶ˆæ¯çš„å¤„ç†è¿‡ç¨‹ï¼Œè¿è¡Œæ—¶ç³»ç»Ÿé€šå¸¸ä¼šå°†ä½¿ç”¨è¿‡çš„æ–¹æ³•é€‰æ ‡å’Œæ–¹æ³•å®ç°çš„åœ°å€æ”¾å…¥ç¼“å­˜ä¸­ã€‚æ¯ä¸ªç±»<br>éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¼“å­˜ï¼ŒåŒæ—¶åŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³•å’Œåœ¨è¯¥ç±»ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚æ¶ˆæ¯å‡½æ•°ä¼šé¦–å…ˆæ£€æŸ¥æ¶ˆæ¯æ¥æ”¶è€…å¯¹è±¡<br>å¯¹åº”çš„ç±»çš„ç¼“å­˜(ç†è®ºä¸Šï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•è¢«ä½¿ç”¨è¿‡ä¸€æ¬¡ï¼Œé‚£ä¹ˆå®ƒå¾ˆå¯èƒ½è¢«å†æ¬¡ä½¿ç”¨)ã€‚å¦‚æœåœ¨ç¼“å­˜ä¸­å·²ç»<br>æœ‰äº†éœ€è¦çš„æ–¹æ³•é€‰æ ‡ï¼Œåˆ™æ¶ˆæ¯ä»…ä»…æ¯”å‡½æ•°è°ƒç”¨æ…¢ä¸€ç‚¹ç‚¹ã€‚å¦‚æœç¨‹åºè¿è¡Œäº†è¶³å¤Ÿé•¿çš„æ—¶é—´ï¼Œå‡ ä¹æ¯ä¸ªæ¶ˆæ¯éƒ½<br>èƒ½åœ¨ç¼“å­˜ä¸­æ‰¾åˆ°æ–¹æ³•å®ç°ã€‚ç¨‹åºè¿è¡Œæ—¶ï¼Œç¼“å­˜ä¹Ÿå°†éšç€æ–°çš„æ¶ˆæ¯çš„å¢åŠ è€Œå¢åŠ ã€‚</p><h3 id="ä½¿ç”¨éšè—çš„å‚æ•°"><a href="#ä½¿ç”¨éšè—çš„å‚æ•°" class="headerlink" title="ä½¿ç”¨éšè—çš„å‚æ•°"></a>ä½¿ç”¨éšè—çš„å‚æ•°</h3><p>ç–‘é—®ï¼š<br>æˆ‘ä»¬ç»å¸¸ç”¨åˆ°å…³é”®å­—<code>self</code>ï¼Œä½†æ˜¯<code>self</code>æ˜¯å¦‚ä½•è·å–å½“å‰æ–¹æ³•çš„å¯¹è±¡å‘¢ï¼Ÿ</p><p>å…¶å®ï¼Œè¿™ä¹Ÿæ˜¯<code>runtime</code>ç³»ç»Ÿçš„ä½œç”¨ï¼Œ<code>self</code>æ˜¯åœ¨æ–¹æ³•è¿è¡Œæ—¶è¢«åŠ¨æ€ä¼ å…¥çš„ã€‚</p><p>å½“<code>objc_msgSend</code>æ‰¾åˆ°æ–¹æ³•å¯¹åº”å®ç°æ—¶ï¼Œå®ƒå°†ç›´æ¥è°ƒç”¨è¯¥æ–¹æ³•å®ç°ï¼Œå¹¶å°†æ¶ˆæ¯ä¸­æ‰€æœ‰å‚æ•°éƒ½ä¼ é€’ç»™æ–¹æ³•å®ç°ï¼ŒåŒæ—¶ï¼Œå¥¹è¿˜å°†ä¼ é€’ä¸¤ä¸ª<strong>éšè—å‚æ•°</strong>ï¼š</p><ul><li>æ¥æ”¶æ¶ˆæ¯çš„å¯¹è±¡ï¼ˆ<code>self</code>æ‰€æŒ‡å‘çš„å†…å®¹ï¼Œå½“å‰æ–¹æ³•çš„å¯¹è±¡æŒ‡é’ˆï¼‰</li><li>æ–¹æ³•é€‰æ‹©å™¨ï¼ˆ<code>_cmd</code>æŒ‡å‘çš„å†…å®¹ï¼Œå½“å‰æ–¹æ³•çš„<code>SEL</code>æŒ‡é’ˆï¼‰</li></ul><p>è¿™äº›å‚æ•°å¸®åŠ©æ–¹æ³•å®ç°è·å¾—äº†æ¶ˆæ¯è¡¨è¾¾å¼çš„ä¿¡æ¯ã€‚å®ƒä»¬è¢«è®¤ä¸ºæ˜¯â€œéšè—â€çš„æ˜¯å› ä¸ºå®ƒä»¬å¹¶æ²¡æœ‰åœ¨å®šä¹‰æ–¹æ³•çš„æºä»£ç ä¸­å£°æ˜ï¼Œè€Œæ˜¯åœ¨ä»£ç ç¼–è¯‘æ—¶æ’å…¥æ–¹æ³•å®ç°ä¸­çš„ã€‚å°½ç®¡è¿™äº›å‚æ•°æ²¡æœ‰è¢«æ˜ç¡®å£°æ˜ï¼Œåœ¨æºä»£ç ä¸­æˆ‘ä»¬ä»ç„¶å¯ä»¥å¼•ç”¨å®ƒä»¬ã€‚</p><p>è¿™ä¸¤ä¸ªå‚æ•°ä¸­ï¼Œ<code>self</code>æ›´å®ç”¨ã€‚å®ƒæ˜¯åœ¨æ–¹æ³•å®ç°ä¸­è®¿é—®æ¶ˆæ¯æ¥æ”¶è€…å¯¹è±¡çš„å®ä¾‹å˜é‡çš„é€”å¾„ã€‚</p><p>è¿™æ—¶æˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°å¦ä¸€ä¸ªå…³é”®å­—<code>super</code>ï¼Œå®é™…ä¸Š<code>super</code>å…³é”®å­—æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåˆ›å»ºä¸€ä¸ª<code>objc_super</code>ç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_super</span> &#123;</span> id receiver; Class <span class="class"><span class="keyword">class</span>;</span>&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ä½“æŒ‡æ˜äº†æ¶ˆæ¯åº”è¯¥è¢«ä¼ é€’ç»™ç‰¹å®šçš„çˆ¶ç±»ã€‚<code>receiver</code>ä»ç„¶æ˜¯<code>self</code>æœ¬èº«ï¼Œå½“æˆ‘ä»¬æƒ³é€šè¿‡<code>[super class]</code>è·å–çˆ¶ç±»æ—¶ï¼Œç¼–è¯‘å™¨å…¶å®æ˜¯å°†æŒ‡å‘<code>self</code>çš„<code>id</code>æŒ‡é’ˆå’Œ<code>class</code>çš„<code>SEL</code>ä¼ é€’ç»™<code>objc_msgSendSuper</code>å‡½æ•°ã€‚åªæœ‰åœ¨NSObjectç±»ä¸­æ‰èƒ½æ‰¾åˆ°<code>class</code>æ–¹æ³•ï¼Œç„¶å<code>class</code>æ–¹æ³•åº•å±‚è¢«è½¬æ¢ä¸º<code>object_getClass()</code>ï¼Œæ¥ç€åº•å±‚ç¼–è¯‘å™¨å°†ä»£ç è½¬æ¢ä¸º<code>objc_msgSend(objc_super-&gt;receiver, @selector(class))</code>ï¼Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å‘<code>self</code>çš„<code>id</code>æŒ‡é’ˆï¼Œä¸è°ƒç”¨<code>[self class]</code>ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°çš„æ°¸è¿œéƒ½æ˜¯<code>self</code>çš„ç±»å‹ã€‚å› æ­¤ä½ ä¼šå‘ç°ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™å¥è¯å¹¶ä¸èƒ½è·å–çˆ¶ç±»çš„ç±»å‹ï¼Œåªèƒ½è·å–å½“å‰ç±»çš„ç±»å‹å</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">super</span> <span class="keyword">class</span>]));</span><br></pre></td></tr></table></figure><h2 id="æ¶ˆæ¯è½¬å‘"><a href="#æ¶ˆæ¯è½¬å‘" class="headerlink" title="æ¶ˆæ¯è½¬å‘"></a>æ¶ˆæ¯è½¬å‘</h2><p><strong>æ¶ˆæ¯è½¬å‘æœºåˆ¶åŸºæœ¬åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</strong><br>1ã€åŠ¨æ€æ–¹æ³•è§£æ<br>2ã€å¤‡ç”¨æ¥æ”¶è€…<br>3ã€å®Œæ•´è½¬å‘</p><p>æ•´ä¸ªæ¶ˆæ¯è½¬å‘æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://p9u62mso1.bkt.clouddn.com/s_msgSend.png" alt=""></p><h3 id="1ã€æ‰€å±ç±»åŠ¨æ€æ–¹æ³•è§£æ"><a href="#1ã€æ‰€å±ç±»åŠ¨æ€æ–¹æ³•è§£æ" class="headerlink" title="1ã€æ‰€å±ç±»åŠ¨æ€æ–¹æ³•è§£æ"></a>1ã€æ‰€å±ç±»åŠ¨æ€æ–¹æ³•è§£æ</h3><p>é¦–å…ˆï¼Œå¦‚æœæ²¿ç€ç»§æ‰¿æ ‘æ²¡æœ‰æœç´¢åˆ°ç›¸å…³æ–¹æ³•åˆ™ä¼šå‘æ¥å—è€…æ‰€å±çš„ç±»è¿›è¡Œä¸€æ¬¡è¯·æ±‚ï¼Œè°ƒç”¨æ‰€å±ç±»çš„ç±»æ–¹æ³• <code>+resolveInstanceMethod:(å®ä¾‹æ–¹æ³•)</code> æˆ–è€… <code>+resolveClassMethod:(ç±»æ–¹æ³•)</code>ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æœ‰æœºä¼šä¸ºè¯¥æœªçŸ¥æ¶ˆæ¯æ–°å¢ä¸€ä¸ªâ€å¤„ç†æ–¹æ³•â€œã€‚ä¸è¿‡ä½¿ç”¨è¯¥æ–¹æ³•çš„å‰ææ˜¯æˆ‘ä»¬å·²ç»å®ç°äº†è¯¥â€å¤„ç†æ–¹æ³•â€ï¼Œåªéœ€è¦åœ¨è¿è¡Œæ—¶é€šè¿‡<code>class_addMethod</code>å‡½æ•°åŠ¨æ€æ·»åŠ åˆ°ç±»é‡Œé¢å°±å¯ä»¥äº†ã€‚</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="selector-tag">BOOL</span>)<span class="selector-tag">resolveInstanceMethod</span><span class="selector-pseudo">:(SEL)sel</span>;</span><br><span class="line">+ (<span class="selector-tag">BOOL</span>)<span class="selector-tag">resolveClassMethod</span><span class="selector-pseudo">:(SEL)sel</span>;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Person.m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Person.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSUInteger</span> age;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"resolveInstanceMethod: %@"</span>, <span class="built_in">NSStringFromSelector</span>(sel));</span><br><span class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(appendString:)) &#123;</span><br><span class="line">        class_addMethod([<span class="keyword">self</span> <span class="keyword">class</span>], sel, (IMP)dynamicAdditonMethodIMP, <span class="string">"v@:"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveClassMethod:(SEL)sel &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"resolveClassMethod: %@"</span>, <span class="built_in">NSStringFromSelector</span>(sel));</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveClassMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> dynamicAdditonMethodIMP(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dynamicAdditonMethodIMP"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// viewController.m</span></span><br><span class="line"><span class="keyword">id</span> *p = [[Person alloc] init];</span><br><span class="line">[p appendString:<span class="string">@""</span>];</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2018<span class="selector-tag">-06-12</span> 14<span class="selector-pseudo">:38</span><span class="selector-pseudo">:54.461050+0800</span> <span class="selector-tag">getIP</span><span class="selector-attr">[12036:607027]</span> <span class="selector-tag">resolveInstanceMethod</span>: <span class="selector-tag">appendString</span>:</span><br><span class="line">2018<span class="selector-tag">-06-12</span> 14<span class="selector-pseudo">:38</span><span class="selector-pseudo">:54.461230+0800</span> <span class="selector-tag">getIP</span><span class="selector-attr">[12036:607027]</span> <span class="selector-tag">dynamicAdditonMethodIMP</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªPersonçš„å®ä¾‹å¯¹è±¡ï¼Œä¸€å®šè¦ç”¨<code>id</code>ç±»å‹æ¥å£°æ˜ï¼Œå¦åˆ™ä¼šåœ¨ç¼–è¯‘å™¨å°±æŠ¥é”™ï¼Œå› ä¸ºæ‰¾ä¸åˆ°ç›¸å…³å‡½æ•°çš„å£°æ˜ï¼ˆè¿™é‡Œæ˜¯appendString:ï¼‰ã€‚<code>id</code>ç±»å‹ç”±äºå¯ä»¥æŒ‡å‘ä»»ä½•ç±»å‹çš„å¯¹è±¡ï¼Œå› æ­¤ç¼–è¯‘æ—¶èƒ½å¤Ÿæ‰¾åˆ°NSStringç±»çš„ç›¸å…³æ–¹æ³•å£°æ˜å°±ä¸ä¼šæŠ¥é”™ã€‚</p><p>ç”±äºPersonç±»æ²¡æœ‰å£°æ˜å’Œå®šä¹‰<code>appendString:</code>æ–¹æ³•ï¼Œæ‰€ä»¥è¿è¡Œæ—¶åº”è¯¥ä¼šæŠ¥<code>unrecognized selector</code>é”™è¯¯ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ï¼Œå› ä¸ºæˆ‘ä»¬é‡å†™äº†ç±»æ–¹æ³•<code>+ (BOOL)resolveInstanceMethod:(SEL)sel</code>ï¼Œå½“æ‰¾ä¸åˆ°ç›¸å…³å®ä¾‹æ–¹æ³•çš„æ—¶å€™å°±ä¼šè°ƒç”¨è¯¥ç±»æ–¹æ³•å»è¯¢é—®æ˜¯å¦å¯ä»¥åŠ¨æ€æ·»åŠ ï¼Œå¦‚æœè¿”å›<code>YES</code>å°±ä¼šå†æ¬¡æ‰§è¡Œç›¸å…³æ–¹æ³•ï¼Œå¦‚ä½•ç»™ä¸€ä¸ªç±»åŠ¨æ€æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£å°±æ˜¯è°ƒç”¨<code>runtime</code>åº“ä¸­çš„<code>class_addMethod</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åŸå‹æ˜¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">class_addMethod</span><span class="params">(Class cls, SEL name, IMP imp, <span class="keyword">const</span> <span class="keyword">char</span> *types)</span></span>;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éœ€è¦æ·»åŠ æ–¹æ³•çš„ç±»ï¼›<br>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª<code>selector</code>ï¼Œä¹Ÿå°±æ˜¯å®ä¾‹æ–¹æ³•çš„åå­—ï¼›<br>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª<code>IMP</code>ç±»å‹çš„å˜é‡ä¹Ÿæ˜¯å‡½æ•°å®ç°ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªCå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è‡³å°‘ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯<code>id self</code> ä¸€ä¸ªæ˜¯<code>SEL _cmd</code>ï¼›<br>ç¬¬å››ä¸ªå‚æ•°æ˜¯å‡½æ•°ç±»å‹ï¼Œæ›´å¤šå«ä¹‰è§ï¼š<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="noopener">Type Encodings</a>ï¼›</p><h3 id="2ã€å¤‡ç”¨æ¥æ”¶è€…"><a href="#2ã€å¤‡ç”¨æ¥æ”¶è€…" class="headerlink" title="2ã€å¤‡ç”¨æ¥æ”¶è€…"></a>2ã€å¤‡ç”¨æ¥æ”¶è€…</h3><p>åŠ¨æ€æ–¹æ³•è§£ææ— æ³•å¤„ç†æ¶ˆæ¯æ—¶ï¼Œåˆ™ä¼šèµ°å¤‡ç”¨æ¥æ”¶è€…ã€‚è¿™ä¸ª<strong>å¤‡ç”¨æ¥æ”¶è€…åªèƒ½æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡</strong>ï¼Œä¸èƒ½æ˜¯<code>self</code>æœ¬èº«ï¼Œå¦åˆ™å°±ä¼šå‡ºç°æ— çº¿å¾ªç¯ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šç›¸åº”çš„å¯¹è±¡æ¥å¤„ç†aSelectorï¼Œåˆ™åº”è¯¥è°ƒç”¨çˆ¶ç±»çš„å®ç°æ¥è¿”å›ç»“æœã€‚</p><p><strong>Personç±»å£°æ˜ä¸¤ä¸ªæ–¹æ³•ï¼š</strong></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@interface</span> <span class="string">Person :</span> NSObject</span><br><span class="line">- (<span class="keyword">void</span>)hello;</span><br><span class="line">+ (Person *)hi;</span><br><span class="line"><span class="meta">@end</span></span><br></pre></td></tr></table></figure><p><strong>å®ç°åœ¨Person.mä¸­å®ç°æ–°çš„æ¥æ”¶å¯¹è±¡_helperå’ŒforwardingTargetForSelector:æ–¹æ³•ï¼š</strong></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    RuntimeMethodHelper *_helper;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"forwardingTargetForSelector"</span>);</span><br><span class="line">    <span class="built_in">NSString</span> *selectorString = <span class="built_in">NSStringFromSelector</span>(aSelector);</span><br><span class="line">    <span class="comment">// å°†æ¶ˆæ¯äº¤ç»™_helperæ¥å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> ([selectorString isEqualToString:<span class="string">@"hello"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> _helper;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>RuntimeMethodHelperç±»éœ€è¦å®ç°è½¬å‘çš„æ–¹æ³•ï¼š</strong></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"RuntimeMethodHelper.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">RuntimeMethodHelper</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)hello &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@, %p"</span>, <span class="keyword">self</span>, _cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p><strong>æœ€ååœ¨viewController.mä¸­è°ƒç”¨ï¼š</strong></p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id p = <span class="comment">[<span class="comment">[Person alloc]</span> init]</span>;</span><br><span class="line"><span class="comment">[p hello]</span>;</span><br></pre></td></tr></table></figure><p><strong>è¾“å‡ºç»“æœï¼š</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2018<span class="selector-tag">-06-12</span> 16<span class="selector-pseudo">:54</span><span class="selector-pseudo">:26.113808+0800</span> <span class="selector-tag">getIP</span><span class="selector-attr">[13842:768645]</span> <span class="selector-tag">forwardingTargetForSelector</span></span><br><span class="line">2018<span class="selector-tag">-06-12</span> 16<span class="selector-pseudo">:54</span><span class="selector-pseudo">:26.114031+0800</span> <span class="selector-tag">getIP</span><span class="selector-attr">[13842:768645]</span> &lt;<span class="selector-tag">RuntimeMethodHelper</span>: 0<span class="selector-tag">x60400000e270</span>&gt;, 0<span class="selector-tag">x10ed5f93b</span></span><br></pre></td></tr></table></figure><h3 id="3ã€æ¶ˆæ¯é‡å®šå‘"><a href="#3ã€æ¶ˆæ¯é‡å®šå‘" class="headerlink" title="3ã€æ¶ˆæ¯é‡å®šå‘"></a>3ã€æ¶ˆæ¯é‡å®šå‘</h3><p>å¦‚æœåŠ¨æ€æ–¹æ³•è§£æå’Œå¤‡ç”¨æ¥æ”¶è€…éƒ½æ²¡æœ‰å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œå°±åªå‰©æœ€åä¸€æ¬¡æœºä¼šï¼Œé‚£å°±æ˜¯æ¶ˆæ¯é‡å®šå‘ã€‚è¿™ä¸ªæ—¶å€™<code>runtime</code>ä¼šå°†æœªçŸ¥æ¶ˆæ¯çš„æ‰€æœ‰ç»†èŠ‚éƒ½å°è£…ä¸º<code>NSInvocation</code>å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ä¸‹è¿°æ–¹æ³•ï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(void)</span>forwardInvocation:<span class="params">(NSInvocation *)</span>anInvocation;</span><br></pre></td></tr></table></figure><p><code>forwardInvocation:</code>æ¶ˆæ¯ç»™è¿™ä¸ªé—®é¢˜æä¾›äº†ä¸€ä¸ªæ›´ç‰¹åˆ«çš„ï¼ŒåŠ¨æ€çš„è§£å†³æ–¹æ¡ˆï¼šå½“ä¸€ä¸ªå¯¹è±¡ç”±äºæ²¡æœ‰ç›¸åº”çš„æ–¹æ³•å®ç°è€Œæ— æ³•å“åº”æŸæ¶ˆæ¯æ—¶ï¼Œè¿è¡Œæ—¶ç³»ç»Ÿå°†é€šè¿‡<code>forwardInvocation:</code>æ¶ˆæ¯é€šçŸ¥è¯¥å¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡éƒ½ä» NSObjectç±»ä¸­ç»§æ‰¿äº†<code>forwardInvocation:</code>æ–¹æ³•ã€‚ç„¶è€Œï¼ŒNSObject ä¸­çš„æ–¹æ³•å®ç°åªæ˜¯ç®€å•åœ°è°ƒç”¨äº† <code>doesNotRecognizeSelector:</code>ã€‚é€šè¿‡å®ç°æ‚¨è‡ªå·±çš„<code>forwardInvocation:</code>æ–¹æ³•ï¼Œæ‚¨å¯ä»¥åœ¨è¯¥æ–¹æ³•å®ç°ä¸­å°†æ¶ˆæ¯è½¬å‘ç»™å…¶å®ƒå¯¹è±¡ã€‚</p><p>è¦è½¬å‘æ¶ˆæ¯ç»™å…¶ä»–å¯¹è±¡æ—¶ï¼Œ<code>forwardInvocation:</code>æ–¹æ³•æ‰€å¿…é¡»åšçš„æœ‰ï¼š</p><ul><li>å†³å®šå°†æ¶ˆæ¯è½¬å‘ç»™è°</li><li>å¹¶ä¸”ï¼Œå°†æ¶ˆæ¯å’ŒåŸæ¥çš„å‚æ•°ä¸€å—è½¬å‘å‡ºå»</li></ul><blockquote><p>æ³¨æ„ï¼šforwardæ„æ€æ˜¯â€œè½¬å¯„â€ï¼ŒforwardingTargetForSelector:å’ŒforwardInvocation:éƒ½æ˜¯æŠŠæ¶ˆæ¯è½¬å‘ç»™ä¸€ä¸ªæ–°çš„æ¥æ”¶å¯¹è±¡ã€‚</p></blockquote><p>è¿™é‡Œæ¶ˆæ¯å¯ä»¥é€šè¿‡<code>invokeWithTarget:</code>æ–¹æ³•æ¥è½¬å‘ï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation &#123;</span><br><span class="line">    NSLog(@<span class="string">"forwardInvocation"</span>);</span><br><span class="line">    <span class="keyword">if</span> ([RuntimeMethodHelper <span class="string">instancesRespondToSelector:</span>anInvocation.selector]) &#123;</span><br><span class="line">        [anInvocation <span class="string">invokeWithTarget:</span>_helper];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSMethodSignature *)<span class="string">methodSignatureForSelector:</span>(SEL)aSelector &#123;</span><br><span class="line">    NSMethodSignature *signature = [<span class="keyword">super</span> <span class="string">methodSignatureForSelector:</span>aSelector];</span><br><span class="line">    <span class="keyword">if</span> (!signature) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([RuntimeMethodHelper <span class="string">instancesRespondToSelector:</span>aSelector]) &#123;</span><br><span class="line">            signature = [RuntimeMethodHelper <span class="string">instanceMethodSignatureForSelector:</span>aSelector];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> signature;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2018<span class="selector-tag">-06-12</span> 17<span class="selector-pseudo">:21</span><span class="selector-pseudo">:22.255362+0800</span> <span class="selector-tag">getIP</span><span class="selector-attr">[14454:801341]</span> <span class="selector-tag">forwardInvocation</span></span><br><span class="line">2018<span class="selector-tag">-06-12</span> 17<span class="selector-pseudo">:21</span><span class="selector-pseudo">:22.255588+0800</span> <span class="selector-tag">getIP</span><span class="selector-attr">[14454:801341]</span> &lt;<span class="selector-tag">RuntimeMethodHelper</span>: 0<span class="selector-tag">x604000016fd0</span>&gt;, 0<span class="selector-tag">x10c80f8e9</span></span><br></pre></td></tr></table></figure><p>è½¬å‘æ¶ˆæ¯åçš„è¿”å›å€¼å°†è¿”å›ç»™åŸæ¥çš„æ¶ˆæ¯å‘é€è€…ã€‚ä½ å¯ä»¥è¿”å›ä»»ä½•ç±»å‹çš„è¿”å›å€¼ï¼ŒåŒ…æ‹¬idï¼Œç»“æ„ä½“ï¼Œæµ®ç‚¹æ•°ç­‰ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è‡³æ­¤ï¼Œæˆ‘ä»¬äº†è§£åˆ°äº†<code>runtime</code>æ˜¯å¦‚ä½•é€šè¿‡<code>objc_msgSend</code>åœ¨è¿è¡Œæ—¶æŠŠæ–¹æ³•å’Œæ–¹æ³•å®ç°è¿›è¡ŒåŠ¨æ€ç»‘å®šçš„ï¼›ä¹Ÿäº†è§£åˆ°å¦‚æœæ²¿ç»§æ‰¿æ ‘æ‰¾ä¸åˆ°<code>IMP</code>ï¼Œå¦‚ä½•è¿›è¡ŒåŠ¨æ€æ–¹æ³•è§£æå’Œæ¶ˆæ¯è½¬å‘çš„ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ‚¨å°†äº†è§£åˆ°äº†&lt;code&gt;runtime&lt;/code&gt;æ˜¯å¦‚ä½•é€šè¿‡&lt;code&gt;objc_msgSend&lt;/code&gt;åœ¨è¿è¡Œæ—¶æŠŠæ–¹æ³•å’Œæ–¹æ³•å®ç°è¿›è¡ŒåŠ¨æ€ç»‘å®šçš„ï¼›&lt;br&gt;ä¹Ÿå°†äº†è§£åˆ°runtimeä¸‹åŠ¨æ€æ–¹æ³•è§£æå’Œæ¶ˆæ¯è½¬å‘çš„æœºåˆ¶æ˜¯æ€æ ·çš„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="runtime" scheme="http://yoursite.com/tags/runtime/"/>
    
  </entry>
  
  <entry>
    <title>runtimeç³»åˆ—ä¹‹ï¼ˆ2ï¼‰ä»runtimeå¼€å§‹ç†è§£é¢å‘å¯¹è±¡çš„ç±»åˆ°é¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“</title>
    <link href="http://yoursite.com/2018/06/05/runtime%E7%B3%BB%E5%88%97%E4%B9%8B%EF%BC%882%EF%BC%89%E4%BB%8Eruntime%E5%BC%80%E5%A7%8B%E7%90%86%E8%A7%A3%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%B1%BB%E5%88%B0%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B%E7%9A%84%E7%BB%93/"/>
    <id>http://yoursite.com/2018/06/05/runtimeç³»åˆ—ä¹‹ï¼ˆ2ï¼‰ä»runtimeå¼€å§‹ç†è§£é¢å‘å¯¹è±¡çš„ç±»åˆ°é¢å‘è¿‡ç¨‹çš„ç»“/</id>
    <published>2018-06-05T12:16:23.000Z</published>
    <updated>2019-03-25T06:52:57.232Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬ç¯‡å°†çœ‹åˆ°runtimeæ˜¯å¦‚ä½•å°†é¢å‘å¯¹è±¡çš„ç±»è½¬å˜ä¸ºé¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“çš„ï¼Œæ·±å…¥ç†è§£instanceã€class objectã€metaclassçš„å…³ç³»ã€‚</p><a id="more"></a><h3 id="ä»ç†è§£é¢å‘å¯¹è±¡çš„ç±»åˆ°é¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“å¼€å§‹"><a href="#ä»ç†è§£é¢å‘å¯¹è±¡çš„ç±»åˆ°é¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“å¼€å§‹" class="headerlink" title="ä»ç†è§£é¢å‘å¯¹è±¡çš„ç±»åˆ°é¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“å¼€å§‹"></a>ä»ç†è§£é¢å‘å¯¹è±¡çš„ç±»åˆ°é¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“å¼€å§‹</h3><p>æˆ‘ä»¬ä½¿ç”¨OCè¿›è¡Œé¢å‘å¯¹è±¡å¼€å‘ï¼Œè€ŒCè¯­è¨€æ›´å¤šçš„æ˜¯é¢å‘è¿‡ç¨‹å¼€å‘ï¼Œè¿™å°±éœ€è¦å°†é¢å‘å¯¹è±¡çš„ç±»è½¬å˜ä¸ºé¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“ï¼Œæœ¬æ–‡æ­£æ˜¯é€šè¿‡<code>runtime</code>æºç åˆ†ææ¥è®²è§£<code>runtime</code>æ˜¯å¦‚ä½•å°†é¢å‘å¯¹è±¡çš„ç±»è½¬å˜ä¸ºé¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“ï¼Œæ¢ç©¶OCå¯¹ç±»çš„å¤„ç†æœ¬è´¨ã€‚</p><h3 id="æ·±å…¥ä»£ç ç†è§£instanceã€class-objectã€metaclass"><a href="#æ·±å…¥ä»£ç ç†è§£instanceã€class-objectã€metaclass" class="headerlink" title="æ·±å…¥ä»£ç ç†è§£instanceã€class objectã€metaclass"></a>æ·±å…¥ä»£ç ç†è§£instanceã€class objectã€metaclass</h3><p>é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œæœ€é‡è¦çš„æ¦‚å¿µå°±æ˜¯ç±»ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä»ä»£ç å…¥æ‰‹ï¼Œçœ‹çœ‹OCæ˜¯å¦‚ä½•å®ç°ç±»çš„ã€‚</p><p>å‰é¢ä¸€ç›´åœ¨è¯´runtimeå°†é¢å‘å¯¹è±¡çš„ç±»è½¬å˜ä¸ºé¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“ï¼Œé‚£è¿™ä¸ªç»“æ„ä½“åˆ°åº•æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿæ‰“å¼€<code>#import&lt;objc/objc.h&gt;</code>æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°ä»¥ä¸‹å‡ è¡Œä»£ç ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/// An opaque type that represents an Objective-C class.</span><br><span class="line">typedef struct objc_class *Class;</span><br><span class="line"></span><br><span class="line">/// Represents an<span class="built_in"> instance </span>of a class.</span><br><span class="line">struct objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAI<span class="class">LABILITY;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/// A pointer to an<span class="built_in"> instance </span>of a class.</span><br><span class="line">typedef struct objc_object *id;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ³¨é‡Šå’Œä»£ç ä¸éš¾å‘ç°ï¼Œæˆ‘ä»¬åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡æˆ–ç¤ºä¾‹å…¶å®å°±æ˜¯ä¸€ä¸ª<code>struct objc_object</code>ç»“æ„ä½“ï¼Œè€Œæˆ‘ä»¬å¸¸ç”¨çš„<code>id</code>ä¹Ÿå°±æ˜¯è¿™ä¸ªç»“æ„ä½“çš„æŒ‡é’ˆã€‚æœ‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»¥ä¸‹ä¸¤ç§å†™æ³•éƒ½æˆç«‹</span></span><br><span class="line">id <span class="keyword">str</span> = [[NSString <span class="keyword">alloc</span>] init]<span class="comment">;</span></span><br><span class="line">NSString *<span class="keyword">str</span> = [[NSString <span class="keyword">alloc</span>] init]<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šè¿°ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬åˆ›å»ºçš„<code>NSStringç±»</code>çš„å®ä¾‹<code>str</code>å…¶å®å°±æ˜¯ä¸€ä¸ª<code>struct objc_object</code>ç»“æ„ä½“æŒ‡é’ˆï¼Œæ‰€ä»¥ä¸ç®¡æ˜¯<code>Foundationæ¡†æ¶</code>ä¸­çš„ç±»æˆ–æ˜¯è‡ªå®šä¹‰çš„ç±»ï¼Œæˆ‘ä»¬åˆ›å»ºçš„ç±»çš„å®ä¾‹æœ€ç»ˆè·å–çš„éƒ½æ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆï¼Œè¿™ä¸ªç»“æ„ä½“åªæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡å°±æ˜¯<code>Class</code>ç±»å‹çš„<code>isa</code>æŒ‡é’ˆï¼Œ<code>Class</code>æ˜¯ç»“æ„ä½“æŒ‡é’ˆï¼ŒæŒ‡å‘<code>struct objc_class</code>ï¼Œé‚£è¿™ä¸ªç»“æ„ä½“åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œå…ˆé€æ¼ä¸€å¥è¯<code>str is a NSString</code>ï¼Œå†åŠ ä¸Š<code>Class</code>è¿™ä¸ªæŒ‡é’ˆçš„åå­—ï¼Œä¸éš¾çŒœæµ‹ï¼Œè¿™é‡Œ<code>Class</code>å°±æ˜¯ä»£è¡¨<code>NSString</code>è¿™ä¸ªç±»ã€‚</p><p>æ¥ä¸‹æ¥è¯¦ç»†è®²è§£<code>objc_class</code>è¿™ä¸ªç»“æ„ä½“ï¼Œç°åœ¨å†çœ‹å¦ä¸€ä¸ªä¾‹å­ï¼Œæœ‰æ—¶æˆ‘ä»¬ä¹Ÿä¼šé€šè¿‡ä¸‹è¿°æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">NSString</span> *str = [[<span class="symbol">NSString</span> alloc] initWithString: @<span class="string">"Hello World"</span>];</span><br><span class="line"><span class="symbol">Class</span> c = [str class];</span><br><span class="line"><span class="symbol">NSString</span> *str2 = [[c alloc] initWithString: @<span class="string">"Hello World"</span>];</span><br></pre></td></tr></table></figure><p>å¯èƒ½ä½ å·²ç»å‘ç°ï¼Œé€šè¿‡å®ä¾‹å¯¹è±¡è°ƒç”¨çš„<code>class</code>æ–¹æ³•ï¼Œèƒ½å¤Ÿè·å–åˆ°ä¸€ä¸ª<code>Class</code>ç±»å‹çš„å˜é‡ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ª<code>Class</code>æ¥åˆ›å»ºç›¸åº”çš„å®ä¾‹å¯¹è±¡ã€‚</p><p>å®é™…ä¸Šï¼ŒOCä¸­çš„ç±»ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæˆä¸º<code>ç±»å¯¹è±¡</code>ï¼Œä¸Šè¿°æ–¹æ³•ä¸­é€šè¿‡<code>[str class]</code>æ–¹æ³•è·å–åˆ°çš„å°±æ˜¯<code>NSStringç±»</code>çš„<code>ç±»å¯¹è±¡</code>ï¼Œæ¥ç€æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ª<code>ç±»å¯¹è±¡</code>æ¥åˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œé‚£è¿™ä¸ª<code>ç±»å¯¹è±¡</code>åˆæ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿæ‰“å¼€<code>#import&lt;objc/runtime.h&gt;</code>æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ç»“æ„ä½“<code>struct objc_class</code>çš„å®šä¹‰ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶objc/runtime.hä¸­æœ‰å¦‚ä¸‹å®šä¹‰:</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> &#123;</span></span><br><span class="line">  Class isa OBJC_ISA_AVAILABILITY; <span class="comment">//isaæŒ‡é’ˆæŒ‡å‘Meta Classï¼Œå› ä¸ºObjcçš„ç±»çš„æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªObjectï¼Œä¸ºäº†å¤„ç†è¿™ä¸ªå…³ç³»ï¼Œruntimeå°±åˆ›é€ äº†Meta Classï¼Œå½“ç»™ç±»å‘é€[NSObject alloc]è¿™æ ·æ¶ˆæ¯æ—¶ï¼Œå®é™…ä¸Šæ˜¯æŠŠè¿™ä¸ªæ¶ˆæ¯å‘ç»™äº†Class Object</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> !__OBJC2__</span></span><br><span class="line">  Class super_class OBJC2_UNAVAILABLE; <span class="comment">// çˆ¶ç±»</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *name OBJC2_UNAVAILABLE; <span class="comment">// ç±»å</span></span><br><span class="line">  <span class="keyword">long</span> version OBJC2_UNAVAILABLE; <span class="comment">// ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œé»˜è®¤ä¸º0</span></span><br><span class="line">  <span class="keyword">long</span> info OBJC2_UNAVAILABLE; <span class="comment">// ç±»ä¿¡æ¯ï¼Œä¾›è¿è¡ŒæœŸä½¿ç”¨çš„ä¸€äº›ä½æ ‡è¯†</span></span><br><span class="line">  <span class="keyword">long</span> instance_size OBJC2_UNAVAILABLE; <span class="comment">// è¯¥ç±»çš„å®ä¾‹å˜é‡å¤§å°</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar_list</span> *<span class="title">ivars</span> <span class="title">OBJC2_UNAVAILABLE</span>;</span> <span class="comment">// è¯¥ç±»çš„æˆå‘˜å˜é‡é“¾è¡¨</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">objc_method_list</span> **<span class="title">methodLists</span> <span class="title">OBJC2_UNAVAILABLE</span>;</span> <span class="comment">// æ–¹æ³•å®šä¹‰çš„é“¾è¡¨</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> *<span class="title">cache</span> <span class="title">OBJC2_UNAVAILABLE</span>;</span> <span class="comment">// æ–¹æ³•ç¼“å­˜ï¼Œå¯¹è±¡æ¥åˆ°ä¸€ä¸ªæ¶ˆæ¯ä¼šæ ¹æ®isaæŒ‡é’ˆæŸ¥æ‰¾æ¶ˆæ¯å¯¹è±¡ï¼Œè¿™æ—¶ä¼šåœ¨method Listsä¸­éå†ï¼Œå¦‚æœcacheäº†ï¼Œå¸¸ç”¨çš„æ–¹æ³•è°ƒç”¨æ—¶å°±èƒ½å¤Ÿæé«˜è°ƒç”¨çš„æ•ˆç‡ã€‚</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">objc_protocol_list</span> *<span class="title">protocols</span> <span class="title">OBJC2_UNAVAILABLE</span>;</span> <span class="comment">// åè®®é“¾è¡¨</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  &#125; OBJC2_UNAVAILABLE;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  æ–‡ä»¶objc/objc.hæ–‡ä»¶ä¸­æœ‰å¦‚ä¸‹å®šä¹‰</span><br><span class="line"><span class="comment">/// An opaque type that represents an Objective-C class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> *<span class="title">Class</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// Represents an instance of a class.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A pointer to an instance of a class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> *<span class="title">id</span>;</span></span><br></pre></td></tr></table></figure><p><code>struct objc_class</code>ç»“æ„ä½“å®šä¹‰äº†å¾ˆå¤šå˜é‡ï¼Œé€šè¿‡å‘½åä¸éš¾å‘ç°ï¼Œç»“æ„ä½“é‡Œä¿å­˜äº†æŒ‡å‘çˆ¶ç±»çš„æŒ‡é’ˆã€ç±»çš„åå­—ã€ç‰ˆæœ¬ã€å®ä¾‹å¤§å°ã€å®ä¾‹å˜é‡åˆ—è¡¨ã€æ–¹æ³•åˆ—è¡¨ã€ç¼“å­˜ã€éµå®ˆçš„åè®®åˆ—è¡¨ç­‰ï¼Œä¸€ä¸ªç±»åŒ…å«çš„ä¿¡æ¯ä¹Ÿä¸å°±æ­£æ˜¯è¿™äº›å—ï¼Ÿæ²¡é”™ï¼Œ<code>ç±»å¯¹è±¡</code>å°±æ˜¯ä¸€ä¸ªç»“æ„ä½“<code>struct objc_class</code>ï¼Œè¿™ä¸ªç»“æ„ä½“å­˜æ”¾çš„æ•°æ®ç§°ä¸º<code>å…ƒæ•°æ®(metadata)</code>ï¼Œè¯¥ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡ä¹Ÿæ˜¯<code>isa</code>æŒ‡é’ˆï¼Œè¿™å°±è¯´æ˜<code>Class</code>æœ¬èº«å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬ç§°ä¹‹ä¸º<code>ç±»å¯¹è±¡</code>ï¼Œç±»å¯¹è±¡åœ¨ç¼–è¯‘æœŸäº§ç”Ÿç”¨äºåˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œæ˜¯å•ä¾‹ã€‚</p><p><code>ç±»å¯¹è±¡</code>ä¸­çš„<code>å…ƒæ•°æ®</code>å­˜å‚¨çš„éƒ½æ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ªå®ä¾‹çš„ç›¸å…³ä¿¡æ¯ï¼Œé‚£ä¹ˆç±»å¯¹è±¡å’Œç±»æ–¹æ³•åº”è¯¥ä»å“ªé‡Œåˆ›å»ºå‘¢ï¼Ÿå°±æ˜¯ä»<code>isa</code>æŒ‡é’ˆæŒ‡å‘çš„ç»“æ„ä½“åˆ›å»ºï¼Œç±»å¯¹è±¡çš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘çš„æˆ‘ä»¬ç§°ä¹‹ä¸º<code>å…ƒç±»(metaclass)</code>ï¼Œ<code>å…ƒç±»</code>ä¸­ä¿å­˜äº†åˆ›å»ºç±»å¯¹è±¡ä»¥åŠç±»æ–¹æ³•æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå› æ­¤æ•´ä¸ªç»“æ„åº”è¯¥å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="http://p9u62mso1.bkt.clouddn.com/r_runtimeIsa.png" alt=""></p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥æ¸…æ™°çš„çœ‹å‡ºæ¥ä¸€ä¸ªå®ä¾‹å¯¹è±¡ä¹Ÿå°±æ˜¯<code>struct objc_object</code>ç»“æ„ä½“å®ƒçš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘<code>ç±»å¯¹è±¡</code>ï¼Œ<code>ç±»å¯¹è±¡</code>çš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘äº†<code>å…ƒç±»</code>ï¼Œ<code>ç±»å¯¹è±¡</code>çš„<code>super_class</code>æŒ‡é’ˆæŒ‡å‘äº†çˆ¶ç±»çš„<code>ç±»å¯¹è±¡</code>ï¼Œè€Œ<code>å…ƒç±»</code>çš„<code>super_class</code>æŒ‡é’ˆæŒ‡å‘äº†çˆ¶ç±»çš„<code>å…ƒç±»</code>ï¼Œé‚£<code>å…ƒç±»</code>çš„<code>isa</code>æŒ‡é’ˆåˆæŒ‡å‘äº†ä»€ä¹ˆï¼Ÿä¸ºäº†æ›´æ¸…æ™°çš„è¡¨è¾¾ç›´æ¥å€Ÿç”¨å¤§ç¥çš„å›¾ã€‚</p><p><img src="http://p9u62mso1.bkt.clouddn.com/r_runtimeIsaAll.png" alt=""></p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ•´ä¸ªä½“ç³»æ„æˆäº†ä¸€ä¸ªè‡ªé—­ç¯ï¼Œå¦‚æœæ˜¯ä»<code>NSObject</code>ä¸­ç»§æ‰¿è€Œæ¥çš„ï¼Œä¸Šå›¾ä¸­çš„<code>Root class</code>å°±æ˜¯<code>NSObject</code>ã€‚è‡³æ­¤ï¼Œæ•´ä¸ª<code>å®ä¾‹</code>ã€<code>ç±»å¯¹è±¡</code>ã€<code>å…ƒç±»</code>çš„æ¦‚å¿µä¹Ÿå°±è®²æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åœ¨ä»£ç ä¸­çœ‹çœ‹è¿™äº›æ¦‚å¿µè¯¥æ€ä¹ˆåº”ç”¨ã€‚</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–°å»ºä¸€ä¸ªPersonç±»ç»§æ‰¿è‡ªNSObject</span></span><br><span class="line"></span><br><span class="line">Person *p = [[Person alloc] init]<span class="comment">;</span></span><br><span class="line"><span class="keyword">Class</span> c1 = [p <span class="keyword">class</span>]<span class="comment">;</span></span><br><span class="line"><span class="keyword">Class</span> c2 = [Person <span class="keyword">class</span>]<span class="comment">;</span></span><br><span class="line"><span class="comment">//è¾“å‡º 1</span></span><br><span class="line">NSLog(@<span class="string">"%d"</span>, c1 == c2)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p><code>c1</code>æ˜¯é€šè¿‡ä¸€ä¸ªå®ä¾‹å¯¹è±¡è·å–çš„<code>Class</code>ï¼Œå®ä¾‹å¯¹è±¡å¯ä»¥è·å–åˆ°å…¶ä»–<code>ç±»å¯¹è±¡</code>ï¼Œç±»åä½œä¸ºæ¶ˆæ¯çš„æ¥å—è€…æ—¶ä»£è¡¨çš„æ˜¯<code>ç±»å¯¹è±¡</code>ï¼Œå› æ­¤<code>ç±»å¯¹è±¡</code>è·å–<code>Class</code>å¾—åˆ°çš„æ˜¯å…¶æœ¬èº«ï¼ŒåŒæ—¶ä¹Ÿå°è¯äº†<code>ç±»å¯¹è±¡</code>æ˜¯ä¸€ä¸ªå•ä¾‹çš„æƒ³æ³•ã€‚</p><p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³è·å–<code>isa</code>æŒ‡é’ˆçš„æŒ‡å‘å¯¹è±¡å‘¢ï¼Ÿ</p><p>ä»‹ç»ä¸¤ä¸ªå‡½æ•°ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OBJC_EXPORT</span> <span class="selector-tag">BOOL</span></span><br><span class="line"><span class="selector-tag">class_isMetaClass</span>(<span class="selector-tag">Class</span> _<span class="selector-tag">Nullable</span> <span class="selector-tag">cls</span>) </span><br><span class="line">    <span class="selector-tag">OBJC_AVAILABLE</span>(10<span class="selector-class">.5</span>, 2<span class="selector-class">.0</span>, 9<span class="selector-class">.0</span>, 1<span class="selector-class">.0</span>, 2<span class="selector-class">.0</span>);</span><br><span class="line">    </span><br><span class="line"><span class="selector-tag">OBJC_EXPORT</span> <span class="selector-tag">Class</span> _<span class="selector-tag">Nullable</span></span><br><span class="line"><span class="selector-tag">object_getClass</span>(<span class="selector-tag">id</span> _<span class="selector-tag">Nullable</span> <span class="selector-tag">obj</span>) </span><br><span class="line">    <span class="selector-tag">OBJC_AVAILABLE</span>(10<span class="selector-class">.5</span>, 2<span class="selector-class">.0</span>, 9<span class="selector-class">.0</span>, 1<span class="selector-class">.0</span>, 2<span class="selector-class">.0</span>);</span><br></pre></td></tr></table></figure><p><code>class_isMetaClass</code>ç”¨äºåˆ¤æ–­<code>Class</code>å¯¹è±¡æ˜¯å¦ä¸º<code>å…ƒç±»</code>ï¼Œ<code>object_getClass</code>ç”¨äºè·å–å¯¹è±¡çš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ã€‚</p><p>å†çœ‹å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Person *p = [[Person alloc] init];</span><br><span class="line"><span class="comment">//è¾“å‡º1</span></span><br><span class="line">NSLog(@<span class="string">"%d"</span>, [p <span class="keyword">class</span>] == <span class="keyword">object</span><span class="number">_</span>getClass(p));</span><br><span class="line"><span class="comment">//è¾“å‡º0</span></span><br><span class="line">NSLog(@<span class="string">"%d"</span>, <span class="keyword">class</span><span class="number">_</span>isMetaClass(<span class="keyword">object</span><span class="number">_</span>getClass(p)));</span><br><span class="line"><span class="comment">//è¾“å‡º1</span></span><br><span class="line">NSLog(@<span class="string">"%d"</span>, <span class="keyword">class</span><span class="number">_</span>isMetaClass(<span class="keyword">object</span><span class="number">_</span>getClass([Person <span class="keyword">class</span>])));</span><br><span class="line"><span class="comment">//è¾“å‡º0</span></span><br><span class="line">NSLog(@<span class="string">"%d"</span>, <span class="keyword">object</span><span class="number">_</span>getClass(p) == <span class="keyword">object</span><span class="number">_</span>getClass([Person <span class="keyword">class</span>]));</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä»£ç å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ªå®ä¾‹å¯¹è±¡é€šè¿‡<code>class</code>æ–¹æ³•è·å–çš„<code>Class</code>å°±æ˜¯å®ƒçš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘çš„<code>ç±»å¯¹è±¡</code>ï¼Œè€Œ<code>ç±»å¯¹è±¡</code>ä¸æ˜¯<code>å…ƒç±»</code>ï¼Œ<code>ç±»å¯¹è±¡</code>çš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡æ˜¯<code>å…ƒç±»</code>ã€‚</p><h3 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h3><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ¸…æ¥šçš„äº†è§£äº†OCä¸­çš„ç±»å’Œå®ä¾‹æ˜¯å¦‚ä½•æ˜ å°„åˆ°Cè¯­è¨€ç»“æ„ä½“çš„ï¼Œå®ä¾‹å¯¹è±¡æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“åªæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ï¼ŒæŒ‡å‘æ„é€ å®ƒçš„é‚£ä¸ªç±»å¯¹è±¡ï¼Œè¿™ä¸ªç±»å¯¹è±¡ä¸­å­˜å‚¨äº†ä¸€åˆ‡å®ä¾‹å¯¹è±¡éœ€è¦çš„ä¿¡æ¯åŒ…æ‹¬å®ä¾‹å˜é‡ã€å®ä¾‹æ–¹æ³•ç­‰ï¼Œè€Œç±»å¯¹è±¡æ˜¯é€šè¿‡å…ƒç±»åˆ›å»ºçš„ï¼Œå…ƒç±»ä¸­ä¿å­˜äº†ç±»å˜é‡å’Œç±»æ–¹æ³•ï¼Œè¿™å°±å®Œç¾çš„è§£é‡Šäº†æ•´ä¸ªç±»å’Œå®ä¾‹æ˜¯å¦‚ä½•æ˜ å°„åˆ°ç»“æ„ä½“çš„ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬ç¯‡å°†çœ‹åˆ°runtimeæ˜¯å¦‚ä½•å°†é¢å‘å¯¹è±¡çš„ç±»è½¬å˜ä¸ºé¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“çš„ï¼Œæ·±å…¥ç†è§£instanceã€class objectã€metaclassçš„å…³ç³»ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="runtime" scheme="http://yoursite.com/tags/runtime/"/>
    
  </entry>
  
  <entry>
    <title>runtimeç³»åˆ—ä¹‹ï¼ˆ1ï¼‰runtimeåˆæ¢</title>
    <link href="http://yoursite.com/2018/06/01/runtime%E7%B3%BB%E5%88%97%E4%B9%8B%EF%BC%881%EF%BC%89runtime%E5%88%9D%E6%8E%A2/"/>
    <id>http://yoursite.com/2018/06/01/runtimeç³»åˆ—ä¹‹ï¼ˆ1ï¼‰runtimeåˆæ¢/</id>
    <published>2018-06-01T14:46:40.000Z</published>
    <updated>2019-03-25T06:52:48.741Z</updated>
    
    <content type="html"><![CDATA[<p>æ‚¨å°†äº†è§£åˆ°ï¼š</p><ul><li>ä»€ä¹ˆæ˜¯runtime</li><li>ä¸runtimeç³»ç»Ÿå‘ç”Ÿäº¤äº’çš„ä¸‰ç§æ–¹å¼</li><li>ä¸€äº›runtimeçš„æœ¯è¯­çš„æ•°æ®ç»“æ„<a id="more"></a></li></ul><h3 id="ä»€ä¹ˆæ˜¯runtime"><a href="#ä»€ä¹ˆæ˜¯runtime" class="headerlink" title="ä»€ä¹ˆæ˜¯runtime"></a>ä»€ä¹ˆæ˜¯runtime</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“é«˜çº§ç¼–ç¨‹è¯­è¨€æƒ³è¦æˆä¸ºå¯æ‰§è¡Œæ–‡ä»¶éœ€è¦å…ˆç¼–è¯‘ä¸ºæ±‡ç¼–è¯­è¨€å†æ±‡ç¼–ä¸ºæœºå™¨è¯­è¨€ï¼Œæœºå™¨è¯­è¨€ä¹Ÿæ˜¯è®¡ç®—æœºèƒ½å¤Ÿè¯†åˆ«çš„å”¯ä¸€è¯­è¨€ï¼Œä½†æ˜¯OCå¹¶ä¸èƒ½ç›´æ¥ç¼–è¯‘ä¸ºæ±‡ç¼–è¯­è¨€ï¼Œè€Œæ˜¯è¦å…ˆè½¬å†™ä¸ºçº¯Cè¯­è¨€å†è¿›è¡Œç¼–è¯‘å’Œæ±‡ç¼–çš„æ“ä½œï¼Œä»OCåˆ°Cè¯­è¨€çš„è¿‡æ¸¡å°±æ˜¯ç”±<code>runtime</code>æ¥å®ç°çš„ã€‚</p><p>Objective-Cæ˜¯åŸºäºCçš„ï¼Œå®ƒä¸ºCæ·»åŠ äº†é¢å‘å¯¹è±¡çš„ç‰¹æ€§ã€‚å®ƒå°†å¾ˆå¤šé™æ€è¯­è¨€åœ¨ç¼–è¯‘å’Œé“¾æ¥æ—¶æœŸåšçš„äº‹æ”¾åˆ°äº†<code>runtime</code>è¿è¡Œæ—¶æ¥å¤„ç†ï¼Œå¯ä»¥è¯´<code>runtime</code>æ˜¯æˆ‘ä»¬Objective-Cå¹•åå·¥ä½œè€…ã€‚</p><ul><li><p><code>runtime</code>ï¼ˆç®€ç§°è¿è¡Œæ—¶ï¼‰ï¼Œæ˜¯ä¸€å¥—çº¯Cï¼ˆCå’Œæ±‡ç¼–å†™çš„ï¼‰çš„APIã€‚è€ŒOCå°±æ˜¯è¿è¡Œæ—¶æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿è¡Œæ—¶å€™çš„ä¸€äº›æœºåˆ¶ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„æ˜¯æ¶ˆæ¯æœºåˆ¶ã€‚</p></li><li><p>å¯¹äºCè¯­è¨€ï¼Œæ–¹æ³•çš„è°ƒç”¨ä¼šåœ¨ç¼–è¯‘çš„æ—¶å€™å°±å†³å®šå¥½è°ƒç”¨å“ªä¸ªæ–¹æ³•ã€‚</p></li><li><p>OCçš„æ–¹æ³•è°ƒç”¨æˆä¸ºæ¶ˆæ¯å‘é€ï¼Œå±äºåŠ¨æ€è°ƒç”¨è¿‡ç¨‹ã€‚åœ¨ç¼–è¯‘çš„æ—¶å€™å¹¶ä¸èƒ½å†³å®šçœŸæ­£è°ƒç”¨å“ªä¸ªæ–¹æ³•ï¼Œåªæœ‰åœ¨çœŸæ­£è¿è¡Œçš„æ—¶å€™æ‰ä¼šæ ¹æ®æ–¹æ³•çš„åç§°æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•å®ç°æ¥è°ƒç”¨ã€‚</p></li><li><p>äº‹å®è¯æ˜ï¼šåœ¨ç¼–è¯‘é˜¶æ®µï¼ŒOCå¯ä»¥è°ƒç”¨ä»»ä½•æ–¹æ³•ï¼Œå³ä½¿è¿™ä¸ªæ–¹æ³•å¹¶æœªå®ç°ï¼Œåªè¦å£°æ˜è¿‡å°±ä¸ä¼šæŠ¥é”™ï¼Œåªæœ‰è¿è¡Œçš„æ—¶å€™æ‰ä¼šæŠ¥é”™ï¼Œè¿™æ˜¯å› ä¸ºOCæ˜¯è¿è¡Œæ—¶åŠ¨æ€è°ƒç”¨çš„ã€‚è€ŒCè¯­è¨€è°ƒç”¨æœªå®ç°çš„æ–¹æ³•å°±ä¼šæŠ¥é”™ã€‚</p></li></ul><h3 id="ä¸runtimeç³»ç»Ÿå‘ç”Ÿäº¤äº’çš„ä¸‰ç§æ–¹å¼"><a href="#ä¸runtimeç³»ç»Ÿå‘ç”Ÿäº¤äº’çš„ä¸‰ç§æ–¹å¼" class="headerlink" title="ä¸runtimeç³»ç»Ÿå‘ç”Ÿäº¤äº’çš„ä¸‰ç§æ–¹å¼"></a>ä¸runtimeç³»ç»Ÿå‘ç”Ÿäº¤äº’çš„ä¸‰ç§æ–¹å¼</h3><p><code>runtime</code>æ˜¯ä¸€ä¸ªå…±äº«åŠ¨æ€åº“ï¼Œç”±ä¸€ç³»åˆ—çš„Cå‡½æ•°å’Œç»“æ„ä½“æ„æˆã€‚å’Œ<code>runtime</code>ç³»ç»Ÿå‘ç”Ÿäº¤äº’çš„æ–¹å¼æœ‰ä¸‰ç§ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨å‰ä¸¤ç§ï¼š</p><ol><li><strong>é€šè¿‡Objective-Cæºä»£ç </strong><ul><li>å¤šæ•°æƒ…å†µæˆ‘ä»¬åªéœ€è¦ç¼–å†™OCä»£ç å³å¯ï¼Œruntimeç³»ç»Ÿè‡ªåŠ¨åœ¨å¹•åæå®šä¸€åˆ‡ã€‚</li></ul></li><li><p><strong>é€šè¿‡Foundationæ¡†æ¶çš„NSObjectç±»å®šä¹‰çš„æ–¹æ³•</strong><br> Cocoa ç¨‹åºä¸­ç»å¤§éƒ¨åˆ†ç±»éƒ½æ˜¯NSObjectç±»çš„å­ç±»ï¼Œæ‰€ä»¥éƒ½ç»§æ‰¿äº†NSObjectçš„è¡Œä¸ºã€‚(<code>NSProxy</code>ç±»æ—¶ä¸ªä¾‹å¤–ï¼Œå®ƒæ˜¯ä¸ªæŠ½è±¡è¶…ç±»)</p><p> ä¸€äº›æƒ…å†µä¸‹ï¼ŒNSObject ç±»ä»…ä»…å®šä¹‰äº†å®ŒæˆæŸä»¶äº‹æƒ…çš„æ¨¡æ¿ï¼Œå¹¶æ²¡æœ‰æä¾›æ‰€éœ€è¦çš„ä»£ç ã€‚ä¾‹å¦‚<code>-description</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ç±»å†…å®¹çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œè¯¥æ–¹æ³•ä¸»è¦ç”¨æ¥è°ƒè¯•ç¨‹åºã€‚NSObject ç±»å¹¶ä¸çŸ¥é“å­ç±»çš„å†…å®¹ï¼Œæ‰€ä»¥å®ƒåªæ˜¯è¿”å›ç±»çš„åå­—å’Œå¯¹è±¡çš„åœ°å€ï¼ŒNSObject çš„å­ç±»å¯ä»¥é‡æ–°å®ç°ã€‚</p><p> è¿˜æœ‰ä¸€äº›NSObjectçš„æ–¹æ³•å¯ä»¥ä»runtimeç³»ç»Ÿä¸­è·å–ä¿¡æ¯ï¼Œå…è®¸å¯¹è±¡è¿›è¡Œè‡ªæˆ‘æ£€æŸ¥ã€‚ä¾‹å¦‚ï¼š</p><ul><li><code>-class</code>æ–¹æ³•è¿”å›å¯¹è±¡çš„ç±»ï¼›</li><li><code>-isKindOfClass:</code>å’Œ<code>-isMemberOfClass:</code>æ–¹æ³•æ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨äºæŒ‡å®šçš„ç±»çš„ç»§æ‰¿ä½“ç³»ä¸­(æ˜¯å¦æ˜¯å…¶å­ç±»æˆ–è€…çˆ¶ç±»æˆ–è€…å½“å‰ç±»çš„æˆå‘˜å˜é‡)ï¼›</li><li><code>-respondsToSelector:</code>æ£€æŸ¥å¯¹è±¡èƒ½å¦å“åº”æŒ‡å®šçš„æ¶ˆæ¯ï¼›</li><li><code>-conformsToProtocol:</code>æ£€æŸ¥å¯¹è±¡æ˜¯å¦å®ç°äº†æŒ‡å®šåè®®ç±»çš„æ–¹æ³•ï¼›</li><li><code>-methodForSelector:</code>è¿”å›æŒ‡å®šæ–¹æ³•å®ç°çš„åœ°å€ï¼›</li></ul></li><li><p><strong>é€šè¿‡å¯¹runtimeåº“å‡½æ•°çš„ç›´æ¥è°ƒç”¨</strong><br> ä½¿ç”¨æ—¶å¼•å…¥<code>#import &lt;objc/runtime.h&gt;</code>å’Œ<code>#import &lt;objc/message.h&gt;</code>å¤´æ–‡ä»¶ï¼Œä¸€äº›åŸºç¡€æ–¹æ³•éƒ½å®šä¹‰åœ¨è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­ã€‚</p></li></ol><h3 id="ä¸€äº›runtimeçš„æœ¯è¯­çš„æ•°æ®ç»“æ„"><a href="#ä¸€äº›runtimeçš„æœ¯è¯­çš„æ•°æ®ç»“æ„" class="headerlink" title="ä¸€äº›runtimeçš„æœ¯è¯­çš„æ•°æ®ç»“æ„"></a>ä¸€äº›runtimeçš„æœ¯è¯­çš„æ•°æ®ç»“æ„</h3><h4 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h4><p>å®ƒæ˜¯selectoråœ¨Objcä¸­è¡¨ç¤ºï¼ˆswiftä¸­æ˜¯Selectorç±»ï¼‰ã€‚selectoræ˜¯æ–¹æ³•é€‰æ‹©å™¨ï¼Œselectorå¯¹æ–¹æ³•åè¿›è¡ŒåŒ…è£…ï¼Œä»¥ä¾¿æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•å®ç°ã€‚å®ƒçš„æ•°æ®ç»“æ„æ˜¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_selector</span> *<span class="title">SEL</span>;</span></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼š<br>ä¸åŒç±»ä¸­ç›¸åŒåå­—çš„æ–¹æ³•æ‰€å¯¹åº”çš„ selector æ˜¯ç›¸åŒçš„ï¼Œç”±äºå˜é‡çš„ç±»å‹ä¸åŒï¼Œæ‰€ä»¥ä¸ä¼šå¯¼è‡´å®ƒä»¬è°ƒç”¨æ–¹æ³•å®ç°æ··ä¹±ã€‚</p></blockquote><h4 id="id"><a href="#id" class="headerlink" title="id"></a>id</h4><p>idæ˜¯ä¸€ä¸ªå‚æ•°ç±»å‹ï¼Œå®ƒæ˜¯æŒ‡å‘æŸä¸ªç±»çš„å®ä¾‹çš„æŒ‡é’ˆã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAI<span class="class">LABILITY;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/// A pointer to an<span class="built_in"> instance </span>of a class.</span><br><span class="line">typedef struct objc_object *id;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå®šä¹‰ï¼Œçœ‹åˆ°<code>objc_object</code>ç»“æ„ä½“åŒ…å«ä¸€ä¸ª<code>isa</code>æŒ‡é’ˆï¼Œæ ¹æ®<code>isa</code>æŒ‡é’ˆå°±å¯ä»¥æ‰¾åˆ°å¯¹è±¡æ‰€å±çš„ç±»ã€‚</p><blockquote><p>æ³¨æ„ï¼š<br><code>isa</code> æŒ‡é’ˆåœ¨ä»£ç è¿è¡Œæ—¶å¹¶ä¸æ€»æŒ‡å‘å®ä¾‹å¯¹è±¡æ‰€å±çš„ç±»å‹ï¼Œæ‰€ä»¥ä¸èƒ½ä¾é å®ƒæ¥ç¡®å®šç±»å‹ï¼Œè¦æƒ³ç¡®å®šç±»å‹è¿˜æ˜¯éœ€è¦ç”¨å¯¹è±¡çš„ <code>-class</code> æ–¹æ³•ã€‚</p></blockquote><p>PS: KVO çš„å®ç°æœºç†å°±æ˜¯å°†è¢«è§‚å¯Ÿå¯¹è±¡çš„ <code>isa</code> æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªä¸­é—´ç±»è€Œä¸æ˜¯çœŸå®ç±»å‹ï¼Œè¯¦è§:</p><h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> *<span class="title">Class</span>;</span></span><br></pre></td></tr></table></figure><p><code>Class</code>å…¶å®æ˜¯æŒ‡å‘<code>objc_class</code>ç»“æ„ä½“çš„æŒ‡é’ˆã€‚<code>objc_class</code>çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> &#123;</span></span><br><span class="line">  Class isa OBJC_ISA_AVAILABILITY; <span class="comment">//isaæŒ‡é’ˆæŒ‡å‘Meta Classï¼Œå› ä¸ºObjcçš„ç±»çš„æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªObjectï¼Œä¸ºäº†å¤„ç†è¿™ä¸ªå…³ç³»ï¼Œruntimeå°±åˆ›é€ äº†Meta Classï¼Œå½“ç»™ç±»å‘é€[NSObject alloc]è¿™æ ·æ¶ˆæ¯æ—¶ï¼Œå®é™…ä¸Šæ˜¯æŠŠè¿™ä¸ªæ¶ˆæ¯å‘ç»™äº†Class Object</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> !__OBJC2__</span></span><br><span class="line">  Class super_class OBJC2_UNAVAILABLE; <span class="comment">// çˆ¶ç±»</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *name OBJC2_UNAVAILABLE; <span class="comment">// ç±»å</span></span><br><span class="line">  <span class="keyword">long</span> version OBJC2_UNAVAILABLE; <span class="comment">// ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œé»˜è®¤ä¸º0</span></span><br><span class="line">  <span class="keyword">long</span> info OBJC2_UNAVAILABLE; <span class="comment">// ç±»ä¿¡æ¯ï¼Œä¾›è¿è¡ŒæœŸä½¿ç”¨çš„ä¸€äº›ä½æ ‡è¯†</span></span><br><span class="line">  <span class="keyword">long</span> instance_size OBJC2_UNAVAILABLE; <span class="comment">// è¯¥ç±»çš„å®ä¾‹å˜é‡å¤§å°</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar_list</span> *<span class="title">ivars</span> <span class="title">OBJC2_UNAVAILABLE</span>;</span> <span class="comment">// è¯¥ç±»çš„æˆå‘˜å˜é‡é“¾è¡¨</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">objc_method_list</span> **<span class="title">methodLists</span> <span class="title">OBJC2_UNAVAILABLE</span>;</span> <span class="comment">// æ–¹æ³•å®šä¹‰çš„é“¾è¡¨</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> *<span class="title">cache</span> <span class="title">OBJC2_UNAVAILABLE</span>;</span> <span class="comment">// æ–¹æ³•ç¼“å­˜ï¼Œå¯¹è±¡æ¥åˆ°ä¸€ä¸ªæ¶ˆæ¯ä¼šæ ¹æ®isaæŒ‡é’ˆæŸ¥æ‰¾æ¶ˆæ¯å¯¹è±¡ï¼Œè¿™æ—¶ä¼šåœ¨method Listsä¸­éå†ï¼Œå¦‚æœcacheäº†ï¼Œå¸¸ç”¨çš„æ–¹æ³•è°ƒç”¨æ—¶å°±èƒ½å¤Ÿæé«˜è°ƒç”¨çš„æ•ˆç‡ã€‚</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">objc_protocol_list</span> *<span class="title">protocols</span> <span class="title">OBJC2_UNAVAILABLE</span>;</span> <span class="comment">// åè®®é“¾è¡¨</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  &#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure><p>ä»<code>objc_class</code>å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªè¿è¡Œæ—¶ç±»ä¸­å…³è”äº†å®ƒçš„<code>çˆ¶ç±»</code>ã€<code>ç±»å</code>ã€<code>æˆå‘˜å˜é‡</code>ã€<code>æ–¹æ³•</code>ã€<code>ç¼“å­˜</code>ä»¥åŠ<code>é™„å±çš„åè®®</code>ã€‚å…¶ä¸­<code>objc_ivar_list</code>å’Œ<code>objc_method_list</code>åˆ†åˆ«æ˜¯æˆå‘˜å˜é‡åˆ—è¡¨å’Œæ–¹æ³•åˆ—è¡¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æˆå‘˜å˜é‡åˆ—è¡¨</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar_list</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> ivar_count                                           OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar</span> <span class="title">ivar_list</span>[1]                            <span class="title">OBJC2_UNAVAILABLE</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_method_list</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_method_list</span> * _<span class="title">Nullable</span> <span class="title">obsolete</span>             <span class="title">OBJC2_UNAVAILABLE</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> method_count                                         OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">objc_method</span> <span class="title">method_list</span>[1]                        <span class="title">OBJC2_UNAVAILABLE</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯è§ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€ä¿®æ”¹<code>*methodList</code>çš„å€¼æ¥æ·»åŠ æˆå‘˜æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯Categoryå®ç°çš„åŸç†ï¼ŒåŒæ ·è§£é‡Šäº†Categoryä¸èƒ½æ·»åŠ å±æ€§çš„åŸå› ã€‚è¿™é‡Œå¯ä»¥å‚è€ƒä¸‹ç¾å›¢æŠ€æœ¯å›¢é˜Ÿçš„æ–‡ç« ï¼š<a href="https://tech.meituan.com/DiveIntoCategory.html" target="_blank" rel="noopener">ç¾å›¢æŠ€æœ¯å›¢é˜Ÿâ€“æ·±å…¥ç†è§£Objective-C:Category</a></p><p><code>objc_ivar_list</code>ç»“æ„ä½“ç”¨æ¥å­˜å‚¨æˆå‘˜å˜é‡çš„åˆ—è¡¨ï¼Œè€Œ<code>objc_ivar</code>åˆ™æ˜¯å­˜å‚¨äº†å•ä¸ªæˆå‘˜å˜é‡çš„ä¿¡æ¯ï¼›åŒç†ï¼Œ<code>objc_method_list</code>ç»“æ„ä½“å­˜å‚¨ç€æ–¹æ³•æ•°ç»„çš„åˆ—è¡¨ï¼Œè€Œå•ä¸ªæ–¹æ³•çš„ä¿¡æ¯åˆ™ç”±<code>objc_method</code>ç»“æ„ä½“å­˜å‚¨ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>objc_class</code>ä¸­ä¹Ÿæœ‰ä¸€ä¸ª<code>isa</code>æŒ‡é’ˆï¼Œè¿™è¯´æ˜<code>Objcç±»</code>æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚ä¸ºäº†å¤„ç†ç±»å’Œå¯¹è±¡çš„å…³ç³»ï¼Œ<code>runtime</code>åº“åˆ›å»ºäº†ä¸€ç§å«åš<code>Meta Classï¼ˆå…ƒç±»ï¼‰</code>çš„ä¸œè¥¿ï¼Œç±»å¯¹è±¡æ‰€å±çš„ç±»å°±å«åš<code>å…ƒç±»</code>ã€‚<code>Meta Class</code>è¡¨è¿°äº†ç±»å¯¹è±¡æœ¬èº«æ‰€å…·å¤‡çš„å…ƒæ•°æ®ã€‚</p><p>æˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„ç±»æ–¹æ³•ï¼Œå°±æºè‡ªäº<code>Meta Class</code>ã€‚æˆ‘ä»¬å¯ä»¥ç«‹å³ä¸ºç±»æ–¹æ³•å°±æ˜¯ç±»å¯¹è±¡çš„å®ä¾‹æ–¹æ³•ã€‚æ¯ä¸ªç±»ä»…æœ‰ä¸€ä¸ªç±»å¯¹è±¡ï¼Œè€Œæ¯ä¸ªç±»å¯¹è±¡ä»…æœ‰ä¸€ä¸ªä¸ä¹‹ç›¸å…³çš„å…ƒç±»ã€‚</p><p>å½“ä½ å‘å‡ºä¸€ä¸ªç±»ä¼¼<code>[NSObject alloc](ç±»æ–¹æ³•)</code>çš„æ¶ˆæ¯æ—¶ï¼Œå®é™…ä¸Šï¼Œè¿™ä¸ªæ¶ˆæ¯è¢«å‘é€ç»™äº†ä¸€ä¸ª<code>ç±»å¯¹è±¡(Class Object)</code>ï¼Œè¿™ä¸ªç±»å¯¹è±¡å¿…é¡»æ˜¯ä¸€ä¸ªå…ƒç±»çš„å®ä¾‹ï¼Œè€Œè¿™ä¸ªå…ƒç±»åŒæ—¶ä¹Ÿæ˜¯ä¹Ÿæ˜¯ä¸€ä¸ª<code>æ ¹å…ƒç±»(Root Meta Class)</code>çš„å®ä¾‹ã€‚æ‰€æœ‰å…ƒç±»çš„<code>isa</code>æŒ‡é’ˆæœ€ç»ˆéƒ½æŒ‡å‘<code>æ ¹å…ƒç±»</code>ã€‚</p><p>æ‰€ä»¥å½“<code>[NSObject alloc]</code>è¿™æ¡æ¶ˆæ¯å‘é€ç»™ç±»å¯¹è±¡çš„æ—¶å€™ï¼Œè¿è¡Œæ—¶ä»£ç <code>objc_msgSend()</code>ä¼šå»å®ƒçš„å…ƒç±»ä¸­æŸ¥æ‰¾èƒ½å¤Ÿå“åº”æ¶ˆæ¯çš„æ–¹æ³•å®ç°ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ä¼šå¯¹è¿™ä¸ªç±»å¯¹è±¡æ‰§è¡Œæ–¹æ³•è°ƒç”¨ã€‚</p><p><img src="http://p9u62mso1.bkt.clouddn.com/r_runtimeIsaAll.png" alt=""></p><p>ä¸Šå›¾å®çº¿æ˜¯<code>super_class</code>æŒ‡é’ˆï¼Œè™šçº¿æ˜¯<code>isa</code>æŒ‡é’ˆã€‚è€Œæ ¹å…ƒç±»çš„çˆ¶ç±»æ˜¯NSObjectï¼Œ<code>isa</code>æŒ‡å‘äº†è‡ªå·±ã€‚è€ŒNSObjectæ²¡æœ‰çˆ¶ç±»ã€‚æœ€å<code>objc_class</code>ä¸­è¿˜æœ‰ä¸€ä¸ª<code>objc_cache</code>ï¼Œç¼“å­˜ï¼Œå®ƒçš„å·¦å³å¾ˆé‡è¦ï¼Œåé¢ä¼šæåˆ°ã€‚</p><h4 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_method *<span class="function"><span class="keyword">Method</span>;</span></span><br><span class="line"></span><br><span class="line">struct objc_method <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    SEL _Nonnull method_name                                 OBJC2_UNAVAILABLE;</span></span><br><span class="line"><span class="comment">    char * _Nullable method_types                            OBJC2_UNAVAILABLE;</span></span><br><span class="line"><span class="comment">    IMP _Nonnull method_imp                                  OBJC2_UNAVAILABLE;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure><p><code>objc_method</code>å­˜å‚¨äº†æ–¹æ³•åï¼Œæ–¹æ³•ç±»å‹å’Œæ–¹æ³•å®çº¿ï¼š</p><ul><li>æ–¹æ³•åç±»å‹ä¸º<code>SEL</code></li><li>æ–¹æ³•ç±»å‹<code>method_types</code>æ˜¯ä¸ª<code>char</code>æŒ‡é’ˆï¼Œå­˜å‚¨æ–¹æ³•çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹</li><li><code>method_imp</code>æŒ‡å‘äº†æ–¹æ³•çš„å®ç°ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ</li></ul><h4 id="Ivar"><a href="#Ivar" class="headerlink" title="Ivar"></a>Ivar</h4><p><code>Ivar</code>æ˜¯è¡¨ç¤ºæˆå‘˜å˜é‡çš„ç±»å‹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar</span> *<span class="title">Ivar</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_ivar</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> * _Nullable ivar_name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">char</span> * _Nullable ivar_type                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">int</span> ivar_offset                                          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>ivar_offset</code>æ˜¯åŸºåœ°å€åç§»å­—èŠ‚</p><h4 id="IMP"><a href="#IMP" class="headerlink" title="IMP"></a>IMP</h4><p><code>IMP</code>åœ¨<code>objc.h</code>ä¸­çš„å®šä¹‰æ˜¯ï¼š</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef void (*<span class="type">IMP</span>)(void /* id, <span class="type">SEL</span>, ... */ );</span><br></pre></td></tr></table></figure><p>å®ƒå°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¿™æ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ã€‚å½“ä½ å‘èµ·ä¸€ä¸ª<code>ObjC</code>æ¶ˆæ¯ä¹‹åï¼Œæœ€ç»ˆå®ƒä¼šæ‰§è¡Œçš„é‚£æ®µä»£ç ï¼Œå°±æ˜¯ç”±è¿™ä¸ªå‡½æ•°æŒ‡é’ˆæŒ‡å®šçš„ã€‚è€Œ<code>IMP</code>è¿™ä¸ªå‡½æ•°æŒ‡é’ˆå°±æ˜¯æŒ‡å‘äº†è¿™ä¸ªæ–¹æ³•çš„å®ç°ã€‚</p><p>å¦‚æœå¾—åˆ°äº†æ‰§è¡ŒæŸä¸ªå®ä¾‹æŸä¸ªæ–¹æ³•çš„å…¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç»•å¼€æ¶ˆæ¯ä¼ é€’é˜¶æ®µï¼Œç›´æ¥æ‰§è¡Œæ–¹æ³•ï¼Œè¿™åœ¨ä¸‹é¢çš„<code>Cache</code>ä¸­ä¼šæåˆ°ã€‚</p><p>ä½ ä¼šå‘ç°<code>IMP</code>æŒ‡å‘çš„æ–¹æ³•ä¸<code>objc_msgSend</code>å‡½æ•°ç±»å‹ç›¸åŒï¼Œå‚æ•°éƒ½åŒ…å«<code>id</code>å’Œ<code>SEL</code>ç±»å‹ã€‚æ¯ä¸ªæ–¹æ³•åéƒ½å¯¹åº”ä¸€ä¸ª<code>SEL</code>ç±»å‹çš„æ–¹æ³•é€‰æ‹©å™¨ï¼Œè€Œæ¯ä¸ªå®ä¾‹å¯¹è±¡ä¸­çš„<code>SEL</code>å¯¹åº”æ–¹æ³•å®çº¿æ€»æ˜¯å”¯ä¸€çš„ï¼Œé€šè¿‡ä¸€ç»„<code>id</code>å’Œ<code>SEL</code>å‚æ•°å°±èƒ½ç¡®å®šå”¯ä¸€çš„æ–¹æ³•å®çº¿åœ°å€ã€‚</p><p>è€Œä¸€ä¸ªç¡®å®šçš„æ–¹æ³•ä¹Ÿåªæœ‰å”¯ä¸€çš„ä¸€ç»„<code>id</code>å’Œ<code>SEL</code>å‚æ•°ã€‚</p><h4 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h4><p>Cacheå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> *<span class="title">Cache</span>                             <span class="title">OBJC2_UNAVAILABLE</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mask <span class="comment">/* total = mask + 1 */</span>                 OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> occupied                                    OBJC2_UNAVAILABLE;</span><br><span class="line">    Method _Nullable buckets[<span class="number">1</span>]                              OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Cacheä¸ºæ–¹æ³•è°ƒç”¨çš„æ€§èƒ½è¿›è¡Œä¼˜åŒ–ï¼Œæ¯å½“å®ä¾‹å¯¹è±¡æ¥æ”¶åˆ°ä¸€ä¸ªæ¶ˆæ¯æ—¶ï¼Œå®ƒä¸ä¼šç›´æ¥åœ¨isaæŒ‡é’ˆæŒ‡å‘çš„ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­éå†æŸ¥æ‰¾èƒ½å¤Ÿå“åº”çš„æ–¹æ³•ï¼Œå› ä¸ºæ¯æ¬¡éƒ½è¦æŸ¥æ‰¾æ•ˆç‡å¤ªä½äº†ï¼Œè€Œæ˜¯ä¼˜å…ˆåœ¨Cacheä¸­æŸ¥æ‰¾ã€‚</p><p>runtimeç³»ç»Ÿä¼šæŠŠè¢«è°ƒç”¨çš„æ–¹æ³•å­˜åˆ°Cacheä¸­ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆå®ƒæœ‰å¯èƒ½ä»Šåè¿˜ä¼šè¢«è°ƒç”¨ï¼Œä¸‹æ¬¡æŸ¥æ‰¾çš„æ—¶å€™å°±ä¼šæ•ˆç‡æ›´é«˜ã€‚å°±åƒè®¡ç®—æœºç»„æˆåŸç†ä¸­CPUç»•è¿‡ä¸»å­˜å…ˆè®¿é—®Cacheä¸€æ ·ã€‚</p><h4 id="Property"><a href="#Property" class="headerlink" title="Property"></a>Property</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_property</span> *<span class="title">objc_property_t</span>;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡<code>class_copyPropertyList</code>å’Œ<code>protocol_copyPropertyList</code>æ–¹æ³•è·å–ç±»å’Œåè®®ä¸­çš„å±æ€§ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">objc_property_t</span> *class_copyPropertyList(Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount)</span><br><span class="line"><span class="keyword">objc_property_t</span> *protocol_copyPropertyList(Protocol *proto, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount);</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šè¿”å›çš„æ˜¯å±æ€§åˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª<code>objc_property_t</code>æŒ‡é’ˆ</p></blockquote><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** å§“å */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** age */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** weight */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="keyword">double</span> weight;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯ä¸€ä¸ªPersonç±»ï¼Œæœ‰ä¸‰ä¸ªå±æ€§ã€‚è®©æˆ‘ä»¬ç”¨ä¸Šè¿°æ–¹æ³•è·å–ç±»çš„è¿è¡Œæ—¶å±æ€§ã€‚</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">unsigned int outCount = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">objc_property_t *properties = class_copyPropertyList([Person class], <span class="symbol">&amp;outCount</span>)<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">for (<span class="name">NSInteger</span> i = <span class="number">0</span><span class="comment">; i &lt; outCount; ++i) &#123;</span></span><br><span class="line">   NSString *name = @(property_getName(properties[i]));</span><br><span class="line">   NSString *attributes = @(<span class="name">property_getAttributes</span>(<span class="name">properties</span>[i]))<span class="comment">;</span></span><br><span class="line">   NSLog(@<span class="string">"%@ ------- %@"</span>, name, attributes)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name ------- <span class="built_in">T</span>@<span class="string">"NSString"</span>,C,<span class="built_in">N</span>,V_name</span><br><span class="line">age ------- TQ,<span class="built_in">N</span>,V_age</span><br><span class="line">weight ------- Td,<span class="built_in">N</span>,V_weight</span><br></pre></td></tr></table></figure><p><code>property_getName</code>ç”¨æ¥æŸ¥æ‰¾å±æ€§çš„åç§°ï¼Œè¿”å›cå­—ç¬¦ä¸²ã€‚<code>property_getAttributes</code>å‡½æ•°æŒ–æ˜å±æ€§çš„çœŸå®åç§°å’Œ@encodeç±»å‹ï¼Œè¿”å›cå­—ç¬¦ä¸²ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">objc_property_t</span> class_getProperty(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line"><span class="keyword">objc_property_t</span> protocol_getProperty(Protocol *proto, <span class="keyword">const</span> <span class="keyword">char</span> *name, BOOL isRequiredProperty, BOOL isInstanceProperty)</span><br></pre></td></tr></table></figure><p><code>class_getProperty</code>å’Œ<code>protocol_getProperty</code>é€šè¿‡ç»™å‡ºå±æ€§ååœ¨ç±»å’Œåè®®ä¸­è·å¾—å±æ€§çš„å¼•ç”¨ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ä¸€äº›runtimeæœ¯è¯­è®²å®Œäº†ï¼Œæˆ‘ä»¬é˜Ÿç»“æ„ä½“<code>struct objc_class</code>æœ‰äº†äº†è§£ï¼Œä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°†å­¦ä¹ runtimeå¦‚ä½•å°†é¢å‘å¯¹è±¡çš„ç±»è½¬å˜ä¸ºé¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ‚¨å°†äº†è§£åˆ°ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä»€ä¹ˆæ˜¯runtime&lt;/li&gt;
&lt;li&gt;ä¸runtimeç³»ç»Ÿå‘ç”Ÿäº¤äº’çš„ä¸‰ç§æ–¹å¼&lt;/li&gt;
&lt;li&gt;ä¸€äº›runtimeçš„æœ¯è¯­çš„æ•°æ®ç»“æ„
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="runtime" scheme="http://yoursite.com/tags/runtime/"/>
    
  </entry>
  
  <entry>
    <title>SDWebImageæºç å·¥ä½œæµåˆ†æ</title>
    <link href="http://yoursite.com/2018/05/28/SDWebImage%E6%BA%90%E7%A0%81%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%88%86%E6%9E%90/"/>
    <id>http://yoursite.com/2018/05/28/SDWebImageæºç å·¥ä½œæµåˆ†æ/</id>
    <published>2018-05-28T14:46:40.000Z</published>
    <updated>2019-03-25T06:57:56.043Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://upload-images.jianshu.io/upload_images/1276164-09000824a56a1ad0.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="113"></p><p><strong>æœ¬ç¯‡å°†äº†è§£åˆ°ï¼š</strong></p><ul><li>SDWebImageæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå„å·¥å…·ç±»ä¹‹é—´æ˜¯å¦‚ä½•åè°ƒå¤„ç†çš„</li><li>SDWebImageæ˜¯å¦‚ä½•å¼‚æ­¥ä¸‹è½½å›¾ç‰‡åŠå¤„ç†çº¿ç¨‹å®‰å…¨é—®é¢˜çš„</li><li>SDWebImageæ˜¯å¦‚ä½•å¼‚æ­¥ç¼“å­˜å¹¶è‡ªåŠ¨ç®¡ç†ç¼“å­˜æœ‰æ•ˆæ€§çš„</li></ul><a id="more"></a><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><ul><li>ç›®çš„<br>SDWebImageæä¾›äº†UIImageViewã€UIButtonã€MKAnnotationViewçš„å›¾ç‰‡ä¸‹è½½åˆ†ç±»ï¼Œåªè¦ä¸€è¡Œä»£ç å°±å¯ä»¥å®ç°å›¾ç‰‡å¼‚æ­¥ä¸‹è½½å’Œç¼“å­˜åŠŸèƒ½ã€‚</li><li>ç‰¹æ€§<ul><li>æä¾›UIImageViewã€UIButtonã€MKAnnotationViewçš„åˆ†ç±»ï¼Œç”¨æ¥æ˜¾ç¤ºç½‘ç»œå›¾ç‰‡ï¼Œä»¥åŠç¼“å­˜ç®¡ç†</li><li>å¼‚æ­¥ä¸‹è½½å›¾ç‰‡</li><li>å¼‚æ­¥ç¼“å­˜ï¼ˆå†…å­˜+ç£ç›˜ï¼‰ï¼Œå¹¶ä¸”è‡ªåŠ¨ç®¡ç†ç¼“å­˜æœ‰æ•ˆæ€§</li><li>åå°å›¾ç‰‡è§£å‹ç¼©</li><li>åŒä¸€ä¸ªURLä¸ä¼šé‡å¤ä¸‹è½½</li><li>è‡ªåŠ¨è¯†åˆ«æ— æ•ˆURLï¼Œä¸ä¼šåå¤é‡è¯•</li><li>ä¸é˜»å¡ä¸»çº¿ç¨‹</li><li>é«˜æ€§èƒ½</li><li>ä½¿ç”¨GCDå’ŒARC</li><li>æ”¯æŒå¤šå›¾ç‰‡æ ¼å¼</li><li>æ”¯æŒåŠ¨å›¾<ul><li>4.0ä¹‹å‰åŠ¨å›¾æ•ˆæœå¹¶ä¸æ˜¯å¤ªå¥½</li><li>4.0ä¹‹ååŸºäºFLAnimatedImageåŠ è½½åŠ¨å›¾</li></ul></li></ul></li></ul><p><img src="http://p9u62mso1.bkt.clouddn.com/s_SDClassDiagram.png" alt="SDWebImageæ‰€æœ‰ç±»å…³ç³»å›¾è§£"></p><p><img src="http://p9u62mso1.bkt.clouddn.com/s_SDSequenceDiagram.png" alt="SDWebImageå·¥ä½œæµå›¾è§£"></p><p>ä¸Šé¢ä¸¤å¼ å›¾æ˜¯SDWebImage<a href="https://github.com/rs/SDWebImage" target="_blank" rel="noopener">åŸæ–‡</a>ç»™å‡ºçš„ï¼Œç°åœ¨çœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼Œä¸‹é¢åˆ†æ­¥è§£æä¹‹åå†å›æ¥çœ‹ã€‚</p><h2 id="æ ¸å¿ƒé€»è¾‘ï¼š"><a href="#æ ¸å¿ƒé€»è¾‘ï¼š" class="headerlink" title="æ ¸å¿ƒé€»è¾‘ï¼š"></a>æ ¸å¿ƒé€»è¾‘ï¼š</h2><ol><li><p>å…¥å£UIImageView+WebCacheè°ƒç”¨æ–¹æ³•<code>sd_setImageWithURL:placeholderImage:options:progress:completed:</code>ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨çš„æ˜¯UIView+WebCacheæä¾›çš„æ–¹æ³•<code>sd_internalSetImageWithURL:placeholderImage:options:operationKey:setImageBlock:progress:completed:</code></p></li><li><p>å¿…é¡»å…ˆåˆ é™¤è¯¥æ§ä»¶ä¹‹å‰çš„ä¸‹è½½ä»»åŠ¡ï¼Œ<code>sd_cancelImageLoadOperationWithKey</code>(4.0ä¹‹å‰æ˜¯sd_cancelCurrentImageLoad)åŸå› æ˜¯å½“ä½ ç½‘ç»œä¸å¿«çš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚ä½ ä¸€ä¸ªå±å¹•èƒ½å±•ç¤ºä¸‰ä¸ªcellï¼Œç¬¬ä¸€ä¸ªcellç”±äºç½‘ç»œé—®é¢˜ä¸èƒ½ç«‹åˆ»ä¸‹å®Œï¼Œé‚£ä¹ˆç”¨æˆ·å°±æ»‘åŠ¨äº†tableviewï¼Œç¬¬ä¸€ä¸ªcellè¿›å»å¤ç”¨æ± ï¼Œç¬¬äº”ä¸ªå‡ºæ¥çš„cellä»å¤ç”¨æ± å­æ‹¿ï¼Œç”±äºä¹‹å‰çš„ä¸‹è½½è¿˜åœ¨ï¼Œæœ¬æ¥æ˜¯åº”è¯¥æ˜¾ç¤ºç¬¬äº”ä¸ªå›¾ç‰‡ï¼Œä½†æ˜¯SDWebImageçš„é»˜è®¤åšæ³•æ˜¯ç«‹é©¬æŠŠä¸‹è½½å¥½çš„å›¾ç‰‡ç»™UIImageViewï¼Œæ‰€ä»¥è¿™æ—¶å€™ä¼šå›¾ç‰‡æ•°æ®é”™ä¹±ï¼ŒBUG</p></li><li><p>æœ‰placeHolderå…ˆå±•ç¤ºï¼Œç„¶åå¯ç”¨SDWebImageManagerå•ä¾‹<code>loadImageWithURL:options:progress:completed:</code>æ¥å¤„ç†å›¾ç‰‡ä¸‹è½½</p></li><li><p>å…ˆåˆ¤æ–­urlçš„åˆæ³•æ€§ï¼Œå†åˆ›å»ºSDwebImageCombinedOperationçš„cacheä»»åŠ¡å¯¹è±¡ï¼Œå†æŸ¥çœ‹urlæ˜¯å¦ä¹‹å‰ä¸‹è½½å¤±è´¥è¿‡ï¼Œæœ€åå¦‚æœurlä¸ºnilï¼Œåˆ™ç›´æ¥è¿”å›æ“ä½œå¯¹è±¡å®Œæˆå›è°ƒï¼Œå¦‚æœéƒ½æ­£å¸¸ï¼Œé‚£ä¹ˆå°±è°ƒç”¨SDWebImageManagerä¸­çš„ç®¡ç†ç¼“å­˜ç±»SDImageCacheå•ä¾‹çš„æ–¹æ³•<code>queryDiskCacheForKey:done:</code>æŸ¥çœ‹æ˜¯å¦æœ‰ç¼“å­˜</p></li><li><p>SDImageCacheå†…å­˜ç¼“å­˜ç”¨çš„æ˜¯NSCacheï¼ŒDiskç¼“å­˜ç”¨çš„æ˜¯NSFileManagerçš„æ–‡ä»¶å†™å…¥æ“ä½œï¼Œé‚£ä¹ˆæŸ¥çœ‹ç¼“å­˜çš„æ—¶å€™æ˜¯å…ˆå»å†…å­˜æŸ¥æ‰¾ï¼Œè¿™é‡Œçš„keyéƒ½æ˜¯ç»è¿‡MD5ä¹‹åçš„å­—ä¸²ï¼Œæ‰¾åˆ°ç›´æ¥å›è°ƒï¼Œæ²¡æ‰¾åˆ°ç»§ç»­å»ç£ç›˜æŸ¥æ‰¾ï¼Œ<em>å¼€å¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—å»æ‰¾ï¼Œé¿å…å¡æ­»ä¸»çº¿ç¨‹</em>ï¼Œå¯ç”¨autoreleasepoolé¿å…å†…å­˜æš´æ¶¨ï¼ŒæŸ¥åˆ°äº†ç¼“å­˜åˆ°å†…å­˜ï¼Œç„¶åå›è°ƒ</p></li><li><p>å¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼Œå°±è°ƒç”¨SDWebImageManagerä¸­çš„ç®¡ç†ä¸‹è½½ç±»SDWebImageDownloaderå•ä¾‹<code>downloadImageWithURL:options:progress:completed:completedBlock</code>å¤„ç†ä¸‹è½½</p></li><li><p>ä¸‹è½½å‰è°ƒç”¨<code>addProgressCallback:completedBlock:forURL:createCallback:</code>æ¥ä¿è¯ç»Ÿä¸€urlåªä¼šç”Ÿæˆä¸€ä¸ªç½‘ç»œä¸‹è½½å¯¹è±¡ï¼Œå¤šä½™çš„éƒ½åªä¼šç”¨URLCallbackså­˜å‚¨ä¼ å…¥çš„è¿›åº¦Blockæˆ–è€…CompleteBlockï¼Œå› æ­¤ä¸‹è½½ç»“æœè¿”å›çš„æ—¶å€™ä¼šè¿›è¡Œéå†å›è°ƒ</p></li><li><p>ä¸‹è½½ç”¨NSOperationå’ŒNSOperationQueueæ¥è¿›è¡Œï¼ŒSDWebImageæ´¾ç”Ÿäº†ä¸€ä¸ªSDWebImageDownloaderOperationè´Ÿè´£å›¾ç‰‡çš„ä¸‹è½½ä»»åŠ¡ï¼Œè°ƒç”¨<code>initWithRequest:inSession:options:progress:completed:cancelled:</code></p></li><li><p>æŠŠè¿”å›çš„SDWebImageDownloaderOperationå¯¹è±¡addåˆ°NSOperationQueueï¼ŒFIFOé˜Ÿåˆ—å°±æ­£å¸¸ï¼Œå¦‚æœæ˜¯LIFOé˜Ÿåˆ—ï¼Œå°±éœ€è¦è®¾ç½®ä¾èµ–ï¼Œè¿™ä¹Ÿæ˜¯GCDå’ŒNSOperationçš„åŒºåˆ«ï¼Œä¹Ÿæ˜¯NSOperationçš„ä¼˜ç‚¹ï¼Œè®©ä¸Šä¸€æ¬¡çš„ä»»åŠ¡ä¾èµ–äºæœ¬æ¬¡ä»»åŠ¡<code>[wself.lastAddedOperationaddDependency:operation]</code></p></li><li><p>ä¸‹è½½ä»»åŠ¡å¼€å§‹æ˜¯ç”¨NSURLSessionäº†ï¼Œä¸ç”¨NSURLConnetionäº†ï¼Œç”±äºSDæ˜¯è‡ªå®šä¹‰çš„NSOperationå†…éƒ¨éœ€è¦é‡å†™startæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢é…ç½®Sessionï¼Œå½“taskResumeçš„æ—¶å€™ï¼Œæ ¹æ®è®¾ç½®çš„ä»£ç†å°±èƒ½å–åˆ°ä¸åŒçš„å›è°ƒå‚æ•°</p><ul><li>didReceiveResponseèƒ½è·å–åˆ°å“åº”çš„æ‰€æœ‰å‚æ•°è§„æ ¼ï¼Œä¾‹å¦‚æ€»size</li><li>didReceiveDataæ˜¯ä¸€æ­¥æ­¥è·å–dataï¼Œå‹ç¼©è§£ç å›è°ƒprogressBlock</li><li>didCompleteWithErrorå…¨éƒ¨å®Œæˆå›è°ƒï¼Œå›¾ç‰‡è§£ç ï¼Œå›è°ƒcompleteBlock</li></ul></li><li><p>å›¾ç‰‡çš„è§£ç æ˜¯åœ¨SDWebImageDecoderé‡Œé¢å®Œæˆçš„ï¼Œç¼©æ”¾æ“ä½œæ˜¯åœ¨SDWebImageCompatå†…å®Œæˆçš„ï¼Œä»£ç†æ–¹æ³•é‡Œé¢æœ¬èº«å°±å·²ç»æ˜¯å¼‚æ­¥äº†ï¼Œè€Œä¸”è§£ç æ“ä½œåŠ å…¥äº†autoreleasepoolå‡å°‘å†…å­˜å³°å€¼</p></li><li><p>å½“åœ¨SDWebImageDownloaderOperationä¸­NSURLSessionå®Œæˆä¸‹è½½ä¹‹åæˆ–è€…ä¸­é€”å›è°ƒåˆ°SDWebImageDownloaderä¸­ï¼Œç„¶åå†å›è°ƒåˆ°SDWebImageManagerï¼Œåœ¨Managerä¸­äºŒçº§ç¼“å­˜imageï¼Œç„¶åç»§ç»­å›è°ƒå‡ºå»åˆ°UIImage+WebCacheä¸­ï¼Œæœ€åæŠŠImageå›è°ƒå‡ºå»ï¼Œåœ¨è°ƒç”¨çš„æ§ä»¶ä¸­å±•ç¤ºå‡ºæ¥</p></li><li><p>SDImageCacheåˆå§‹åŒ–çš„æ—¶å€™æ³¨å†Œäº†å‡ ä¸ªé€šçŸ¥ï¼Œå½“å†…å­˜è­¦å‘Šçš„æ—¶å€™ï¼Œç¨‹åºè¿›å…¥åå°æˆ–è€…ç¨‹åºæ€æ­»çš„æ—¶å€™æ ¹æ®ç­–ç•¥æ¸…ç†ç¼“å­˜<br>å†…å­˜è­¦å‘Šï¼šè‡ªåŠ¨æ¸…é™¤NSCacheå†…å­˜ç¼“å­˜<br>è¿›å…¥åå°å’Œç¨‹åºæ€æ­»ï¼šæ¸…ç†è¿‡æœŸçš„æ–‡ä»¶ï¼ˆé»˜è®¤ä¸€å‘¨ï¼‰,ç„¶åæœ‰ä¸ªç¼“å­˜æœŸæœ›å€¼ï¼Œå¯¹æ¯”å·²æœ‰æ–‡ä»¶çš„å¤§å°ï¼Œå…ˆæ ¹æ®æ–‡ä»¶æœ€åç¼–è¾‘æ—¶é—´å‡åºæ’ï¼ŒæŠŠå¤§äºæœŸæœ›å€¼å¤§å°çš„æ–‡ä»¶å…¨éƒ¨æ€æ‰</p></li></ol><p><img src="http://p9u62mso1.bkt.clouddn.com/s_sdFlow.jpeg" alt="ä¸‹è½½å›¾ç‰‡è¿è¡Œå›¾"></p><h3 id="ç¬¬ä¸€æ­¥-UIImageView-WebCache"><a href="#ç¬¬ä¸€æ­¥-UIImageView-WebCache" class="headerlink" title="ç¬¬ä¸€æ­¥ UIImageView+WebCache"></a>ç¬¬ä¸€æ­¥ UIImageView+WebCache</h3><p>å¤–éƒ¨æ¥å£ï¼Œæä¾›ç»™ä½¿ç”¨è€…ç›´æ¥è°ƒç”¨ï¼Œè¿™äº›æ¥å£æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨UIView+WebCacheé‡Œé¢çš„<code>-sd_internalSetImageWithURL:placeholderImage:options:operationKey:setImageBlock:progress:completed:</code>ï¼Œä»»åŠ¡å°±æ˜¯ä»è¿™ä¸ªæ–¹æ³•å¼€å§‹å¤„ç†çš„ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder <span class="built_in">NS_REFINED_FOR_SWIFT</span>;</span><br><span class="line">          </span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                   options:(SDWebImageOptions)options <span class="built_in">NS_REFINED_FOR_SWIFT</span>;</span><br><span class="line">                   </span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                   options:(SDWebImageOptions)options</span><br><span class="line">                  progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                 completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬äºŒæ­¥-UIView-WebCache"><a href="#ç¬¬äºŒæ­¥-UIView-WebCache" class="headerlink" title="ç¬¬äºŒæ­¥ UIView+WebCache"></a>ç¬¬äºŒæ­¥ UIView+WebCache</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sd_internalSetImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                  placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                           options:(SDWebImageOptions)options</span><br><span class="line">                      operationKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)operationKey</span><br><span class="line">                     setImageBlock:(<span class="keyword">nullable</span> SDSetImageBlock)setImageBlock</span><br><span class="line">                          progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                         completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> sd_internalSetImageWithURL:url placeholderImage:placeholder options:options operationKey:operationKey setImageBlock:setImageBlock progress:progressBlock completed:completedBlock context:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰€æœ‰çš„sd_setImageWithURLæ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šè¿›å…¥è¿™ä¸ªæ–¹æ³•è¿›è¡Œå›¾ç‰‡çš„åŠ è½½</span></span><br><span class="line"><span class="comment">// url åŠ è½½çš„å›¾ç‰‡</span></span><br><span class="line"><span class="comment">// placeholder å ä½å›¾</span></span><br><span class="line"><span class="comment">// options ä¸‹è½½å›¾ç‰‡çš„å„ç§èŠ±å¼è®¾ç½® ä¸€èˆ¬ä½¿ç”¨çš„æ˜¯SDWebImageRetryFailed | SDWebImageLowPriority</span></span><br><span class="line">- (<span class="keyword">void</span>)sd_internalSetImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                  placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                           options:(SDWebImageOptions)options</span><br><span class="line">                      operationKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)operationKey</span><br><span class="line">                     setImageBlock:(<span class="keyword">nullable</span> SDSetImageBlock)setImageBlock</span><br><span class="line">                          progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                         completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock</span><br><span class="line">                           context:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)context &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®å‚æ•°operationKeyå–æ¶ˆå½“å‰ç±»æ‰€å¯¹åº”çš„ä¸‹è½½Operationå¯¹è±¡ï¼Œå¦‚æœoperationKeyä¸ºnilÂ keyå–NSStringFromClass([selfÂ class])</span></span><br><span class="line">    <span class="built_in">NSString</span> *validOperationKey = operationKey ?: <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]);</span><br><span class="line">    <span class="comment">// å–æ¶ˆå½“å‰çš„ä¸‹è½½æ“ä½œï¼Œå¦‚æœä¸å–æ¶ˆï¼Œé‚£ä¹ˆå½“tableViewæ»‘åŠ¨çš„æ—¶å€™ï¼Œå½“å‰cellçš„imageViewä¼šä¸€ç›´å»ä¸‹è½½å›¾ç‰‡ï¼Œç„¶åä¼˜å…ˆæ˜¾ç¤ºä¸‹è½½å®Œæˆçš„å›¾ç‰‡ï¼Œç›´æ¥é”™ä¹±</span></span><br><span class="line">    [<span class="keyword">self</span> sd_cancelImageLoadOperationWithKey:validOperationKey];</span><br><span class="line">    <span class="comment">// åˆ©ç”¨å…³è”å¯¹è±¡ç»™å½“å‰selfå®ä¾‹ç»‘å®šurlÂ key=imageURLKeyÂ value=url</span></span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">    <span class="comment">//è¿™é‡Œå°±ç”¨åˆ°äº†æˆ‘ä»¬å¼€ç¯‡è®²çš„ä½è¿ç®—ï¼Œåˆ©ç”¨&amp;ä¸è¿ç®—åˆ¤æ–­è°ƒç”¨è€…æ˜¯å¦éœ€è¦è®¾ç½®å ä½å›¾ï¼Œéœ€è¦åˆ™set</span></span><br><span class="line">    <span class="keyword">if</span> (!(options &amp; SDWebImageDelayPlaceholder)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([context valueForKey:SDWebImageInternalSetImageGroupKey]) &#123;</span><br><span class="line">            dispatch_group_t group = [context valueForKey:SDWebImageInternalSetImageGroupKey];</span><br><span class="line">            dispatch_group_enter(group);</span><br><span class="line">        &#125;</span><br><span class="line">        dispatch_main_async_safe(^&#123;</span><br><span class="line">            [<span class="keyword">self</span> sd_setImage:placeholder imageData:<span class="literal">nil</span> basedOnClassOrViaCustomSetImageBlock:setImageBlock];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä¸‹è½½é“¾æ¥urlæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (url) &#123;</span><br><span class="line">        <span class="comment">// check if activityView is enabled or not</span></span><br><span class="line">        <span class="comment">//Â åˆ¤æ–­ä¹‹å‰æ˜¯å¦åˆ©ç”¨å…³è”å¯¹è±¡ç»™selfè®¾ç½®äº†æ˜¾ç¤ºèŠèŠ±åŠ è½½ï¼Œå¦‚æœæœ‰åˆ™add</span></span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> sd_showActivityIndicatorView]) &#123;</span><br><span class="line">            [<span class="keyword">self</span> sd_addActivityIndicator];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// reset the progress</span></span><br><span class="line">        <span class="keyword">self</span>.sd_imageProgress.totalUnitCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">self</span>.sd_imageProgress.completedUnitCount = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…³é”®ç±» SDWebImageManager æ¥å¤„ç†å›¾ç‰‡ä¸‹è½½</span></span><br><span class="line">        <span class="comment">// ä¸‹è½½æœ‰ä¸‰å±‚ 1å½“å‰manangerè°ƒç”¨ä¸‹è½½ 2ä»ç¼“å­˜ä¸­è·å–ï¼Œhitå¤±è´¥è°ƒç”¨SDWebImageDownloaderå¯¹è±¡è°ƒç”¨ä¸‹è½½ 3.SDWebImageDownloaderOperationæœ€ç»ˆç»§æ‰¿</span></span><br><span class="line">        SDWebImageManager *manager;</span><br><span class="line">        <span class="keyword">if</span> ([context valueForKey:SDWebImageExternalCustomManagerKey]) &#123;</span><br><span class="line">            manager = (SDWebImageManager *)[context valueForKey:SDWebImageExternalCustomManagerKey];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            manager = [SDWebImageManager sharedManager];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        __<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)wself = <span class="keyword">self</span>;</span><br><span class="line">        SDWebImageDownloaderProgressBlock combinedProgressBlock = ^(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize, <span class="built_in">NSURL</span> * _Nullable targetURL) &#123;</span><br><span class="line">            wself.sd_imageProgress.totalUnitCount = expectedSize;</span><br><span class="line">            wself.sd_imageProgress.completedUnitCount = receivedSize;</span><br><span class="line">            <span class="keyword">if</span> (progressBlock) &#123;</span><br><span class="line">                progressBlock(receivedSize, expectedSize, targetURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// NSOperationçš„å¯¹è±¡NSURLSessionçš„æ–¹æ³•å»ä¸‹è½½å›¾ç‰‡ï¼Œä»£ç†é‡Œé¢æ“ä½œ</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨SDWebImageManagerçš„loadImageWithURLæ–¹æ³•å»åŠ è½½å›¾ç‰‡ï¼Œè¿”å›å€¼æ˜¯SDWebImageCombinedOperation</span></span><br><span class="line">        <span class="keyword">id</span> &lt;SDWebImageOperation&gt; operation = [manager loadImageWithURL:url options:options progress:combinedProgressBlock completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL) &#123;</span><br><span class="line">            __<span class="keyword">strong</span> __<span class="keyword">typeof</span> (wself) sself = wself;</span><br><span class="line">            <span class="keyword">if</span> (!sself) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">            <span class="comment">// åœ¨è¿™é‡Œç§»é™¤èŠèŠ±</span></span><br><span class="line">            [sself sd_removeActivityIndicator];</span><br><span class="line">            <span class="comment">// if the progress not been updated, mark it to complete state</span></span><br><span class="line">            <span class="keyword">if</span> (finished &amp;&amp; !error &amp;&amp; sself.sd_imageProgress.totalUnitCount == <span class="number">0</span> &amp;&amp; sself.sd_imageProgress.completedUnitCount == <span class="number">0</span>) &#123;</span><br><span class="line">                sself.sd_imageProgress.totalUnitCount = SDWebImageProgressUnitCountUnknown;</span><br><span class="line">                sself.sd_imageProgress.completedUnitCount = SDWebImageProgressUnitCountUnknown;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">BOOL</span> shouldCallCompletedBlock = finished || (options &amp; SDWebImageAvoidAutoSetImage);</span><br><span class="line">            <span class="comment">//æ˜¯å¦ä¸æ˜¾ç¤ºå›¾ç‰‡ä¸¤ä¸ªæ¡ä»¶æ»¡è¶³å…¶ä¸€å³å¯Â 1&gt;è°ƒç”¨è€…æ‰‹åŠ¨ä¸»åŠ¨é…ç½®ï¼Œå“ªæ€•imageä¸ä¸ºnilÂ 2&gt;æ²¡æœ‰å›¾ç‰‡å¹¶ä¸”ä¸delayeå ä½å›¾æƒ…å†µ</span></span><br><span class="line">            <span class="comment">// è®¾ç½®äº†SDWebImageAvoidAutoSetImageé»˜è®¤ä¸ä¼šå°†UIImageæ·»åŠ è¿›UIImageViewå¯¹è±¡é‡Œï¼Œè€Œæ”¾ç½®åœ¨completBlocké‡Œé¢äº¤ç”±è°ƒç”¨æ–¹è‡ªå·±å¤„ç†ï¼Œåšä¸ªæ»¤é•œæˆ–è€…æ·¡å…¥æ·¡å‡ºä»€ä¹ˆçš„ã€‚</span></span><br><span class="line">            <span class="built_in">BOOL</span> shouldNotSetImage = ((image &amp;&amp; (options &amp; SDWebImageAvoidAutoSetImage)) ||</span><br><span class="line">                                      (!image &amp;&amp; !(options &amp; SDWebImageDelayPlaceholder)));</span><br><span class="line">            SDWebImageNoParamsBlock callCompletedBlockClojure = ^&#123;</span><br><span class="line">                <span class="keyword">if</span> (!sself) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">                <span class="keyword">if</span> (!shouldNotSetImage) &#123;</span><br><span class="line">                    [sself sd_setNeedsLayout];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å¦‚æœè®¾ç½®äº†ä¸è‡ªåŠ¨æ˜¾ç¤ºå›¾ç‰‡ï¼Œåˆ™å›è°ƒè®©è°ƒç”¨è€…æ‰‹åŠ¨æ·»åŠ æ˜¾ç¤ºå›¾ç‰‡Â ç¨‹åºreturn</span></span><br><span class="line">                <span class="keyword">if</span> (completedBlock &amp;&amp; shouldCallCompletedBlock) &#123;</span><br><span class="line">                    completedBlock(image, error, cacheType, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// case 1a: we got an image, but the SDWebImageAvoidAutoSetImage flag is set</span></span><br><span class="line">            <span class="comment">// OR</span></span><br><span class="line">            <span class="comment">// case 1b: we got no image and the SDWebImageDelayPlaceholder is not set</span></span><br><span class="line">            <span class="keyword">if</span> (shouldNotSetImage) &#123;<span class="comment">//å¦‚æœè®¾ç½®äº†ä¸è‡ªåŠ¨æ˜¾ç¤ºå›¾ç‰‡ï¼Œåˆ™å›è°ƒè®©è°ƒç”¨è€…æ‰‹åŠ¨æ·»åŠ æ˜¾ç¤ºå›¾ç‰‡Â ç¨‹åºreturn</span></span><br><span class="line"></span><br><span class="line">                dispatch_main_async_safe(callCompletedBlockClojure);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">UIImage</span> *targetImage = <span class="literal">nil</span>;</span><br><span class="line">            <span class="built_in">NSData</span> *targetData = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">if</span> (image) &#123;</span><br><span class="line">                <span class="comment">// case 2a: we got an image and the SDWebImageAvoidAutoSetImage is not set</span></span><br><span class="line">                targetImage = image;</span><br><span class="line">                targetData = data;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options &amp; SDWebImageDelayPlaceholder) &#123;</span><br><span class="line">                <span class="comment">// case 2b: we got no image and the SDWebImageDelayPlaceholder flag is set</span></span><br><span class="line">                targetImage = placeholder;</span><br><span class="line">                targetData = <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// check whether we should use the image transition</span></span><br><span class="line">            SDWebImageTransition *transition = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">if</span> (finished &amp;&amp; (options &amp; SDWebImageForceTransition || cacheType == SDImageCacheTypeNone)) &#123;</span><br><span class="line">                transition = sself.sd_imageTransition;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ([context valueForKey:SDWebImageInternalSetImageGroupKey]) &#123;</span><br><span class="line">                dispatch_group_t group = [context valueForKey:SDWebImageInternalSetImageGroupKey];</span><br><span class="line">                dispatch_group_enter(group);</span><br><span class="line">                dispatch_main_async_safe(^&#123;</span><br><span class="line">                    [sself sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock transition:transition cacheType:cacheType imageURL:imageURL];</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">// ensure completion block is called after custom setImage process finish</span></span><br><span class="line">                dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    callCompletedBlockClojure();</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dispatch_main_async_safe(^&#123;</span><br><span class="line">                    [sself sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock transition:transition cacheType:cacheType imageURL:imageURL];</span><br><span class="line">                    callCompletedBlockClojure();</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="comment">// ä¿å­˜æœ¬æ¬¡operationï¼Œå¦‚æœå‘ç”Ÿå¤šæ¬¡å›¾ç‰‡è¯·æ±‚å¯ä»¥ç”¨æ¥å–æ¶ˆ</span></span><br><span class="line">        <span class="comment">// å…ˆå–æ¶ˆå½“å‰UIImageViewæ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡ï¼Œç„¶åä¿å­˜operations</span></span><br><span class="line">        <span class="comment">// ä¹Ÿå°±æ˜¯è¯´å½“åŠ¨æ€ç»‘å®šçš„å­—å…¸é‡Œé¢çš„key valueå¯¹åº”ä¸€ä¸ªå›¾ç‰‡ä¸‹è½½ å•ä¸ªå›¾ç‰‡valueæ•°ç»„å°±æ˜¯0ï¼Œä¸ç„¶å°±æ˜¯å¤šä¸ªï¼Œä¸‹è½½å®Œå°±ä¼šæ ¹æ®keyç§»é™¤</span></span><br><span class="line">        [<span class="keyword">self</span> sd_setImageLoadOperation:operation forKey:validOperationKey];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dispatch_main_async_safe(^&#123;</span><br><span class="line">            <span class="comment">//ç§»é™¤èŠèŠ± æŠ›å‡ºurlä¸ºnilçš„å›è°ƒ</span></span><br><span class="line">            [<span class="keyword">self</span> sd_removeActivityIndicator];</span><br><span class="line">            <span class="keyword">if</span> (completedBlock) &#123;</span><br><span class="line">                <span class="built_in">NSError</span> *error = [<span class="built_in">NSError</span> errorWithDomain:SDWebImageErrorDomain code:<span class="number">-1</span> userInfo:@&#123;<span class="built_in">NSLocalizedDescriptionKey</span> : <span class="string">@"Trying to load a nil url"</span>&#125;];</span><br><span class="line">                completedBlock(<span class="literal">nil</span>, error, SDImageCacheTypeNone, url);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°çŸ¥è¯†ç‚¹ï¼š<br>è¿™é‡Œé¦–å…ˆä¼šè°ƒç”¨<code>sd_cancelImageLoadOperationWithKey</code>(4.0ä¹‹å‰æ˜¯sd_cancelCurrentImageLoad)æ–¹æ³•ï¼Œåˆ é™¤è¯¥æ§ä»¶ä¹‹å‰çš„ä¸‹è½½ä»»åŠ¡ï¼Œå› ä¸ºSDWebImageçš„é»˜è®¤åšæ³•æ˜¯ç«‹é©¬æŠŠä¸‹è½½å¥½çš„å›¾ç‰‡ç»™UIImageViewï¼Œæ‰€ä»¥è¿™æ—¶å€™å¦‚æœå›¾ç‰‡è¿˜æ²¡ä¸‹è½½ä¸‹æ¥ï¼Œç”¨æˆ·æ»‘åŠ¨äº†å±å¹•å¯¼è‡´å…¶ä»–æ§ä»¶åˆå‘é€äº†å›¾ç‰‡è¯·æ±‚ä¼šå›¾ç‰‡æ•°æ®é”™ä¹±çš„é—®é¢˜ã€‚</p><h3 id="ç¬¬ä¸‰æ­¥-SDWebImageManager"><a href="#ç¬¬ä¸‰æ­¥-SDWebImageManager" class="headerlink" title="ç¬¬ä¸‰æ­¥ SDWebImageManager"></a>ç¬¬ä¸‰æ­¥ SDWebImageManager</h3><p><em>æ‰¿ä¸Šå¯ä¸‹çš„æ ¸å¿ƒç®¡ç†ç±»</em>ï¼Œæœ‰ä¸¤ä¸ªå¾—åŠ›æ‰‹ä¸‹ï¼š</p><ul><li><p>SDImageCache ä¸“é—¨ç®¡ç†ç¼“å­˜</p><ul><li>NSCacheè´Ÿè´£å†…å­˜ç¼“å­˜ï¼Œç”¨æ³•ä¸NSDictionaryåŸºæœ¬ä¸€æ ·</li><li><p>ç£ç›˜ç¼“å­˜ç”¨NSFileManagerè¯»å†™æ–‡ä»¶çš„æ–¹å¼</p><blockquote><p>   æ³¨ï¼š</p><pre><code>1. NSCacheå…·æœ‰è‡ªåŠ¨åˆ é™¤çš„åŠŸèƒ½ï¼Œä»¥å‡å°‘ç³»ç»Ÿå†…å­˜ï¼Œè¿˜èƒ½è®¾ç½®å†…å­˜ä¸´ç•Œå€¼2. NSCacheæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸éœ€è¦åŠ çº¿ç¨‹é”3. é”®å¯¹è±¡ä¸ä¼šåƒNSMutableDictionaryä¸­é‚£æ ·è¢«å¤åˆ¶ã€‚(é”®ä¸éœ€è¦å®ç°NSCopyingåè®®)</code></pre></blockquote></li></ul></li><li><p>SDWebImageDownloader ä¸“é—¨è´Ÿè´£å›¾ç‰‡çš„ä¸‹è½½ï¼Œå›¾ç‰‡çš„ä¸‹è½½éƒ½æ˜¯æ”¾åœ¨NSOperationQueueä¸­å®Œæˆçš„</p></li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»imageCacheä¸­å¯»æ‰¾å›¾ç‰‡</span></span><br><span class="line"><span class="comment">//æ¯æ¬¡å‘SDWebImageCacheç´¢å–å›¾ç‰‡çš„æ—¶å€™ï¼Œä¼šå…ˆæ ¹æ®å›¾ç‰‡URLå¯¹åº”çš„keyå€¼å…ˆæ£€æŸ¥å†…å­˜ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„å›¾ç‰‡ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¿”å›ï¼›å¦‚æœæ²¡æœ‰åˆ™åœ¨ioQueueä¸­å»ç¡¬ç›˜ä¸­æŸ¥æ‰¾ï¼Œå…¶ä¸­æ–‡ä»¶åæ˜¯æ˜¯æ ¹æ®URLç”Ÿæˆçš„MD5å€¼ï¼Œæ‰¾åˆ°ä¹‹åå…ˆå°†å›¾ç‰‡ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œç„¶ååœ¨æŠŠå›¾ç‰‡è¿”å›</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSOperation</span> *)queryCacheOperationForKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)key options:(SDImageCacheOptions)options done:(<span class="keyword">nullable</span> SDCacheQueryCompletedBlock)doneBlock &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="keyword">if</span> (doneBlock) &#123;</span><br><span class="line">            doneBlock(<span class="literal">nil</span>, <span class="literal">nil</span>, SDImageCacheTypeNone);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// First check the in-memory cache...</span></span><br><span class="line">    <span class="comment">// 1. å…ˆå»å†…å­˜ä¸­æŸ¥æ‰¾</span></span><br><span class="line">    <span class="built_in">UIImage</span> *image = [<span class="keyword">self</span> imageFromMemoryCacheForKey:key];</span><br><span class="line">    <span class="built_in">BOOL</span> shouldQueryMemoryOnly = (image &amp;&amp; !(options &amp; SDImageCacheQueryDataWhenInMemory));</span><br><span class="line">    <span class="keyword">if</span> (shouldQueryMemoryOnly) &#123;</span><br><span class="line">        <span class="keyword">if</span> (doneBlock) &#123;</span><br><span class="line">            doneBlock(image, <span class="literal">nil</span>, SDImageCacheTypeMemory);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœåœ¨å†…å­˜æ²¡æ‰¾åˆ°</span></span><br><span class="line">    <span class="comment">// 2. å¦‚æœå†…å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™åœ¨ç£ç›˜ä¸­æŸ¥æ‰¾ã€‚å¦‚æœæ‰¾åˆ°ï¼Œåˆ™å°†å…¶æ”¾åˆ°å†…å­˜ç¼“å­˜ï¼Œå¹¶è°ƒç”¨doneBlockå›è°ƒ</span></span><br><span class="line">    <span class="built_in">NSOperation</span> *operation = [<span class="built_in">NSOperation</span> new];</span><br><span class="line">    <span class="keyword">void</span>(^queryDiskBlock)(<span class="keyword">void</span>) =  ^&#123;</span><br><span class="line">        <span class="keyword">if</span> (operation.isCancelled) &#123;</span><br><span class="line">            <span class="comment">// do not call the completion if cancelled</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå†…å­˜å³æ—¶é‡Šæ”¾</span></span><br><span class="line">        <span class="comment">// å¦‚æœä½ çš„åº”ç”¨ç¨‹åºæˆ–è€…çº¿ç¨‹æ˜¯è¦é•¿æœŸè¿è¡Œçš„å¹¶ä¸”æœ‰å¯èƒ½äº§ç”Ÿå¤§é‡autoreleasedå¯¹è±¡, ä½ åº”è¯¥ä½¿ç”¨autorelease pool blocks</span></span><br><span class="line">        <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">            <span class="comment">// ä»ç£ç›˜ç¼“å­˜ä¸­æ‹¿ï¼Œæ‹¿åˆ°æ ¹æ®å­—æ®µå­˜å…¥å†…å­˜</span></span><br><span class="line">            <span class="built_in">NSData</span> *diskData = [<span class="keyword">self</span> diskImageDataBySearchingAllPathsForKey:key];</span><br><span class="line">            <span class="built_in">UIImage</span> *diskImage;</span><br><span class="line">            SDImageCacheType cacheType = SDImageCacheTypeDisk;</span><br><span class="line">            <span class="keyword">if</span> (image) &#123;</span><br><span class="line">                <span class="comment">// the image is from in-memory cache</span></span><br><span class="line">                diskImage = image;</span><br><span class="line">                cacheType = SDImageCacheTypeMemory;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (diskData) &#123;</span><br><span class="line">                <span class="comment">// decode image data only if in-memory cache missed</span></span><br><span class="line">                diskImage = [<span class="keyword">self</span> diskImageForKey:key data:diskData options:options];</span><br><span class="line">                <span class="keyword">if</span> (diskImage &amp;&amp; <span class="keyword">self</span>.config.shouldCacheImagesInMemory) &#123;</span><br><span class="line">                    <span class="comment">// åƒç´ </span></span><br><span class="line">                    <span class="built_in">NSUInteger</span> cost = SDCacheCostForImage(diskImage);</span><br><span class="line">                    <span class="comment">// ç¼“å­˜åˆ°NSCacheä¸­</span></span><br><span class="line">                    [<span class="keyword">self</span>.memCache setObject:diskImage forKey:key cost:cost];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (doneBlock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (options &amp; SDImageCacheQueryDiskSync) &#123;</span><br><span class="line">                    doneBlock(diskImage, diskData, cacheType);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                        doneBlock(diskImage, diskData, cacheType);</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (options &amp; SDImageCacheQueryDiskSync) &#123;</span><br><span class="line">        queryDiskBlock();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.ioQueue, queryDiskBlock);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°çŸ¥è¯†ç‚¹ï¼š<br>è¿™é‡Œå¼€äº†å¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—å»Diskä¸­æŸ¥æ‰¾ï¼Œä¿è¯ä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œè€Œä¸”å¼€äº†autoreleasepoolä»¥é™ä½å†…å­˜æš´æ¶¨é—®é¢˜ï¼Œèƒ½å¾—åˆ°åŠæ—¶é‡Šæ”¾ã€‚å¦‚æœèƒ½ä»ç£ç›˜ç¼“å­˜ä¸­å–åˆ°ï¼Œé¦–å…ˆç¼“å­˜åˆ°å†…å­˜ä¸­ç„¶åå†å›è°ƒã€‚<br>å¦‚æœå†…å­˜å’Œç£ç›˜ä¸­éƒ½æ‰¾ä¸åˆ°å›¾ç‰‡ï¼Œå°±ä¼šè®©SDWebImageManagerçš„å¦ä¸€ä¸ªå¸®æ‰‹SDWebImageDownloaderå»ä¸‹è½½å›¾ç‰‡ã€‚</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸‹è½½å›¾ç‰‡æœ€ç»ˆå®ç°æ–¹æ³•</span></span><br><span class="line">- (id &lt;SDWebImageOperation&gt;)<span class="string">loadImageWithURL:</span>(nullable NSURL *)url</span><br><span class="line"><span class="symbol">                                     options:</span>(SDWebImageOptions)options</span><br><span class="line"><span class="symbol">                                    progress:</span>(nullable SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line"><span class="symbol">                                   completed:</span>(nullable SDInternalCompletionBlock)completedBlock &#123;</span><br><span class="line">    <span class="comment">// Invoking this method without a completedBlock is pointless</span></span><br><span class="line">    <span class="comment">//completedBlockä¸ºnilï¼Œåˆ™è§¦å‘æ–­è¨€ï¼Œç¨‹åºcrash</span></span><br><span class="line">    NSAssert(completedBlock != nil, @<span class="string">"If you mean to prefetch the image, use -[SDWebImagePrefetcher prefetchURLs] instead"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Very common mistake is to send the URL using NSString object instead of NSURL. For some strange reason, Xcode won't</span></span><br><span class="line">    <span class="comment">// throw any warning for this type mismatch. Here we failsafe this error by allowing URLs to be passed as NSString.</span></span><br><span class="line">    <span class="keyword">if</span> ([url <span class="string">isKindOfClass:</span>NSString.<span class="keyword">class</span>]) &#123;</span><br><span class="line">        url = [NSURL <span class="string">URLWithString:</span>(NSString *)url];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevents app crashing on argument type error like sending NSNull instead of NSURL</span></span><br><span class="line">    <span class="keyword">if</span> (![url <span class="string">isKindOfClass:</span>NSURL.<span class="keyword">class</span>]) &#123;</span><br><span class="line">        url = nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è£…ä¸‹è½½æ“ä½œçš„å¯¹è±¡</span></span><br><span class="line">    SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation <span class="keyword">new</span>];</span><br><span class="line">    operation.manager = self;</span><br><span class="line"></span><br><span class="line">    BOOL isFailedUrl = NO;</span><br><span class="line">    <span class="keyword">if</span> (url) &#123;</span><br><span class="line">        <span class="comment">// ä¿¡å·é‡dispatch_semaphore_waitï¼Œå¯ä½¿æ€»ä¿¡å·é‡å‡1ï¼Œå½“ä¿¡å·é‡ä¸º0æ—¶å°±ä¼šä¸€ç›´ç­‰å¾…ï¼ˆé˜»å¡çº¿ç¨‹ï¼‰</span></span><br><span class="line">        LOCK(self.failedURLsLock);</span><br><span class="line">        isFailedUrl = [self.failedURLs <span class="string">containsObject:</span>url];</span><br><span class="line">        <span class="comment">// ä¿¡å·é‡dispatch_semaphore_signalï¼Œå‘é€ä¸€ä¸ªä¿¡å·é‡ï¼Œè®©ä¿¡å·æ€»é‡åŠ 1</span></span><br><span class="line">        UNLOCK(self.failedURLsLock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœurlä¸ºnilï¼Œæˆ–è€…æ²¡æœ‰è®¾ç½®å¤±è´¥urlé‡æ–°ä¸‹è½½çš„é…ç½®ï¼ˆSDWebImageRetryFailedï¼‰ä¸”è¯¥urlå·²ç»ä¸‹è½½å¤±è´¥è¿‡äº†ï¼Œé‚£ä¹ˆè¿”å›å¤±è´¥çš„å›è°ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (url.absoluteString.length == <span class="number">0</span> || (!(options &amp; SDWebImageRetryFailed) &amp;&amp; isFailedUrl)) &#123;</span><br><span class="line">        [self <span class="string">callCompletionBlockForOperation:</span>operation <span class="string">completion:</span>completedBlock <span class="string">error:</span>[NSError <span class="string">errorWithDomain:</span>NSURLErrorDomain <span class="string">code:</span>NSURLErrorFileDoesNotExist <span class="string">userInfo:</span>nil] <span class="string">url:</span>url];</span><br><span class="line">        <span class="keyword">return</span> operation;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºäº’æ–¥é”ï¼Œæ·»åŠ operationåˆ°æ•°ç»„ä¸­</span></span><br><span class="line">    LOCK(self.runningOperationsLock);</span><br><span class="line">    [self.runningOperations <span class="string">addObject:</span>operation];</span><br><span class="line">    UNLOCK(self.runningOperationsLock);</span><br><span class="line">    NSString *key = [self <span class="string">cacheKeyForURL:</span>url];</span><br><span class="line">    </span><br><span class="line">    SDImageCacheOptions cacheOptions = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (options &amp; SDWebImageQueryDataWhenInMemory) cacheOptions |= SDImageCacheQueryDataWhenInMemory;</span><br><span class="line">    <span class="keyword">if</span> (options &amp; SDWebImageQueryDiskSync) cacheOptions |= SDImageCacheQueryDiskSync;</span><br><span class="line">    <span class="keyword">if</span> (options &amp; SDWebImageScaleDownLargeImages) cacheOptions |= SDImageCacheScaleDownLargeImages;</span><br><span class="line">    </span><br><span class="line">    __weak SDWebImageCombinedOperation *weakOperation = operation;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ç¼“å­˜å¯¹è±¡ï¼Œæ ¹æ®keyå»å¯»æ‰¾æŸ¥æ‰¾</span></span><br><span class="line">    operation.cacheOperation = [self.imageCache <span class="string">queryCacheOperationForKey:</span>key <span class="string">options:</span>cacheOptions <span class="string">done:</span>^(UIImage *cachedImage, NSData *cachedData, SDImageCacheType cacheType) &#123;</span><br><span class="line">        __strong __typeof(weakOperation) strongOperation = weakOperation;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰æ“ä½œè¢«å–æ¶ˆï¼Œåˆ™removeä¸”return</span></span><br><span class="line">        <span class="keyword">if</span> (!strongOperation || strongOperation.isCancelled) &#123;</span><br><span class="line">            [self <span class="string">safelyRemoveOperationFromRunning:</span>strongOperation];</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check whether we should download image from network</span></span><br><span class="line">        BOOL shouldDownload = (!(options &amp; SDWebImageFromCacheOnly))</span><br><span class="line">            &amp;&amp; (!cachedImage || options &amp; SDWebImageRefreshCached)</span><br><span class="line">            &amp;&amp; (![self.delegate <span class="string">respondsToSelector:</span><span class="meta">@selector</span>(<span class="string">imageManager:</span><span class="string">shouldDownloadImageForURL:</span>)] || [self.delegate <span class="string">imageManager:</span>self <span class="string">shouldDownloadImageForURL:</span>url]);</span><br><span class="line">        <span class="keyword">if</span> (shouldDownload) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cachedImage &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</span><br><span class="line">                <span class="comment">// If image was found in the cache but SDWebImageRefreshCached is provided, notify about the cached image</span></span><br><span class="line">                <span class="comment">// AND try to re-download it in order to let a chance to NSURLCache to refresh it from server.</span></span><br><span class="line">                [self <span class="string">callCompletionBlockForOperation:</span>strongOperation <span class="string">completion:</span>completedBlock <span class="string">image:</span>cachedImage <span class="string">data:</span>cachedData <span class="string">error:</span>nil <span class="string">cacheType:</span>cacheType <span class="string">finished:</span>YES <span class="string">url:</span>url];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// download if no image or requested to refresh anyway, and download allowed by delegate</span></span><br><span class="line">            SDWebImageDownloaderOptions downloaderOptions = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageLowPriority) downloaderOptions |= SDWebImageDownloaderLowPriority;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageProgressiveDownload) downloaderOptions |= SDWebImageDownloaderProgressiveDownload;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageRefreshCached) downloaderOptions |= SDWebImageDownloaderUseNSURLCache;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageContinueInBackground) downloaderOptions |= SDWebImageDownloaderContinueInBackground;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageHandleCookies) downloaderOptions |= SDWebImageDownloaderHandleCookies;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageAllowInvalidSSLCertificates) downloaderOptions |= SDWebImageDownloaderAllowInvalidSSLCertificates;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageHighPriority) downloaderOptions |= SDWebImageDownloaderHighPriority;</span><br><span class="line">            <span class="keyword">if</span> (options &amp; SDWebImageScaleDownLargeImages) downloaderOptions |= SDWebImageDownloaderScaleDownLargeImages;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (cachedImage &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</span><br><span class="line">                <span class="comment">// force progressive off if image already cached but forced refreshing</span></span><br><span class="line">                downloaderOptions &amp;= ~SDWebImageDownloaderProgressiveDownload;</span><br><span class="line">                <span class="comment">// ignore image read from NSURLCache if image if cached but force refreshing</span></span><br><span class="line">                downloaderOptions |= SDWebImageDownloaderIgnoreCachedResponse;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// `SDWebImageCombinedOperation` -&gt; `SDWebImageDownloadToken` -&gt; `downloadOperationCancelToken`, which is a `SDCallbacksDictionary` and retain the completed block below, so we need weak-strong again to avoid retain cycle</span></span><br><span class="line">            __weak typeof(strongOperation) weakSubOperation = strongOperation;</span><br><span class="line">            <span class="comment">// è°ƒç”¨SDWebImageDownloaderçš„downloadImageWithURL:æ–¹æ³•</span></span><br><span class="line">            strongOperation.downloadToken = [self.imageDownloader <span class="string">downloadImageWithURL:</span>url <span class="string">options:</span>downloaderOptions <span class="string">progress:</span>progressBlock <span class="string">completed:</span>^(UIImage *downloadedImage, NSData *downloadedData, NSError *error, BOOL finished) &#123;</span><br><span class="line">                __strong typeof(weakSubOperation) strongSubOperation = weakSubOperation;</span><br><span class="line">                <span class="keyword">if</span> (!strongSubOperation || strongSubOperation.isCancelled) &#123;</span><br><span class="line">                    <span class="comment">// Do nothing if the operation was cancelled</span></span><br><span class="line">                    <span class="comment">// See #699 for more details</span></span><br><span class="line">                    <span class="comment">// if we would call the completedBlock, there could be a race condition between this block and another completedBlock for the same object, so if this one is called second, we will overwrite the new data</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                    [self <span class="string">callCompletionBlockForOperation:</span>strongSubOperation <span class="string">completion:</span>completedBlock <span class="string">error:</span>error <span class="string">url:</span>url];</span><br><span class="line">                    BOOL shouldBlockFailedURL;</span><br><span class="line">                    <span class="comment">// Check whether we should block failed url</span></span><br><span class="line">                    <span class="keyword">if</span> ([self.delegate <span class="string">respondsToSelector:</span><span class="meta">@selector</span>(<span class="string">imageManager:</span><span class="string">shouldBlockFailedURL:</span><span class="string">withError:</span>)]) &#123;</span><br><span class="line">                        shouldBlockFailedURL = [self.delegate <span class="string">imageManager:</span>self <span class="string">shouldBlockFailedURL:</span>url <span class="string">withError:</span>error];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        shouldBlockFailedURL = (   error.code != NSURLErrorNotConnectedToInternet</span><br><span class="line">                                                &amp;&amp; error.code != NSURLErrorCancelled</span><br><span class="line">                                                &amp;&amp; error.code != NSURLErrorTimedOut</span><br><span class="line">                                                &amp;&amp; error.code != NSURLErrorInternationalRoamingOff</span><br><span class="line">                                                &amp;&amp; error.code != NSURLErrorDataNotAllowed</span><br><span class="line">                                                &amp;&amp; error.code != NSURLErrorCannotFindHost</span><br><span class="line">                                                &amp;&amp; error.code != NSURLErrorCannotConnectToHost</span><br><span class="line">                                                &amp;&amp; error.code != NSURLErrorNetworkConnectionLost);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (shouldBlockFailedURL) &#123;</span><br><span class="line">                        LOCK(self.failedURLsLock);</span><br><span class="line">                        [self.failedURLs <span class="string">addObject:</span>url];</span><br><span class="line">                        UNLOCK(self.failedURLsLock);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((options &amp; SDWebImageRetryFailed)) &#123;</span><br><span class="line">                        LOCK(self.failedURLsLock);</span><br><span class="line">                        [self.failedURLs <span class="string">removeObject:</span>url];</span><br><span class="line">                        UNLOCK(self.failedURLsLock);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// æ˜¯å¦éœ€è¦ç¼“å­˜åˆ°ç£ç›˜</span></span><br><span class="line">                    BOOL cacheOnDisk = !(options &amp; SDWebImageCacheMemoryOnly);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// We've done the scale process in SDWebImageDownloader with the shared manager, this is used for custom manager and avoid extra scale.</span></span><br><span class="line">                    <span class="keyword">if</span> (self != [SDWebImageManager sharedManager] &amp;&amp; self.cacheKeyFilter &amp;&amp; downloadedImage) &#123;</span><br><span class="line">                        downloadedImage = [self <span class="string">scaledImageForKey:</span>key <span class="string">image:</span>downloadedImage];</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (options &amp; SDWebImageRefreshCached &amp;&amp; cachedImage &amp;&amp; !downloadedImage) &#123;</span><br><span class="line">                        <span class="comment">// Image refresh hit the NSURLCache cache, do not call the completion block</span></span><br><span class="line">                    <span class="comment">// å›¾ç‰‡ä¸‹è½½æˆåŠŸå¹¶ä¸”åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬æ¢å›¾ç‰‡</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (downloadedImage &amp;&amp; (!downloadedImage.images || (options &amp; SDWebImageTransformAnimatedImage)) &amp;&amp; [self.delegate <span class="string">respondsToSelector:</span><span class="meta">@selector</span>(<span class="string">imageManager:</span><span class="string">transformDownloadedImage:</span><span class="string">withURL:</span>)]) &#123;</span><br><span class="line">                        dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>), ^&#123;</span><br><span class="line">                            <span class="comment">// æ ¹æ®ä»£ç†è·å–è½¬æ¢åçš„å›¾ç‰‡</span></span><br><span class="line">                            UIImage *transformedImage = [self.delegate <span class="string">imageManager:</span>self <span class="string">transformDownloadedImage:</span>downloadedImage <span class="string">withURL:</span>url];</span><br><span class="line">                            <span class="comment">// å¦‚æœè½¬æ¢å›¾ç‰‡å­˜åœ¨ä¸”ä¸‹è½½å›¾ç‰‡æ“ä½œå·²å®Œæˆï¼Œåˆ™åœ¨ç¼“å­˜å¯¹è±¡ä¸­å­˜å‚¨å›¾ç‰‡</span></span><br><span class="line">                            <span class="keyword">if</span> (transformedImage &amp;&amp; finished) &#123;</span><br><span class="line">                                BOOL imageWasTransformed = ![transformedImage <span class="string">isEqual:</span>downloadedImage];</span><br><span class="line">                                NSData *cacheData;</span><br><span class="line">                                <span class="comment">// pass nil if the image was transformed, so we can recalculate the data from the image</span></span><br><span class="line">                                <span class="keyword">if</span> (self.cacheSerializer) &#123;</span><br><span class="line">                                    cacheData = self.cacheSerializer(transformedImage, (imageWasTransformed ? nil : downloadedData), url);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    cacheData = (imageWasTransformed ? nil : downloadedData);</span><br><span class="line">                                &#125;</span><br><span class="line">                                [self.imageCache <span class="string">storeImage:</span>transformedImage <span class="string">imageData:</span>cacheData <span class="string">forKey:</span>key <span class="string">toDisk:</span>cacheOnDisk <span class="string">completion:</span>nil];</span><br><span class="line">                            &#125;</span><br><span class="line">                            </span><br><span class="line">                            [self <span class="string">callCompletionBlockForOperation:</span>strongSubOperation <span class="string">completion:</span>completedBlock <span class="string">image:</span>transformedImage <span class="string">data:</span>downloadedData <span class="string">error:</span>nil <span class="string">cacheType:</span>SDImageCacheTypeNone <span class="string">finished:</span>finished <span class="string">url:</span>url];</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (downloadedImage &amp;&amp; finished) &#123;<span class="comment">//ä¸‹è½½å®Œæˆä¸”æœ‰imageåˆ™ç¼“å­˜å›¾ç‰‡</span></span><br><span class="line">                            <span class="keyword">if</span> (self.cacheSerializer) &#123;</span><br><span class="line">                                dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>), ^&#123;</span><br><span class="line">                                    NSData *cacheData = self.cacheSerializer(downloadedImage, downloadedData, url);</span><br><span class="line">                                    [self.imageCache <span class="string">storeImage:</span>downloadedImage <span class="string">imageData:</span>cacheData <span class="string">forKey:</span>key <span class="string">toDisk:</span>cacheOnDisk <span class="string">completion:</span>nil];</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                [self.imageCache <span class="string">storeImage:</span>downloadedImage <span class="string">imageData:</span>downloadedData <span class="string">forKey:</span>key <span class="string">toDisk:</span>cacheOnDisk <span class="string">completion:</span>nil];</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        [self <span class="string">callCompletionBlockForOperation:</span>strongSubOperation <span class="string">completion:</span>completedBlock <span class="string">image:</span>downloadedImage <span class="string">data:</span>downloadedData <span class="string">error:</span>nil <span class="string">cacheType:</span>SDImageCacheTypeNone <span class="string">finished:</span>finished <span class="string">url:</span>url];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å¦‚æœä¸‹è½½å’Œç¼“å­˜éƒ½å®Œæˆäº†åˆ™åˆ é™¤æ“ä½œé˜Ÿåˆ—ä¸­çš„operation</span></span><br><span class="line">                <span class="keyword">if</span> (finished) &#123;</span><br><span class="line">                    [self <span class="string">safelyRemoveOperationFromRunning:</span>strongSubOperation];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cachedImage) &#123;</span><br><span class="line">            <span class="comment">// ç¼“å­˜ä¸­æœ‰å›¾ç‰‡ä¸”çº¿ç¨‹æ²¡æœ‰å€å–æ¶ˆï¼Œåˆ™è¿”å›æœ‰å›¾ç‰‡çš„completedBlock</span></span><br><span class="line">            [self <span class="string">callCompletionBlockForOperation:</span>strongOperation <span class="string">completion:</span>completedBlock <span class="string">image:</span>cachedImage <span class="string">data:</span>cachedData <span class="string">error:</span>nil <span class="string">cacheType:</span>cacheType <span class="string">finished:</span>YES <span class="string">url:</span>url];</span><br><span class="line">            [self <span class="string">safelyRemoveOperationFromRunning:</span>strongOperation];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Image not in cache and download disallowed by delegate</span></span><br><span class="line">            <span class="comment">// å›¾ç‰‡æ²¡æœ‰åœ¨ç¼“å­˜ä¸­ä¸”ä»£ç†æ–¹æ³•ä¸å…è®¸ä¸‹è½½åˆ™å›è°ƒå¤±è´¥</span></span><br><span class="line">            [self <span class="string">callCompletionBlockForOperation:</span>strongOperation <span class="string">completion:</span>completedBlock <span class="string">image:</span>nil <span class="string">data:</span>nil <span class="string">error:</span>nil <span class="string">cacheType:</span>SDImageCacheTypeNone <span class="string">finished:</span>YES <span class="string">url:</span>url];</span><br><span class="line">            [self <span class="string">safelyRemoveOperationFromRunning:</span>strongOperation];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬å››æ­¥-SDWebImageDownloader"><a href="#ç¬¬å››æ­¥-SDWebImageDownloader" class="headerlink" title="ç¬¬å››æ­¥ SDWebImageDownloader"></a>ç¬¬å››æ­¥ SDWebImageDownloader</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»™æŒ‡å®šurlä¸‹è½½å›¾ç‰‡</span></span><br><span class="line">- (<span class="keyword">nullable</span> SDWebImageDownloadToken *)downloadImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                                                   options:(SDWebImageDownloaderOptions)options</span><br><span class="line">                                                  progress:(<span class="keyword">nullable</span> SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                                                 completed:(<span class="keyword">nullable</span> SDWebImageDownloaderCompletedBlock)completedBlock &#123;</span><br><span class="line">    __<span class="keyword">weak</span> SDWebImageDownloader *wself = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨ä¸‹é¢çš„blockä¸­åˆ›å»ºoperation</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> addProgressCallback:progressBlock completedBlock:completedBlock forURL:url createCallback:^SDWebImageDownloaderOperation *&#123;</span><br><span class="line">        __<span class="keyword">strong</span> __<span class="keyword">typeof</span> (wself) sself = wself;</span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸‹è½½æ—¶é—´</span></span><br><span class="line">        <span class="built_in">NSTimeInterval</span> timeoutInterval = sself.downloadTimeout;</span><br><span class="line">        <span class="keyword">if</span> (timeoutInterval == <span class="number">0.0</span>) &#123;</span><br><span class="line">            timeoutInterval = <span class="number">15.0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In order to prevent from potential duplicate caching (NSURLCache + SDImageCache) we disable the cache for image requests if told otherwise</span></span><br><span class="line">        <span class="built_in">NSURLRequestCachePolicy</span> cachePolicy = options &amp; SDWebImageDownloaderUseNSURLCache ? <span class="built_in">NSURLRequestUseProtocolCachePolicy</span> : <span class="built_in">NSURLRequestReloadIgnoringLocalCacheData</span>;</span><br><span class="line">        <span class="comment">// åˆ›å»ºrequest è®¾ç½®è¯·æ±‚ç¼“å­˜ç­–ç•¥ ä¸‹è½½æ—¶é—´</span></span><br><span class="line">        <span class="built_in">NSMutableURLRequest</span> *request = [[<span class="built_in">NSMutableURLRequest</span> alloc] initWithURL:url</span><br><span class="line">                                                                    cachePolicy:cachePolicy</span><br><span class="line">                                                                timeoutInterval:timeoutInterval];</span><br><span class="line">        </span><br><span class="line">        request.HTTPShouldHandleCookies = (options &amp; SDWebImageDownloaderHandleCookies);</span><br><span class="line">        <span class="comment">// HTTPShouldUsePipeliningè®¾ç½®ä¸ºYES, åˆ™å…è®¸ä¸å¿…ç­‰åˆ°response, å°±å¯ä»¥å†æ¬¡è¯·æ±‚. è¿™ä¸ªä¼šå¾ˆå¤§çš„æé«˜ç½‘ç»œè¯·æ±‚çš„æ•ˆç‡,ä½†æ˜¯ä¹Ÿå¯èƒ½ä¼šå‡ºé—®é¢˜</span></span><br><span class="line">        <span class="comment">// å› ä¸ºå®¢æˆ·ç«¯æ— æ³•æ­£ç¡®çš„åŒ¹é…è¯·æ±‚ä¸å“åº”, æ‰€ä»¥è¿™ä¾èµ–äºæœåŠ¡å™¨å¿…é¡»ä¿è¯,å“åº”çš„é¡ºåºä¸å®¢æˆ·ç«¯è¯·æ±‚çš„é¡ºåºä¸€è‡´.å¦‚æœæœåŠ¡å™¨ä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹, é‚£å¯èƒ½å¯¼è‡´å“åº”å’Œè¯·æ±‚æ··ä¹±.</span></span><br><span class="line">        request.HTTPShouldUsePipelining = <span class="literal">YES</span>;</span><br><span class="line">        <span class="comment">// è®¾ç½®è¯·æ±‚å¤´</span></span><br><span class="line">        <span class="keyword">if</span> (sself.headersFilter) &#123;</span><br><span class="line">            request.allHTTPHeaderFields = sself.headersFilter(url, [sself allHTTPHeaderFields]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            request.allHTTPHeaderFields = [sself allHTTPHeaderFields];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡å¤´æˆ åœ¨è¿™é‡Œåˆ›å»ºoperationå¯¹è±¡</span></span><br><span class="line">        SDWebImageDownloaderOperation *operation = [[sself.operationClass alloc] initWithRequest:request inSession:sself.session options:options];</span><br><span class="line">        operation.shouldDecompressImages = sself.shouldDecompressImages;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (sself.urlCredential) &#123;</span><br><span class="line">            operation.credential = sself.urlCredential;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sself.username &amp;&amp; sself.password) &#123;</span><br><span class="line">            operation.credential = [<span class="built_in">NSURLCredential</span> credentialWithUser:sself.username password:sself.password persistence:<span class="built_in">NSURLCredentialPersistenceForSession</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸‹è½½ä¼˜å…ˆçº§</span></span><br><span class="line">        <span class="keyword">if</span> (options &amp; SDWebImageDownloaderHighPriority) &#123;</span><br><span class="line">            operation.queuePriority = <span class="built_in">NSOperationQueuePriorityHigh</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options &amp; SDWebImageDownloaderLowPriority) &#123;</span><br><span class="line">            operation.queuePriority = <span class="built_in">NSOperationQueuePriorityLow</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸‹è½½çš„é¡ºåºæ˜¯é˜Ÿåˆ—è¿˜æ˜¯æ ˆ</span></span><br><span class="line">        <span class="keyword">if</span> (sself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) &#123;</span><br><span class="line">            <span class="comment">// Emulate LIFO execution order by systematically adding new operations as last operation's dependency</span></span><br><span class="line">            [sself.lastAddedOperation addDependency:operation];</span><br><span class="line">            sself.lastAddedOperation = operation;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> operation;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çŸ¥è¯†ç‚¹ï¼š<br>é€šè¿‡<code>addProgressCallback: completedBlock: forURL: createCallback:</code>æ¥ç¡®ä¿åŒä¸€urlåªä¼šä¸‹è½½ä¸€æ¬¡</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒ…è£…callbackBlocksï¼ŒURLOperationså’Œtoken</span></span><br><span class="line">- (<span class="keyword">nullable</span> SDWebImageDownloadToken *)addProgressCallback:(SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                                           completedBlock:(SDWebImageDownloaderCompletedBlock)completedBlock</span><br><span class="line">                                                   forURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">                                           createCallback:(SDWebImageDownloaderOperation *(^)(<span class="keyword">void</span>))createCallback &#123;</span><br><span class="line">    <span class="comment">// The URL will be used as the key to the callbacks dictionary so it cannot be nil. If it is nil immediately call the completed block with no image or data.</span></span><br><span class="line">    <span class="keyword">if</span> (url == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (completedBlock != <span class="literal">nil</span>) &#123;</span><br><span class="line">            completedBlock(<span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">NO</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”ŸæˆURLOperationså­—å…¸Â ä¸‹è½½urlä½œä¸ºkeyÂ valueæ˜¯å…·ä½“çš„ä¸‹è½½operationÂ æ–¹ä¾¿ä¸‹è½½cancelç­‰æ“ä½œ</span></span><br><span class="line">    LOCK(<span class="keyword">self</span>.operationsLock);</span><br><span class="line">    SDWebImageDownloaderOperation *operation = [<span class="keyword">self</span>.URLOperations objectForKey:url];</span><br><span class="line">    <span class="keyword">if</span> (!operation) &#123;</span><br><span class="line">        operation = createCallback();</span><br><span class="line">        __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) wself = <span class="keyword">self</span>;</span><br><span class="line">        operation.completionBlock = ^&#123;</span><br><span class="line">            __<span class="keyword">strong</span> <span class="keyword">typeof</span>(wself) sself = wself;</span><br><span class="line">            <span class="keyword">if</span> (!sself) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            LOCK(sself.operationsLock);</span><br><span class="line">            [sself.URLOperations removeObjectForKey:url];</span><br><span class="line">            UNLOCK(sself.operationsLock);</span><br><span class="line">        &#125;;</span><br><span class="line">        [<span class="keyword">self</span>.URLOperations setObject:operation forKey:url];</span><br><span class="line">        <span class="comment">// Add operation to operation queue only after all configuration done according to Apple's doc.</span></span><br><span class="line">        <span class="comment">// `addOperation:` does not synchronously execute the `operation.completionBlock` so this will not cause deadlock.</span></span><br><span class="line">        [<span class="keyword">self</span>.downloadQueue addOperation:operation];</span><br><span class="line">    &#125;</span><br><span class="line">    UNLOCK(<span class="keyword">self</span>.operationsLock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†è¿›åº¦progressBlockå’Œä¸‹è½½ç»“æŸcompletedBlockå°è£…æˆå­—å…¸SDCallbacksDictionaryï¼Œè£…å…¥æ•°ç»„callbackBlocksï¼Œ</span></span><br><span class="line">    <span class="keyword">id</span> downloadOperationCancelToken = [operation addHandlersForProgress:progressBlock completed:completedBlock];</span><br><span class="line">    <span class="comment">//è¿™é‡Œç”Ÿæˆtokenæ ‡è¯†ï¼Œè¿™ä¸ªtokenè¯´ç™½äº†å°±æ˜¯ä¸ºäº†åœ¨SDWebImageManagerä¸­è°ƒç”¨[self.imageDownloaderÂ cancel:subOperationToken];æ¥åšå–æ¶ˆçš„</span></span><br><span class="line">    SDWebImageDownloadToken *token = [SDWebImageDownloadToken new];</span><br><span class="line">    token.downloadOperation = operation;</span><br><span class="line">    token.url = url;</span><br><span class="line">    token.downloadOperationCancelToken = downloadOperationCancelToken;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬äº”æ­¥-SDWebImageDownloaderOperation"><a href="#ç¬¬äº”æ­¥-SDWebImageDownloaderOperation" class="headerlink" title="ç¬¬äº”æ­¥ SDWebImageDownloaderOperation"></a>ç¬¬äº”æ­¥ SDWebImageDownloaderOperation</h3><p>SDWebImageDownloaderOperationç»§æ‰¿è‡ªNSOperationï¼Œæ˜¯å…·ä½“çš„æ‰§è¡Œå›¾ç‰‡ä¸‹è½½çš„å•ä½ã€‚è´Ÿè´£ç”ŸæˆNSURLSessionTaskè¿›è¡Œå›¾ç‰‡è¯·æ±‚ï¼Œæ”¯æŒä¸‹è½½å–æ¶ˆå’Œåå°ä¸‹è½½ï¼Œåœ¨ä¸‹è½½ä¸­åŠæ—¶æ±‡æŠ¥ä¸‹è½½è¿›åº¦ï¼Œåœ¨ä¸‹è½½æˆåŠŸåï¼Œå¯¹å›¾ç‰‡è¿›è¡Œè§£ç ï¼Œç¼©æ”¾å’Œå‹ç¼©ç­‰æ“ä½œã€‚</p><p><img src="http://p9u62mso1.bkt.clouddn.com/s_s_SDDown.png" alt="SDWebImageåŠ è½½å›¾ç‰‡æ€»ç»“"></p><p>å…·ä½“çš„ä¸‹è½½æµç¨‹ç”¨æ–‡å­—æ¥æè¿°ï¼š</p><ol><li>é¦–å…ˆç”Ÿæˆç»§æ‰¿åœ¨NSOperationçš„SDWebImageDownloaderOperationï¼Œé…ç½®operationã€‚</li><li>å°†operationæ·»åŠ åˆ°NSOperationQueueä¸‹è½½é˜Ÿåˆ—ï¼Œæ·»åŠ åˆ°ä¸‹è½½é˜Ÿåˆ—ä¼šè§¦å‘operationçš„staræ–¹æ³•ã€‚</li><li>å¦‚æœå‘ç°operationçš„isCancelledä¸ºYESï¼Œè¯´æ˜å·²ç»è¢«å–æ¶ˆï¼Œåˆ™finished=YESç»“æŸä¸‹è½½ã€‚</li><li>åˆ›å»ºNSURLSessionTaskæ‰§è¡Œresumeå¼€å§‹ä¸‹è½½ã€‚</li><li>å½“æ”¶åˆ°æœåŠ¡ç«¯çš„å“åº”æ—¶æ ¹æ®codeåˆ¤æ–­è¯·æ±‚çŠ¶æ€ï¼Œå¦‚æœæ˜¯æ­£å¸¸çŠ¶æ€åˆ™å‘é€æ­£åœ¨æ¥å—responseçš„é€šçŸ¥ä»¥åŠä¸‹è½½è¿›åº¦ã€‚å¦‚æœæ˜¯404æˆ–è€…å…¶ä»–çŠ¶æ€åˆ™cancelä¸‹è½½æ“ä½œ</li><li>åœ¨didReceiveDataæ¯æ¬¡æ”¶åˆ°æœåŠ¡å™¨çš„è¿”å›responseæ—¶ï¼Œç»™å¯å˜dataè¿½åŠ å½“å‰ä¸‹è½½çš„dataï¼Œå¹¶æ±‡æŠ¥ä¸‹è½½è¿›åº¦</li><li>åœ¨didCompleteWithErrorä¸‹è½½ç»“æŸæ—¶ï¼Œå¦‚æœä¸‹è½½æˆåŠŸè¿›è¡Œå›¾ç‰‡dataè§£ç ï¼Œå›¾ç‰‡çš„ç¼©æ”¾æˆ–è€…å‹ç¼©æ“ä½œï¼Œå‘é€ä¸‹è½½ç»“æŸé€šçŸ¥ã€‚ä¸‹è½½å¤±è´¥æ‰§è¡Œå¤±è´¥å›è°ƒã€‚</li></ol><h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><ol><li>é—®é¢˜ 1ï¼šå›¾ç‰‡åˆ·æ–°é—®é¢˜ï¼šSDWebImage åœ¨è¿›è¡Œç¼“å­˜æ—¶å¿½ç•¥äº†æ‰€æœ‰æœåŠ¡å™¨è¿”å›çš„ caching control è®¾ç½®ï¼Œå¹¶ä¸”åœ¨ç¼“å­˜æ—¶æ²¡æœ‰åšæ—¶é—´é™åˆ¶ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€å›¾ç‰‡ URL å¿…é¡»æ˜¯é™æ€çš„äº†ï¼Œè¦æ±‚æœåŠ¡å™¨ä¸Šä¸€ä¸ª URL å¯¹åº”çš„å›¾ç‰‡å†…å®¹ä¸å…è®¸æ›´æ–°ã€‚ä½†æ˜¯å¦‚æœå­˜å‚¨å›¾ç‰‡çš„æœåŠ¡å™¨ä¸ç”±è‡ªå·±æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ å›¾ç‰‡å†…å®¹æ›´æ–°äº†ï¼ŒURL å´æ²¡æœ‰æ›´æ–°ï¼Œè¿™ç§æƒ…å†µæ€ä¹ˆåŠï¼Ÿ</li></ol><ul><li>è§£å†³æ–¹æ¡ˆï¼šåœ¨è°ƒç”¨ sd_setImageWithURL: placeholderImage: options:æ–¹æ³•æ—¶è®¾ç½® options å‚æ•°ä¸º SDWebImageRefreshCachedï¼Œè¿™æ ·è™½ç„¶ä¼šé™ä½æ€§èƒ½ï¼Œä½†æ˜¯ä¸‹è½½å›¾ç‰‡æ—¶ä¼šç…§é¡¾åˆ°æœåŠ¡å™¨è¿”å›çš„ caching controlã€‚</li></ul><ol start="2"><li>é—®é¢˜ 2ï¼šåœ¨åŠ è½½å›¾ç‰‡æ—¶ï¼Œå¦‚ä½•æ·»åŠ é»˜è®¤çš„ progress indicator ï¼Ÿ</li></ol><ul><li><p>è§£å†³æ–¹æ¡ˆï¼šåœ¨è°ƒç”¨ -sd_setImageWithURL:æ–¹æ³•ä¹‹å‰ï¼Œå…ˆè°ƒç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š</p><p>  [imageView sd_setShowActivityIndicatorView:YES];</p><p>  [imageView sd_setIndicatorStyle:UIActivityIndicatorViewStyleGray];</p></li></ul><p>å‚è€ƒï¼š<br><a href="http://www.cocoachina.com/ios/20171218/21566.html" target="_blank" rel="noopener">SDWebImageæºç è§£æä¸€</a><br><a href="http://www.cocoachina.com/ios/20171219/21582.html" target="_blank" rel="noopener">SDWebImageæºç è§£æäºŒ</a><br><a href="https://blog.csdn.net/deft_mkjing/article/details/52900586" target="_blank" rel="noopener">SDWebImageè¯¦è§£</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-09000824a56a1ad0.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;113&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬ç¯‡å°†äº†è§£åˆ°ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SDWebImageæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå„å·¥å…·ç±»ä¹‹é—´æ˜¯å¦‚ä½•åè°ƒå¤„ç†çš„&lt;/li&gt;
&lt;li&gt;SDWebImageæ˜¯å¦‚ä½•å¼‚æ­¥ä¸‹è½½å›¾ç‰‡åŠå¤„ç†çº¿ç¨‹å®‰å…¨é—®é¢˜çš„&lt;/li&gt;
&lt;li&gt;SDWebImageæ˜¯å¦‚ä½•å¼‚æ­¥ç¼“å­˜å¹¶è‡ªåŠ¨ç®¡ç†ç¼“å­˜æœ‰æ•ˆæ€§çš„&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="SDWebImage" scheme="http://yoursite.com/tags/SDWebImage/"/>
    
      <category term="æºç åˆ†æ" scheme="http://yoursite.com/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>iOSå¤šçº¿ç¨‹ä¹‹NSOperationã€NSOperationQueueè¯¦è§£</title>
    <link href="http://yoursite.com/2018/05/24/iOS%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BNSOperation%E3%80%81NSOperationQueue%E8%AF%A6%E8%A7%A3/"/>
    <id>http://yoursite.com/2018/05/24/iOSå¤šçº¿ç¨‹ä¹‹NSOperationã€NSOperationQueueè¯¦è§£/</id>
    <published>2018-05-24T12:33:42.000Z</published>
    <updated>2019-03-25T06:46:50.200Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://upload-images.jianshu.io/upload_images/1276164-72af03942adef005.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="iOSå¤šçº¿ç¨‹ä¹‹NSOperation.jpg"></p><p>æœ¬æ–‡ç”¨æ¥ä»‹ç»iOSå¤šçº¿ç¨‹ä¸­çš„NSOperationã€NSOperationQueueçš„ç›¸å…³çŸ¥è¯†åŠä½¿ç”¨æ–¹æ³•ã€‚<br>é€šè¿‡æœ¬æ–‡ï¼Œæ‚¨å°†äº†è§£åˆ°ï¼š<br><strong>NSOperationã€NSOperationQueueç®€ä»‹ã€æ“ä½œå’Œæ“ä½œé˜Ÿåˆ—ã€ä½¿ç”¨æ­¥éª¤å’ŒåŸºæœ¬ä½¿ç”¨æ–¹æ³•ã€æ§åˆ¶ä¸²è¡Œ/å¹¶å‘æ‰§è¡Œã€NSOperationæ“ä½œä¾èµ–å’Œä¼˜å…ˆçº§ã€çº¿ç¨‹é—´çš„é€šä¿¡ã€çº¿ç¨‹åŒæ­¥å’Œçº¿ç¨‹å®‰å…¨ï¼Œä»¥åŠNSOperationã€NSOperationQueueå¸¸ç”¨å±æ€§å’Œæ–¹æ³•å½’çº³ã€‚</strong></p><a id="more"></a><h2 id="1-NSOperationã€NSOperationQueueç®€ä»‹"><a href="#1-NSOperationã€NSOperationQueueç®€ä»‹" class="headerlink" title="1. NSOperationã€NSOperationQueueç®€ä»‹"></a>1. NSOperationã€NSOperationQueueç®€ä»‹</h2><p>NSOperationã€NSOperationQueueæ˜¯è‹¹æœæä¾›ç»™æˆ‘ä»¬çš„ä¸€å¥—å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆã€‚å®é™…ä¸ŠNSOperationã€NSOperationQueueæ˜¯åŸºäºGCDæ›´é«˜ä¸€å±‚çš„å°è£…ï¼Œå®Œå…¨é¢å‘å¯¹è±¡ã€‚ä½†æ˜¯æ¯”GCDæ›´ç®€å•æ˜“ç”¨ã€ä»£ç å¯è¯»æ€§ä¹Ÿæ›´é«˜ã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨NSOperationã€NSOperationQueue?</strong></p><ol><li>å¯æ·»åŠ å®Œæˆçš„ä»£ç å—ï¼Œåœ¨æ“ä½œå®Œæˆä¹‹åæ‰§è¡Œ</li><li>æ·»åŠ æ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæ–¹ä¾¿çš„æ§åˆ¶æ‰§è¡Œé¡ºåº</li><li>è®¾å®šæ“ä½œæ‰§è¡Œçš„ä¼˜å…ˆçº§</li><li>å¯ä»¥å¾ˆæ–¹ä¾¿çš„å–æ¶ˆä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œ</li><li>ä½¿ç”¨KVOè§‚å¯Ÿå¯¹æ“ä½œæ‰§è¡ŒçŠ¶æ€çš„æ›´æ”¹ï¼šisExecuteingã€isFinishedã€isCancelled</li></ol><h2 id="2-NSOperationã€NSOperationQueueæ“ä½œå’Œæ“ä½œé˜Ÿåˆ—"><a href="#2-NSOperationã€NSOperationQueueæ“ä½œå’Œæ“ä½œé˜Ÿåˆ—" class="headerlink" title="2. NSOperationã€NSOperationQueueæ“ä½œå’Œæ“ä½œé˜Ÿåˆ—"></a>2. NSOperationã€NSOperationQueueæ“ä½œå’Œæ“ä½œé˜Ÿåˆ—</h2><p>æ—¢ç„¶æ˜¯åŸºäº GCD çš„æ›´é«˜ä¸€å±‚çš„å°è£…ã€‚é‚£ä¹ˆï¼ŒGCD ä¸­çš„ä¸€äº›æ¦‚å¿µåŒæ ·é€‚ç”¨äº NSOperationã€NSOperationQueueã€‚åœ¨ NSOperationã€NSOperationQueue ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„<code>ä»»åŠ¡ï¼ˆæ“ä½œï¼‰</code>å’Œ<code>é˜Ÿåˆ—ï¼ˆæ“ä½œé˜Ÿåˆ—ï¼‰</code>çš„æ¦‚å¿µã€‚</p><ul><li><p><strong>æ“ä½œï¼ˆOperationï¼‰ï¼š</strong></p><ul><li>æ‰§è¡Œæ“ä½œçš„æ„æ€ï¼Œæ¢å¥è¯è¯´å°±æ˜¯ä½ åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œçš„é‚£æ®µä»£ç ã€‚</li><li>åœ¨ GCD ä¸­æ˜¯æ”¾åœ¨ block ä¸­çš„ã€‚åœ¨ NSOperation ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ NSOperation å­ç±» NSInvocationOperationã€NSBlockOperationï¼Œæˆ–è€…è‡ªå®šä¹‰å­ç±»æ¥å°è£…æ“ä½œã€‚</li></ul></li><li><p><strong>æ“ä½œé˜Ÿåˆ—ï¼ˆOperation Queuesï¼‰ï¼š</strong></p><ul><li>è¿™é‡Œçš„é˜Ÿåˆ—æŒ‡æ“ä½œé˜Ÿåˆ—ï¼Œå³ç”¨æ¥å­˜æ”¾æ“ä½œçš„é˜Ÿåˆ—ã€‚ä¸åŒäº GCD ä¸­çš„è°ƒåº¦é˜Ÿåˆ— FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰çš„åŸåˆ™ã€‚NSOperationQueue å¯¹äºæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„æ“ä½œï¼Œé¦–å…ˆè¿›å…¥å‡†å¤‡å°±ç»ªçš„çŠ¶æ€ï¼ˆå°±ç»ªçŠ¶æ€å–å†³äºæ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼‰ï¼Œç„¶åè¿›å…¥å°±ç»ªçŠ¶æ€çš„æ“ä½œçš„å¼€å§‹æ‰§è¡Œé¡ºåºï¼ˆéç»“æŸæ‰§è¡Œé¡ºåºï¼‰ç”±æ“ä½œä¹‹é—´ç›¸å¯¹çš„ä¼˜å…ˆçº§å†³å®šï¼ˆä¼˜å…ˆçº§æ˜¯æ“ä½œå¯¹è±¡è‡ªèº«çš„å±æ€§ï¼‰ã€‚</li><li>æ“ä½œé˜Ÿåˆ—é€šè¿‡è®¾ç½®æœ€å¤§å¹¶å‘æ“ä½œæ•°ï¼ˆmaxConcurrentOperationCountï¼‰æ¥æ§åˆ¶å¹¶å‘ã€ä¸²è¡Œã€‚</li><li>NSOperationQueue ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§ä¸åŒç±»å‹çš„é˜Ÿåˆ—ï¼šä¸»é˜Ÿåˆ—å’Œè‡ªå®šä¹‰é˜Ÿåˆ—ã€‚ä¸»é˜Ÿåˆ—è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¹‹ä¸Šï¼Œè€Œè‡ªå®šä¹‰é˜Ÿåˆ—åœ¨åå°æ‰§è¡Œã€‚</li></ul></li></ul><h2 id="3-NSOperationã€NSOperationQueue-ä½¿ç”¨æ­¥éª¤"><a href="#3-NSOperationã€NSOperationQueue-ä½¿ç”¨æ­¥éª¤" class="headerlink" title="3. NSOperationã€NSOperationQueue ä½¿ç”¨æ­¥éª¤"></a>3. NSOperationã€NSOperationQueue ä½¿ç”¨æ­¥éª¤</h2><p>NSOperationéœ€è¦é…åˆNSOperationQueueæ¥å®ç°å¤šçº¿ç¨‹ã€‚å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼ŒNSOperationå•ç‹¬ä½¿ç”¨æ—¶ç³»ç»ŸåŒæ­¥æ‰§è¡Œæ“ä½œï¼Œé…åˆNSOperationQueueèƒ½æ›´å¥½çš„å®ç°å¼‚æ­¥æ‰§è¡Œã€‚</p><p>NSOperationå®ç°å¤šçº¿ç¨‹çš„ä½¿ç”¨æ­¥éª¤åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol><li>åˆ›å»ºæ“ä½œï¼šå…ˆå°†éœ€è¦æ‰§è¡Œçš„æ“ä½œå°è£…åˆ°ä¸€ä¸ªNSOperationå¯¹è±¡ä¸­</li><li>åˆ›å»ºé˜Ÿåˆ—ï¼šåˆ›å»ºNSOperationQueueå¯¹è±¡</li><li>å°†æ“ä½œåŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼šå°†NSOperationå¯¹è±¡æ·»åŠ åˆ°NSOperationQueueå¯¹è±¡ä¸­</li></ol><p>ä¹‹åå‘¢ï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨å°†NSOperationQueueä¸­çš„NSOperationå–å‡ºæ¥ï¼Œåœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œæ“ä½œã€‚</p><h2 id="4-NSOperationã€NSOperationQueueåŸºæœ¬ä½¿ç”¨"><a href="#4-NSOperationã€NSOperationQueueåŸºæœ¬ä½¿ç”¨" class="headerlink" title="4. NSOperationã€NSOperationQueueåŸºæœ¬ä½¿ç”¨"></a>4. NSOperationã€NSOperationQueueåŸºæœ¬ä½¿ç”¨</h2><h3 id="4-1-åˆ›å»ºæ“ä½œ"><a href="#4-1-åˆ›å»ºæ“ä½œ" class="headerlink" title="4.1 åˆ›å»ºæ“ä½œ"></a>4.1 åˆ›å»ºæ“ä½œ</h3><p>NSOperationæ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œä¸èƒ½ç”¨æ¥å°è£…æ“ä½œã€‚æˆ‘ä»¬åªèƒ½æ˜¯ç”¨å®ƒçš„å­ç±»æ¥å°è£…æ“ä½œã€‚æˆ‘ä»¬æœ‰ä¸‰ç§æ–¹å¼æ¥å°è£…æ“ä½œã€‚</p><ol><li>ä½¿ç”¨å­ç±»NSInvocationOperation</li><li>ä½¿ç”¨å­ç±»NSBlockOperation</li><li>è‡ªå®šä¹‰ç»§æ‰¿è‡ªNSOperationçš„å­ç±»ï¼Œé€šè¿‡å®ç°å†…éƒ¨ç›¸åº”çš„æ–¹æ³•æ¥å°è£…æ“ä½œ</li></ol><p>åœ¨ä¸ä½¿ç”¨NSOperationQueueï¼Œå•ç‹¬ä½¿ç”¨NSOperationçš„æƒ…å†µä¸‹ç³»ç»ŸåŒæ­¥æ‰§è¡Œæ“ä½œï¼Œä¸‹é¢æˆ‘ä»¬å­¦ä¹ ä¸€ä¸‹æ“ä½œçš„ä¸‰ç§åˆ›å»ºæ–¹å¼ã€‚</p><h4 id="4-1-1-ä½¿ç”¨å­ç±»NSInvocationOperation"><a href="#4-1-1-ä½¿ç”¨å­ç±»NSInvocationOperation" class="headerlink" title="4.1.1 ä½¿ç”¨å­ç±»NSInvocationOperation"></a>4.1.1 ä½¿ç”¨å­ç±»NSInvocationOperation</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨å­ç±» NSInvocationOperation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)useInvocationOperation &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.åˆ›å»º NSInvocationOperation å¯¹è±¡</span></span><br><span class="line">    <span class="built_in">NSInvocationOperation</span> *op = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(task1) object:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.è°ƒç”¨ start æ–¹æ³•å¼€å§‹æ‰§è¡Œæ“ä½œ</span></span><br><span class="line">    [op start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)task1 &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-05-24</span> <span class="number">14</span>:<span class="number">20</span>:<span class="number">59.367361</span>+<span class="number">0800</span> test[<span class="number">6371:138119</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000260280</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">14</span>:<span class="number">21</span>:<span class="number">01.368783</span>+<span class="number">0800</span> test[<span class="number">6371:138119</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000260280</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼šåœ¨æ²¡æœ‰ä½¿ç”¨NSOperationQueueã€åœ¨ä¸»çº¿ç¨‹ä¸­å•ç‹¬ä½¿ç”¨å­ç±»NSInvocationOperationæ‰§è¡Œä¸€ä¸ªæ“ä½œçš„æƒ…å†µä¸‹ï¼Œæ“ä½œæ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå¹¶æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ã€‚</p><p>å¦‚æœæ˜¯åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œæ“ä½œï¼Œåˆ™æ‰“å°ç»“æœä¸ºå…¶ä»–çº¿ç¨‹ã€‚</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨å…¶ä»–çº¿ç¨‹ä½¿ç”¨å­ç±» NSInvocationOperation</span></span><br><span class="line">[NSThread <span class="string">detachNewThreadSelector:</span><span class="meta">@selector</span>(useInvocationOperation) <span class="string">toTarget:</span>self <span class="string">withObject:</span>nil];</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-05-24</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">42.406393</span>+<span class="number">0800</span> test[<span class="number">6509:146542</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">00000277300</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">44.409801</span>+<span class="number">0800</span> test[<span class="number">6509:146542</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">00000277300</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1-2-ä½¿ç”¨å­ç±»NSBlockOperation"><a href="#4-1-2-ä½¿ç”¨å­ç±»NSBlockOperation" class="headerlink" title="4.1.2 ä½¿ç”¨å­ç±»NSBlockOperation"></a>4.1.2 ä½¿ç”¨å­ç±»NSBlockOperation</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨å­ç±» NSBlockOperation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)useBlockOperation &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.åˆ›å»º NSBlockOperation å¯¹è±¡</span></span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.è°ƒç”¨ start æ–¹æ³•å¼€å§‹æ‰§è¡Œæ“ä½œ</span></span><br><span class="line">    [op start];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">04</span>:<span class="number">53.603988</span>+<span class="number">0800</span> test[<span class="number">7767:222327</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00006e400</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">04</span>:<span class="number">55.604878</span>+<span class="number">0800</span> test[<span class="number">7767:222327</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00006e400</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼šåœ¨æ²¡æœ‰ä½¿ç”¨NSOperationQueueã€åœ¨ä¸»çº¿ç¨‹ä¸­å•ç‹¬ä½¿ç”¨NSBlockOperationæ‰§è¡Œä¸€ä¸ªæ“ä½œçš„æƒ…å†µä¸‹ï¼Œæ“ä½œæ˜¯åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå¹¶æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ã€‚</p><blockquote><p>æ³¨æ„ï¼šå’Œä¸Šè¾¹<code>NSInvocationOperation</code>ä½¿ç”¨ä¸€æ ·ã€‚å› ä¸ºä»£ç æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨çš„ï¼Œæ‰€ä»¥æ‰“å°ç»“æœä¸ºä¸»çº¿ç¨‹ã€‚å¦‚æœåœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œæ“ä½œï¼Œåˆ™æ‰“å°ç»“æœä¸ºå…¶ä»–çº¿ç¨‹ã€‚</p></blockquote><p>ä½†æ˜¯ï¼ŒNSBlockOperationè¿˜æä¾›äº†ä¸€ä¸ªæ–¹æ³•<code>addExecutionBlock:</code>ï¼Œé€šè¿‡<code>addExecutionBlock:</code>å°±å¯ä»¥ä¸ºNSBlockOperationæ·»åŠ é¢å¤–çš„æ“ä½œã€‚è¿™äº›æ“ä½œï¼ˆåŒ…æ‹¬blockOperationWithBlockä¸­çš„æ“ä½œï¼‰å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­åŒæ—¶ï¼ˆå¹¶å‘ï¼‰æ‰§è¡Œã€‚åªæœ‰å½“æ‰€æœ‰ç›¸å…³çš„æ“ä½œå·²ç»å®Œæˆæ‰§è¡Œæ—¶ï¼Œæ‰è§†ä¸ºå®Œæˆã€‚</p><p>å¦‚æœæ·»åŠ å¤šæ“ä½œçš„è¯ï¼Œ<code>blockOperationWithBlock:</code>ä¸­çš„æ“ä½œä¹Ÿå¯èƒ½ä¼šåœ¨å…¶ä»–çº¿ç¨‹ï¼ˆéå½“å‰çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œï¼Œè¿™æ˜¯ç”±ç³»ç»Ÿå†³å®šçš„ï¼Œå¹¶ä¸æ˜¯è¯´æ·»åŠ åˆ°<code>blockOperationWithBlock:</code>ä¸­çš„æ“ä½œä¸€å®šä¼šåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œã€‚ï¼ˆå¯ä»¥ç”¨<code>addExecutionBlock:</code>å¤šæ·»åŠ å‡ ä¸ªæ“ä½œè¯•è¯•ï¼‰ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨å­ç±» NSBlockOperation</span></span><br><span class="line"><span class="comment"> * è°ƒç”¨æ–¹æ³• AddExecutionBlock:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)useBlockOperationAddExecutionBlock &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.åˆ›å»º NSBlockOperation å¯¹è±¡</span></span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.æ·»åŠ é¢å¤–çš„æ“ä½œ</span></span><br><span class="line">    [op addExecutionBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [op addExecutionBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [op addExecutionBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"4---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [op addExecutionBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"5---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [op addExecutionBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"6---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [op addExecutionBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"7---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [op addExecutionBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"8---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [op addExecutionBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"9---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [op addExecutionBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"10---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [op addExecutionBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"11---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [op addExecutionBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"12---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="comment">// 3.è°ƒç”¨ start æ–¹æ³•å¼€å§‹æ‰§è¡Œæ“ä½œ</span></span><br><span class="line">    [op start];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">12.815707</span>+<span class="number">0800</span> test[<span class="number">8360:253503</span>] <span class="number">4</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b380</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">12.815707</span>+<span class="number">0800</span> test[<span class="number">8360:253501</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">40002688c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">13.815373</span>+<span class="number">0800</span> test[<span class="number">8360:253500</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b340</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">13.815386</span>+<span class="number">0800</span> test[<span class="number">8360:253436</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x600000068ec0&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">13.816409</span>+<span class="number">0800</span> test[<span class="number">8360:253503</span>] <span class="number">4</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b380</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">13.816410</span>+<span class="number">0800</span> test[<span class="number">8360:253501</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">40002688c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">14.816860</span>+<span class="number">0800</span> test[<span class="number">8360:253501</span>] <span class="number">6</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">40002688c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">15.816932</span>+<span class="number">0800</span> test[<span class="number">8360:253500</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b340</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">15.816994</span>+<span class="number">0800</span> test[<span class="number">8360:253503</span>] <span class="number">5</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b380</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">15.817005</span>+<span class="number">0800</span> test[<span class="number">8360:253436</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x600000068ec0&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">15.817349</span>+<span class="number">0800</span> test[<span class="number">8360:253501</span>] <span class="number">6</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">40002688c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">16.818352</span>+<span class="number">0800</span> test[<span class="number">8360:253436</span>] <span class="number">8</span>---&lt;NSThread: <span class="number">0</span>x600000068ec0&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">16.818352</span>+<span class="number">0800</span> test[<span class="number">8360:253500</span>] <span class="number">7</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b340</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">17.817353</span>+<span class="number">0800</span> test[<span class="number">8360:253503</span>] <span class="number">5</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b380</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">17.817703</span>+<span class="number">0800</span> test[<span class="number">8360:253501</span>] <span class="number">9</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">40002688c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">17.819481</span>+<span class="number">0800</span> test[<span class="number">8360:253500</span>] <span class="number">7</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b340</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">17.819481</span>+<span class="number">0800</span> test[<span class="number">8360:253436</span>] <span class="number">8</span>---&lt;NSThread: <span class="number">0</span>x600000068ec0&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44:18.819172</span>+<span class="number">0800</span> test[<span class="number">8360:253503</span>] <span class="number">10</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b380</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">18.820352</span>+<span class="number">0800</span> test[<span class="number">8360:253500</span>] <span class="number">12</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b340</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">19.818892</span>+<span class="number">0800</span> test[<span class="number">8360:253501</span>] <span class="number">9</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">40002688c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">19.820372</span>+<span class="number">0800</span> test[<span class="number">8360:253503</span>] <span class="number">10</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b380</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">19.821269</span>+<span class="number">0800</span> test[<span class="number">8360:253436</span>] <span class="number">11</span>---&lt;NSThread: <span class="number">0</span>x600000068ec0&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">19.821381</span>+<span class="number">0800</span> test[<span class="number">8360:253500</span>] <span class="number">12</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b340</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">21.822326</span>+<span class="number">0800</span> test[<span class="number">8360:253436</span>] <span class="number">11</span>---&lt;NSThread: <span class="number">0</span>x600000068ec0&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼šä½¿ç”¨å­ç±»<code>NSBlockOperation</code>ï¼Œå¹¶è°ƒç”¨æ–¹æ³•<code>addExecutionBlock:</code>çš„æƒ…å†µä¸‹ï¼Œ<code>blockOperationWithBlock:</code>æ–¹æ³•ä¸­çš„æ“ä½œå’Œ<code>addExecutionBlock:</code>ä¸­çš„æ“ä½œæ˜¯<strong>åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å¼‚æ­¥æ‰§è¡Œ</strong>çš„ã€‚è€Œä¸”ï¼Œè¿™æ¬¡æ‰§è¡Œç»“æœä¸­<code>blockOperationWithBlock:</code>æ–¹æ³•ä¸­çš„æ“ä½œä¹Ÿä¸æ˜¯åœ¨å½“å‰çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œçš„ã€‚ä»è€Œå°è¯äº†<code>blockOperationWithBlock:</code>ä¸­çš„æ“ä½œä¹Ÿå¯èƒ½ä¼šåœ¨å…¶ä»–çº¿ç¨‹ï¼ˆéå½“å‰çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªNSBlockOperationå¯¹è±¡å°è£…äº†å¤šä¸ªæ“ä½œã€‚NSBlockOperationæ˜¯å¦å¼€å¯æ–°çº¿ç¨‹ï¼Œå–å†³äºæ“ä½œçš„ä¸ªæ•°ã€‚å¦‚æœæ·»åŠ çš„æ“ä½œçš„ä¸ªæ•°è¶³å¤Ÿå¤šï¼Œå°±ä¼šè‡ªåŠ¨å¼€å¯æ–°çº¿ç¨‹ã€‚å½“ç„¶å¼€å¯çš„çº¿ç¨‹æ•°æ˜¯ç”±ç³»ç»Ÿæ¥å†³å®šçš„ã€‚</p><h4 id="4-1-3-ä½¿ç”¨è‡ªå®šä¹‰ç»§æ‰¿è‡ªNSOperationçš„å­ç±»"><a href="#4-1-3-ä½¿ç”¨è‡ªå®šä¹‰ç»§æ‰¿è‡ªNSOperationçš„å­ç±»" class="headerlink" title="4.1.3 ä½¿ç”¨è‡ªå®šä¹‰ç»§æ‰¿è‡ªNSOperationçš„å­ç±»"></a>4.1.3 ä½¿ç”¨è‡ªå®šä¹‰ç»§æ‰¿è‡ªNSOperationçš„å­ç±»</h4><p>å¦‚æœä½¿ç”¨å­ç±»<code>NSInvocationOperation</code>ã€<code>NSBlockOperation</code>ä¸èƒ½æ»¡è¶³æ—¥å¸¸éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ç»§æ‰¿è‡ªNSOperationçš„å­ç±»ã€‚å¯ä»¥é€šè¿‡é‡å†™<code>main</code>æˆ–è€…<code>star</code>æ–¹æ³•æ¥å®šä¹‰è‡ªå·±çš„NSOperationå¯¹è±¡ã€‚<br>é‡å†™mainæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç®¡ç†æ“ä½œçš„çŠ¶æ€å±æ€§<code>isExecuting</code>å’Œ<code>isFinished</code>ã€‚å½“<code>main</code>æ‰§è¡Œå®Œè¿”å›çš„æ—¶å€™ï¼Œè¿™ä¸ªæ“ä½œå°±ç»“æŸäº†ã€‚</p><p>å…ˆå®šä¹‰ä¸€ä¸ªç»§æ‰¿è‡ªNSOperationçš„å­ç±»ï¼Œé‡å†™<code>main</code>æ–¹æ³•ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YSCOperation.h æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YSCOperation</span> : <span class="title">NSOperation</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// YSCOperation.m æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"YSCOperation.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YSCOperation</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)main &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.isCancelled) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨çš„æ—¶å€™å¯¼å…¥å¤´æ–‡ä»¶YSCOperation.hã€‚</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨è‡ªå®šä¹‰ç»§æ‰¿è‡ª NSOperation çš„å­ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)useCustomOperation &#123;</span><br><span class="line">    <span class="comment">// 1.åˆ›å»º YSCOperation å¯¹è±¡</span></span><br><span class="line">    YSCOperation *op = [[YSCOperation alloc] init];</span><br><span class="line">    <span class="comment">// 2.è°ƒç”¨ start æ–¹æ³•å¼€å§‹æ‰§è¡Œæ“ä½œ</span></span><br><span class="line">    [<span class="meta">op start</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">19.821381</span>+<span class="number">0800</span> test[<span class="number">8360:253500</span>] <span class="number">12</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027b340</span>&gt;&#123;number = <span class="number">5</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-05-24</span> <span class="number">16</span>:<span class="number">44</span>:<span class="number">21.822326</span>+<span class="number">0800</span> test[<span class="number">8360:253436</span>] <span class="number">11</span>---&lt;NSThread: <span class="number">0</span>x600000068ec0&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼šåœ¨æ²¡æœ‰ä½¿ç”¨NSOperationQueueã€åœ¨ä¸»çº¿ç¨‹å•ç‹¬ä½¿ç”¨è‡ªå®šä¹‰ç»§æ‰¿åœ¨NSoperationçš„å­ç±»çš„æƒ…å†µä¸‹ï¼Œæ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œæ“ä½œï¼Œå¹¶æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ã€‚</p><p>ä¸‹è¾¹æˆ‘ä»¬æ¥è®²è®²NSOperationQueueçš„åˆ›å»º</p><h3 id="4-2-åˆ›å»ºé˜Ÿåˆ—"><a href="#4-2-åˆ›å»ºé˜Ÿåˆ—" class="headerlink" title="4.2 åˆ›å»ºé˜Ÿåˆ—"></a>4.2 åˆ›å»ºé˜Ÿåˆ—</h3><p>NSOperationQueueä¸€å…±æœ‰ä¸¤ç§é˜Ÿåˆ—ï¼šä¸»é˜Ÿåˆ—ã€è‡ªå®šä¹‰é˜Ÿåˆ—ã€‚å…¶ä¸­è‡ªå®šä¹‰é˜Ÿåˆ—åŒæ—¶åŒ…å«äº†ä¸²è¡Œã€å¹¶å‘åŠŸèƒ½ã€‚ä¸‹è¾¹æ˜¯ä¸»é˜Ÿåˆ—ã€è‡ªå®šä¹‰é˜Ÿåˆ—çš„åŸºæœ¬åˆ›å»ºæ–¹æ³•å’Œç‰¹ç‚¹ã€‚</p><ul><li>ä¸»é˜Ÿåˆ—<ul><li>å‡¡æ˜¯æ·»åŠ åˆ°ä¸»é˜Ÿåˆ—ä¸­çš„æ“ä½œï¼Œéƒ½ä¼šæ”¾åˆ°ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚</li></ul></li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸»é˜Ÿåˆ—è·å–æ–¹æ³•</span></span><br><span class="line"><span class="built_in">NSOperationQueue</span> *queue = [<span class="built_in">NSOperationQueue</span> mainQueue];</span><br></pre></td></tr></table></figure><ul><li>è‡ªå®šä¹‰é˜Ÿåˆ—ï¼ˆéä¸»é˜Ÿåˆ—ï¼‰<ul><li>æ·»åŠ åˆ°è¿™ç§é˜Ÿåˆ—ä¸­çš„æ“ä½œï¼Œå°±ä¼šè‡ªåŠ¨æ”¾åˆ°å­çº¿ç¨‹ä¸­æ‰§è¡Œã€‚</li><li>åŒæ—¶åŒ…å«äº†ï¼šä¸²è¡Œã€å¹¶å‘åŠŸèƒ½</li></ul></li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰é˜Ÿåˆ—åˆ›å»ºæ–¹æ³•</span></span><br><span class="line"><span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br></pre></td></tr></table></figure><h3 id="4-3-å°†æ“ä½œåŠ å…¥åˆ°ä¸»é˜Ÿåˆ—"><a href="#4-3-å°†æ“ä½œåŠ å…¥åˆ°ä¸»é˜Ÿåˆ—" class="headerlink" title="4.3 å°†æ“ä½œåŠ å…¥åˆ°ä¸»é˜Ÿåˆ—"></a>4.3 å°†æ“ä½œåŠ å…¥åˆ°ä¸»é˜Ÿåˆ—</h3><p>ä¸Šè¾¹æˆ‘ä»¬è¯´åˆ°NSOperationéœ€è¦é…åˆNSOperationQueueæ¥å®ç°å¤šçº¿ç¨‹ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬éœ€è¦å°†åˆ›å»ºå¥½çš„æ“ä½œåŠ å…¥åˆ°é˜Ÿåˆ—ä¸­å»ã€‚æ€»å…±æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ol><li><ul><li>(void)addOperation:(NSOperation *)op;<ul><li>éœ€è¦å…ˆåˆ›å»ºæ“ä½œï¼Œå†å°†åˆ›å»ºå¥½çš„æ“ä½œåŠ å…¥åˆ°åˆ›å»ºå¥½çš„é˜Ÿåˆ—ä¸­å»ã€‚</li></ul></li></ul></li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addOperationToQueue &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºæ“ä½œ</span></span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op1 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op2 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op3 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†æ“ä½œæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    [queue addOperation:op1];</span><br><span class="line">    [queue addOperation:op2];</span><br><span class="line">    [queue addOperation:op3];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-07-16</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">06.486271</span>+<span class="number">0800</span> test[<span class="number">11369</span>:<span class="number">280869</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000462b00</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-16</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">06.486359</span>+<span class="number">0800</span> test[<span class="number">11369</span>:<span class="number">280871</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">40004628c0</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-16</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">06.486355</span>+<span class="number">0800</span> test[<span class="number">11369</span>:<span class="number">280870</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000462a40</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-16</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">07.489468</span>+<span class="number">0800</span> test[<span class="number">11369</span>:<span class="number">280871</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">40004628c0</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-16</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">07.489484</span>+<span class="number">0800</span> test[<span class="number">11369</span>:<span class="number">280869</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000462b00</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-16</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">07.489543</span>+<span class="number">0800</span> test[<span class="number">11369</span>:<span class="number">280870</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000462a40</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><ul><li>(void)addOperationWithBlock:(void (^)(void))block;</li></ul></li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨ addOperationWithBlock: å°†æ“ä½œåŠ å…¥åˆ°æ“ä½œé˜Ÿåˆ—ä¸­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addOperationWithBlockToQueue &#123;</span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.ä½¿ç”¨ addOperationWithBlock: æ·»åŠ æ“ä½œåˆ°é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    [queue addOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [queue addOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [queue addOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ:</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">19:51.179870</span>+<span class="number">0800</span> test[<span class="number">1341:30827</span>] <span class="number">4</span>---&lt;NSThread: <span class="number">0</span>x604000463ec0&gt;&#123;number = <span class="number">6</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">19:51.179925</span>+<span class="number">0800</span> test[<span class="number">1341:30826</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000463f00</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">19:51.179931</span>+<span class="number">0800</span> test[<span class="number">1341:30835</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000274740</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">19:51.180024</span>+<span class="number">0800</span> test[<span class="number">1341:30825</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000463e80</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">19:53.185475</span>+<span class="number">0800</span> test[<span class="number">1341:30826</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000463f00</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">19:53.185480</span>+<span class="number">0800</span> test[<span class="number">1341:30827</span>] <span class="number">4</span>---&lt;NSThread: <span class="number">0</span>x604000463ec0&gt;&#123;number = <span class="number">6</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">19:53.185475</span>+<span class="number">0800</span> test[<span class="number">1341:30835</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000274740</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">19:53.185578</span>+<span class="number">0800</span> test[<span class="number">1341:30825</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000463e80</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼šä½¿ç”¨<code>addOperation:</code>æˆ–<code>addOperationWithBlock:</code>å°†æ“ä½œåŠ å…¥åˆ°æ“ä½œé˜Ÿåˆ—åèƒ½å¤Ÿå¼€å¯æ–°çº¿ç¨‹ï¼Œè¿›è¡Œå¹¶å‘æ‰§è¡Œã€‚</p><h2 id="5-NSOperationQueueæ§åˆ¶ä¸²è¡Œæ‰§è¡Œã€å¹¶å‘æ‰§è¡Œ"><a href="#5-NSOperationQueueæ§åˆ¶ä¸²è¡Œæ‰§è¡Œã€å¹¶å‘æ‰§è¡Œ" class="headerlink" title="5. NSOperationQueueæ§åˆ¶ä¸²è¡Œæ‰§è¡Œã€å¹¶å‘æ‰§è¡Œ"></a>5. NSOperationQueueæ§åˆ¶ä¸²è¡Œæ‰§è¡Œã€å¹¶å‘æ‰§è¡Œ</h2><p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒNSOperationQueueåˆ›å»ºçš„è‡ªå®šä¹‰é˜Ÿåˆ—åŒæ—¶å…·æœ‰ä¸²è¡Œã€å¹¶å‘åŠŸèƒ½ï¼Œä¸Šé¢æˆ‘ä»¬æ¼”ç¤ºäº†å¹¶å‘åŠŸèƒ½ï¼Œé‚£ä¹ˆä»–çš„ä¸²è¡ŒåŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><p>è¿™é‡Œæœ‰ä¸ªå…³é”®å±æ€§<code>maxConcurrentOperationCount</code>æ§åˆ¶çš„ä¸æ˜¯å¹¶å‘çº¿ç¨‹çš„æ•°é‡ï¼Œè€Œæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ä¸­åŒæ—¶èƒ½å¹¶å‘æ‰§è¡Œçš„æœ€å¤§æ“ä½œæ•°ã€‚å¹¶ä¸”ä¸€ä¸ªæ“ä½œä¹Ÿå¹¶éåªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œã€‚</p><ul><li>æœ€å¤§å¹¶å‘æ“ä½œæ•°ï¼š<code>maxConcurrentOperationCount</code><ul><li><code>maxConcurrentOperationCount</code>é»˜è®¤æƒ…å†µä¸‹ä¸º<em>-1</em>ï¼Œè¡¨ç¤ºä¸è¿›è¡Œé™åˆ¶ï¼Œå¯è¿›è¡Œå¹¶å‘æ‰§è¡Œã€‚</li><li><code>maxConcurrentOperationCount</code>ä¸º<em>1</em>æ—¶ï¼Œé˜Ÿåˆ—ä¸ºä¸²è¡Œé˜Ÿåˆ—ã€‚åªèƒ½ä¸²è¡Œæ‰§è¡Œã€‚</li><li><code>maxConcurrentOperationCount</code><em>å¤§äº1</em>æ—¶ï¼Œé˜Ÿåˆ—ä¸ºå¹¶å‘é˜Ÿåˆ—ã€‚æ“ä½œå¹¶å‘æ‰§è¡Œï¼Œå½“ç„¶è¿™ä¸ªå€¼ä¸åº”è¶…è¿‡ç³»ç»Ÿé™åˆ¶ï¼Œå³ä½¿è‡ªå·±è®¾ç½®ä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œç³»ç»Ÿä¹Ÿä¼šè‡ªåŠ¨è°ƒæ•´ä¸º<code>min{è‡ªå·±è®¾å®šçš„å€¼, ç³»ç»Ÿè®¾å®šçš„é»˜è®¤æœ€å¤§å€¼};</code></li></ul></li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è®¾ç½® MaxConcurrentOperationCountï¼ˆæœ€å¤§å¹¶å‘æ“ä½œæ•°ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)setMaxConcurrentOperationCount &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.è®¾ç½®æœ€å¤§å¹¶å‘æ“ä½œæ•°</span></span><br><span class="line">    queue.maxConcurrentOperationCount = <span class="number">1</span>; <span class="comment">// ä¸²è¡Œé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">// queue.maxConcurrentOperationCount = 2; // å¹¶å‘é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">// queue.maxConcurrentOperationCount = 8; // å¹¶å‘é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.æ·»åŠ æ“ä½œ</span></span><br><span class="line">    [queue addOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [queue addOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [queue addOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [queue addOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"4---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€å¤§æ“ä½œå¹¶å‘æ•°ä¸º1æ—¶è¾“å‡ºç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">43.406467</span>+<span class="number">0800</span> test[<span class="number">2376:62463</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">00002740c0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">45.411312</span>+<span class="number">0800</span> test[<span class="number">2376:62463</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">00002740c0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">50:47.414252</span>+<span class="number">0800</span> test[<span class="number">2376:62460</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">00002757c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">50:49.415113</span>+<span class="number">0800</span> test[<span class="number">2376:62460</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">00002757c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">51.420317</span>+<span class="number">0800</span> test[<span class="number">2376:62463</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">00002740c0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">50:53.421105</span>+<span class="number">0800</span> test[<span class="number">2376:62463</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">00002740c0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">50:55.422231</span>+<span class="number">0800</span> test[<span class="number">2376:62460</span>] <span class="number">4</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">00002757c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">57.425648</span>+<span class="number">0800</span> test[<span class="number">2376:62460</span>] <span class="number">4</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">00002757c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure><p>æœ€å¤§å¹¶å‘æ“ä½œæ•°ä¸º2æ—¶è¾“å‡ºç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">53</span>:<span class="number">10.540363</span>+<span class="number">0800</span> test[<span class="number">2407:65980</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x604000271ec0&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">53</span>:<span class="number">10.540361</span>+<span class="number">0800</span> test[<span class="number">2407:65981</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027f440</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">53</span>:<span class="number">12.543560</span>+<span class="number">0800</span> test[<span class="number">2407:65981</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x600<span class="number">00027f440</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">53</span>:<span class="number">12.543578</span>+<span class="number">0800</span> test[<span class="number">2407:65980</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x604000271ec0&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">53:14.546254</span>+<span class="number">0800</span> test[<span class="number">2407:65982</span>] <span class="number">4</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000271a00</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">53:14.546254</span>+<span class="number">0800</span> test[<span class="number">2407:65983</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">00004692c0</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">53</span>:<span class="number">16.550397</span>+<span class="number">0800</span> test[<span class="number">2407:65982</span>] <span class="number">4</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000271a00</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">10</span>:<span class="number">53</span>:<span class="number">16.550420</span>+<span class="number">0800</span> test[<span class="number">2407:65983</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">00004692c0</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹å‡ºï¼šå½“æœ€å¤§å¹¶å‘æ“ä½œæ•°ä¸º1æ—¶ï¼Œæ“ä½œæ˜¯æŒ‰é¡ºåºä¸²è¡Œæ‰§è¡Œçš„ï¼Œå¹¶ä¸”ä¸€ä¸ªæ“ä½œå®Œæˆä¹‹åï¼Œä¸‹ä¸€ä¸ªæ“ä½œæ‰å¼€å§‹æ‰§è¡Œã€‚å½“æœ€å¤§æ“ä½œå¹¶å‘æ•°ä¸º2æ—¶ï¼Œæ“ä½œæ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œå¯ä»¥åŒæ—¶æ‰§è¡Œä¸¤ä¸ªæ“ä½œã€‚è€Œå¼€å¯çº¿ç¨‹é‡æ˜¯ç”±ç³»ç»Ÿå†³å®šçš„ï¼Œä¸éœ€è¦æˆ‘ä»¬æ¥ç®¡ç†ã€‚</li></ul><p>è¿™æ ·çœ‹æ¥ï¼Œæ˜¯æ¯”GCDç®€å•äº†è®¸å¤šï¼</p><h2 id="6-NSOperationæ“ä½œä¾èµ–"><a href="#6-NSOperationæ“ä½œä¾èµ–" class="headerlink" title="6. NSOperationæ“ä½œä¾èµ–"></a>6. NSOperationæ“ä½œä¾èµ–</h2><p>NSOperationã€NSOperationQueueæœ€å¸å¼•äººçš„åœ°æ–¹æ˜¯å®ƒèƒ½æ·»åŠ æ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚é€šè¿‡æ“ä½œä¾èµ–ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ§åˆ¶æ“ä½œä¹‹é—´çš„æ‰§è¡Œå…ˆåé¡ºåºã€‚NSOperationæä¾›äº†3ä¸ªæ¥å£ä¾›æˆ‘ä»¬ç®¡ç†å’ŒæŸ¥çœ‹ä¾èµ–ã€‚</p><ul><li><code>- (void)addDependency:(NSOperation *)op;</code>æ·»åŠ ä¾èµ–ï¼Œä½¿å½“å‰æ“ä½œä¾èµ–äºæ“ä½œopçš„å®Œæˆï¼›</li><li><code>- (void)removeDependency:(NSOperation *)op;</code>ç§»é™¤ä¾èµ–ï¼Œå–æ¶ˆå½“å‰æ“ä½œå¯¹è±¡å¯¹æ“ä½œopçš„ä¾èµ–ï¼›</li><li><code>@property (readonly, copy) NSArray&lt;NSOperation *&gt; *dependencies;</code>åœ¨å½“å‰æ“ä½œå¼€å§‹æ‰§è¡Œä¹‹å‰å®Œæˆæ‰§è¡Œçš„æ‰€æœ‰æ“ä½œå¯¹è±¡æ•°ç»„ï¼›</li></ul><p>å½“ç„¶æˆ‘ä»¬å¸¸ç”¨åˆ°çš„è¿˜æ˜¯æ·»åŠ ä¾èµ–æ“ä½œã€‚ç°åœ¨è€ƒè™‘è¿™æ ·çš„éœ€æ±‚ï¼Œæ¯”å¦‚è¯´æœ‰Aã€Bä¸¤ä¸ªæ“ä½œï¼Œå…¶ä¸­Aæ“ä½œæ‰§è¡Œå®Œï¼ŒBæ“ä½œæ‰èƒ½æ‰§è¡Œã€‚</p><p>å¦‚æœä½¿ç”¨ä¾èµ–æ¥å¤„ç†çš„è¯ï¼Œé‚£ä¹ˆä¹…éœ€è¦è®©æ“ä½œBä¾èµ–äºæ“ä½œAã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ“ä½œä¾èµ–</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨æ–¹æ³•ï¼šaddDependency:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)addDependency &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.åˆ›å»ºæ“ä½œ</span></span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op1 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op2 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.æ·»åŠ ä¾èµ–</span></span><br><span class="line">    [op2 addDependency:op1]; <span class="comment">// è®©op2 ä¾èµ–äº op1ï¼Œåˆ™å…ˆæ‰§è¡Œop1ï¼Œåœ¨æ‰§è¡Œop2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.æ·»åŠ æ“ä½œåˆ°é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    [queue addOperation:op1];</span><br><span class="line">    [queue addOperation:op2];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-05-28</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">15.838781</span>+<span class="number">0800</span> test[<span class="number">2933:116467</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x<span class="number">60000027d200</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">17.842654</span>+<span class="number">0800</span> test[<span class="number">2933:116467</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x<span class="number">60000027d200</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">11</span>:<span class="number">41:19.848179</span>+<span class="number">0800</span> test[<span class="number">2933:116468</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x60000027bd80&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">21.849031</span>+<span class="number">0800</span> test[<span class="number">2933:116468</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x60000027bd80&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹åˆ°ï¼šé€šè¿‡æ·»åŠ æ“ä½œä¾èµ–ï¼Œæ— è®ºè¿è¡Œå‡ æ¬¡ï¼Œå…¶ç»“æœéƒ½æ˜¯op1å…ˆæ‰§è¡Œï¼Œop2åæ‰§è¡Œã€‚</li></ul><h2 id="7-NSOperationä¼˜å…ˆçº§"><a href="#7-NSOperationä¼˜å…ˆçº§" class="headerlink" title="7. NSOperationä¼˜å…ˆçº§"></a>7. NSOperationä¼˜å…ˆçº§</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">property</span><span class="title"> </span>NSOperationQueuePriority queuePriority;</span><br></pre></td></tr></table></figure><p>NSOperationæä¾›äº†<code>queuePriority</code>ï¼ˆä¼˜å…ˆçº§ï¼‰å±æ€§ï¼Œ<code>queuePriority</code>å±æ€§é€‚ç”¨äº<em>åŒä¸€æ“ä½œé˜Ÿåˆ—ä¸­</em>çš„æ“ä½œï¼Œä¸é€‚ç”¨äºä¸åŒæ“ä½œé˜Ÿåˆ—ä¸­çš„æ“ä½œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ–°åˆ›å»ºçš„æ“ä½œå¯¹è±¡ä¼˜å…ˆçº§éƒ½æ˜¯<code>NSOperationQueuePriorityNormal</code>ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>setQueuePriority:</code>æ–¹æ³•æ¥æ”¹å˜å½“å‰æ“ä½œåœ¨åŒä¸€é˜Ÿåˆ—ä¸­çš„æ‰§è¡Œä¼˜å…ˆçº§ã€‚</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// ä¼˜å…ˆçº§çš„å–å€¼</span><br><span class="line">typedef <span class="type">NS_ENUM</span>(<span class="type">NSInteger</span>, <span class="type">NSOperationQueuePriority</span>) &#123;</span><br><span class="line">    <span class="type">NSOperationQueuePriorityVeryLow</span> = -8L,</span><br><span class="line">    <span class="type">NSOperationQueuePriorityLow</span> = -4L,</span><br><span class="line">    <span class="type">NSOperationQueuePriorityNormal</span> = 0,</span><br><span class="line">    <span class="type">NSOperationQueuePriorityHigh</span> = 4,</span><br><span class="line">    <span class="type">NSOperationQueuePriorityVeryHigh</span> = 8</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šè¾¹æˆ‘ä»¬è¯´è¿‡ï¼šå¯¹äºæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„æ“ä½œï¼Œé¦–å…ˆè¿›å…¥å‡†å¤‡å°±ç»ªçš„çŠ¶æ€ï¼ˆå°±ç»ªçŠ¶æ€å–å†³äºæ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼‰ï¼Œç„¶åè¿›å…¥å°±ç»ªçŠ¶æ€çš„æ“ä½œçš„<strong>å¼€å§‹æ‰§è¡Œé¡ºåº</strong>ï¼ˆéç»“æŸæ‰§è¡Œé¡ºåºï¼‰ç”±æ“ä½œä¹‹é—´ç›¸å¯¹çš„ä¼˜å…ˆçº§å†³å®šï¼ˆä¼˜å…ˆçº§æ˜¯æ“ä½œå¯¹è±¡è‡ªèº«çš„å±æ€§ï¼‰ã€‚</p><p><strong>é‚£ä¹ˆï¼Œä»€ä¹ˆæ ·çš„æ“ä½œæ‰æ˜¯è¿›å…¥å°±ç»ªçŠ¶æ€çš„æ“ä½œå‘¢ï¼Ÿ</strong></p><ul><li>å½“ä¸€ä¸ªæ“ä½œçš„æ‰€æœ‰ä¾èµ–éƒ½å·²ç»å®Œæˆæ—¶ï¼Œæ“ä½œå¯¹è±¡é€šå¸¸ä¼šè¿›å…¥å‡†å¤‡å°±ç»ªçŠ¶æ€ï¼Œç­‰å¾…æ‰§è¡Œã€‚</li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼šç°åœ¨æœ‰4ä¸ªä¼˜å…ˆçº§éƒ½æ˜¯NSOperationQueuePriorityNormal(é»˜è®¤çº§åˆ«)çš„æ“ä½œï¼šop1ã€op2ã€op3ã€op4ã€‚å…¶ä¸­op3ä¾èµ–äºop2ï¼Œop2ä¾èµ–äºop1ï¼Œå³ä¼˜å…ˆçº§ï¼šop1 &gt; op2 &gt; op3 ã€‚ç°åœ¨è®²è¿™4ä¸ªæ“ä½œæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­å¹¶å‘æ‰§è¡Œã€‚</p><ul><li>å› ä¸ºop1å’Œop4éƒ½æ²¡æœ‰éœ€è¦ä¾èµ–çš„æ“ä½œï¼Œæ‰€ä»¥åœ¨op1ï¼Œop4æ‰§è¡Œä¹‹å‰ï¼Œå°±æ˜¯å‡ºäºå‡†å¤‡å°±ç»ªçŠ¶æ€çš„æ“ä½œã€‚</li><li>è€Œop3å’Œop2éƒ½æœ‰ä¾èµ–çš„æ“ä½œï¼ˆop3ä¾èµ–äºop2ï¼Œop2ä¾èµ–äºop1ï¼‰ï¼Œæ‰€ä»¥op3å’Œop2éƒ½ä¸æ˜¯å‡†å¤‡å°±ç»ªçŠ¶æ€ä¸‹çš„æ“ä½œã€‚</li></ul><p>ç†è§£äº†è¿›å…¥å°±ç»ªçŠ¶æ€çš„æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç†è§£äº†<code>queuePriority</code>å±æ€§çš„ä½œç”¨å¯¹è±¡ã€‚</p><ul><li><code>queuePriority</code>å±æ€§å†³å®šäº†<strong>è¿›å…¥å‡†å¤‡å°±ç»ªçŠ¶æ€ä¸‹çš„æ“ä½œ</strong>ä¹‹é—´çš„å¼€å§‹æ‰§è¡Œé¡ºåºã€‚å¹¶ä¸”ï¼Œä¼˜å…ˆçº§ä¸èƒ½å–ä»£ä¾èµ–å…³ç³»ã€‚</li><li>å¦‚æœä¸€ä¸ªé˜Ÿåˆ—ä¸­æ—¢åŒ…å«é«˜ä¼˜å…ˆçº§æ“ä½œï¼ŒåˆåŒ…å«ä½ä¼˜å…ˆçº§æ“ä½œï¼Œå¹¶ä¸”ä¸¤ä¸ªæ“ä½œéƒ½å·²ç»å‡†å¤‡å°±ç»ªï¼Œé‚£ä¹ˆé˜Ÿåˆ—å…ˆæ‰§è¡Œé«˜ä¼˜å…ˆçº§æ“ä½œã€‚æ¯”å¦‚ä¸Šä¾‹ä¸­ï¼Œå¦‚æœ op1 å’Œ op4 æ˜¯ä¸åŒä¼˜å…ˆçº§çš„æ“ä½œï¼Œé‚£ä¹ˆå°±ä¼šå…ˆæ‰§è¡Œä¼˜å…ˆçº§é«˜çš„æ“ä½œã€‚</li><li>å¦‚æœï¼Œä¸€ä¸ªé˜Ÿåˆ—ä¸­æ—¢åŒ…å«äº†å‡†å¤‡å°±ç»ªçŠ¶æ€çš„æ“ä½œï¼ŒåˆåŒ…å«äº†æœªå‡†å¤‡å°±ç»ªçš„æ“ä½œï¼Œæœªå‡†å¤‡å°±ç»ªçš„æ“ä½œä¼˜å…ˆçº§æ¯”å‡†å¤‡å°±ç»ªçš„æ“ä½œä¼˜å…ˆçº§é«˜ã€‚é‚£ä¹ˆï¼Œè™½ç„¶å‡†å¤‡å°±ç»ªçš„æ“ä½œä¼˜å…ˆçº§ä½ï¼Œä¹Ÿä¼šä¼˜å…ˆæ‰§è¡Œã€‚ä¼˜å…ˆçº§ä¸èƒ½å–ä»£ä¾èµ–å…³ç³»ã€‚å¦‚æœè¦æ§åˆ¶æ“ä½œé—´çš„å¯åŠ¨é¡ºåºï¼Œåˆ™å¿…é¡»ä½¿ç”¨ä¾èµ–å…³ç³»ã€‚</li></ul><h2 id="8-NSOperationã€NSOperationQueueçº¿ç¨‹é—´çš„é€šä¿¡"><a href="#8-NSOperationã€NSOperationQueueçº¿ç¨‹é—´çš„é€šä¿¡" class="headerlink" title="8.NSOperationã€NSOperationQueueçº¿ç¨‹é—´çš„é€šä¿¡"></a>8.NSOperationã€NSOperationQueueçº¿ç¨‹é—´çš„é€šä¿¡</h2><p>åœ¨iOSå¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬åœ¨ä¸»çº¿ç¨‹é‡Œè¾¹è¿›è¡ŒUIåˆ·æ–°ï¼Œä¾‹å¦‚ï¼šç‚¹å‡»ã€æ»šåŠ¨ã€æ‹–æ‹½ç­‰äº‹ä»¶ã€‚æˆ‘ä»¬é€šå¸¸æŠŠä¸€äº›è€—æ—¶æ“ä½œæ”¾åœ¨å…¶ä»–çº¿ç¨‹ï¼Œæ¯”å¦‚è¯´å›¾ç‰‡ä¸‹è½½ã€æ–‡ä»¶ä¸Šä¼ ç­‰è€—æ—¶æ“ä½œã€‚è€Œå½“æˆ‘ä»¬æœ‰æ—¶å€™åœ¨å…¶ä»–çº¿ç¨‹å®Œæˆäº†è€—æ—¶æ“ä½œæ—¶ï¼Œéœ€è¦å›åˆ°ä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆä¹…ç”¨åˆ°äº†çº¿ç¨‹ä¹‹é—´çš„é€šè®¯ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¿ç¨‹é—´é€šä¿¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)communication &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc]init];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.æ·»åŠ æ“ä½œ</span></span><br><span class="line">    [queue addOperationWithBlock:^&#123;</span><br><span class="line">        <span class="comment">// å¼‚æ­¥è¿›è¡Œè€—æ—¶æ“ä½œ</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å›åˆ°ä¸»çº¿ç¨‹</span></span><br><span class="line">        [[<span class="built_in">NSOperationQueue</span> mainQueue] addOperationWithBlock:^&#123;</span><br><span class="line">            <span class="comment">// è¿›è¡Œä¸€äº› UI åˆ·æ–°ç­‰æ“ä½œ</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">                [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>]; <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-05-28</span> <span class="number">14</span>:<span class="number">45:18.184142</span>+<span class="number">0800</span> test[<span class="number">3570:202499</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x60400027cc80&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">14</span>:<span class="number">45:20.189357</span>+<span class="number">0800</span> test[<span class="number">3570:202499</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x60400027cc80&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">14</span>:<span class="number">45:22.190944</span>+<span class="number">0800</span> test[<span class="number">3570:202450</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x604000075ac0&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-05-28</span> <span class="number">14</span>:<span class="number">45:24.191504</span>+<span class="number">0800</span> test[<span class="number">3570:202450</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x604000075ac0&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼šé€šè¿‡çº¿ç¨‹é—´çš„é€šä¿¡ï¼Œå…ˆåœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œæ“ä½œï¼Œç­‰æ“ä½œæ‰§è¡Œå®Œäº†ä¹‹åå†å›åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œä¸»çº¿ç¨‹çš„ç›¸åº”æ“ä½œã€‚</p><h2 id="9-NSOperationã€NSOperationQueueçº¿ç¨‹åŒæ­¥å’Œçº¿ç¨‹å®‰å…¨"><a href="#9-NSOperationã€NSOperationQueueçº¿ç¨‹åŒæ­¥å’Œçº¿ç¨‹å®‰å…¨" class="headerlink" title="9. NSOperationã€NSOperationQueueçº¿ç¨‹åŒæ­¥å’Œçº¿ç¨‹å®‰å…¨"></a>9. NSOperationã€NSOperationQueueçº¿ç¨‹åŒæ­¥å’Œçº¿ç¨‹å®‰å…¨</h2><ul><li><p><strong>çº¿ç¨‹å®‰å…¨</strong>ï¼šå¦‚æœä½ çš„ä»£ç æ‰€åœ¨çš„è¿›ç¨‹ä¸­æœ‰å¤šä¸ªçº¿ç¨‹åœ¨åŒæ—¶è¿è¡Œï¼Œè€Œè¿™äº›çº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶è¿è¡Œè¿™æ®µä»£ç ã€‚å¦‚æœæ¯æ¬¡è¿è¡Œç»“æœå’Œå•çº¿ç¨‹è¿è¡Œçš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”å…¶ä»–çš„å˜é‡çš„å€¼ä¹Ÿå’Œé¢„æœŸçš„æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚<br>è‹¥æ¯ä¸ªçº¿ç¨‹ä¸­å¯¹å…¨å±€å˜é‡ã€é™æ€å˜é‡åªæœ‰è¯»æ“ä½œï¼Œè€Œæ— å†™æ“ä½œï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªå…¨å±€å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›è‹¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œå†™æ“ä½œï¼ˆæ›´æ”¹å˜é‡ï¼‰ï¼Œä¸€èˆ¬éƒ½éœ€è¦è€ƒè™‘çº¿ç¨‹åŒæ­¥ï¼Œå¦åˆ™çš„è¯å°±å¯èƒ½å½±å“çº¿ç¨‹å®‰å…¨ã€‚</p></li><li><p><strong>çº¿ç¨‹åŒæ­¥</strong>ï¼šå¯ç†è§£ä¸ºçº¿ç¨‹ A å’Œ çº¿ç¨‹ B ä¸€å—é…åˆï¼ŒA æ‰§è¡Œåˆ°ä¸€å®šç¨‹åº¦æ—¶è¦ä¾é çº¿ç¨‹ B çš„æŸä¸ªç»“æœï¼Œäºæ˜¯åœä¸‹æ¥ï¼Œç¤ºæ„ B è¿è¡Œï¼›B ä¾è¨€æ‰§è¡Œï¼Œå†å°†ç»“æœç»™ Aï¼›A å†ç»§ç»­æ“ä½œã€‚</p></li></ul><p>ä¸¾ä¸ªç®€å•ä¾‹å­å°±æ˜¯ï¼šä¸¤ä¸ªäººåœ¨ä¸€èµ·èŠå¤©ã€‚ä¸¤ä¸ªäººä¸èƒ½åŒæ—¶è¯´è¯ï¼Œé¿å…å¬ä¸æ¸…(æ“ä½œå†²çª)ã€‚ç­‰ä¸€ä¸ªäººè¯´å®Œ(ä¸€ä¸ªçº¿ç¨‹ç»“æŸæ“ä½œ)ï¼Œå¦ä¸€ä¸ªå†è¯´(å¦ä¸€ä¸ªçº¿ç¨‹å†å¼€å§‹æ“ä½œ)ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿç«è½¦ç¥¨å”®å–çš„æ–¹å¼ï¼Œå®ç° NSOperation çº¿ç¨‹å®‰å…¨å’Œè§£å†³çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚<br>åœºæ™¯ï¼šæ€»å…±æœ‰50å¼ ç«è½¦ç¥¨ï¼Œæœ‰ä¸¤ä¸ªå”®å–ç«è½¦ç¥¨çš„çª—å£ï¼Œä¸€ä¸ªæ˜¯åŒ—äº¬ç«è½¦ç¥¨å”®å–çª—å£ï¼Œå¦ä¸€ä¸ªæ˜¯ä¸Šæµ·ç«è½¦ç¥¨å”®å–çª—å£ã€‚ä¸¤ä¸ªçª—å£åŒæ—¶å”®å–ç«è½¦ç¥¨ï¼Œå–å®Œä¸ºæ­¢ã€‚</p><h3 id="9-1-NSOperationã€NSOperationQueueéçº¿ç¨‹å®‰å…¨"><a href="#9-1-NSOperationã€NSOperationQueueéçº¿ç¨‹å®‰å…¨" class="headerlink" title="9.1 NSOperationã€NSOperationQueueéçº¿ç¨‹å®‰å…¨"></a>9.1 NSOperationã€NSOperationQueueéçº¿ç¨‹å®‰å…¨</h3><p>å…ˆæ¥çœ‹çœ‹ä¸è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éçº¿ç¨‹å®‰å…¨ï¼šä¸ä½¿ç”¨ NSLock</span></span><br><span class="line"><span class="comment"> * åˆå§‹åŒ–ç«è½¦ç¥¨æ•°é‡ã€å–ç¥¨çª—å£(éçº¿ç¨‹å®‰å…¨)ã€å¹¶å¼€å§‹å–ç¥¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)initTicketStatusNotSave &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.ticketSurplusCount = <span class="number">50</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.åˆ›å»º queue1,queue1 ä»£è¡¨åŒ—äº¬ç«è½¦ç¥¨å”®å–çª—å£</span></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *queue1 = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    queue1.maxConcurrentOperationCount = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.åˆ›å»º queue2,queue2 ä»£è¡¨ä¸Šæµ·ç«è½¦ç¥¨å”®å–çª—å£</span></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *queue2 = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    queue2.maxConcurrentOperationCount = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.åˆ›å»ºå–ç¥¨æ“ä½œ op1</span></span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op1 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        [weakSelf saleTicketNotSafe];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4.åˆ›å»ºå–ç¥¨æ“ä½œ op2</span></span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op2 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        [weakSelf saleTicketNotSafe];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5.æ·»åŠ æ“ä½œï¼Œå¼€å§‹å–ç¥¨</span></span><br><span class="line">    [queue1 addOperation:op1];</span><br><span class="line">    [queue2 addOperation:op2];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å”®å–ç«è½¦ç¥¨(éçº¿ç¨‹å®‰å…¨)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)saleTicketNotSafe &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.ticketSurplusCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœè¿˜æœ‰ç¥¨ï¼Œç»§ç»­å”®å–</span></span><br><span class="line">            <span class="keyword">self</span>.ticketSurplusCount--;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"å‰©ä½™ç¥¨æ•°:%ld çª—å£:%@"</span>, (<span class="keyword">long</span>)<span class="keyword">self</span>.ticketSurplusCount, [<span class="built_in">NSThread</span> currentThread]]);</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">0.2</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"æ‰€æœ‰ç«è½¦ç¥¨å‡å·²å”®å®Œ"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:00.910264<span class="string">+0800</span> test[4059:270790] currentThread---&lt;NSThread: 0x604000078040&gt;&#123;number = 1, name = main&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:00.911024<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:48 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:00.911059<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:49 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:01.113769<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:47 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:01.113769<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:47 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:01.315197<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:46 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:01.315245<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:45 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:01.516986<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:44 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:01.516986<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:44 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:01.720397<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:43 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:01.720438<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:42 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:01.923211<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:41 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:01.923234<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:40 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:02.127978<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:39 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:05.783073<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:9 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:05.783073<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:9 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:05.986099<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:8 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:05.986118<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:7 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:06.190088<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:6 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:06.190117<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:5 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:06.394938<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:4 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:06.394961<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:4 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:06.596928<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:3 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:06.597015<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:3 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:06.800513<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:2 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:06.800513<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:1 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:07.004409<span class="string">+0800</span> test[4059:270854] å‰©ä½™ç¥¨æ•°:0 çª—å£:&lt;NSThread: 0x600000468500&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:07.004409<span class="string">+0800</span> test[4059:270856] å‰©ä½™ç¥¨æ•°:0 çª—å£:&lt;NSThread: 0x604000274940&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:07.206585<span class="string">+0800</span> test[4059:270854] æ‰€æœ‰ç«è½¦ç¥¨å‡å·²å”®å®Œ</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:52:07.206626<span class="string">+0800</span> test[4059:270856] æ‰€æœ‰ç«è½¦ç¥¨å‡å·²å”®å®Œ</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼šåœ¨ä¸è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼Œä¸é€‚ç”¨NSLockæƒ…å†µä¸‹ï¼Œå¾—åˆ°ç¥¨æ•°æ˜¯é”™ä¹±çš„ï¼Œè¿™æ ·æ˜¾ç„¶ä¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p><h3 id="9-2-NSOperationã€NSOperationQueueçº¿ç¨‹å®‰å…¨"><a href="#9-2-NSOperationã€NSOperationQueueçº¿ç¨‹å®‰å…¨" class="headerlink" title="9.2 NSOperationã€NSOperationQueueçº¿ç¨‹å®‰å…¨"></a>9.2 NSOperationã€NSOperationQueueçº¿ç¨‹å®‰å…¨</h3><p>çº¿ç¨‹å®‰å…¨è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥ç»™çº¿ç¨‹åŠ é”ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥æ“ä½œçš„æ—¶å€™ï¼Œä¸å…è®¸å…¶ä»–çº¿ç¨‹è¿›è¡Œæ“ä½œã€‚iOS å®ç°çº¿ç¨‹åŠ é”æœ‰å¾ˆå¤šç§æ–¹å¼ã€‚@synchronizedã€ NSLockã€NSRecursiveLockã€NSConditionã€NSConditionLockã€pthread_mutexã€dispatch_semaphoreã€OSSpinLockã€atomic(property) set/getç­‰ç­‰å„ç§æ–¹å¼ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ NSLock å¯¹è±¡æ¥è§£å†³çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚NSLock å¯¹è±¡å¯ä»¥é€šè¿‡è¿›å…¥é”æ—¶è°ƒç”¨ lock æ–¹æ³•ï¼Œè§£é”æ—¶è°ƒç”¨ unlock æ–¹æ³•æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><p>è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¿ç¨‹å®‰å…¨ï¼šä½¿ç”¨ NSLock åŠ é”</span></span><br><span class="line"><span class="comment"> * åˆå§‹åŒ–ç«è½¦ç¥¨æ•°é‡ã€å–ç¥¨çª—å£(çº¿ç¨‹å®‰å…¨)ã€å¹¶å¼€å§‹å–ç¥¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)initTicketStatusSave &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.ticketSurplusCount = <span class="number">50</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.lock = [[<span class="built_in">NSLock</span> alloc] init];  <span class="comment">// åˆå§‹åŒ– NSLock å¯¹è±¡</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.åˆ›å»º queue1,queue1 ä»£è¡¨åŒ—äº¬ç«è½¦ç¥¨å”®å–çª—å£</span></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *queue1 = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    queue1.maxConcurrentOperationCount = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.åˆ›å»º queue2,queue2 ä»£è¡¨ä¸Šæµ·ç«è½¦ç¥¨å”®å–çª—å£</span></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *queue2 = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    queue2.maxConcurrentOperationCount = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.åˆ›å»ºå–ç¥¨æ“ä½œ op1</span></span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op1 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        [weakSelf saleTicketSafe];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4.åˆ›å»ºå–ç¥¨æ“ä½œ op2</span></span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op2 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        [weakSelf saleTicketSafe];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5.æ·»åŠ æ“ä½œï¼Œå¼€å§‹å–ç¥¨</span></span><br><span class="line">    [queue1 addOperation:op1];</span><br><span class="line">    [queue2 addOperation:op2];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å”®å–ç«è½¦ç¥¨(çº¿ç¨‹å®‰å…¨)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)saleTicketSafe &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åŠ é”</span></span><br><span class="line">        [<span class="keyword">self</span>.lock lock];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.ticketSurplusCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœè¿˜æœ‰ç¥¨ï¼Œç»§ç»­å”®å–</span></span><br><span class="line">            <span class="keyword">self</span>.ticketSurplusCount--;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"å‰©ä½™ç¥¨æ•°:%ld çª—å£:%@"</span>, (<span class="keyword">long</span>)<span class="keyword">self</span>.ticketSurplusCount, [<span class="built_in">NSThread</span> currentThread]]);</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">0.2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è§£é”</span></span><br><span class="line">        [<span class="keyword">self</span>.lock unlock];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.ticketSurplusCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"æ‰€æœ‰ç«è½¦ç¥¨å‡å·²å”®å®Œ"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:07.278045<span class="string">+0800</span> test[4089:273593] currentThread---&lt;NSThread: 0x600000067b80&gt;&#123;number = 1, name = main&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:07.278940<span class="string">+0800</span> test[4089:273667] å‰©ä½™ç¥¨æ•°:49 çª—å£:&lt;NSThread: 0x60000026da00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:07.483256<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:48 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:07.685471<span class="string">+0800</span> test[4089:273667] å‰©ä½™ç¥¨æ•°:47 çª—å£:&lt;NSThread: 0x60000026da00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:07.887504<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:46 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:08.087948<span class="string">+0800</span> test[4089:273667] å‰©ä½™ç¥¨æ•°:45 çª—å£:&lt;NSThread: 0x60000026da00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:08.292016<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:44 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:08.493725<span class="string">+0800</span> test[4089:273667] å‰©ä½™ç¥¨æ•°:43 çª—å£:&lt;NSThread: 0x60000026da00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:08.698786<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:42 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:08.901019<span class="string">+0800</span> test[4089:273667] å‰©ä½™ç¥¨æ•°:41 çª—å£:&lt;NSThread: 0x60000026da00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:09.104019<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:40 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:09.305152<span class="string">+0800</span> test[4089:273667] å‰©ä½™ç¥¨æ•°:39 çª—å£:&lt;NSThread: 0x60000026da00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:09.510415<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:38 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:15.215177<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:10 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:15.420174<span class="string">+0800</span> test[4089:273667] å‰©ä½™ç¥¨æ•°:9 çª—å£:&lt;NSThread: 0x60000026da00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:15.624998<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:8 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:15.828335<span class="string">+0800</span> test[4089:273667] å‰©ä½™ç¥¨æ•°:7 çª—å£:&lt;NSThread: 0x60000026da00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:16.033039<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:6 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:16.237666<span class="string">+0800</span> test[4089:273667] å‰©ä½™ç¥¨æ•°:5 çª—å£:&lt;NSThread: 0x60000026da00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:16.438533<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:4 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:16.643922<span class="string">+0800</span> test[4089:273667] å‰©ä½™ç¥¨æ•°:3 çª—å£:&lt;NSThread: 0x60000026da00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:16.848878<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:2 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:17.053019<span class="string">+0800</span> test[4089:273667] å‰©ä½™ç¥¨æ•°:1 çª—å£:&lt;NSThread: 0x60000026da00&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:17.257527<span class="string">+0800</span> test[4089:273665] å‰©ä½™ç¥¨æ•°:0 çª—å£:&lt;NSThread: 0x6000002674c0&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:17.462667<span class="string">+0800</span> test[4089:273667] æ‰€æœ‰ç«è½¦ç¥¨å‡å·²å”®å®Œ</span><br><span class="line">2018<span class="string">-05</span><span class="string">-28</span> 15:54:17.462668<span class="string">+0800</span> test[4089:273665] æ‰€æœ‰ç«è½¦ç¥¨å‡å·²å”®å®Œ</span><br></pre></td></tr></table></figure><h2 id="10-NSOperationã€NSOperationQueueå¸¸ç”¨å±æ€§å’Œæ–¹æ³•å½’çº³"><a href="#10-NSOperationã€NSOperationQueueå¸¸ç”¨å±æ€§å’Œæ–¹æ³•å½’çº³" class="headerlink" title="10. NSOperationã€NSOperationQueueå¸¸ç”¨å±æ€§å’Œæ–¹æ³•å½’çº³"></a>10. NSOperationã€NSOperationQueueå¸¸ç”¨å±æ€§å’Œæ–¹æ³•å½’çº³</h2><h3 id="10-1-NSOperationçš„å¸¸ç”¨å±æ€§å’Œæ–¹æ³•"><a href="#10-1-NSOperationçš„å¸¸ç”¨å±æ€§å’Œæ–¹æ³•" class="headerlink" title="10.1 NSOperationçš„å¸¸ç”¨å±æ€§å’Œæ–¹æ³•"></a>10.1 NSOperationçš„å¸¸ç”¨å±æ€§å’Œæ–¹æ³•</h3><ol><li><p>å–æ¶ˆæ“ä½œæ–¹æ³•</p><ul><li><code>- (void)cancel;</code>å¯ä»¥å–æ¶ˆæ“ä½œï¼Œå®è´¨ä¸Šæ˜¯æ ‡è®°isCancelledçŠ¶æ€ã€‚</li></ul></li><li><p>åˆ¤æ–­æ“ä½œçŠ¶æ€æ–¹æ³•</p><ul><li><code>- (BOOL)isFinished;</code>åˆ¤æ–­æ“ä½œæ˜¯å¦å·²ç»ç»“æŸã€‚</li><li><code>- (BOOL)isCancelled;</code>åˆ¤æ–­æ“ä½œæ˜¯å¦å·²ç»æ ‡è®°ä¸ºå–æ¶ˆã€‚</li><li><code>- (BOOL)isExecuting;</code>åˆ¤æ–­æ“ä½œæ˜¯å¦æ­£åœ¨è¿è¡Œã€‚</li><li><code>- (BOOL)isReady;</code>åˆ¤æ–­æ“ä½œæ˜¯å¦å¤„äºå‡†å¤‡å°±ç»ªçŠ¶æ€ï¼Œè¿™ä¸ªå€¼å’Œæ“ä½œçš„ä¾èµ–å…³ç³»ç›¸å…³ã€‚</li></ul></li><li><p>æ“ä½œåŒæ­¥</p><ul><li><code>- (void)waitUntilFinished;</code>é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è¯¥æ“ä½œç»“æŸã€‚å¯ç”¨äºçº¿ç¨‹æ‰§è¡Œé¡ºåºçš„åŒæ­¥ã€‚</li><li><code>- (void)setCompletionBlock:(void(^)(void))block;</code> <code>completionBlock</code>ä¼šåœ¨å½“å‰æ“ä½œæ‰§è¡Œå®Œæ¯•æ—¶æ‰§è¡ŒcompletionBlockã€‚</li><li><code>- (void)addDependency:(NSOperation *)op;</code>æ·»åŠ ä¾èµ–ï¼Œä½¿å½“å‰æ“ä½œä¾èµ–äºæ“ä½œopçš„å®Œæˆã€‚</li><li><code>- (void)removeDependency:(NSOperation *)op;</code>ç§»é™¤ä¾èµ–ï¼Œå–æ¶ˆå½“å‰æ“ä½œå¯¹æ“ä½œopçš„ä¾èµ–ã€‚</li><li><code>@property(readonly, copy) NSArray&lt;NSOperation *&gt; *dependencies;</code>åœ¨å½“å‰æ“ä½œå¼€å§‹æ‰§è¡Œä¹‹å‰å®Œæˆæ‰§è¡Œçš„æ‰€æœ‰æ“ä½œå¯¹è±¡æ•°ç»„ã€‚</li></ul></li></ol><h3 id="10-2-NSOperationQueueçš„å¸¸ç”¨å±æ€§å’Œæ–¹æ³•"><a href="#10-2-NSOperationQueueçš„å¸¸ç”¨å±æ€§å’Œæ–¹æ³•" class="headerlink" title="10.2 NSOperationQueueçš„å¸¸ç”¨å±æ€§å’Œæ–¹æ³•"></a>10.2 NSOperationQueueçš„å¸¸ç”¨å±æ€§å’Œæ–¹æ³•</h3><ol><li><p>å–æ¶ˆ/æš‚åœ/æ¢å¤æ“ä½œ</p><ul><li><code>- (void)cancelAllOperations;</code>å¯ä»¥å–æ¶ˆé˜Ÿåˆ—çš„æ‰€æœ‰æ“ä½œ</li><li><code>- (BOOL)isSuspended;</code>åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å¤„äºæš‚åœçŠ¶æ€ã€‚YESä¸ºæš‚åœçŠ¶æ€ï¼ŒNOä¸ºæ¢å¤çŠ¶æ€ã€‚</li><li><code>- (void)setSuspended:(BOOL)b;</code>å¯è®¾ç½®æ“ä½œçš„æš‚åœå’Œæ¢å¤ï¼ŒYESä»£è¡¨æš‚åœé˜Ÿåˆ—ï¼ŒNOä»£è¡¨æ¢å¤é˜Ÿåˆ—ã€‚</li></ul></li><li><p>æ“ä½œåŒæ­¥</p><ul><li><code>- (void)waitUntilAllOperationsAreFinished;</code>é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­çš„æ“ä½œå…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚</li></ul></li><li><p>æ·»åŠ /è·å–æ“ä½œ</p><ul><li><code>- (void)addOperationWithBlock:(void(^)(void))block;</code>å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªNSBlockOperationç±»å‹æ“ä½œå¯¹è±¡ã€‚</li><li><code>- (void)addOperations:(NSArray *)ops waitUntilFinished:(BOOL)wait;</code>å‘é˜Ÿåˆ—ä¸­æ·»åŠ æ“ä½œæ•°ç»„ï¼Œwaitæ ‡å¿—æ˜¯å¦é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æ‰€æœ‰æ“ä½œç»“æŸã€‚</li><li><code>- (NSArray *)operations;</code>å½“å‰åœ¨é˜Ÿåˆ—ä¸­çš„æ“ä½œæ•°ç»„ï¼ˆæŸä¸ªæ“ä½œæ‰§è¡Œç»“æŸåä¼šè‡ªåŠ¨ä»è¿™ä¸ªæ•°ç»„æ¸…é™¤ï¼‰ã€‚</li><li><code>- (NSUInteger)operationCount;</code>å½“å‰é˜Ÿåˆ—ä¸­çš„æ“ä½œæ•°ã€‚</li></ul></li><li><p>è·å–é˜Ÿåˆ—</p><ul><li><code>+ (id)currentQueue;</code>è·å–å½“å‰é˜Ÿåˆ—ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯åœ¨NSOperationQueueä¸Šè¿è¡Œåˆ™è¿”å›nilã€‚</li><li><code>+ (id)mainQueue;</code>è·å–ä¸»é˜Ÿåˆ—ã€‚</li></ul></li></ol><blockquote><p>æ³¨æ„ï¼š</p></blockquote><blockquote><ol><li>è¿™é‡Œçš„æš‚åœå’Œå–æ¶ˆï¼ˆåŒ…æ‹¬æ“ä½œçš„å–æ¶ˆå’Œé˜Ÿåˆ—çš„å–æ¶ˆï¼‰å¹¶ä¸ä»£è¡¨å¯ä»¥å°†å½“å‰çš„æ“ä½œç«‹å³å–æ¶ˆï¼Œè€Œæ˜¯å½“å½“å‰çš„æ“ä½œæ‰§è¡Œå®Œæ¯•ä¹‹åä¸å†æ‰§è¡Œæ–°çš„æ“ä½œã€‚</li><li>æš‚åœå’Œå–æ¶ˆçš„åŒºåˆ«å°±åœ¨äºï¼šæš‚åœæ“ä½œä¹‹åè¿˜å¯ä»¥æ¢å¤æ“ä½œï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼›è€Œå–æ¶ˆæ“ä½œä¹‹åï¼Œæ‰€æœ‰çš„æ“ä½œå°±æ¸…ç©ºäº†ï¼Œæ— æ³•å†æ¥ç€æ‰§è¡Œå‰©ä¸‹çš„æ“ä½œã€‚</li></ol></blockquote><p>æœ¬æ–‡ç³»è½¬è½½ï¼Œå¦‚æœ‰ä¾µæƒï¼Œå‘ŠçŸ¥æˆ‘åˆ é™¤ã€‚æ„Ÿè°¢åŸæ–‡:<a href="https://bujige.net/blog/iOS-Complete-learning-NSOperation.html" target="_blank" rel="noopener">iOSå¤šçº¿ç¨‹ï¼šã€NSOperationã€NSOperationQueueã€è¯¦å°½æ€»ç»“</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-72af03942adef005.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOSå¤šçº¿ç¨‹ä¹‹NSOperation.jpg&quot;&gt;&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ç”¨æ¥ä»‹ç»iOSå¤šçº¿ç¨‹ä¸­çš„NSOperationã€NSOperationQueueçš„ç›¸å…³çŸ¥è¯†åŠä½¿ç”¨æ–¹æ³•ã€‚&lt;br&gt;é€šè¿‡æœ¬æ–‡ï¼Œæ‚¨å°†äº†è§£åˆ°ï¼š&lt;br&gt;&lt;strong&gt;NSOperationã€NSOperationQueueç®€ä»‹ã€æ“ä½œå’Œæ“ä½œé˜Ÿåˆ—ã€ä½¿ç”¨æ­¥éª¤å’ŒåŸºæœ¬ä½¿ç”¨æ–¹æ³•ã€æ§åˆ¶ä¸²è¡Œ/å¹¶å‘æ‰§è¡Œã€NSOperationæ“ä½œä¾èµ–å’Œä¼˜å…ˆçº§ã€çº¿ç¨‹é—´çš„é€šä¿¡ã€çº¿ç¨‹åŒæ­¥å’Œçº¿ç¨‹å®‰å…¨ï¼Œä»¥åŠNSOperationã€NSOperationQueueå¸¸ç”¨å±æ€§å’Œæ–¹æ³•å½’çº³ã€‚&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="å¤šçº¿ç¨‹" scheme="http://yoursite.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
      <category term="NSOperationQueue" scheme="http://yoursite.com/tags/NSOperationQueue/"/>
    
  </entry>
  
  <entry>
    <title>iOSå¤šçº¿ç¨‹ä¹‹GCD</title>
    <link href="http://yoursite.com/2018/05/18/iOS%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BGCD/"/>
    <id>http://yoursite.com/2018/05/18/iOSå¤šçº¿ç¨‹ä¹‹GCD/</id>
    <published>2018-05-17T17:18:30.000Z</published>
    <updated>2019-03-25T06:46:25.799Z</updated>
    
    <content type="html"><![CDATA[<h1 id="GCD"><a href="#GCD" class="headerlink" title="GCD"></a>GCD</h1><p><img src="https://upload-images.jianshu.io/upload_images/1276164-dbe0f9c70088f039.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="iOSå¤šçº¿ç¨‹ä¹‹GCD.jpg"></p><blockquote><p>æœ¬æ–‡ç”¨æ¥ä»‹ç» iOS å¤šçº¿ç¨‹ä¸­ GCDçš„ç›¸å…³çŸ¥è¯†ä»¥åŠä½¿ç”¨æ–¹æ³•ã€‚é€šè¿‡æœ¬æ–‡ï¼Œæ‚¨å°†äº†è§£åˆ°ï¼š</p><ol><li>GCD ç®€ä»‹</li><li>GCD ä»»åŠ¡å’Œé˜Ÿåˆ—</li><li>GCD çš„ä½¿ç”¨æ­¥éª¤</li><li>GCD çš„åŸºæœ¬ä½¿ç”¨ï¼ˆ6ç§ä¸åŒç»„åˆåŒºåˆ«ï¼‰</li><li>GCD çº¿ç¨‹é—´çš„é€šä¿¡</li><li>GCD çš„å…¶ä»–æ–¹æ³•ï¼ˆæ …æ æ–¹æ³•ï¼šdispatch_barrier_asyncã€å»¶æ—¶æ‰§è¡Œæ–¹æ³•ï¼šdispatch_afterã€ä¸€æ¬¡æ€§ä»£ç ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰ï¼šdispatch_onceã€å¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch_applyã€é˜Ÿåˆ—ç»„ï¼šdispatch_groupã€ä¿¡å·é‡ï¼šdispatch_semaphore</li></ol></blockquote><a id="more"></a><h2 id="1-GCDç®€ä»‹"><a href="#1-GCDç®€ä»‹" class="headerlink" title="1. GCDç®€ä»‹"></a>1. GCDç®€ä»‹</h2><p>ä»€ä¹ˆæ˜¯ GCD å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç™¾åº¦ç™¾ç§‘çš„è§£é‡Šç®€å•äº†è§£ä¸‹æ¦‚å¿µ</p><blockquote><p>å¼•è‡ªç™¾åº¦ç™¾ç§‘<br>Grand Central Dispatch(GCD) æ˜¯ Apple å¼€å‘çš„ä¸€ä¸ªå¤šæ ¸ç¼–ç¨‹çš„è¾ƒæ–°çš„è§£å†³æ–¹æ³•ã€‚å®ƒä¸»è¦ç”¨äºä¼˜åŒ–åº”ç”¨ç¨‹åºä»¥æ”¯æŒå¤šæ ¸å¤„ç†å™¨ä»¥åŠå…¶ä»–å¯¹ç§°å¤šå¤„ç†ç³»ç»Ÿã€‚å®ƒæ˜¯ä¸€ä¸ªåœ¨çº¿ç¨‹æ± æ¨¡å¼çš„åŸºç¡€ä¸Šæ‰§è¡Œçš„å¹¶å‘ä»»åŠ¡ã€‚åœ¨ Mac OS X 10.6 é›ªè±¹ä¸­é¦–æ¬¡æ¨å‡ºï¼Œä¹Ÿå¯åœ¨ iOS 4 åŠä»¥ä¸Šç‰ˆæœ¬ä½¿ç”¨ã€‚</p></blockquote><p><strong>ä¸ºä»€ä¹ˆè¦ç”¨ GCD å‘¢ï¼Ÿ</strong></p><p>å› ä¸º GCD æœ‰å¾ˆå¤šå¥½å¤„å•Šï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><ul><li>GCD å¯ç”¨äºå¤šæ ¸çš„å¹¶è¡Œè¿ç®—</li><li>GCD ä¼šè‡ªåŠ¨åˆ©ç”¨æ›´å¤šçš„ CPU å†…æ ¸ï¼ˆæ¯”å¦‚åŒæ ¸ã€å››æ ¸ï¼‰</li><li>GCD ä¼šè‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºçº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€é”€æ¯çº¿ç¨‹ï¼‰</li><li>ç¨‹åºå‘˜åªéœ€è¦å‘Šè¯‰ GCD æƒ³è¦æ‰§è¡Œä»€ä¹ˆä»»åŠ¡ï¼Œä¸éœ€è¦ç¼–å†™ä»»ä½•çº¿ç¨‹ç®¡ç†ä»£ç </li><li>æ—¢ç„¶ GCD æœ‰è¿™ä¹ˆå¤šçš„å¥½å¤„ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥ç³»ç»Ÿçš„å­¦ä¹ ä¸€ä¸‹ GCD çš„ä½¿ç”¨æ–¹æ³•ã€‚</li></ul><h2 id="2-GCDä»»åŠ¡å’Œé˜Ÿåˆ—"><a href="#2-GCDä»»åŠ¡å’Œé˜Ÿåˆ—" class="headerlink" title="2. GCDä»»åŠ¡å’Œé˜Ÿåˆ—"></a>2. GCDä»»åŠ¡å’Œé˜Ÿåˆ—</h2><p>å­¦ä¹  GCD ä¹‹å‰ï¼Œå…ˆæ¥äº†è§£ GCD ä¸­ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š<strong>ä»»åŠ¡</strong>å’Œ<strong>é˜Ÿåˆ—</strong>ã€‚</p><p><strong>ä»»åŠ¡</strong>ï¼šå°±æ˜¯æ‰§è¡Œæ“ä½œçš„æ„æ€ï¼Œæ¢å¥è¯è¯´å°±æ˜¯ä½ åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œçš„é‚£æ®µä»£ç ã€‚åœ¨ GCD ä¸­æ˜¯æ”¾åœ¨ block ä¸­çš„ã€‚æ‰§è¡Œä»»åŠ¡æœ‰ä¸¤ç§æ–¹å¼ï¼š<strong>åŒæ­¥æ‰§è¡Œï¼ˆsyncï¼‰</strong>å’Œ<strong>å¼‚æ­¥æ‰§è¡Œï¼ˆasyncï¼‰</strong>ã€‚ä¸¤è€…çš„ä¸»è¦åŒºåˆ«æ˜¯ï¼š<strong>æ˜¯å¦ç­‰å¾…é˜Ÿåˆ—çš„ä»»åŠ¡æ‰§è¡Œç»“æŸï¼Œä»¥åŠæ˜¯å¦å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›</strong>ã€‚</p><ul><li><strong>åŒæ­¥æ‰§è¡Œï¼ˆsyncï¼‰</strong>ï¼š<ul><li>åŒæ­¥æ·»åŠ ä»»åŠ¡åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­ï¼Œåœ¨æ·»åŠ çš„ä»»åŠ¡æ‰§è¡Œç»“æŸä¹‹å‰ï¼Œä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°é˜Ÿåˆ—é‡Œé¢çš„ä»»åŠ¡å®Œæˆä¹‹åå†ç»§ç»­æ‰§è¡Œã€‚</li><li>åªèƒ½åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚</li></ul></li><li><strong>å¼‚æ­¥æ‰§è¡Œï¼ˆasyncï¼‰</strong>ï¼š<ul><li>å¼‚æ­¥æ·»åŠ ä»»åŠ¡åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­ï¼Œå®ƒä¸ä¼šåšä»»ä½•ç­‰å¾…ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä»»åŠ¡ã€‚</li><li>å¯ä»¥åœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚</li></ul></li></ul><p>ä¸¾ä¸ªç®€å•ä¾‹å­ï¼šä½ è¦æ‰“ç”µè¯ç»™å°æ˜å’Œå°ç™½ã€‚<br>åŒæ­¥æ‰§è¡Œå°±æ˜¯ï¼Œä½ æ‰“ç”µè¯ç»™å°æ˜çš„æ—¶å€™ï¼Œä¸èƒ½åŒæ—¶æ‰“ç»™å°ç™½ï¼Œç­‰åˆ°ç»™å°æ˜æ‰“å®Œäº†ï¼Œæ‰èƒ½æ‰“ç»™å°ç™½ï¼ˆç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æŸï¼‰ã€‚è€Œä¸”åªèƒ½ç”¨å½“å‰çš„ç”µè¯ï¼ˆä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼‰ã€‚<br>è€Œå¼‚æ­¥æ‰§è¡Œå°±æ˜¯ï¼Œä½ æ‰“ç”µè¯ç»™å°æ˜çš„æ—¶å€™ï¼Œä¸ç­‰å’Œå°æ˜é€šè¯ç»“æŸï¼Œè¿˜èƒ½ç›´æ¥ç»™å°ç™½æ‰“ç”µè¯ï¼Œä¸ç”¨ç­‰ç€å’Œå°æ˜é€šè¯ç»“æŸå†æ‰“ï¼ˆä¸ç”¨ç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æŸï¼‰ã€‚é™¤äº†å½“å‰ç”µè¯ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–æ‰€èƒ½ä½¿ç”¨çš„ç”µè¯ï¼ˆå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼‰ã€‚</p><blockquote><p>æ³¨æ„ï¼šå¼‚æ­¥æ‰§è¡Œï¼ˆasyncï¼‰è™½ç„¶å…·æœ‰å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä½†æ˜¯å¹¶ä¸ä¸€å®šå¼€å¯æ–°çº¿ç¨‹ã€‚è¿™è·Ÿä»»åŠ¡æ‰€æŒ‡å®šçš„é˜Ÿåˆ—ç±»å‹æœ‰å…³ï¼ˆä¸‹é¢ä¼šè®²ï¼‰ã€‚</p></blockquote><p><strong>é˜Ÿåˆ—ï¼ˆDispatch Queueï¼‰</strong>ï¼šè¿™é‡Œçš„é˜Ÿåˆ—æŒ‡æ‰§è¡Œä»»åŠ¡çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œå³ç”¨æ¥å­˜æ”¾ä»»åŠ¡çš„é˜Ÿåˆ—ã€‚é˜Ÿåˆ—æ˜¯ä¸€ç§ç‰¹æ®Šçš„çº¿æ€§è¡¨ï¼Œé‡‡ç”¨ FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰çš„åŸåˆ™ï¼Œå³æ–°ä»»åŠ¡æ€»æ˜¯è¢«æ’å…¥åˆ°é˜Ÿåˆ—çš„æœ«å°¾ï¼Œè€Œè¯»å–ä»»åŠ¡çš„æ—¶å€™æ€»æ˜¯ä»é˜Ÿåˆ—çš„å¤´éƒ¨å¼€å§‹è¯»å–ã€‚æ¯è¯»å–ä¸€ä¸ªä»»åŠ¡ï¼Œåˆ™ä»é˜Ÿåˆ—ä¸­é‡Šæ”¾ä¸€ä¸ªä»»åŠ¡ã€‚é˜Ÿåˆ—çš„ç»“æ„å¯å‚è€ƒä¸‹å›¾ï¼š<br><img src="https://ysc-demo-1254961422.file.myqcloud.com/YSC-GCD-demo-DispatchQueue.png" alt="image"><br>åœ¨ GCD ä¸­æœ‰ä¸¤ç§é˜Ÿåˆ—ï¼š<strong>ä¸²è¡Œé˜Ÿåˆ—å’Œå¹¶å‘é˜Ÿåˆ—</strong>ã€‚ä¸¤è€…éƒ½ç¬¦åˆ FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰çš„åŸåˆ™ã€‚ä¸¤è€…çš„ä¸»è¦åŒºåˆ«æ˜¯ï¼š<strong>æ‰§è¡Œé¡ºåºä¸åŒï¼Œä»¥åŠå¼€å¯çº¿ç¨‹æ•°ä¸åŒ</strong>ã€‚</p><ul><li><strong>ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial Dispatch Queueï¼‰</strong>ï¼š<ul><li>æ¯æ¬¡åªæœ‰ä¸€ä¸ªä»»åŠ¡è¢«æ‰§è¡Œã€‚è®©ä»»åŠ¡ä¸€ä¸ªæ¥ç€ä¸€ä¸ªåœ°æ‰§è¡Œã€‚ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</li><li>åªå¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹ï¼ˆæˆ–è€…ä¸å¼€å¯æ–°çº¿ç¨‹ï¼Œåœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼‰ã€‚</li></ul></li><li><strong>å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent Dispatch Queueï¼‰</strong>ï¼š<ul><li>å¯ä»¥è®©å¤šä¸ªä»»åŠ¡å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œã€‚</li><li>å¯ä»¥å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”åŒæ—¶æ‰§è¡Œä»»åŠ¡ã€‚<blockquote><p>æ³¨æ„ï¼šå¹¶å‘é˜Ÿåˆ—çš„å¹¶å‘åŠŸèƒ½åªæœ‰åœ¨å¼‚æ­¥ï¼ˆdispatch_asyncï¼‰å‡½æ•°ä¸‹æ‰æœ‰æ•ˆã€‚</p></blockquote></li></ul></li></ul><p>ä¸¤è€…å…·ä½“åŒºåˆ«å¦‚ä¸‹ä¸¤å›¾æ‰€ç¤ºã€‚<br><img src="https://ysc-demo-1254961422.file.myqcloud.com/YSC-GCD-demo-SerialDispatchQueue.png" alt="image"><br><img src="https://ysc-demo-1254961422.file.myqcloud.com/YSC-GCD-demo-ConcurrentDispatchQueue.png" alt="image"></p><h2 id="3-GCDçš„ä½¿ç”¨æ­¥éª¤"><a href="#3-GCDçš„ä½¿ç”¨æ­¥éª¤" class="headerlink" title="3. GCDçš„ä½¿ç”¨æ­¥éª¤"></a>3. GCDçš„ä½¿ç”¨æ­¥éª¤</h2><p>GCD çš„ä½¿ç”¨æ­¥éª¤å…¶å®å¾ˆç®€å•ï¼Œåªæœ‰ä¸¤æ­¥ã€‚</p><blockquote><ol><li>åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼ˆä¸²è¡Œé˜Ÿåˆ—æˆ–å¹¶å‘é˜Ÿåˆ—ï¼‰</li><li>å°†ä»»åŠ¡è¿½åŠ åˆ°ä»»åŠ¡çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç„¶åç³»ç»Ÿå°±ä¼šæ ¹æ®ä»»åŠ¡ç±»å‹æ‰§è¡Œä»»åŠ¡ï¼ˆåŒæ­¥æ‰§è¡Œæˆ–å¼‚æ­¥æ‰§è¡Œï¼‰</li></ol></blockquote><p>ä¸‹è¾¹æ¥çœ‹çœ‹é˜Ÿåˆ—çš„åˆ›å»ºæ–¹æ³•/è·å–æ–¹æ³•ï¼Œä»¥åŠä»»åŠ¡çš„åˆ›å»ºæ–¹æ³•ã€‚</p><h3 id="3-1-é˜Ÿåˆ—çš„åˆ›å»ºæ–¹æ³•-è·å–æ–¹æ³•"><a href="#3-1-é˜Ÿåˆ—çš„åˆ›å»ºæ–¹æ³•-è·å–æ–¹æ³•" class="headerlink" title="3.1 é˜Ÿåˆ—çš„åˆ›å»ºæ–¹æ³•/è·å–æ–¹æ³•"></a>3.1 é˜Ÿåˆ—çš„åˆ›å»ºæ–¹æ³•/è·å–æ–¹æ³•</h3><p>å¯ä»¥ä½¿ç”¨<code>dispatch_queue_create</code>æ¥åˆ›å»ºé˜Ÿåˆ—ï¼Œéœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºé˜Ÿåˆ—çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äº DEBUGï¼Œå¯ä¸ºç©ºï¼ŒDispatch Queue çš„åç§°æ¨èä½¿ç”¨åº”ç”¨ç¨‹åº ID è¿™ç§é€†åºå…¨ç¨‹åŸŸåï¼›ç¬¬äºŒä¸ªå‚æ•°ç”¨æ¥è¯†åˆ«æ˜¯ä¸²è¡Œé˜Ÿåˆ—è¿˜æ˜¯å¹¶å‘é˜Ÿåˆ—ã€‚<code>DISPATCH_QUEUE_SERIAL</code> è¡¨ç¤ºä¸²è¡Œé˜Ÿåˆ—ï¼Œ<code>DISPATCH_QUEUE_CONCURRENT</code> è¡¨ç¤ºå¹¶å‘é˜Ÿåˆ—ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸²è¡Œé˜Ÿåˆ—çš„åˆ›å»ºæ–¹æ³•</span></span><br><span class="line"><span class="keyword">dispatch_queue_t</span> <span class="built_in">queue</span> = dispatch_queue_create(<span class="string">"net.bujige.testQueue"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="comment">// å¹¶å‘é˜Ÿåˆ—çš„åˆ›å»ºæ–¹æ³•</span></span><br><span class="line"><span class="keyword">dispatch_queue_t</span> <span class="built_in">queue</span> = dispatch_queue_create(<span class="string">"net.bujige.testQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br></pre></td></tr></table></figure><ul><li>å¯¹äºä¸²è¡Œé˜Ÿåˆ—ï¼ŒGCD æä¾›äº†çš„ä¸€ç§ç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—ï¼š<strong>ä¸»é˜Ÿåˆ—ï¼ˆMain Dispatch Queueï¼‰</strong>ã€‚<ul><li>æ‰€æœ‰æ”¾åœ¨ä¸»é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œéƒ½ä¼šæ”¾åˆ°ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚</li><li>å¯ä½¿ç”¨<code>dispatch_get_main_queue()</code>è·å¾—ä¸»é˜Ÿåˆ—ã€‚</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸»é˜Ÿåˆ—çš„è·å–æ–¹æ³•</span></span><br><span class="line"><span class="keyword">dispatch_queue_t</span> <span class="built_in">queue</span> = dispatch_get_main_queue();</span><br></pre></td></tr></table></figure><ul><li>å¯¹äºå¹¶å‘é˜Ÿåˆ—ï¼ŒGCD é»˜è®¤æä¾›äº†å…¨å±€å¹¶å‘é˜Ÿåˆ—ï¼ˆGlobal Dispatch Queueï¼‰ã€‚<ul><li>å¯ä»¥ä½¿ç”¨dispatch_get_global_queueæ¥è·å–ã€‚éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºé˜Ÿåˆ—ä¼˜å…ˆçº§ï¼Œä¸€èˆ¬ç”¨DISPATCH_QUEUE_PRIORITY_DEFAULTã€‚ç¬¬äºŒä¸ªå‚æ•°æš‚æ—¶æ²¡ç”¨ï¼Œç”¨0å³å¯ã€‚</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¨å±€å¹¶å‘é˜Ÿåˆ—çš„è·å–æ–¹æ³•</span></span><br><span class="line"><span class="keyword">dispatch_queue_t</span> <span class="built_in">queue</span> = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><h3 id="3-2-ä»»åŠ¡çš„åˆ›å»ºæ–¹æ³•"><a href="#3-2-ä»»åŠ¡çš„åˆ›å»ºæ–¹æ³•" class="headerlink" title="3.2 ä»»åŠ¡çš„åˆ›å»ºæ–¹æ³•"></a>3.2 ä»»åŠ¡çš„åˆ›å»ºæ–¹æ³•</h3><p>GCD æä¾›äº†åŒæ­¥æ‰§è¡Œä»»åŠ¡çš„åˆ›å»ºæ–¹æ³•<code>dispatch_sync</code>å’Œå¼‚æ­¥æ‰§è¡Œä»»åŠ¡åˆ›å»ºæ–¹æ³•<code>dispatch_async</code>ã€‚</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒæ­¥æ‰§è¡Œä»»åŠ¡åˆ›å»ºæ–¹æ³•</span></span><br><span class="line"><span class="selector-tag">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ”¾åŒæ­¥æ‰§è¡Œä»»åŠ¡ä»£ç </span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// å¼‚æ­¥æ‰§è¡Œä»»åŠ¡åˆ›å»ºæ–¹æ³•</span></span><br><span class="line"><span class="selector-tag">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ”¾å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ä»£ç </span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è™½ç„¶ä½¿ç”¨ GCD åªéœ€ä¸¤æ­¥ï¼Œä½†æ˜¯æ—¢ç„¶æˆ‘ä»¬æœ‰ä¸¤ç§é˜Ÿåˆ—ï¼ˆä¸²è¡Œé˜Ÿåˆ—/å¹¶å‘é˜Ÿåˆ—ï¼‰ï¼Œä¸¤ç§ä»»åŠ¡æ‰§è¡Œæ–¹å¼ï¼ˆåŒæ­¥æ‰§è¡Œ/å¼‚æ­¥æ‰§è¡Œï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æœ‰äº†å››ç§ä¸åŒçš„ç»„åˆæ–¹å¼ã€‚è¿™å››ç§ä¸åŒçš„ç»„åˆæ–¹å¼æ˜¯ï¼š</p><blockquote><ol><li>åŒæ­¥æ‰§è¡Œ + å¹¶å‘é˜Ÿåˆ—</li><li>å¼‚æ­¥æ‰§è¡Œ + å¹¶å‘é˜Ÿåˆ—</li><li>åŒæ­¥æ‰§è¡Œ + ä¸²è¡Œé˜Ÿåˆ—</li><li>å¼‚æ­¥æ‰§è¡Œ + ä¸²è¡Œé˜Ÿåˆ—</li></ol></blockquote><p>å®é™…ä¸Šï¼Œåˆšæ‰è¿˜è¯´äº†ä¸¤ç§ç‰¹æ®Šé˜Ÿåˆ—ï¼š<strong>å…¨å±€å¹¶å‘é˜Ÿåˆ—ã€ä¸»é˜Ÿåˆ—</strong>ã€‚å…¨å±€å¹¶å‘é˜Ÿåˆ—å¯ä»¥ä½œä¸ºæ™®é€šå¹¶å‘é˜Ÿåˆ—æ¥ä½¿ç”¨ã€‚ä½†æ˜¯ä¸»é˜Ÿåˆ—å› ä¸ºæœ‰ç‚¹ç‰¹æ®Šï¼Œæ‰€ä»¥æˆ‘ä»¬å°±åˆå¤šäº†ä¸¤ç§ç»„åˆæ–¹å¼ã€‚è¿™æ ·å°±æœ‰å…­ç§ä¸åŒçš„ç»„åˆæ–¹å¼äº†ã€‚</p><blockquote><ol><li>åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</li><li>å¼‚æ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</li></ol></blockquote><p>é‚£ä¹ˆè¿™å‡ ç§ä¸åŒç»„åˆæ–¹å¼å„æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œå…ˆä¸Šç»“æœï¼Œå†æ¥è®²è§£ã€‚</p><table><thead><tr><th>åŒºåˆ«</th><th>å¹¶å‘é˜Ÿåˆ—</th><th>ä¸²è¡Œé˜Ÿåˆ—</th><th>ä¸»é˜Ÿåˆ—</th></tr></thead><tbody><tr><td>åŒæ­¥(sync)</td><td>æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td><td>æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td><td>ä¸»çº¿ç¨‹è°ƒç”¨ï¼šæ­»é”å¡ä½ä¸æ‰§è¡Œ å…¶ä»–çº¿ç¨‹è°ƒç”¨ï¼šæ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td></tr><tr><td>å¼‚æ­¥(async)</td><td>æœ‰å¼€å¯æ–°çº¿ç¨‹ï¼Œå¹¶å‘æ‰§è¡Œä»»åŠ¡</td><td>æœ‰å¼€å¯æ–°çº¿ç¨‹(1æ¡)ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td><td>æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td></tr></tbody></table><h2 id="4-GCDçš„åŸºæœ¬ä½¿ç”¨"><a href="#4-GCDçš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="4. GCDçš„åŸºæœ¬ä½¿ç”¨"></a>4. GCDçš„åŸºæœ¬ä½¿ç”¨</h2><p>å…ˆæ¥è®²è®²å¹¶å‘é˜Ÿåˆ—çš„ä¸¤ç§æ‰§è¡Œæ–¹å¼ã€‚</p><h3 id="4-1-åŒæ­¥æ‰§è¡Œ-å¹¶å‘é˜Ÿåˆ—"><a href="#4-1-åŒæ­¥æ‰§è¡Œ-å¹¶å‘é˜Ÿåˆ—" class="headerlink" title="4.1 åŒæ­¥æ‰§è¡Œ + å¹¶å‘é˜Ÿåˆ—"></a>4.1 åŒæ­¥æ‰§è¡Œ + å¹¶å‘é˜Ÿåˆ—</h3><ul><li>åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŒæ­¥æ‰§è¡Œ + å¹¶å‘é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * ç‰¹ç‚¹ï¼šåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)syncConcurrent &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"syncConcurrent---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"net.bujige.testQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡2</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡3</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"syncConcurrent---end"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">34</span>:<span class="number">55.095932</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19892</span>:<span class="number">4996930</span>] currentThreadâ€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">34</span>:<span class="number">55.096086</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19892</span>:<span class="number">4996930</span>] syncConcurrentâ€”begin</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">34</span>:<span class="number">57.097589</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19892</span>:<span class="number">4996930</span>] <span class="number">1</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">34:59.099100</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19892</span>:<span class="number">4996930</span>] <span class="number">1</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">35</span>:<span class="number">01.099843</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19892</span>:<span class="number">4996930</span>] <span class="number">2</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">35:03.101171</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19892</span>:<span class="number">4996930</span>] <span class="number">2</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">35:05.101750</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19892</span>:<span class="number">4996930</span>] <span class="number">3</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">35:07.102414</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19892</span>:<span class="number">4996930</span>] <span class="number">3</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">35:07.102575</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19892</span>:<span class="number">4996930</span>] syncConcurrentâ€”end</span><br></pre></td></tr></table></figure><p>ä»åŒæ­¥æ‰§è¡Œ + å¹¶å‘é˜Ÿåˆ—ä¸­å¯çœ‹åˆ°ï¼š</p><ul><li>æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯åœ¨å½“å‰çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œçš„ï¼Œæ²¡æœ‰å¼€å¯æ–°çš„çº¿ç¨‹ï¼ˆåŒæ­¥æ‰§è¡Œä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼‰ã€‚</li><li>æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨æ‰“å°çš„syncConcurrentâ€”beginå’ŒsyncConcurrentâ€”endä¹‹é—´æ‰§è¡Œçš„ï¼ˆåŒæ­¥ä»»åŠ¡éœ€è¦ç­‰å¾…é˜Ÿåˆ—çš„ä»»åŠ¡æ‰§è¡Œç»“æŸï¼‰ã€‚</li><li>ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œçš„ã€‚æŒ‰é¡ºåºæ‰§è¡Œçš„åŸå› ï¼šè™½ç„¶å¹¶å‘é˜Ÿåˆ—å¯ä»¥å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚ä½†æ˜¯å› ä¸ºæœ¬èº«ä¸èƒ½åˆ›å»ºæ–°çº¿ç¨‹ï¼Œåªæœ‰å½“å‰çº¿ç¨‹è¿™ä¸€ä¸ªçº¿ç¨‹ï¼ˆåŒæ­¥ä»»åŠ¡ä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼‰ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸å­˜åœ¨å¹¶å‘ã€‚è€Œä¸”å½“å‰çº¿ç¨‹åªæœ‰ç­‰å¾…å½“å‰é˜Ÿåˆ—ä¸­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œæ‰èƒ½ç»§ç»­æ¥ç€æ‰§è¡Œä¸‹é¢çš„æ“ä½œï¼ˆåŒæ­¥ä»»åŠ¡éœ€è¦ç­‰å¾…é˜Ÿåˆ—çš„ä»»åŠ¡æ‰§è¡Œç»“æŸï¼‰ã€‚æ‰€ä»¥ä»»åŠ¡åªèƒ½ä¸€ä¸ªæ¥ä¸€ä¸ªæŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸èƒ½åŒæ—¶è¢«æ‰§è¡Œã€‚</li></ul><h3 id="4-2-å¼‚æ­¥æ‰§è¡Œ-å¹¶å‘é˜Ÿåˆ—"><a href="#4-2-å¼‚æ­¥æ‰§è¡Œ-å¹¶å‘é˜Ÿåˆ—" class="headerlink" title="4.2 å¼‚æ­¥æ‰§è¡Œ + å¹¶å‘é˜Ÿåˆ—"></a>4.2 å¼‚æ­¥æ‰§è¡Œ + å¹¶å‘é˜Ÿåˆ—</h3><ul><li>å¯ä»¥å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œä»»åŠ¡äº¤æ›¿ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œ</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¼‚æ­¥æ‰§è¡Œ + å¹¶å‘é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * ç‰¹ç‚¹ï¼šå¯ä»¥å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œä»»åŠ¡äº¤æ›¿ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)asyncConcurrent &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"asyncConcurrent---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"net.bujige.testQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡2</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡3</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"asyncConcurrent---end"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">36</span>:<span class="number">41.769269</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19929</span>:<span class="number">5005237</span>] currentThreadâ€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">36</span>:<span class="number">41.769496</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19929</span>:<span class="number">5005237</span>] asyncConcurrentâ€”begin</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">36</span>:<span class="number">41.769725</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19929</span>:<span class="number">5005237</span>] asyncConcurrentâ€”end</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">36</span>:<span class="number">43.774442</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19929</span>:<span class="number">5005566</span>] <span class="number">2</span>â€”&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">36</span>:<span class="number">43.774440</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19929</span>:<span class="number">5005567</span>] <span class="number">3</span>â€”&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">36</span>:<span class="number">43.774440</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19929</span>:<span class="number">5005565</span>] <span class="number">1</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">36</span>:<span class="number">45.779286</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19929</span>:<span class="number">5005567</span>] <span class="number">3</span>â€”&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">36</span>:<span class="number">45.779302</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19929</span>:<span class="number">5005565</span>] <span class="number">1</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">36</span>:<span class="number">45.779286</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19929</span>:<span class="number">5005566</span>] <span class="number">2</span>â€”&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¼‚æ­¥æ‰§è¡Œ + å¹¶å‘é˜Ÿåˆ—ä¸­å¯ä»¥çœ‹å‡ºï¼š</p><ul><li>é™¤äº†å½“å‰çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œç³»ç»Ÿåˆå¼€å¯äº†3ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”ä»»åŠ¡æ˜¯äº¤æ›¿/åŒæ—¶æ‰§è¡Œçš„ã€‚ï¼ˆå¼‚æ­¥æ‰§è¡Œå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚ä¸”å¹¶å‘é˜Ÿåˆ—å¯å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼‰ã€‚</li><li>æ‰€æœ‰ä»»åŠ¡æ˜¯åœ¨æ‰“å°çš„syncConcurrentâ€”beginå’ŒsyncConcurrentâ€”endä¹‹åæ‰æ‰§è¡Œçš„ã€‚è¯´æ˜å½“å‰çº¿ç¨‹æ²¡æœ‰ç­‰å¾…ï¼Œè€Œæ˜¯ç›´æ¥å¼€å¯äº†æ–°çº¿ç¨‹ï¼Œåœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼ˆå¼‚æ­¥æ‰§è¡Œä¸åšç­‰å¾…ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼‰ã€‚</li></ul><p><strong>æ¥ä¸‹æ¥å†æ¥è®²è®²ä¸²è¡Œé˜Ÿåˆ—çš„ä¸¤ç§æ‰§è¡Œæ–¹å¼</strong>ã€‚</p><h3 id="4-3-åŒæ­¥æ‰§è¡Œ-ä¸²è¡Œé˜Ÿåˆ—"><a href="#4-3-åŒæ­¥æ‰§è¡Œ-ä¸²è¡Œé˜Ÿåˆ—" class="headerlink" title="4.3 åŒæ­¥æ‰§è¡Œ + ä¸²è¡Œé˜Ÿåˆ—"></a>4.3 åŒæ­¥æ‰§è¡Œ + ä¸²è¡Œé˜Ÿåˆ—</h3><ul><li>ä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œåœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚ä»»åŠ¡æ˜¯ä¸²è¡Œçš„ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŒæ­¥æ‰§è¡Œ + ä¸²è¡Œé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * ç‰¹ç‚¹ï¼šä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œåœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚ä»»åŠ¡æ˜¯ä¸²è¡Œçš„ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)syncSerial &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"syncSerial---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"net.bujige.testQueue"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡2</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡3</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"syncSerial---end"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºç»“æœä¸ºï¼š</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">39</span>:<span class="number">37.876811</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19975</span>:<span class="number">5017162</span>] currentThreadâ€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">39</span>:<span class="number">37.876998</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19975</span>:<span class="number">5017162</span>] syncSerialâ€”begin</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">39</span>:<span class="number">39.878316</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19975</span>:<span class="number">5017162</span>] <span class="number">1</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">39</span>:<span class="number">41.879829</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19975</span>:<span class="number">5017162</span>] <span class="number">1</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">39</span>:<span class="number">43.880660</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19975</span>:<span class="number">5017162</span>] <span class="number">2</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">39</span>:<span class="number">45.881265</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19975</span>:<span class="number">5017162</span>] <span class="number">2</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">39</span>:<span class="number">47.882257</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19975</span>:<span class="number">5017162</span>] <span class="number">3</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">39</span>:<span class="number">49.883008</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19975</span>:<span class="number">5017162</span>] <span class="number">3</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">39:49.883253</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">19975</span>:<span class="number">5017162</span>] syncSerialâ€”end</span><br></pre></td></tr></table></figure><p>åœ¨åŒæ­¥æ‰§è¡Œ + ä¸²è¡Œé˜Ÿåˆ—å¯ä»¥çœ‹åˆ°ï¼š</p><ul><li>æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯åœ¨å½“å‰çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œçš„ï¼Œå¹¶æ²¡æœ‰å¼€å¯æ–°çš„çº¿ç¨‹ï¼ˆåŒæ­¥æ‰§è¡Œä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼‰ã€‚</li><li>æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨æ‰“å°çš„syncConcurrentâ€”beginå’ŒsyncConcurrentâ€”endä¹‹é—´æ‰§è¡Œï¼ˆåŒæ­¥ä»»åŠ¡éœ€è¦ç­‰å¾…é˜Ÿåˆ—çš„ä»»åŠ¡æ‰§è¡Œç»“æŸï¼‰ã€‚</li><li>ä»»åŠ¡æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼ˆä¸²è¡Œé˜Ÿåˆ—æ¯æ¬¡åªæœ‰ä¸€ä¸ªä»»åŠ¡è¢«æ‰§è¡Œï¼Œä»»åŠ¡ä¸€ä¸ªæ¥ä¸€ä¸ªæŒ‰é¡ºåºæ‰§è¡Œï¼‰ã€‚</li></ul><h3 id="4-4-å¼‚æ­¥æ‰§è¡Œ-ä¸²è¡Œé˜Ÿåˆ—"><a href="#4-4-å¼‚æ­¥æ‰§è¡Œ-ä¸²è¡Œé˜Ÿåˆ—" class="headerlink" title="4.4 å¼‚æ­¥æ‰§è¡Œ + ä¸²è¡Œé˜Ÿåˆ—"></a>4.4 å¼‚æ­¥æ‰§è¡Œ + ä¸²è¡Œé˜Ÿåˆ—</h3><ul><li>ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œä½†æ˜¯å› ä¸ºä»»åŠ¡æ˜¯ä¸²è¡Œçš„ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¼‚æ­¥æ‰§è¡Œ + ä¸²è¡Œé˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * ç‰¹ç‚¹ï¼šä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œä½†æ˜¯å› ä¸ºä»»åŠ¡æ˜¯ä¸²è¡Œçš„ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)asyncSerial &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"asyncSerial---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"net.bujige.testQueue"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡2</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡3</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"asyncSerial---end"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºç»“æœä¸ºï¼š</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">41</span>:<span class="number">17.029999</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20008</span>:<span class="number">5024757</span>] currentThreadâ€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">41:17.030212</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20008</span>:<span class="number">5024757</span>] asyncSerialâ€”begin</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">41</span>:<span class="number">17.030364</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20008</span>:<span class="number">5024757</span>] asyncSerialâ€”end</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">41</span>:<span class="number">19.035379</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20008</span>:<span class="number">5024950</span>] <span class="number">1</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">41:21.037140</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20008</span>:<span class="number">5024950</span>] <span class="number">1</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">41:23.042220</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20008</span>:<span class="number">5024950</span>] <span class="number">2</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">41</span>:<span class="number">25.042971</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20008</span>:<span class="number">5024950</span>] <span class="number">2</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">41</span>:<span class="number">27.047690</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20008</span>:<span class="number">5024950</span>] <span class="number">3</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">41</span>:<span class="number">29.052327</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20008</span>:<span class="number">5024950</span>] <span class="number">3</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¼‚æ­¥æ‰§è¡Œ + ä¸²è¡Œé˜Ÿåˆ—å¯ä»¥çœ‹åˆ°ï¼š</p><ul><li>å¼€å¯äº†ä¸€æ¡æ–°çº¿ç¨‹ï¼ˆå¼‚æ­¥æ‰§è¡Œå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä¸²è¡Œé˜Ÿåˆ—åªå¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼‰ã€‚</li><li>æ‰€æœ‰ä»»åŠ¡æ˜¯åœ¨æ‰“å°çš„syncConcurrentâ€”beginå’ŒsyncConcurrentâ€”endä¹‹åæ‰å¼€å§‹æ‰§è¡Œçš„ï¼ˆå¼‚æ­¥æ‰§è¡Œä¸ä¼šåšä»»ä½•ç­‰å¾…ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼‰ã€‚</li><li>ä»»åŠ¡æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼ˆä¸²è¡Œé˜Ÿåˆ—æ¯æ¬¡åªæœ‰ä¸€ä¸ªä»»åŠ¡è¢«æ‰§è¡Œï¼Œä»»åŠ¡ä¸€ä¸ªæ¥ä¸€ä¸ªæŒ‰é¡ºåºæ‰§è¡Œï¼‰ã€‚</li></ul><p>ä¸‹è¾¹è®²è®²åˆšæ‰æˆ‘ä»¬æåˆ°è¿‡çš„ç‰¹æ®Šé˜Ÿåˆ—ï¼š<strong>ä¸»é˜Ÿåˆ—</strong>ã€‚</p><ul><li>ä¸»é˜Ÿåˆ—ï¼šGCDè‡ªå¸¦çš„ä¸€ç§ç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—<ul><li>æ‰€æœ‰æ”¾åœ¨ä¸»é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œéƒ½ä¼šæ”¾åˆ°ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ</li><li>å¯ä½¿ç”¨dispatch_get_main_queue()è·å¾—ä¸»é˜Ÿåˆ—</li></ul></li></ul><p><strong>æˆ‘ä»¬å†æ¥çœ‹çœ‹ä¸»é˜Ÿåˆ—çš„ä¸¤ç§ç»„åˆæ–¹å¼ã€‚</strong></p><h3 id="4-5-åŒæ­¥æ‰§è¡Œ-ä¸»é˜Ÿåˆ—"><a href="#4-5-åŒæ­¥æ‰§è¡Œ-ä¸»é˜Ÿåˆ—" class="headerlink" title="4.5 åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—"></a>4.5 åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</h3><ul><li>åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—åœ¨ä¸åŒçº¿ç¨‹ä¸­è°ƒç”¨ç»“æœä¹Ÿæ˜¯ä¸ä¸€æ ·ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ä¼šå‡ºç°æ­»é”ï¼Œè€Œåœ¨å…¶ä»–çº¿ç¨‹ä¸­åˆ™ä¸ä¼šã€‚</li></ul><h4 id="4-5-1-åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨åŒæ­¥æ‰§è¡Œ-ä¸»é˜Ÿåˆ—"><a href="#4-5-1-åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨åŒæ­¥æ‰§è¡Œ-ä¸»é˜Ÿåˆ—" class="headerlink" title="4.5.1 åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—"></a>4.5.1 åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</h4><ul><li>äº’ç›¸ç­‰å¾…å¡ä½ä¸å¯è¡Œ</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * ç‰¹ç‚¹(ä¸»çº¿ç¨‹è°ƒç”¨)ï¼šäº’ç­‰å¡ä¸»ä¸æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment"> * ç‰¹ç‚¹(å…¶ä»–çº¿ç¨‹è°ƒç”¨)ï¼šä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)syncMain &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"syncMain---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡2</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡3</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"syncMain---end"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºç»“æœ</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">42</span>:<span class="number">36.842892</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20041</span>:<span class="number">5030982</span>] currentThreadâ€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">42</span>:<span class="number">36.843050</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20041</span>:<span class="number">5030982</span>] syncMainâ€”begin</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><p>åœ¨<code>åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</code>å¯ä»¥æƒŠå¥‡çš„å‘ç°ï¼š</p><ul><li>åœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨<code>åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</code>ï¼Œè¿½åŠ åˆ°ä¸»çº¿ç¨‹çš„ä»»åŠ¡1ã€ä»»åŠ¡2ã€ä»»åŠ¡3éƒ½ä¸å†æ‰§è¡Œäº†ï¼Œè€Œä¸”<code>syncMain---end</code>ä¹Ÿæ²¡æœ‰æ‰“å°ï¼Œåœ¨XCode 9ä¸Šè¿˜ä¼šæŠ¥å´©æºƒã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</li></ul><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ<code>syncMain</code>æ–¹æ³•ï¼Œç›¸å½“äºæŠŠ<code>syncMain</code>ä»»åŠ¡æ”¾åˆ°äº†ä¸»çº¿ç¨‹çš„é˜Ÿåˆ—ä¸­ã€‚è€Œ<code>åŒæ­¥æ‰§è¡Œ</code>ä¼šç­‰å¾…å½“å‰é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰ä¼šæ¥ç€æ‰§è¡Œã€‚é‚£ä¹ˆå½“æˆ‘ä»¬æŠŠ<code>ä»»åŠ¡1</code>è¿½åŠ åˆ°ä¸»é˜Ÿåˆ—ä¸­ï¼Œ<code>ä»»åŠ¡1</code>å°±åœ¨ç­‰å¾…ä¸»çº¿ç¨‹å¤„ç†å®Œ<code>syncMain</code>ä»»åŠ¡ã€‚è€Œ<code>syncMain</code>ä»»åŠ¡éœ€è¦ç­‰å¾…<code>ä»»åŠ¡1</code>æ‰§è¡Œå®Œæ¯•ï¼Œæ‰èƒ½æ¥ç€æ‰§è¡Œã€‚</p><p>é‚£ä¹ˆï¼Œç°åœ¨çš„æƒ…å†µå°±æ˜¯<code>syncMain</code>ä»»åŠ¡å’Œ<code>ä»»åŠ¡1</code>éƒ½åœ¨ç­‰å¯¹æ–¹æ‰§è¡Œå®Œæ¯•ã€‚è¿™æ ·å¤§å®¶äº’ç›¸ç­‰å¾…ï¼Œæ‰€ä»¥å°±å¡ä½äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ä»»åŠ¡æ‰§è¡Œä¸äº†ï¼Œè€Œä¸”<code>syncMain---end</code>ä¹Ÿæ²¡æœ‰æ‰“å°ã€‚</p><p><strong>è¦æ˜¯å¦‚æœä¸åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ï¼Œè€Œåœ¨å…¶ä»–çº¿ç¨‹ä¸­è°ƒç”¨ä¼šå¦‚ä½•å‘¢ï¼Ÿ</strong></p><h4 id="4-5-2-åœ¨å…¶ä»–çº¿ç¨‹ä¸­è°ƒç”¨åŒæ­¥æ‰§è¡Œ-ä¸»é˜Ÿåˆ—"><a href="#4-5-2-åœ¨å…¶ä»–çº¿ç¨‹ä¸­è°ƒç”¨åŒæ­¥æ‰§è¡Œ-ä¸»é˜Ÿåˆ—" class="headerlink" title="4.5.2 åœ¨å…¶ä»–çº¿ç¨‹ä¸­è°ƒç”¨åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—"></a>4.5.2 åœ¨å…¶ä»–çº¿ç¨‹ä¸­è°ƒç”¨åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</h4><ul><li>ä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ NSThread çš„ detachNewThreadSelector æ–¹æ³•ä¼šåˆ›å»ºçº¿ç¨‹ï¼Œå¹¶è‡ªåŠ¨å¯åŠ¨çº¿ç¨‹æ‰§è¡Œ selector ä»»åŠ¡</span></span><br><span class="line">[NSThread <span class="string">detachNewThreadSelector:</span><span class="meta">@selector</span>(syncMain) <span class="string">toTarget:</span>self <span class="string">withObject:</span>nil];</span><br></pre></td></tr></table></figure><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">44</span>:<span class="number">19.377321</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20083</span>:<span class="number">5040347</span>] currentThreadâ€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">44</span>:<span class="number">19.377494</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20083</span>:<span class="number">5040347</span>] syncMainâ€”begin</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">44</span>:<span class="number">21.384716</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20083</span>:<span class="number">5040132</span>] <span class="number">1</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">44</span>:<span class="number">23.386091</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20083</span>:<span class="number">5040132</span>] <span class="number">1</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">44</span>:<span class="number">25.387687</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20083</span>:<span class="number">5040132</span>] <span class="number">2</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">44</span>:<span class="number">27.388648</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20083</span>:<span class="number">5040132</span>] <span class="number">2</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">44</span>:<span class="number">29.390459</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20083</span>:<span class="number">5040132</span>] <span class="number">3</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">44</span>:<span class="number">31.391965</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20083</span>:<span class="number">5040132</span>] <span class="number">3</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">44</span>:<span class="number">31.392513</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20083</span>:<span class="number">5040347</span>] syncMainâ€”end</span><br></pre></td></tr></table></figure><p>åœ¨å…¶ä»–çº¿ç¨‹ä¸­ä½¿ç”¨<code>åŒæ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</code>å¯çœ‹åˆ°ï¼š</p><ul><li>æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ï¼ˆéå½“å‰çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œçš„ï¼Œæ²¡æœ‰å¼€å¯æ–°çš„çº¿ç¨‹ï¼ˆæ‰€æœ‰æ”¾åœ¨ä¸»é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œéƒ½ä¼šæ”¾åˆ°ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰ã€‚</li><li>æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨æ‰“å°çš„syncConcurrentâ€”beginå’ŒsyncConcurrentâ€”endä¹‹é—´æ‰§è¡Œï¼ˆåŒæ­¥ä»»åŠ¡éœ€è¦ç­‰å¾…é˜Ÿåˆ—çš„ä»»åŠ¡æ‰§è¡Œç»“æŸï¼‰ã€‚</li><li>ä»»åŠ¡æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼ˆä¸»é˜Ÿåˆ—æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªä»»åŠ¡è¢«æ‰§è¡Œï¼Œä»»åŠ¡ä¸€ä¸ªæ¥ä¸€ä¸ªæŒ‰é¡ºåºæ‰§è¡Œï¼‰ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆç°åœ¨å°±ä¸ä¼šå¡ä½äº†å‘¢ï¼Ÿ</strong></p><p>å› ä¸º<code>syncMain</code> ä»»åŠ¡æ”¾åˆ°äº†å…¶ä»–çº¿ç¨‹é‡Œï¼Œè€Œ<code>ä»»åŠ¡1</code>ã€<code>ä»»åŠ¡2</code>ã€<code>ä»»åŠ¡3</code>éƒ½åœ¨è¿½åŠ åˆ°ä¸»é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸‰ä¸ªä»»åŠ¡éƒ½ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚<code>syncMain</code>ä»»åŠ¡åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œåˆ°è¿½åŠ <code>ä»»åŠ¡1</code>åˆ°ä¸»é˜Ÿåˆ—ä¸­ï¼Œå› ä¸ºä¸»é˜Ÿåˆ—ç°åœ¨æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ‰€ä»¥ï¼Œä¼šç›´æ¥æ‰§è¡Œä¸»é˜Ÿåˆ—çš„<code>ä»»åŠ¡1</code>ï¼Œç­‰<code>ä»»åŠ¡1</code>æ‰§è¡Œå®Œæ¯•ï¼Œå†æ¥ç€æ‰§è¡Œ<code>ä»»åŠ¡2</code>ã€<code>ä»»åŠ¡3</code>ã€‚æ‰€ä»¥è¿™é‡Œä¸ä¼šå¡ä½çº¿ç¨‹ã€‚</p><h3 id="4-6-å¼‚æ­¥æ‰§è¡Œ-ä¸»é˜Ÿåˆ—"><a href="#4-6-å¼‚æ­¥æ‰§è¡Œ-ä¸»é˜Ÿåˆ—" class="headerlink" title="4.6 å¼‚æ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—"></a>4.6 å¼‚æ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</h3><ul><li>åªåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¼‚æ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> * ç‰¹ç‚¹ï¼šåªåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)asyncMain &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"asyncMain---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡2</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡3</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"asyncMain---end"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">45</span>:<span class="number">49.981505</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20111</span>:<span class="number">5046708</span>] currentThreadâ€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">45</span>:<span class="number">49.981935</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20111</span>:<span class="number">5046708</span>] asyncMainâ€”begin</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">45</span>:<span class="number">49.982352</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20111</span>:<span class="number">5046708</span>] asyncMainâ€”end</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">45</span>:<span class="number">51.991096</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20111</span>:<span class="number">5046708</span>] <span class="number">1</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">45</span>:<span class="number">53.991959</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20111</span>:<span class="number">5046708</span>] <span class="number">1</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">45</span>:<span class="number">55.992937</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20111</span>:<span class="number">5046708</span>] <span class="number">2</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">45</span>:<span class="number">57.993649</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20111</span>:<span class="number">5046708</span>] <span class="number">2</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">45</span>:<span class="number">59.994928</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20111</span>:<span class="number">5046708</span>] <span class="number">3</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">46</span>:<span class="number">01.995589</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20111</span>:<span class="number">5046708</span>] <span class="number">3</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>å¼‚æ­¥æ‰§è¡Œ + ä¸»é˜Ÿåˆ—</code>å¯ä»¥çœ‹åˆ°ï¼š</p><ul><li>æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯åœ¨å½“å‰çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œçš„ï¼Œå¹¶æ²¡æœ‰å¼€å¯æ–°çš„çº¿ç¨‹ï¼ˆè™½ç„¶å¼‚æ­¥æ‰§è¡Œå…·å¤‡å¼€å¯çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä½†å› ä¸ºæ˜¯ä¸»é˜Ÿåˆ—ï¼Œæ‰€ä»¥æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ä¸­ï¼‰ã€‚</li><li>æ‰€æœ‰ä»»åŠ¡æ˜¯åœ¨æ‰“å°çš„syncConcurrentâ€”beginå’ŒsyncConcurrentâ€”endä¹‹åæ‰å¼€å§‹æ‰§è¡Œçš„ï¼ˆå¼‚æ­¥æ‰§è¡Œä¸ä¼šåšä»»ä½•ç­‰å¾…ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼‰ã€‚</li><li>ä»»åŠ¡æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼ˆå› ä¸ºä¸»é˜Ÿåˆ—æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªä»»åŠ¡è¢«æ‰§è¡Œï¼Œä»»åŠ¡ä¸€ä¸ªæ¥ä¸€ä¸ªæŒ‰é¡ºåºæ‰§è¡Œï¼‰ã€‚<br>å¼„æ‡‚äº†éš¾ç†è§£ã€ç»•æ¥ç»•å»çš„<strong>é˜Ÿåˆ—+ä»»åŠ¡</strong>ä¹‹åï¼Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸ªç®€å•çš„ä¸œè¥¿ï¼š<strong>5. GCD çº¿ç¨‹é—´çš„é€šä¿¡ã€‚</strong></li></ul><h2 id="5-GCD-çº¿ç¨‹é—´çš„é€šä¿¡"><a href="#5-GCD-çº¿ç¨‹é—´çš„é€šä¿¡" class="headerlink" title="5. GCD çº¿ç¨‹é—´çš„é€šä¿¡"></a>5. GCD çº¿ç¨‹é—´çš„é€šä¿¡</h2><p>åœ¨iOSå¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬åœ¨ä¸»çº¿ç¨‹é‡Œè¾¹è¿›è¡ŒUIåˆ·æ–°ï¼Œä¾‹å¦‚ï¼šç‚¹å‡»ã€æ»šåŠ¨ã€æ‹–æ‹½ç­‰äº‹ä»¶ã€‚æˆ‘ä»¬é€šå¸¸æŠŠä¸€äº›è€—æ—¶çš„æ“ä½œæ”¾åœ¨å…¶ä»–çº¿ç¨‹ï¼Œæ¯”å¦‚è¯´å›¾ç‰‡ä¸‹è½½ã€æ–‡ä»¶ä¸Šä¼ ç­‰è€—æ—¶æ“ä½œã€‚è€Œå½“æˆ‘ä»¬æœ‰æ—¶å€™åœ¨å…¶ä»–çº¿ç¨‹å®Œæˆäº†è€—æ—¶æ“ä½œæ—¶ï¼Œéœ€è¦å›åˆ°ä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ç”¨åˆ°äº†çº¿ç¨‹ä¹‹é—´çš„é€šè®¯ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¿ç¨‹é—´é€šä¿¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)communication &#123;</span><br><span class="line">    <span class="comment">// è·å–å…¨å±€å¹¶å‘é˜Ÿåˆ—</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>); </span><br><span class="line">    <span class="comment">// è·å–ä¸»é˜Ÿåˆ—</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue(); </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// å¼‚æ­¥è¿½åŠ ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å›åˆ°ä¸»çº¿ç¨‹</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(mainQueue, ^&#123;</span><br><span class="line">            <span class="comment">// è¿½åŠ åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">47</span>:<span class="number">03.462394</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20154</span>:<span class="number">5053282</span>] <span class="number">1</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">47</span>:<span class="number">05.465912</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20154</span>:<span class="number">5053282</span>] <span class="number">1</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">47</span>:<span class="number">07.466657</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20154</span>:<span class="number">5052953</span>] <span class="number">2</span>â€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹åˆ°åœ¨å…¶ä»–çº¿ç¨‹ä¸­å…ˆæ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œå®Œäº†ä¹‹åå›åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œä¸»çº¿ç¨‹çš„ç›¸åº”æ“ä½œã€‚</li></ul><h2 id="6-GCDçš„å…¶ä»–æ–¹æ³•"><a href="#6-GCDçš„å…¶ä»–æ–¹æ³•" class="headerlink" title="6. GCDçš„å…¶ä»–æ–¹æ³•"></a>6. GCDçš„å…¶ä»–æ–¹æ³•</h2><h3 id="6-1-GCD-æ …æ æ–¹æ³•ï¼šdispatch-barrier-async"><a href="#6-1-GCD-æ …æ æ–¹æ³•ï¼šdispatch-barrier-async" class="headerlink" title="6.1 GCD æ …æ æ–¹æ³•ï¼šdispatch_barrier_async"></a>6.1 GCD æ …æ æ–¹æ³•ï¼šdispatch_barrier_async</h3><ul><li>æˆ‘ä»¬æœ‰æ—¶éœ€è¦å¼‚æ­¥æ‰§è¡Œä¸¤ç»„æ“ä½œï¼Œè€Œä¸”ç¬¬ä¸€ç»„æ“ä½œæ‰§è¡Œå®Œä¹‹åï¼Œæ‰èƒ½å¼€å§‹æ‰§è¡Œç¬¬äºŒç»„æ“ä½œã€‚è¿™æ ·æˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªç›¸å½“äº<code>æ …æ </code>ä¸€æ ·çš„ä¸€ä¸ªæ–¹æ³•å°†ä¸¤ç»„å¼‚æ­¥æ‰§è¡Œçš„æ“ä½œç»„ç»™åˆ†å‰²èµ·æ¥ï¼Œå½“ç„¶è¿™é‡Œçš„æ“ä½œç»„é‡Œå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ã€‚è¿™å°±éœ€è¦ç”¨åˆ°<code>dispatch_barrier_async</code>æ–¹æ³•åœ¨ä¸¤ä¸ªæ“ä½œç»„é—´å½¢æˆæ …æ ã€‚</li></ul><p><code>dispatch_barrier_async</code>å‡½æ•°ä¼šç­‰å¾…å‰è¾¹è¿½åŠ åˆ°å¹¶å‘é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå†å°†æŒ‡å®šçš„ä»»åŠ¡è¿½åŠ åˆ°è¯¥å¼‚æ­¥é˜Ÿåˆ—ä¸­ã€‚ç„¶ååœ¨<code>dispatch_barrier_async</code>å‡½æ•°è¿½åŠ çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå¼‚æ­¥é˜Ÿåˆ—æ‰æ¢å¤ä¸ºä¸€èˆ¬åŠ¨ä½œï¼Œæ¥ç€è¿½åŠ ä»»åŠ¡åˆ°è¯¥å¼‚æ­¥é˜Ÿåˆ—å¹¶å¼€å§‹æ‰§è¡Œã€‚å…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://ysc-demo-1254961422.file.myqcloud.com/YSC-GCD-demo-barrier.png" alt="image"></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ …æ æ–¹æ³• dispatch_barrier_async</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)barrier &#123;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"net.bujige.testQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡2</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_barrier_async(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡ barrier</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"barrier---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);<span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡3</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡4</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"4---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">48</span>:<span class="number">18.297745</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20188</span>:<span class="number">5059274</span>] <span class="number">1</span>â€”&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">48</span>:<span class="number">18.297745</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20188</span>:<span class="number">5059273</span>] <span class="number">2</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">48:20.301139</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20188</span>:<span class="number">5059274</span>] <span class="number">1</span>â€”&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">48:20.301139</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20188</span>:<span class="number">5059273</span>] <span class="number">2</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">48</span>:<span class="number">22.306290</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20188</span>:<span class="number">5059274</span>] barrierâ€”&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">48</span>:<span class="number">24.311655</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20188</span>:<span class="number">5059274</span>] barrierâ€”&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">48</span>:<span class="number">26.316943</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20188</span>:<span class="number">5059273</span>] <span class="number">4</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">48</span>:<span class="number">26.316956</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20188</span>:<span class="number">5059274</span>] <span class="number">3</span>â€”&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">48</span>:<span class="number">28.320660</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20188</span>:<span class="number">5059273</span>] <span class="number">4</span>â€”&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">48</span>:<span class="number">28.320649</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20188</span>:<span class="number">5059274</span>] <span class="number">3</span>â€”&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>dispatch_barrier_async</code>æ‰§è¡Œç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼š</p><ul><li>åœ¨æ‰§è¡Œå®Œæ …æ å‰é¢çš„æ“ä½œä¹‹åï¼Œæ‰æ‰§è¡Œæ …æ æ“ä½œï¼Œæœ€åå†æ‰§è¡Œæ …æ åè¾¹çš„æ“ä½œã€‚</li></ul><h3 id="6-2-GCD-å»¶æ—¶æ‰§è¡Œæ–¹æ³•ï¼šdispatch-after"><a href="#6-2-GCD-å»¶æ—¶æ‰§è¡Œæ–¹æ³•ï¼šdispatch-after" class="headerlink" title="6.2 GCD å»¶æ—¶æ‰§è¡Œæ–¹æ³•ï¼šdispatch_after"></a>6.2 GCD å»¶æ—¶æ‰§è¡Œæ–¹æ³•ï¼šdispatch_after</h3><p>æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™æ ·çš„éœ€æ±‚ï¼šåœ¨æŒ‡å®šæ—¶é—´ï¼ˆä¾‹å¦‚3ç§’ï¼‰ä¹‹åæ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚å¯ä»¥ç”¨ GCD çš„<code>dispatch_after</code>å‡½æ•°æ¥å®ç°ã€‚</p><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯</strong>:<code>dispatch_after</code>å‡½æ•°å¹¶ä¸æ˜¯åœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰å¼€å§‹æ‰§è¡Œå¤„ç†ï¼Œè€Œæ˜¯åœ¨æŒ‡å®šæ—¶é—´ä¹‹åå°†ä»»åŠ¡è¿½åŠ åˆ°ä¸»é˜Ÿåˆ—ä¸­ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œè¿™ä¸ªæ—¶é—´å¹¶ä¸æ˜¯ç»å¯¹å‡†ç¡®çš„ï¼Œä½†æƒ³è¦å¤§è‡´å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ï¼Œ<code>dispatch_after</code>å‡½æ•°æ˜¯å¾ˆæœ‰æ•ˆçš„ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å»¶æ—¶æ‰§è¡Œæ–¹æ³• dispatch_after</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)after &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"asyncMain---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2.0</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="comment">// 2.0ç§’åå¼‚æ­¥è¿½åŠ ä»»åŠ¡ä»£ç åˆ°ä¸»é˜Ÿåˆ—ï¼Œå¹¶å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"after---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">08.713784</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20282</span>:<span class="number">5080295</span>] currentThreadâ€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">08.713962</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20282</span>:<span class="number">5080295</span>] asyncMainâ€”begin</span><br><span class="line"><span class="number">2018-02-23</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">10.714283</span>+<span class="number">0800</span> YSC-GCD-demo[<span class="number">20282</span>:<span class="number">5080295</span>] afterâ€”&#123;number = <span class="number">1</span>, name = main&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼šåœ¨æ‰“å° <code>asyncMain---begin</code> ä¹‹åå¤§çº¦ <strong>2.0</strong> ç§’çš„æ—¶é—´ï¼Œæ‰“å°äº† <code>after---&lt;NSThread: 0x60000006ee00&gt;{number = 1, name = main}</code></p><h3 id="6-3-GCDä¸€æ¬¡æ€§ä»£ç ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰ï¼šdispatch-once"><a href="#6-3-GCDä¸€æ¬¡æ€§ä»£ç ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰ï¼šdispatch-once" class="headerlink" title="6.3 GCDä¸€æ¬¡æ€§ä»£ç ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰ï¼šdispatch_once"></a>6.3 GCDä¸€æ¬¡æ€§ä»£ç ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰ï¼šdispatch_once</h3><ul><li>æˆ‘ä»¬åœ¨åˆ›å»ºå•ä¾‹ã€æˆ–è€…æœ‰æ•´ä¸ªç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åªæ‰§è¡Œä¸€æ¬¡çš„ä»£ç æ—¶ï¼Œæˆ‘ä»¬å°±ç”¨åˆ°äº†GCDçš„<code>dispatch_once</code>å‡½æ•°ã€‚ä½¿ç”¨<code>dispatch_once</code>å‡½æ•°èƒ½ä¿è¯æŸæ®µä»£ç åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å€¼è¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ä¸”åŠæ—¶åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œ<code>dispatch_once</code>ä¹Ÿå¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸€æ¬¡æ€§ä»£ç ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰dispatch_once</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">    <span class="comment">// åªæ‰§è¡Œä¸€æ¬¡çš„ä»£ç ï¼ˆè¿™é‡Œé¢é»˜è®¤æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼‰</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h3 id="6-4-GCDå¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch-apply"><a href="#6-4-GCDå¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch-apply" class="headerlink" title="6.4 GCDå¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch_apply"></a>6.4 GCDå¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch_apply</h3><ul><li>é€šå¸¸æˆ‘ä»¬ä¼šç”¨<code>for</code>å¾ªç¯éå†ï¼Œä½†æ˜¯GCDç»™æˆ‘ä»¬æä¾›äº†å¿«é€Ÿè¿­ä»£çš„å‡½æ•°<code>dispatch_apply</code>ã€‚<code>dispatch_apply</code>æŒ‰ç…§æŒ‡å®šçš„æ¬¡æ•°å°†æŒ‡å®šçš„ä»»åŠ¡è¿½åŠ åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç­‰å¾…å…¨éƒ¨é˜Ÿåˆ—æ‰§è¡Œç»“æŸã€‚</li></ul><p>å¦‚æœæ˜¯åœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸­ä½¿ç”¨<code>dispatch_apply</code>ï¼Œé‚£ä¹ˆå°±å’Œforå¾ªç¯ä¸€æ ·ï¼ŒæŒ‰ç…§é¡ºåºåŒæ­¥æ‰§è¡Œã€‚å¯è¿™æ ·å°±æç°ä¸å‡ºå¿«é€Ÿè¿­ä»£çš„æ„ä¹‰äº†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨<strong>å¹¶å‘é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥æ‰§è¡Œ</strong>ã€‚æ¯”å¦‚è¯´éå†0~5æŠ˜6ä¸ªæ•°å­—ï¼Œ<code>for</code>å¾ªç¯çš„åšæ³•æ˜¯æ¯æ¬¡å–å‡ºä¸€ä¸ªå…ƒç´ ï¼Œé€ä¸ªéå†ã€‚<code>dispatch_apply</code>å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­åŒæ—¶ï¼ˆå¼‚æ­¥ï¼‰éå†å¤šä¸ªæ•°å­—ã€‚<br>è¿˜æœ‰ä¸€ç‚¹ï¼Œæ— è®ºæ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œè¿˜æ˜¯å¹¶å‘é˜Ÿåˆ—ï¼Œ<code>dispatch_apply</code>éƒ½ä¼šç­‰å¾…å…¨éƒ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™ç‚¹å°±åƒæ˜¯åŒæ­¥æ“ä½œï¼Œä¹Ÿåƒæ˜¯é˜Ÿåˆ—ç»„ä¸­çš„<code>dispatch_group_wait</code>æ–¹æ³•ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">(void)apply</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">dispatch_queue_t</span> <span class="string">queue</span> <span class="string">=</span> <span class="string">dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT,</span> <span class="number">0</span><span class="string">);</span></span><br><span class="line">    <span class="string">NSLog(@"dispatch_apply</span> <span class="meta">---</span> <span class="string">begin");</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">dispatch_apply(6,</span> <span class="string">queue,</span> <span class="string">^(size_t</span> <span class="string">idx)</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">NSLog(@"%zu</span> <span class="meta">---</span> <span class="string">%@",</span> <span class="string">idx,</span> <span class="string">[NSThread</span> <span class="string">currentThread]);</span></span><br><span class="line">    <span class="string">&#125;);</span></span><br><span class="line">    <span class="string">NSLog(@"dispatch_apply</span> <span class="meta">---</span> <span class="string">end");</span></span><br><span class="line"> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="bullet">-07</span><span class="bullet">-13</span> <span class="number">11</span><span class="string">:03:14.776442+0800</span> <span class="string">getIP[52938:2588736]</span> <span class="string">dispatch_apply</span> <span class="meta">---</span> <span class="string">begin</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-07</span><span class="bullet">-13</span> <span class="number">11</span><span class="string">:03:14.778454+0800</span> <span class="string">getIP[52938:2589012]</span> <span class="number">0</span> <span class="meta">---</span> <span class="string">&lt;NSThread:</span> <span class="number">0x600000460580</span><span class="string">&gt;&#123;number</span> <span class="string">=</span> <span class="number">3</span><span class="string">,</span> <span class="string">name</span> <span class="string">=</span> <span class="string">(null)&#125;</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-07</span><span class="bullet">-13</span> <span class="number">11</span><span class="string">:03:14.778456+0800</span> <span class="string">getIP[52938:2589022]</span> <span class="number">2</span> <span class="meta">---</span> <span class="string">&lt;NSThread:</span> <span class="number">0x600000277740</span><span class="string">&gt;&#123;number</span> <span class="string">=</span> <span class="number">5</span><span class="string">,</span> <span class="string">name</span> <span class="string">=</span> <span class="string">(null)&#125;</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-07</span><span class="bullet">-13</span> <span class="number">11</span><span class="string">:03:14.778487+0800</span> <span class="string">getIP[52938:2589015]</span> <span class="number">1</span> <span class="meta">---</span> <span class="string">&lt;NSThread:</span> <span class="number">0x60400007be00</span><span class="string">&gt;&#123;number</span> <span class="string">=</span> <span class="number">4</span><span class="string">,</span> <span class="string">name</span> <span class="string">=</span> <span class="string">(null)&#125;</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-07</span><span class="bullet">-13</span> <span class="number">11</span><span class="string">:03:14.778507+0800</span> <span class="string">getIP[52938:2588736]</span> <span class="number">3</span> <span class="meta">---</span> <span class="string">&lt;NSThread:</span> <span class="number">0x6000000638c0</span><span class="string">&gt;&#123;number</span> <span class="string">=</span> <span class="number">1</span><span class="string">,</span> <span class="string">name</span> <span class="string">=</span> <span class="string">main&#125;</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-07</span><span class="bullet">-13</span> <span class="number">11</span><span class="string">:03:14.778644+0800</span> <span class="string">getIP[52938:2589012]</span> <span class="number">4</span> <span class="meta">---</span> <span class="string">&lt;NSThread:</span> <span class="number">0x600000460580</span><span class="string">&gt;&#123;number</span> <span class="string">=</span> <span class="number">3</span><span class="string">,</span> <span class="string">name</span> <span class="string">=</span> <span class="string">(null)&#125;</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-07</span><span class="bullet">-13</span> <span class="number">11</span><span class="string">:03:14.778648+0800</span> <span class="string">getIP[52938:2589022]</span> <span class="number">5</span> <span class="meta">---</span> <span class="string">&lt;NSThread:</span> <span class="number">0x600000277740</span><span class="string">&gt;&#123;number</span> <span class="string">=</span> <span class="number">5</span><span class="string">,</span> <span class="string">name</span> <span class="string">=</span> <span class="string">(null)&#125;</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-07</span><span class="bullet">-13</span> <span class="number">11</span><span class="string">:03:14.778790+0800</span> <span class="string">getIP[52938:2588736]</span> <span class="string">dispatch_apply</span> <span class="meta">---</span> <span class="string">end</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯åœ¨å¹¶æ‰“é˜Ÿåˆ—ä¸­å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œæ‰€ä»¥å„ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´é•¿çŸ­ä¸å®šï¼Œæœ€åç»“æŸé¡ºåºä¹Ÿä¸å®šã€‚ä½†æ˜¯<code>dispatch_apply --- end</code>ä¸€å®šåœ¨æœ€åæ‰§è¡Œã€‚è¿™æ˜¯å› ä¸º<code>dispatch_apply</code>å‡½æ•°ä¼šç­‰å¾…å…¨éƒ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</p><h3 id="6-5-GCDçš„é˜Ÿåˆ—ç»„ï¼šdispatch-group"><a href="#6-5-GCDçš„é˜Ÿåˆ—ç»„ï¼šdispatch-group" class="headerlink" title="6.5 GCDçš„é˜Ÿåˆ—ç»„ï¼šdispatch_group"></a>6.5 GCDçš„é˜Ÿåˆ—ç»„ï¼šdispatch_group</h3><p>æœ‰æ—¶å€™æˆ‘ä»¬ä¼šæœ‰è¿™æ ·çš„éœ€æ±‚ï¼šåˆ†åˆ«å¼‚æ­¥æ‰§è¡Œ2ä¸ªè€—æ—¶ä»»åŠ¡ï¼Œç„¶åå½“2ä¸ªè€—æ—¶ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•åå†å›åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ç”¨åˆ°GCDçš„é˜Ÿåˆ—ç»„ã€‚</p><ul><li>è°ƒç”¨é˜Ÿåˆ—ç»„çš„<code>dispatch_group_async</code>å…ˆæŠŠä»»åŠ¡æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œç„¶åå°†é˜Ÿåˆ—æ”¾å…¥é˜Ÿåˆ—ç»„ä¸­ã€‚æˆ–è€…ä½¿ç”¨é˜Ÿåˆ—ç»„çš„<code>dispatch_group_enter</code>ã€<code>dispatch_group_leave</code>ç»„åˆæ¥å®ç°<code>dispatch_group_async</code>ã€‚</li><li>è°ƒç”¨é˜Ÿåˆ—ç»„çš„<code>dispatch_group_notify</code>å›åˆ°æŒ‡å®šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚æˆ–è€…ä½¿ç”¨<code>dispatch_group_wait</code>å›åˆ°å½“å‰çº¿ç¨‹ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼ˆä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼‰ã€‚</li></ul><h4 id="6-5-1-dispatch-group-notify"><a href="#6-5-1-dispatch-group-notify" class="headerlink" title="6.5.1 dispatch_group_notify"></a>6.5.1 dispatch_group_notify</h4><ul><li>ç›‘å¬<code>group</code>ä¸­ä»»åŠ¡çš„å®ŒæˆçŠ¶æ€ã€å½“æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆåï¼Œè¿½åŠ ä»»åŠ¡åˆ°<code>group</code>ä¸­ï¼Œå¹¶æ‰§è¡Œä»»åŠ¡ã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)groupNotify &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"group---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1.0</span>];        <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>, [<span class="built_in">NSThread</span> currentThread]); <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡2</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1.0</span>];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="comment">// ç­‰å¾…å‰é¢çš„å¼‚æ­¥ä»»åŠ¡1ã€ä»»åŠ¡2éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œå›åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œä¸‹è¾¹çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1.0</span>];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"group---end"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">48</span>:<span class="number">54.576847</span>+<span class="number">0800</span> getIP[<span class="number">53687</span>:<span class="number">2645304</span>] currentThread---&lt;NSThread: <span class="number">0</span>x60400007ab00&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">48</span>:<span class="number">54.577070</span>+<span class="number">0800</span> getIP[<span class="number">53687</span>:<span class="number">2645304</span>] group---begin</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">48:55.581212</span>+<span class="number">0800</span> getIP[<span class="number">53687</span>:<span class="number">2645586</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000271880</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">48:55.581212</span>+<span class="number">0800</span> getIP[<span class="number">53687</span>:<span class="number">2645585</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">00000463680</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">48</span>:<span class="number">56.584404</span>+<span class="number">0800</span> getIP[<span class="number">53687</span>:<span class="number">2645585</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">00000463680</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">48</span>:<span class="number">56.584442</span>+<span class="number">0800</span> getIP[<span class="number">53687</span>:<span class="number">2645586</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">04000271880</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">48</span>:<span class="number">57.585741</span>+<span class="number">0800</span> getIP[<span class="number">53687</span>:<span class="number">2645304</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x60400007ab00&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">48</span>:<span class="number">58.586547</span>+<span class="number">0800</span> getIP[<span class="number">53687</span>:<span class="number">2645304</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x60400007ab00&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">48:58.587248</span>+<span class="number">0800</span> getIP[<span class="number">53687</span>:<span class="number">2645304</span>] group---end</span><br></pre></td></tr></table></figure><p>ä»<code>dispatch_group_notify</code>ç›¸å…³ä»£ç è¿è¡Œè¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼š<br>å½“æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œæ‰æ‰§è¡Œ<code>dispatch_group_notify</code> block ä¸­çš„ä»»åŠ¡ã€‚</p><h4 id="6-5-2-dispatch-group-wait"><a href="#6-5-2-dispatch-group-wait" class="headerlink" title="6.5.2 dispatch_group_wait"></a>6.5.2 dispatch_group_wait</h4><ul><li>æš‚åœå½“å‰çº¿ç¨‹ï¼ˆé˜»å¡å½“å‰çº¿ç¨‹ï¼‰ï¼Œç­‰å¾…æŒ‡å®šçš„<code>group</code>ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œæ‰ä¼šå¾€ä¸‹ç»§ç»­æ‰§è¡Œã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é˜Ÿåˆ—ç»„ dispatch_group_wait</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)groupWait &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"group---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_t group =  dispatch_group_create();</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡2</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç­‰å¾…ä¸Šé¢çš„ä»»åŠ¡å…¨éƒ¨å®Œæˆåï¼Œä¼šå¾€ä¸‹ç»§ç»­æ‰§è¡Œï¼ˆä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼‰</span></span><br><span class="line">    dispatch_group_wait(group, DISPATCH_TIME_FOREVER);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"group---end"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">57</span>:<span class="number">25.616529</span>+<span class="number">0800</span> getIP[<span class="number">53836</span>:<span class="number">2657139</span>] currentThread---&lt;NSThread: <span class="number">0</span>x6<span class="number">00000077580</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">57</span>:<span class="number">25.616699</span>+<span class="number">0800</span> getIP[<span class="number">53836</span>:<span class="number">2657139</span>] group---begin</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">57</span>:<span class="number">26.620585</span>+<span class="number">0800</span> getIP[<span class="number">53836</span>:<span class="number">2657304</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">00000271b40</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">57</span>:<span class="number">26.620585</span>+<span class="number">0800</span> getIP[<span class="number">53836</span>:<span class="number">2657307</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">40004665c0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">57</span>:<span class="number">27.624935</span>+<span class="number">0800</span> getIP[<span class="number">53836</span>:<span class="number">2657307</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x60<span class="number">40004665c0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">57</span>:<span class="number">27.624967</span>+<span class="number">0800</span> getIP[<span class="number">53836</span>:<span class="number">2657304</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">00000271b40</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">11</span>:<span class="number">57:27.625234</span>+<span class="number">0800</span> getIP[<span class="number">53836</span>:<span class="number">2657139</span>] group---end</span><br></pre></td></tr></table></figure><p>ä»<code>dispatch_group_wait</code>ç›¸å…³ä»£ç è¿è¡Œè¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼š<br>å½“æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ‰æ‰§è¡Œ<code>dispatch_group_wait</code>ä¹‹åçš„æ“ä½œã€‚ä½†æ˜¯ï¼Œä½¿ç”¨<code>dispatch_group_wait</code>ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚</p><h4 id="6-5-3-dispatch-group-enterã€dispatch-group-leave"><a href="#6-5-3-dispatch-group-enterã€dispatch-group-leave" class="headerlink" title="6.5.3 dispatch_group_enterã€dispatch_group_leave"></a>6.5.3 dispatch_group_enterã€dispatch_group_leave</h4><ul><li><code>dispatch_group_enter</code>æ ‡å¿—ç€ä¸€ä¸ªä»»åŠ¡è¿½åŠ åˆ°<code>group</code>ï¼Œæ‰§è¡Œä¸€æ¬¡ï¼Œç›¸å½“äº<code>group</code>ä¸­æœªæ‰§è¡Œå®Œæ¯•ä»»åŠ¡æ•°+1ã€‚</li><li><code>dispatch_group_leave</code>æ ‡å¿—ç€ä¸€ä¸ªä»»åŠ¡ç¦»å¼€äº†<code>group</code>ï¼Œæ‰§è¡Œä¸€æ¬¡ï¼Œç›¸å½“äº<code>group</code>ä¸­æœªæ‰§è¡Œå®Œæ¯•ä»»åŠ¡æ•°-1ã€‚</li><li>å½“<code>group</code>ä¸­æœªæ‰§è¡Œå®Œæ¯•ä»»åŠ¡æ•°ä¸º0çš„æ—¶å€™ï¼Œæ‰ä¼šä½¿<code>dispatch_group_wait</code>è§£é™¤é˜»å¡ï¼Œä»¥åŠæ‰§è¡Œè¿½åŠ åˆ°<code>dispatch_group_notify</code>ä¸­çš„ä»»åŠ¡ã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é˜Ÿåˆ—ç»„ dispatch_group_enterã€dispatch_group_leave</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)groupEnterAndLeave</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"group---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">    dispatch_group_enter(group);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡1</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        dispatch_group_leave(group);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_enter(group);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡2</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        dispatch_group_leave(group);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="comment">// ç­‰å‰é¢çš„å¼‚æ­¥æ“ä½œéƒ½æ‰§è¡Œå®Œæ¯•åï¼Œå›åˆ°ä¸»çº¿ç¨‹.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"group---end"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//    // ç­‰å¾…ä¸Šé¢çš„ä»»åŠ¡å…¨éƒ¨å®Œæˆåï¼Œä¼šå¾€ä¸‹ç»§ç»­æ‰§è¡Œï¼ˆä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼‰</span></span><br><span class="line">    <span class="comment">//    dispatch_group_wait(group, DISPATCH_TIME_FOREVER);</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//    NSLog(@"group---end");</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-07-13</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">24.452830</span>+<span class="number">0800</span> getIP[<span class="number">55700</span>:<span class="number">2775055</span>] currentThread---&lt;NSThread: <span class="number">0</span>x60400007df40&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">24.453043</span>+<span class="number">0800</span> getIP[<span class="number">55700</span>:<span class="number">2775055</span>] group---begin</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">25.457721</span>+<span class="number">0800</span> getIP[<span class="number">55700</span>:<span class="number">2775246</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">00000275a80</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">25.457721</span>+<span class="number">0800</span> getIP[<span class="number">55700</span>:<span class="number">2775244</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x<span class="number">60000027a180</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">26.460928</span>+<span class="number">0800</span> getIP[<span class="number">55700</span>:<span class="number">2775244</span>] <span class="number">2</span>---&lt;NSThread: <span class="number">0</span>x<span class="number">60000027a180</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">26.460932</span>+<span class="number">0800</span> getIP[<span class="number">55700</span>:<span class="number">2775246</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">00000275a80</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">27.461397</span>+<span class="number">0800</span> getIP[<span class="number">55700</span>:<span class="number">2775055</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x60400007df40&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">28.462036</span>+<span class="number">0800</span> getIP[<span class="number">55700</span>:<span class="number">2775055</span>] <span class="number">3</span>---&lt;NSThread: <span class="number">0</span>x60400007df40&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">28.462406</span>+<span class="number">0800</span> getIP[<span class="number">55700</span>:<span class="number">2775055</span>] group---end</span><br></pre></td></tr></table></figure><p>ä»<code>dispatch_group_enter</code>ã€<code>dispatch_group_leave</code>ç›¸å…³ä»£ç è¿è¡Œç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼š<br>å½“æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ‰æ‰§è¡Œ<code>dispatch_group_notify</code>ä¸­çš„ä»»åŠ¡ã€‚è¿™é‡Œçš„<code>dispatch_group_enter</code>ã€<code>dispatch_group_leave</code>ç»„åˆï¼Œå…¶å®ç­‰åŒäº<code>dispatch_group_async</code>ã€‚</p><h3 id="6-6-GCDä¿¡å·é‡ï¼šdispatch-semaphore"><a href="#6-6-GCDä¿¡å·é‡ï¼šdispatch-semaphore" class="headerlink" title="6.6 GCDä¿¡å·é‡ï¼šdispatch_semaphore"></a>6.6 GCDä¿¡å·é‡ï¼šdispatch_semaphore</h3><p>GCDä¸­çš„ä¿¡å·é‡æ˜¯æŒ‡<code>Dispatch Semaphore</code>ï¼Œæ˜¯æŒæœ‰è®¡æ•°çš„ä¿¡å·ã€‚ç±»ä¼¼äºè¿‡é«˜é€Ÿè·¯æ”¶è´¹ç«™çš„æ æ†ã€‚å¯ä»¥é€šè¿‡æ—¶ï¼Œæ‰“å¼€æ æ†ï¼Œä¸å¯ä»¥é€šè¿‡æ—¶ï¼Œå…³é—­æ æ†ã€‚åœ¨<code>Dispatch Semaphore</code>ä¸­ï¼Œä½¿ç”¨è®¡æ•°æ¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ï¼Œè®¡æ•°ä¸º0æ—¶ä¸ºç­‰å¾…ï¼Œä¸å¯é€šè¿‡ã€‚è®¡æ•°ä¸º1æˆ–å¤§äº1æ—¶ï¼Œè®¡æ•°å‡1ä¸”ä¸å¯ç­‰å¾…ï¼Œå¯é€šè¿‡ã€‚</p><p><code>Dispatch Semaphore</code>æä¾›äº†ä¸‰ä¸ªå‡½æ•°ï¼š</p><ul><li><code>dispatch_semaphore_create</code> åˆ›å»ºä¸€ä¸ªSemaphoreå¹¶åˆå§‹åŒ–ä¿¡å·çš„æ€»é‡</li><li><code>dispatch_semaphore_signal</code> å‘é€ä¸€ä¸ªä¿¡å·ï¼Œè®©ä¿¡å·æ€»é‡åŠ 1</li><li><code>dispatch_semaphore_wait</code> å¯ä»¥ä½¿æ€»ä¿¡å·é‡å‡1ï¼Œå½“ä¿¡å·é‡æ€»é‡ä¸º0æ—¶å°±ä¼šä¸€ç›´ç­‰å¾…ï¼ˆé˜»å¡æ‰€åœ¨çº¿ç¨‹ï¼‰ï¼Œå¦åˆ™å°±å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚</li></ul><blockquote><p>æ³¨æ„ï¼šä¿¡å·é‡çš„ä½¿ç”¨å‰ææ˜¯ï¼šæƒ³æ¸…æ¥šä½ éœ€è¦å¤„ç†å“ªä¸ªçº¿ç¨‹ç­‰å¾…ï¼ˆé˜»å¡ï¼‰ï¼Œåˆè¦å“ªä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œç„¶åä½¿ç”¨ä¿¡å·é‡ã€‚</p></blockquote><p><code>Dispatch Semaphore</code>åœ¨å®é™…å¼€å‘ä¸­ä¸»è¦ç”¨äºï¼š</p><ul><li>ä¿æŒçº¿ç¨‹åŒæ­¥ï¼Œå°†å¼‚æ­¥æ‰§è¡Œä»»åŠ¡è½¬æ¢ä¸ºåŒæ­¥æ‰§è¡Œä»»åŠ¡ã€‚</li><li>ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¸ºçº¿ç¨‹åŠ é”ã€‚</li></ul><h4 id="6-6-1-Dispatch-Semaphore-çº¿ç¨‹åŒæ­¥"><a href="#6-6-1-Dispatch-Semaphore-çº¿ç¨‹åŒæ­¥" class="headerlink" title="6.6.1 Dispatch Semaphore çº¿ç¨‹åŒæ­¥"></a>6.6.1 Dispatch Semaphore çº¿ç¨‹åŒæ­¥</h4><p>æˆ‘ä»¬åœ¨å¼€å‘ä¸­ï¼Œä¼šé‡åˆ°è¿™æ ·çš„éœ€æ±‚ï¼šå¼‚æ­¥æ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼Œå¹¶ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œçš„ç»“æœè¿›è¡Œä¸€äº›é¢å¤–çš„æ“ä½œã€‚æ¢å¥è¯è¯´ï¼Œç›¸å½“äºï¼Œå°†å¼‚æ­¥æ‰§è¡Œä»»åŠ¡è½¬æ¢ä¸ºåŒæ­¥æ‰§è¡Œä»»åŠ¡ã€‚æ¯”å¦‚è¯´ï¼š<code>AFNetworkingä¸­AFURLSessionManager.m</code>é‡Œé¢çš„<code>tasksForKeyPath:</code>æ–¹æ³•ã€‚é€šè¿‡å¼•å…¥ä¿¡å·é‡çš„æ–¹å¼ï¼Œç­‰å¾…å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ç»“æœï¼Œè·å–<code>tasks</code>ï¼Œç„¶åå†è¿”å›è¯¥<code>tasks</code>ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSArray</span> *)tasksForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    __block <span class="built_in">NSArray</span> *tasks = <span class="literal">nil</span>;</span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">    [<span class="keyword">self</span>.session getTasksWithCompletionHandler:^(<span class="built_in">NSArray</span> *dataTasks, <span class="built_in">NSArray</span> *uploadTasks, <span class="built_in">NSArray</span> *downloadTasks) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(dataTasks))]) &#123;</span><br><span class="line">            tasks = dataTasks;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(uploadTasks))]) &#123;</span><br><span class="line">            tasks = uploadTasks;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(downloadTasks))]) &#123;</span><br><span class="line">            tasks = downloadTasks;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(tasks))]) &#123;</span><br><span class="line">            tasks = [@[dataTasks, uploadTasks, downloadTasks] valueForKeyPath:<span class="string">@"@unionOfArrays.self"</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ©ç”¨Dispatch Semaphore å®ç°çº¿ç¨‹åŒæ­¥ï¼Œå°†å¼‚æ­¥æ‰§è¡Œä»»åŠ¡è½¬æ¢ä¸ºåŒæ­¥æ‰§è¡Œä»»åŠ¡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * semaphore çº¿ç¨‹åŒæ­¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)semaphoreSync &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"semaphore---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    __block <span class="keyword">int</span> number = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="comment">// è¿½åŠ ä»»åŠ¡1</span></span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];              <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);      <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        </span><br><span class="line">        number = <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"semaphore---end,number = %d"</span>,number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-07-13</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">12.677080</span>+<span class="number">0800</span> getIP[<span class="number">1108:118264</span>] currentThread---&lt;NSThread: <span class="number">0</span>x60400006cb80&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">12.677331</span>+<span class="number">0800</span> getIP[<span class="number">1108:118264</span>] semaphore---begin</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">17</span>:<span class="number">24:13.682121</span>+<span class="number">0800</span> getIP[<span class="number">1108:118716</span>] <span class="number">1</span>---&lt;NSThread: <span class="number">0</span>x6<span class="number">00000265780</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">13.682417</span>+<span class="number">0800</span> getIP[<span class="number">1108:118264</span>] semaphore---end,number = <span class="number">100</span></span><br></pre></td></tr></table></figure><p>ä»Dispatch Semaphoreå®ç°çº¿ç¨‹åŒæ­¥çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼š</p><ul><li><code>semaphore---end</code> æ˜¯åœ¨æ‰§è¡Œå®Œ <code>number = 100</code>; ä¹‹åæ‰æ‰“å°çš„ã€‚è€Œä¸”è¾“å‡ºç»“æœ <code>number</code> ä¸º 100ã€‚<br>è¿™æ˜¯å› ä¸ºå¼‚æ­¥æ‰§è¡Œä¸ä¼šåšä»»ä½•ç­‰å¾…ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä»»åŠ¡ã€‚å¼‚æ­¥æ‰§è¡Œå°†ä»»åŠ¡1è¿½åŠ åˆ°é˜Ÿåˆ—ä¹‹åï¼Œä¸åšç­‰å¾…ï¼Œæ¥ç€æ‰§è¡Œ<code>dispatch_semaphore_wait</code>æ–¹æ³•ã€‚æ­¤æ—¶ semaphore == 0ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚ç„¶åï¼Œå¼‚æ­¥ä»»åŠ¡1å¼€å§‹æ‰§è¡Œã€‚ä»»åŠ¡1æ‰§è¡Œåˆ°<code>dispatch_semaphore_signal</code>ä¹‹åï¼Œæ€»ä¿¡å·é‡ï¼Œæ­¤æ—¶ semaphore == 1ï¼Œ<code>dispatch_semaphore_wait</code>æ–¹æ³•ä½¿æ€»ä¿¡å·é‡å‡1ï¼Œæ­£åœ¨è¢«é˜»å¡çš„çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰æ¢å¤ç»§ç»­æ‰§è¡Œã€‚æœ€åæ‰“å°semaphoreâ€”end,number = 100ã€‚è¿™æ ·å°±å®ç°äº†çº¿ç¨‹åŒæ­¥ï¼Œå°†å¼‚æ­¥æ‰§è¡Œä»»åŠ¡è½¬æ¢ä¸ºåŒæ­¥æ‰§è¡Œä»»åŠ¡ã€‚</li></ul><h4 id="6-6-2-Dispatch-Semaphore-çº¿ç¨‹å®‰å…¨å’Œçº¿ç¨‹åŒæ­¥ï¼ˆä¸ºçº¿ç¨‹åŠ é”ï¼‰"><a href="#6-6-2-Dispatch-Semaphore-çº¿ç¨‹å®‰å…¨å’Œçº¿ç¨‹åŒæ­¥ï¼ˆä¸ºçº¿ç¨‹åŠ é”ï¼‰" class="headerlink" title="6.6.2 Dispatch Semaphore çº¿ç¨‹å®‰å…¨å’Œçº¿ç¨‹åŒæ­¥ï¼ˆä¸ºçº¿ç¨‹åŠ é”ï¼‰"></a>6.6.2 Dispatch Semaphore çº¿ç¨‹å®‰å…¨å’Œçº¿ç¨‹åŒæ­¥ï¼ˆä¸ºçº¿ç¨‹åŠ é”ï¼‰</h4><p><strong>çº¿ç¨‹å®‰å…¨</strong>ï¼šå¦‚æœä½ çš„ä»£ç æ‰€åœ¨çš„è¿›ç¨‹ä¸­æœ‰å¤šä¸ªçº¿ç¨‹åœ¨åŒæ—¶è¿è¡Œï¼Œè€Œè¿™äº›çº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶è¿è¡Œè¿™æ®µä»£ç ã€‚å¦‚æœæ¯æ¬¡è¿è¡Œç»“æœå’Œå•çº¿ç¨‹è¿è¡Œçš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”å…¶ä»–çš„å˜é‡çš„å€¼ä¹Ÿå’Œé¢„æœŸçš„æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><p>è‹¥æ¯ä¸ªçº¿ç¨‹ä¸­å¯¹å…¨å±€å˜é‡ã€é™æ€å˜é‡åªæœ‰è¯»æ“ä½œï¼Œè€Œæ— å†™æ“ä½œï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªå…¨å±€å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›è‹¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œå†™æ“ä½œï¼ˆæ›´æ”¹å˜é‡ï¼‰ï¼Œä¸€èˆ¬éƒ½éœ€è¦è€ƒè™‘çº¿ç¨‹åŒæ­¥ï¼Œå¦åˆ™çš„è¯å°±å¯èƒ½å½±å“çº¿ç¨‹å®‰å…¨ã€‚</p><p><strong>çº¿ç¨‹åŒæ­¥</strong>ï¼šå¯ç†è§£ä¸ºçº¿ç¨‹ A å’Œ çº¿ç¨‹ B ä¸€å—é…åˆï¼ŒA æ‰§è¡Œåˆ°ä¸€å®šç¨‹åº¦æ—¶è¦ä¾é çº¿ç¨‹ B çš„æŸä¸ªç»“æœï¼Œäºæ˜¯åœä¸‹æ¥ï¼Œç¤ºæ„ B è¿è¡Œï¼›B ä¾è¨€æ‰§è¡Œï¼Œå†å°†ç»“æœç»™ Aï¼›A å†ç»§ç»­æ“ä½œã€‚</p><p>ä¸¾ä¸ªç®€å•ä¾‹å­å°±æ˜¯ï¼šä¸¤ä¸ªäººåœ¨ä¸€èµ·èŠå¤©ã€‚ä¸¤ä¸ªäººä¸èƒ½åŒæ—¶è¯´è¯ï¼Œé¿å…å¬ä¸æ¸…(æ“ä½œå†²çª)ã€‚ç­‰ä¸€ä¸ªäººè¯´å®Œ(ä¸€ä¸ªçº¿ç¨‹ç»“æŸæ“ä½œ)ï¼Œå¦ä¸€ä¸ªå†è¯´(å¦ä¸€ä¸ªçº¿ç¨‹å†å¼€å§‹æ“ä½œ)ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿç«è½¦ç¥¨å”®å–çš„æ–¹å¼ï¼Œå®ç° NSThread çº¿ç¨‹å®‰å…¨å’Œè§£å†³çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚</p><p>åœºæ™¯ï¼šæ€»å…±æœ‰50å¼ ç«è½¦ç¥¨ï¼Œæœ‰ä¸¤ä¸ªå”®å–ç«è½¦ç¥¨çš„çª—å£ï¼Œä¸€ä¸ªæ˜¯åŒ—äº¬ç«è½¦ç¥¨å”®å–çª—å£ï¼Œå¦ä¸€ä¸ªæ˜¯ä¸Šæµ·ç«è½¦ç¥¨å”®å–çª—å£ã€‚ä¸¤ä¸ªçª—å£åŒæ—¶å”®å–ç«è½¦ç¥¨ï¼Œå–å®Œä¸ºæ­¢ã€‚</p><h5 id="6-6-2-1-éçº¿ç¨‹å®‰å…¨ï¼ˆä¸ä½¿ç”¨-semaphoreï¼‰"><a href="#6-6-2-1-éçº¿ç¨‹å®‰å…¨ï¼ˆä¸ä½¿ç”¨-semaphoreï¼‰" class="headerlink" title="6.6.2.1 éçº¿ç¨‹å®‰å…¨ï¼ˆä¸ä½¿ç”¨ semaphoreï¼‰"></a>6.6.2.1 éçº¿ç¨‹å®‰å…¨ï¼ˆä¸ä½¿ç”¨ semaphoreï¼‰</h5><p>å…ˆæ¥çœ‹çœ‹ä¸è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éçº¿ç¨‹å®‰å…¨ï¼šä¸ä½¿ç”¨ semaphore</span></span><br><span class="line"><span class="comment"> * åˆå§‹åŒ–ç«è½¦ç¥¨æ•°é‡ã€å–ç¥¨çª—å£(éçº¿ç¨‹å®‰å…¨)ã€å¹¶å¼€å§‹å–ç¥¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)initTicketStatusNotSave &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"semaphore---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.ticketSurplusCount = <span class="number">50</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// queue1 ä»£è¡¨åŒ—äº¬ç«è½¦ç¥¨å”®å–çª—å£</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"net.bujige.testQueue1"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    <span class="comment">// queue2 ä»£è¡¨ä¸Šæµ·ç«è½¦ç¥¨å”®å–çª—å£</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">"net.bujige.testQueue2"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue1, ^&#123;</span><br><span class="line">        [weakSelf saleTicketNotSafe];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue2, ^&#123;</span><br><span class="line">        [weakSelf saleTicketNotSafe];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å”®å–ç«è½¦ç¥¨(éçº¿ç¨‹å®‰å…¨)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)saleTicketNotSafe &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.ticketSurplusCount &gt; <span class="number">0</span>) &#123;  <span class="comment">//å¦‚æœè¿˜æœ‰ç¥¨ï¼Œç»§ç»­å”®å–</span></span><br><span class="line">            <span class="keyword">self</span>.ticketSurplusCount--;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"å‰©ä½™ç¥¨æ•°ï¼š%d çª—å£ï¼š%@"</span>, <span class="keyword">self</span>.ticketSurplusCount, [<span class="built_in">NSThread</span> currentThread]]);</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">0.2</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">//å¦‚æœå·²å–å®Œï¼Œå…³é—­å”®ç¥¨çª—å£</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"æ‰€æœ‰ç«è½¦ç¥¨å‡å·²å”®å®Œ"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42:23.185480</span>+<span class="number">0800</span> getIP[<span class="number">1627:173309</span>] currentThread---&lt;NSThread: <span class="number">0</span>x600<span class="number">00007e400</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42:23.185683</span>+<span class="number">0800</span> getIP[<span class="number">1627:173309</span>] semaphore---begin</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42:23.186613</span>+<span class="number">0800</span> getIP[<span class="number">1627:173436</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">49</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x600000467ac0&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42:23.186756</span>+<span class="number">0800</span> getIP[<span class="number">1627:173434</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">48</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x600<span class="number">00046e6c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">23.388436</span>+<span class="number">0800</span> getIP[<span class="number">1627:173434</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">46</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x600<span class="number">00046e6c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">23.388436</span>+<span class="number">0800</span> getIP[<span class="number">1627:173436</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">47</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x600000467ac0&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">23.589428</span>+<span class="number">0800</span> getIP[<span class="number">1627:173434</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">44</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x600<span class="number">00046e6c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">23.589443</span>+<span class="number">0800</span> getIP[<span class="number">1627:173436</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">45</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x600000467ac0&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42:23.793100</span>+<span class="number">0800</span> getIP[<span class="number">1627:173436</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">43</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x600000467ac0&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42:23.793101</span>+<span class="number">0800</span> getIP[<span class="number">1627:173434</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">42</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x600<span class="number">00046e6c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">23.996581</span>+<span class="number">0800</span> getIP[<span class="number">1627:173434</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">40</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x600<span class="number">00046e6c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">23.996598</span>+<span class="number">0800</span> getIP[<span class="number">1627:173436</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">41</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x600000467ac0&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ä¸è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼Œä¸ä½¿ç”¨ semaphore çš„æƒ…å†µä¸‹ï¼Œå¾—åˆ°ç¥¨æ•°æ˜¯é”™ä¹±çš„ï¼Œè¿™æ ·æ˜¾ç„¶ä¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p><h5 id="6-6-2-2-çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨semaphoreåŠ é”ï¼‰"><a href="#6-6-2-2-çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨semaphoreåŠ é”ï¼‰" class="headerlink" title="6.6.2.2 çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨semaphoreåŠ é”ï¼‰"></a>6.6.2.2 çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨semaphoreåŠ é”ï¼‰</h5><p>è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    dispatch_semaphore_t semaphoreLock;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¿ç¨‹å®‰å…¨ï¼šä½¿ç”¨ semaphore åŠ é”</span></span><br><span class="line"><span class="comment"> * åˆå§‹åŒ–ç«è½¦ç¥¨æ•°é‡ã€å–ç¥¨çª—å£(çº¿ç¨‹å®‰å…¨)ã€å¹¶å¼€å§‹å–ç¥¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)initTicketStatusSave &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread---%@"</span>,[<span class="built_in">NSThread</span> currentThread]);  <span class="comment">// æ‰“å°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"semaphore---begin"</span>);</span><br><span class="line">    </span><br><span class="line">    semaphoreLock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.ticketSurplusCount = <span class="number">50</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// queue1 ä»£è¡¨åŒ—äº¬ç«è½¦ç¥¨å”®å–çª—å£</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"net.bujige.testQueue1"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    <span class="comment">// queue2 ä»£è¡¨ä¸Šæµ·ç«è½¦ç¥¨å”®å–çª—å£</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">"net.bujige.testQueue2"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue1, ^&#123;</span><br><span class="line">        [weakSelf saleTicketSafe];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue2, ^&#123;</span><br><span class="line">        [weakSelf saleTicketSafe];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å”®å–ç«è½¦ç¥¨(çº¿ç¨‹å®‰å…¨)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)saleTicketSafe &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// ç›¸å½“äºåŠ é”</span></span><br><span class="line">        dispatch_semaphore_wait(semaphoreLock, DISPATCH_TIME_FOREVER);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.ticketSurplusCount &gt; <span class="number">0</span>) &#123;  <span class="comment">//å¦‚æœè¿˜æœ‰ç¥¨ï¼Œç»§ç»­å”®å–</span></span><br><span class="line">            <span class="keyword">self</span>.ticketSurplusCount--;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"å‰©ä½™ç¥¨æ•°ï¼š%ld çª—å£ï¼š%@"</span>, <span class="keyword">self</span>.ticketSurplusCount, [<span class="built_in">NSThread</span> currentThread]]);</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">0.2</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">//å¦‚æœå·²å–å®Œï¼Œå…³é—­å”®ç¥¨çª—å£</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"æ‰€æœ‰ç«è½¦ç¥¨å‡å·²å”®å®Œ"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ç›¸å½“äºè§£é”</span></span><br><span class="line">            dispatch_semaphore_signal(semaphoreLock);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç›¸å½“äºè§£é”</span></span><br><span class="line">        dispatch_semaphore_signal(semaphoreLock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46</span>:<span class="number">50.765047</span>+<span class="number">0800</span> getIP[<span class="number">1670:177634</span>] currentThread---&lt;NSThread: <span class="number">0</span>x6<span class="number">00000065080</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46:50.765215</span>+<span class="number">0800</span> getIP[<span class="number">1670:177634</span>] semaphore---begin</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46</span>:<span class="number">50.765473</span>+<span class="number">0800</span> getIP[<span class="number">1670:177688</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">49</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">04000264580</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46</span>:<span class="number">50.970353</span>+<span class="number">0800</span> getIP[<span class="number">1670:177689</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">48</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">00000266000</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46:51.174297</span>+<span class="number">0800</span> getIP[<span class="number">1670:177688</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">47</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">04000264580</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46</span>:<span class="number">51.377259</span>+<span class="number">0800</span> getIP[<span class="number">1670:177689</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">46</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">00000266000</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46</span>:<span class="number">51.577962</span>+<span class="number">0800</span> getIP[<span class="number">1670:177688</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">45</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">04000264580</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46</span>:<span class="number">51.778651</span>+<span class="number">0800</span> getIP[<span class="number">1670:177689</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">44</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">00000266000</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46:51.983102</span>+<span class="number">0800</span> getIP[<span class="number">1670:177688</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">43</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">04000264580</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46:52.187355</span>+<span class="number">0800</span> getIP[<span class="number">1670:177689</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">42</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">00000266000</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46</span>:<span class="number">52.391359</span>+<span class="number">0800</span> getIP[<span class="number">1670:177688</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">41</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">04000264580</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2018-07-13</span> <span class="number">18</span>:<span class="number">46</span>:<span class="number">52.595843</span>+<span class="number">0800</span> getIP[<span class="number">1670:177689</span>] å‰©ä½™ç¥¨æ•°ï¼š<span class="number">40</span> çª—å£ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">00000266000</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œåœ¨è€ƒè™‘äº†çº¿ç¨‹å®‰å…¨çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ dispatch_semaphore<br>æœºåˆ¶ä¹‹åï¼Œå¾—åˆ°çš„ç¥¨æ•°æ˜¯æ­£ç¡®çš„ï¼Œæ²¡æœ‰å‡ºç°æ··ä¹±çš„æƒ…å†µã€‚æˆ‘ä»¬ä¹Ÿå°±è§£å†³äº†å¤šä¸ªçº¿ç¨‹åŒæ­¥çš„é—®é¢˜ã€‚</p><p>æœ¬æ–‡ç³»è½¬è½½ï¼Œå¦‚æœ‰ä¾µæƒï¼Œå‘ŠçŸ¥æˆ‘åˆ é™¤ã€‚æ„Ÿè°¢åŸæ–‡ï¼š<br><a href="https://bujige.net/blog/iOS-Complete-learning-GCD.html" target="_blank" rel="noopener">iOSå¤šçº¿ç¨‹GCDè¯¦è§£</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;GCD&quot;&gt;&lt;a href=&quot;#GCD&quot; class=&quot;headerlink&quot; title=&quot;GCD&quot;&gt;&lt;/a&gt;GCD&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-dbe0f9c70088f039.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOSå¤šçº¿ç¨‹ä¹‹GCD.jpg&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡ç”¨æ¥ä»‹ç» iOS å¤šçº¿ç¨‹ä¸­ GCDçš„ç›¸å…³çŸ¥è¯†ä»¥åŠä½¿ç”¨æ–¹æ³•ã€‚é€šè¿‡æœ¬æ–‡ï¼Œæ‚¨å°†äº†è§£åˆ°ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;GCD ç®€ä»‹&lt;/li&gt;
&lt;li&gt;GCD ä»»åŠ¡å’Œé˜Ÿåˆ—&lt;/li&gt;
&lt;li&gt;GCD çš„ä½¿ç”¨æ­¥éª¤&lt;/li&gt;
&lt;li&gt;GCD çš„åŸºæœ¬ä½¿ç”¨ï¼ˆ6ç§ä¸åŒç»„åˆåŒºåˆ«ï¼‰&lt;/li&gt;
&lt;li&gt;GCD çº¿ç¨‹é—´çš„é€šä¿¡&lt;/li&gt;
&lt;li&gt;GCD çš„å…¶ä»–æ–¹æ³•ï¼ˆæ …æ æ–¹æ³•ï¼šdispatch_barrier_asyncã€å»¶æ—¶æ‰§è¡Œæ–¹æ³•ï¼šdispatch_afterã€ä¸€æ¬¡æ€§ä»£ç ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰ï¼šdispatch_onceã€å¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch_applyã€é˜Ÿåˆ—ç»„ï¼šdispatch_groupã€ä¿¡å·é‡ï¼šdispatch_semaphore&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="å¤šçº¿ç¨‹" scheme="http://yoursite.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
      <category term="GCD" scheme="http://yoursite.com/tags/GCD/"/>
    
  </entry>
  
  <entry>
    <title>iOSå¤šçº¿ç¨‹ä¹‹pthreadã€NSThread</title>
    <link href="http://yoursite.com/2018/05/15/iOS%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8Bpthread%E3%80%81NSThread/"/>
    <id>http://yoursite.com/2018/05/15/iOSå¤šçº¿ç¨‹ä¹‹pthreadã€NSThread/</id>
    <published>2018-05-15T14:32:42.000Z</published>
    <updated>2019-03-25T06:47:01.158Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://upload-images.jianshu.io/upload_images/1276164-bdccfafe3fddebf5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="iOSå¤šçº¿ç¨‹ä¹‹pthreadã€NSThread.jpg"></p><blockquote><p>æœ¬æ–‡ç”¨æ¥ä»‹ç» iOS å¤šçº¿ç¨‹ä¸­ï¼Œpthreadã€NSThread çš„ä½¿ç”¨æ–¹æ³•åŠå®ç°ã€‚<br>ç¬¬ä¸€éƒ¨åˆ†ï¼špthread çš„ä½¿ç”¨ã€å…¶ä»–ç›¸å…³æ–¹æ³•ã€‚<br>ç¬¬äºŒéƒ¨åˆ†ï¼šNSThread çš„ä½¿ç”¨ã€çº¿ç¨‹ç›¸å…³ç”¨æ³•ã€çº¿ç¨‹çŠ¶æ€æ§åˆ¶æ–¹æ³•ã€çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€çº¿ç¨‹å®‰å…¨å’Œçº¿ç¨‹åŒæ­¥ï¼Œä»¥åŠçº¿ç¨‹çš„çŠ¶æ€è½¬æ¢ç›¸å…³çŸ¥è¯†ã€‚</p></blockquote><a id="more"></a><h2 id="1-pthread"><a href="#1-pthread" class="headerlink" title="1. pthread"></a>1. pthread</h2><h3 id="1-1-pthreadç®€ä»‹"><a href="#1-1-pthreadç®€ä»‹" class="headerlink" title="1.1 pthreadç®€ä»‹"></a>1.1 pthreadç®€ä»‹</h3><p>pthread æ˜¯ä¸€å¥—é€šç”¨çš„å¤šçº¿ç¨‹çš„ APIï¼Œå¯ä»¥åœ¨Unix / Linux / Windows ç­‰ç³»ç»Ÿè·¨å¹³å°ä½¿ç”¨ï¼Œä½¿ç”¨ C è¯­è¨€ç¼–å†™ï¼Œéœ€è¦ç¨‹åºå‘˜è‡ªå·±ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½¿ç”¨éš¾åº¦è¾ƒå¤§ï¼Œæˆ‘ä»¬åœ¨ iOS å¼€å‘ä¸­å‡ ä¹ä¸ä½¿ç”¨ pthreadï¼Œä½†æ˜¯è¿˜æ˜¯æ¥å¯ä»¥äº†è§£ä¸€ä¸‹çš„ã€‚</p><h3 id="1-2-pthreadä½¿ç”¨æ–¹æ³•"><a href="#1-2-pthreadä½¿ç”¨æ–¹æ³•" class="headerlink" title="1.2 pthreadä½¿ç”¨æ–¹æ³•"></a>1.2 pthreadä½¿ç”¨æ–¹æ³•</h3><ol><li>é¦–å…ˆè¦åŒ…å«å¤´æ–‡ä»¶<code>#import &lt;pthread.h&gt;</code></li><li>å…¶æ¬¡è¦åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶å¼€å¯çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. åˆ›å»ºçº¿ç¨‹: å®šä¹‰ä¸€ä¸ªpthread_tç±»å‹å˜é‡</span></span><br><span class="line"><span class="keyword">pthread_t</span> thread;</span><br><span class="line"><span class="comment">// 2. å¼€å¯çº¿ç¨‹: æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">pthread_create(&amp;thread, <span class="literal">NULL</span>, run, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">// 3. è®¾ç½®å­çº¿ç¨‹çš„çŠ¶æ€è®¾ç½®ä¸º detachedï¼Œè¯¥çº¿ç¨‹è¿è¡Œç»“æŸåä¼šè‡ªåŠ¨é‡Šæ”¾æ‰€æœ‰èµ„æº</span></span><br><span class="line">pthread_detach(thread);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">run</span><span class="params">(<span class="keyword">void</span> *param)</span>    <span class="comment">// æ–°çº¿ç¨‹è°ƒç”¨æ–¹æ³•ï¼Œé‡Œè¾¹ä¸ºéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">NSLog(@<span class="string">"%@"</span>, [NSThread currentThread]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>pthread_create(&amp;thread, NULL, run, NULL);</code> ä¸­å„é¡¹å‚æ•°å«ä¹‰ï¼š<ul><li>ç¬¬ä¸€ä¸ªå‚æ•°<code>&amp;thread</code>æ˜¯çº¿ç¨‹å¯¹è±¡ï¼ŒæŒ‡å‘çº¿ç¨‹æ ‡è¯†ç¬¦çš„æŒ‡é’ˆ</li><li>ç¬¬äºŒä¸ªæ˜¯çº¿ç¨‹å±æ€§ï¼Œå¯èµ‹å€¼<code>NULL</code></li><li>ç¬¬ä¸‰ä¸ª<code>run</code>è¡¨ç¤ºæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ(runå¯¹åº”å‡½æ•°é‡Œæ˜¯éœ€è¦åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œçš„ä»»åŠ¡)</li><li>ç¬¬å››ä¸ªæ˜¯è¿è¡Œå‡½æ•°çš„å‚æ•°ï¼Œå¯èµ‹å€¼<code>NULL</code></li></ul></li></ul><h3 id="1-3-pthread-å…¶ä»–ç›¸å…³æ–¹æ³•"><a href="#1-3-pthread-å…¶ä»–ç›¸å…³æ–¹æ³•" class="headerlink" title="1.3 pthread å…¶ä»–ç›¸å…³æ–¹æ³•"></a>1.3 pthread å…¶ä»–ç›¸å…³æ–¹æ³•</h3><ul><li><code>pthread_create()</code> åˆ›å»ºä¸€ä¸ªçº¿ç¨‹</li><li><code>pthread_exit()</code> ç»ˆæ­¢å½“å‰çº¿ç¨‹</li><li><code>pthread_cancel()</code> ä¸­æ–­å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„è¿è¡Œ</li><li><code>pthread_join()</code> é˜»å¡å½“å‰çš„çº¿ç¨‹ï¼Œç›´åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿è¡Œç»“æŸ</li><li><code>pthread_attr_init()</code> åˆå§‹åŒ–çº¿ç¨‹çš„å±æ€§</li><li><code>pthread_attr_setdetachstate()</code> è®¾ç½®è„±ç¦»çŠ¶æ€çš„å±æ€§ï¼ˆå†³å®šè¿™ä¸ªçº¿ç¨‹åœ¨ç»ˆæ­¢æ—¶æ˜¯å¦å¯ä»¥è¢«ç»“åˆï¼‰</li><li><code>pthread_attr_getdetachstate()</code> è·å–è„±ç¦»çŠ¶æ€çš„å±æ€§</li><li><code>pthread_attr_destroy()</code> åˆ é™¤çº¿ç¨‹çš„å±æ€§</li><li><code>pthread_kill()</code> å‘çº¿ç¨‹å‘é€ä¸€ä¸ªä¿¡å·</li></ul><h2 id="2-NSThread"><a href="#2-NSThread" class="headerlink" title="2. NSThread"></a>2. NSThread</h2><p>NSThread æ˜¯è‹¹æœå®˜æ–¹æä¾›çš„ï¼Œä½¿ç”¨èµ·æ¥æ¯” pthread æ›´åŠ é¢å‘å¯¹è±¡ï¼Œç®€å•æ˜“ç”¨ï¼Œå¯ä»¥ç›´æ¥æ“ä½œçº¿ç¨‹å¯¹è±¡ã€‚ä¸è¿‡ä¹Ÿéœ€è¦éœ€è¦ç¨‹åºå‘˜è‡ªå·±ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ(ä¸»è¦æ˜¯åˆ›å»º)ï¼Œæˆ‘ä»¬åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­å¶å°”ä½¿ç”¨ NSThreadã€‚æ¯”å¦‚æˆ‘ä»¬ä¼šç»å¸¸è°ƒç”¨<code>[NSThread currentThread]</code>æ¥æ˜¾ç¤ºå½“å‰çš„è¿›ç¨‹ä¿¡æ¯ã€‚</p><h3 id="2-1-åˆ›å»ºã€å¯åŠ¨çº¿ç¨‹"><a href="#2-1-åˆ›å»ºã€å¯åŠ¨çº¿ç¨‹" class="headerlink" title="2.1 åˆ›å»ºã€å¯åŠ¨çº¿ç¨‹"></a>2.1 åˆ›å»ºã€å¯åŠ¨çº¿ç¨‹</h3><ul><li>å…ˆåˆ›å»ºçº¿ç¨‹ï¼Œå†å¯åŠ¨çº¿ç¨‹</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line"><span class="built_in">NSThread</span> *thread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(run) object:<span class="literal">nil</span>];</span><br><span class="line"><span class="comment">// 2. å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">[thread start];    <span class="comment">// çº¿ç¨‹ä¸€å¯åŠ¨ï¼Œå°±ä¼šåœ¨çº¿ç¨‹threadä¸­æ‰§è¡Œselfçš„runæ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°çº¿ç¨‹è°ƒç”¨æ–¹æ³•ï¼Œé‡Œè¾¹ä¸ºéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">- (<span class="keyword">void</span>)run &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºçº¿ç¨‹åè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. åˆ›å»ºçº¿ç¨‹åè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">[<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(run) toTarget:<span class="keyword">self</span> withObject:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°çº¿ç¨‹è°ƒç”¨æ–¹æ³•ï¼Œé‡Œè¾¹ä¸ºéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">- (<span class="keyword">void</span>)run &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>éšå¼åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. åˆ›å»ºçº¿ç¨‹åè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">[<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(run) toTarget:<span class="keyword">self</span> withObject:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°çº¿ç¨‹è°ƒç”¨æ–¹æ³•ï¼Œé‡Œè¾¹ä¸ºéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">- (<span class="keyword">void</span>)run &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-çº¿ç¨‹ç›¸å…³ç”¨æ³•"><a href="#2-2-çº¿ç¨‹ç›¸å…³ç”¨æ³•" class="headerlink" title="2.2 çº¿ç¨‹ç›¸å…³ç”¨æ³•"></a>2.2 çº¿ç¨‹ç›¸å…³ç”¨æ³•</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å¾—ä¸»çº¿ç¨‹</span></span><br><span class="line">+ (<span class="built_in">NSThread</span> *)mainThread;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºä¸»çº¿ç¨‹(å¯¹è±¡æ–¹æ³•)</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isMainThread;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºä¸»çº¿ç¨‹(ç±»æ–¹æ³•)</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)isMainThread;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å¾—å½“å‰çº¿ç¨‹</span></span><br><span class="line"><span class="built_in">NSThread</span> *current = [<span class="built_in">NSThread</span> currentThread];</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹çš„åå­—â€”â€”setteræ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)n;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹çš„åå­—â€”â€”getteræ–¹æ³•</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)name;</span><br></pre></td></tr></table></figure><h3 id="2-3-çº¿ç¨‹çŠ¶æ€æ§åˆ¶æ–¹æ³•"><a href="#2-3-çº¿ç¨‹çŠ¶æ€æ§åˆ¶æ–¹æ³•" class="headerlink" title="2.3 çº¿ç¨‹çŠ¶æ€æ§åˆ¶æ–¹æ³•"></a>2.3 çº¿ç¨‹çŠ¶æ€æ§åˆ¶æ–¹æ³•</h3><ul><li>å¯åŠ¨çº¿ç¨‹æ–¹æ³•</li></ul><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)start;</span><br><span class="line"><span class="comment">// çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ -&gt; è¿è¡ŒçŠ¶æ€ã€‚å½“çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè‡ªåŠ¨è¿›å…¥æ­»äº¡çŠ¶æ€</span></span><br></pre></td></tr></table></figure><ul><li>é˜»å¡ï¼ˆæš‚åœï¼‰çº¿ç¨‹æ–¹æ³•</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)<span class="string">sleepUntilDate:</span>(NSDate *)date;</span><br><span class="line">+ (<span class="keyword">void</span>)<span class="string">sleepForTimeInterval:</span>(NSTimeInterval)ti;</span><br><span class="line"><span class="comment">// çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€</span></span><br></pre></td></tr></table></figure><ul><li>å¼ºåˆ¶åœæ­¢çº¿ç¨‹</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ (void)<span class="keyword">exit</span>;</span><br><span class="line"><span class="regexp">//</span> çº¿ç¨‹è¿›å…¥æ­»äº¡çŠ¶æ€</span><br></pre></td></tr></table></figure><h3 id="2-4-çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡"><a href="#2-4-çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡" class="headerlink" title="2.4 çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡"></a>2.4 çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡</h3><p>åœ¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šåœ¨å­çº¿ç¨‹ä¸­è¿›è¡Œè€—æ—¶æ“ä½œï¼Œæ“ä½œç»“æŸåå†å›åˆ°ä¸»çº¿ç¨‹å»åˆ·æ–°UIã€‚è¿™å°±æ¶‰åŠåˆ°äº†å­çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚å…ˆæ¥äº†è§£ä¸€ä¸‹å®˜æ–¹å…³äºNSThreadçš„çº¿ç¨‹é—´é€šä¿¡çš„æ–¹æ³•ï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œæ“ä½œ</span><br><span class="line">- <span class="params">(void)</span>performSelectorOnMainThread:<span class="params">(SEL)</span>aSelector withObject:<span class="params">(id)</span>arg waitUntilDone:<span class="params">(BOOL)</span>wait;</span><br><span class="line">- <span class="params">(void)</span>performSelectorOnMainThread:<span class="params">(SEL)</span>aSelector withObject:<span class="params">(id)</span>arg waitUntilDone:<span class="params">(BOOL)</span>wait modes:<span class="params">(NSArray&lt;NSString *&gt; *)</span>array;</span><br><span class="line">// equivalent to the first method with kCFRunLoopCommonModes</span><br><span class="line"></span><br><span class="line">// åœ¨æŒ‡å®šçº¿ç¨‹ä¸Šæ‰§è¡Œæ“ä½œ</span><br><span class="line">- <span class="params">(void)</span>performSelector:<span class="params">(SEL)</span>aSelector onThread:<span class="params">(NSThread *)</span>thr withObject:<span class="params">(id)</span>arg waitUntilDone:<span class="params">(BOOL)</span>wait modes:<span class="params">(NSArray *)</span>array NS_AVAILABLE<span class="params">(<span class="number">10</span>_5, <span class="number">2</span>_0)</span>;</span><br><span class="line">- <span class="params">(void)</span>performSelector:<span class="params">(SEL)</span>aSelector onThread:<span class="params">(NSThread *)</span>thr withObject:<span class="params">(id)</span>arg waitUntilDone:<span class="params">(BOOL)</span>wait NS_AVAILABLE<span class="params">(<span class="number">10</span>_5, <span class="number">2</span>_0)</span>;</span><br><span class="line"></span><br><span class="line">// åœ¨å½“å‰çº¿ç¨‹ä¸Šæ‰§è¡Œæ“ä½œï¼Œè°ƒç”¨ NSObject çš„ performSelector:ç›¸å…³æ–¹æ³•</span><br><span class="line">- <span class="params">(id)</span>performSelector:<span class="params">(SEL)</span>aSelector;</span><br><span class="line">- <span class="params">(id)</span>performSelector:<span class="params">(SEL)</span>aSelector withObject:<span class="params">(id)</span>object;</span><br><span class="line">- <span class="params">(id)</span>performSelector:<span class="params">(SEL)</span>aSelector withObject:<span class="params">(id)</span>object1 withObject:<span class="params">(id)</span>object2;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç»å…¸çš„ä¸‹è½½å›¾ç‰‡çš„DEMOæ¥å±•ç¤ºçº¿ç¨‹é—´çš„é€šä¿¡ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>å¼€å¯ä¸€ä¸ªå­çº¿ç¨‹ï¼Œåœ¨å­çº¿ç¨‹ä¸­ä¸‹è½½å›¾ç‰‡</li><li>å›åˆ°ä¸»çº¿ç¨‹åˆ·æ–°UIï¼Œå°†å›¾ç‰‡å±•ç¤ºåœ¨UIImageViewä¸­</li></ol><p>DEMOä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä¸‹è½½å›¾ç‰‡</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)downloadImageOnSubThread &#123;</span><br><span class="line"><span class="comment">// åœ¨åˆ›å»ºçš„å­çº¿ç¨‹ä¸­è°ƒç”¨downloadImageä¸‹è½½å›¾ç‰‡</span></span><br><span class="line">[<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(downloadImage) toTarget:<span class="keyword">self</span> withObject:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* ä¸‹è½½å›¾ç‰‡ï¼Œä¸‹è½½å®Œä¹‹åå›åˆ°ä¸»çº¿ç¨‹è¿›è¡Œ UI åˆ·æ–°</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)downloadImage &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"current thread -- %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. è·å–å›¾ç‰‡ imageUrl</span></span><br><span class="line"><span class="built_in">NSURL</span> *imageUrl = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://ysc-demo-1254961422.file.myqcloud.com/YSC-phread-NSThread-demo-icon.jpg"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ä» imageUrl ä¸­è¯»å–æ•°æ®(ä¸‹è½½å›¾ç‰‡) -- è€—æ—¶æ“ä½œ</span></span><br><span class="line"><span class="built_in">NSData</span> *imageData = [<span class="built_in">NSData</span> dataWithContentsOfURL:imageUrl];</span><br><span class="line"><span class="comment">// é€šè¿‡äºŒè¿›åˆ¶ data åˆ›å»º image</span></span><br><span class="line"><span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithData:imageData];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. å›åˆ°ä¸»çº¿ç¨‹è¿›è¡Œå›¾ç‰‡èµ‹å€¼å’Œç•Œé¢åˆ·æ–°</span></span><br><span class="line">[<span class="keyword">self</span> performSelectorOnMainThread:<span class="keyword">@selector</span>(refreshOnMainThread:) withObject:image waitUntilDone:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å›åˆ°ä¸»çº¿ç¨‹è¿›è¡Œå›¾ç‰‡èµ‹å€¼å’Œç•Œé¢åˆ·æ–°</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)refreshOnMainThread:(<span class="built_in">UIImage</span> *)image &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"current thread -- %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// èµ‹å€¼å›¾ç‰‡åˆ°imageview</span></span><br><span class="line"><span class="keyword">self</span>.imageView.image = image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-5-çº¿ç¨‹å®‰å…¨ä¸çº¿ç¨‹åŒæ­¥"><a href="#2-5-çº¿ç¨‹å®‰å…¨ä¸çº¿ç¨‹åŒæ­¥" class="headerlink" title="2.5 çº¿ç¨‹å®‰å…¨ä¸çº¿ç¨‹åŒæ­¥"></a>2.5 çº¿ç¨‹å®‰å…¨ä¸çº¿ç¨‹åŒæ­¥</h3><p><strong>çº¿ç¨‹å®‰å…¨ï¼š</strong>å¦‚æœä½ çš„ä»£ç æ‰€åœ¨çš„è¿›ç¨‹ä¸­æœ‰å¤šä¸ªçº¿ç¨‹åœ¨åŒæ—¶è¿è¡Œï¼Œè€Œè¿™äº›çº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶è¿è¡Œè¿™æ®µä»£ç ã€‚å¦‚æœæ¯æ¬¡è¿è¡Œçš„ç»“æœå’Œå•çº¿ç¨‹è¿è¡Œçš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”å…¶ä»–çš„å˜é‡çš„å€¼ä¹Ÿå’Œé¢„æœŸæ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><p>è‹¥æ¯ä¸ªçº¿ç¨‹ä¸­å¯¹å…¨å±€å˜é‡ã€é™æ€å˜é‡åªæœ‰è¯»æ“ä½œï¼Œè€Œæ— å†™æ“ä½œï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªå…¨å±€å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›<br>è‹¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œå†™æ“ä½œï¼ˆæ›´æ”¹å˜é‡ï¼‰ï¼Œä¸€èˆ¬éƒ½è¦è€ƒè™‘çº¿ç¨‹åŒæ­¥ï¼Œå¦åˆ™çš„è¯å°±å¯èƒ½å½±å“çº¿ç¨‹å®‰å…¨ã€‚</p><p><strong>çº¿ç¨‹åŒæ­¥ï¼š</strong>å¯ä»¥ç†è§£ä¸ºçº¿ç¨‹Aå’Œçº¿ç¨‹Bä¸€å—å„¿é…åˆï¼ŒAæ‰§è¡Œåˆ°ä¸€å®šçš„ç¨‹åº¦æ˜¯è¦ä¾é çº¿ç¨‹Bçš„æŸä¸ªç»“æœï¼Œäºæ˜¯åœä¸‹æ¥ï¼Œç¤ºæ„Bè¿è¡Œï¼›Bä¾è¨€æ‰§è¡Œï¼Œå†å°†ç»“æœç»™Aï¼›Aå†ç»§ç»­æ“ä½œã€‚</p><p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­å°±æ˜¯ï¼šä¸¤ä¸ªäººåœ¨ä¸€èµ·èŠå¤©ã€‚ä¸¤ä¸ªäººä¸èƒ½åŒæ—¶è¯´è¯ï¼Œé¿å…å¬ä¸æ¸…æ¥šï¼ˆæ“ä½œå†²çªï¼‰ã€‚ç­‰ä¸€ä¸ªäººè¯´å®Œï¼ˆä¸€ä¸ªçº¿ç¨‹ç»“æŸæ“ä½œï¼‰ï¼Œå¦ä¸€ä¸ªå†è¯´ï¼Œï¼ˆä¸¤ä¸€ä¸ªçº¿ç¨‹å†å¼€å§‹æ“ä½œï¼‰ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°†æ¨¡æ‹Ÿç«è½¦ç¯‡å”®å–çš„æ–¹å¼ï¼Œå®ç°NSThreadçº¿ç¨‹å®‰å…¨å’Œè§£å†³çº¿ç¨‹åŒæ­¥çš„é—®é¢˜ã€‚</p><p><strong>åœºæ™¯ï¼š</strong>æ€»å…±æœ‰50å¼ ç«è½¦ç¥¨ï¼Œæœ‰ä¸¤ä¸ªå”®å–ç«è½¦ç¥¨çš„çª—å£ï¼Œä¸€ä¸ªæ˜¯åŒ—äº¬ç«è½¦ç¥¨å”®å–çª—å£ï¼Œå¦ä¸€ä¸ªæ˜¯ä¸Šæµ·ç«è½¦ç¥¨å”®å–çª—å£ã€‚ä¸¤ä¸ªçª—å£åŒäº‹å”®å–ç«è½¦ç¥¨ï¼Œå–å®Œä¸ºæ­¢ã€‚</p><h4 id="2-5-1-NSThreadéçº¿ç¨‹å®‰å…¨"><a href="#2-5-1-NSThreadéçº¿ç¨‹å®‰å…¨" class="headerlink" title="2.5.1 NSThreadéçº¿ç¨‹å®‰å…¨"></a>2.5.1 NSThreadéçº¿ç¨‹å®‰å…¨</h4><p>å…ˆçœ‹çœ‹ä¸è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* åˆå§‹åŒ–ç«è½¦ç¥¨æ•°é‡ã€å–ç¥¨çª—å£(éçº¿ç¨‹å®‰å…¨)ã€å¹¶å¼€å§‹å–ç¥¨</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)initTicketStatusNotSave &#123;</span><br><span class="line"><span class="comment">// 1. è®¾ç½®å‰©ä½™ç«è½¦ç¥¨ä¸º 50</span></span><br><span class="line"><span class="keyword">self</span>.ticketSurplusCount = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. è®¾ç½®åŒ—äº¬ç«è½¦ç¥¨å”®å–çª—å£çš„çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">self</span>.ticketSaleWindow1 = [[<span class="built_in">NSThread</span> alloc]initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(saleTicketNotSafe) object:<span class="literal">nil</span>];</span><br><span class="line"><span class="keyword">self</span>.ticketSaleWindow1.name = <span class="string">@"åŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. è®¾ç½®ä¸Šæµ·ç«è½¦ç¥¨å”®å–çª—å£çš„çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">self</span>.ticketSaleWindow2 = [[<span class="built_in">NSThread</span> alloc]initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(saleTicketNotSafe) object:<span class="literal">nil</span>];</span><br><span class="line"><span class="keyword">self</span>.ticketSaleWindow2.name = <span class="string">@"ä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. å¼€å§‹å”®å–ç«è½¦ç¥¨</span></span><br><span class="line">[<span class="keyword">self</span>.ticketSaleWindow1 start];</span><br><span class="line">[<span class="keyword">self</span>.ticketSaleWindow2 start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å”®å–ç«è½¦ç¥¨(éçº¿ç¨‹å®‰å…¨)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)saleTicketNotSafe &#123;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">//å¦‚æœè¿˜æœ‰ç¥¨ï¼Œç»§ç»­å”®å–</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.ticketSurplusCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">self</span>.ticketSurplusCount --;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"å‰©ä½™ç¥¨æ•°ï¼š%ld çª—å£ï¼š%@"</span>,<span class="keyword">self</span>.ticketSurplusCount, [<span class="built_in">NSThread</span> currentThread].name]);</span><br><span class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">0.2</span>];</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span> &#123;<span class="comment">//å¦‚æœå·²å–å®Œï¼Œå…³é—­å”®ç¥¨çª—å£</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"æ‰€æœ‰ç«è½¦ç¥¨å‡å·²å”®å®Œ"</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œåéƒ¨åˆ†ç»“æœä¸ºï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2018<span class="selector-tag">-05-21</span> 18<span class="selector-pseudo">:44</span><span class="selector-pseudo">:55.428108+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4226:459324]</span> å‰©ä½™ç¥¨æ•°ï¼š48 çª—å£ï¼šä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 18<span class="selector-pseudo">:44</span><span class="selector-pseudo">:55.428112+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4226:459323]</span> å‰©ä½™ç¥¨æ•°ï¼š49 çª—å£ï¼šåŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 18<span class="selector-pseudo">:44</span><span class="selector-pseudo">:55.631715+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4226:459324]</span> å‰©ä½™ç¥¨æ•°ï¼š47 çª—å£ï¼šä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 18<span class="selector-pseudo">:44</span><span class="selector-pseudo">:55.631715+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4226:459323]</span> å‰©ä½™ç¥¨æ•°ï¼š46 çª—å£ï¼šåŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 18<span class="selector-pseudo">:44</span><span class="selector-pseudo">:55.833247+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4226:459324]</span> å‰©ä½™ç¥¨æ•°ï¼š45 çª—å£ï¼šä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 18<span class="selector-pseudo">:44</span><span class="selector-pseudo">:55.833289+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4226:459323]</span> å‰©ä½™ç¥¨æ•°ï¼š45 çª—å£ï¼šåŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 18<span class="selector-pseudo">:44</span><span class="selector-pseudo">:56.038194+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4226:459324]</span> å‰©ä½™ç¥¨æ•°ï¼š44 çª—å£ï¼šä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 18<span class="selector-pseudo">:44</span><span class="selector-pseudo">:56.038223+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4226:459323]</span> å‰©ä½™ç¥¨æ•°ï¼š43 çª—å£ï¼šåŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 18<span class="selector-pseudo">:44</span><span class="selector-pseudo">:56.239316+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4226:459324]</span> å‰©ä½™ç¥¨æ•°ï¼š42 çª—å£ï¼šä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 18<span class="selector-pseudo">:44</span><span class="selector-pseudo">:56.239318+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4226:459323]</span> å‰©ä½™ç¥¨æ•°ï¼š42 çª—å£ï¼šåŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ä¸è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„æƒ…å†µä¸‹ï¼Œå¾—åˆ°çš„ç¥¨æ•°æ˜¯é”™ä¹±çš„ï¼Œè¿™æ ·æ˜¾ç¤ºä¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚</p><h4 id="2-5-2-NSThreadçº¿ç¨‹å®‰å…¨"><a href="#2-5-2-NSThreadçº¿ç¨‹å®‰å…¨" class="headerlink" title="2.5.2 NSThreadçº¿ç¨‹å®‰å…¨"></a>2.5.2 NSThreadçº¿ç¨‹å®‰å…¨</h4><p>çº¿ç¨‹å®‰å…¨è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥ç»™çº¿ç¨‹åŠ é”ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥æ“ä½œçš„æ—¶å€™ï¼Œä¸å…è®¸å…¶ä»–çº¿ç¨‹è¿›è¡Œæ“ä½œã€‚iOSå®ç°çº¿ç¨‹åŠ é”æœ‰å¾ˆå¤šç§æ–¹å¼ï¼š@synchronizedã€ NSLockã€NSRecursiveLockã€NSConditionã€NSConditionLockã€pthread_mutexã€dispatch_semaphoreã€OSSpinLockã€atomic(property) set/geç­‰ç­‰å„ç§æ–¹å¼ã€‚<br>ä¸ºäº†ç®€å•èµ·è§ï¼Œè¿™é‡Œä¸å¯¹å„ç§é”çš„è§£å†³æ–¹æ¡ˆå’Œæ€§èƒ½åšåˆ†æï¼Œåªç”¨æœ€ç®€å•çš„@synchronizedæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä»è€Œè§£å†³çº¿ç¨‹åŒæ­¥çš„é—®é¢˜ã€‚</p><p>è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆå§‹åŒ–ç«è½¦ç¥¨æ•°é‡ã€å–ç¥¨çª—å£(éçº¿ç¨‹å®‰å…¨)ã€å¹¶å¼€å§‹å–ç¥¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)initTicketStatusNotSave &#123;</span><br><span class="line">    <span class="comment">// 1. è®¾ç½®å‰©ä½™ç«è½¦ç¥¨ä¸º 50</span></span><br><span class="line">    <span class="keyword">self</span>.ticketSurplusCount = <span class="number">50</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. è®¾ç½®åŒ—äº¬ç«è½¦ç¥¨å”®å–çª—å£çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">self</span>.ticketSaleWindow1 = [[<span class="built_in">NSThread</span> alloc]initWithTarget:<span class="keyword">self</span>     selector:<span class="keyword">@selector</span>(saleTicketNotSafe) object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">self</span>.ticketSaleWindow1.name = <span class="string">@"åŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. è®¾ç½®ä¸Šæµ·ç«è½¦ç¥¨å”®å–çª—å£çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">self</span>.ticketSaleWindow2 = [[<span class="built_in">NSThread</span> alloc]initWithTarget:<span class="keyword">self</span>     selector:<span class="keyword">@selector</span>(saleTicketNotSafe) object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">self</span>.ticketSaleWindow2.name = <span class="string">@"ä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. å¼€å§‹å”®å–ç«è½¦ç¥¨</span></span><br><span class="line">    [<span class="keyword">self</span>.ticketSaleWindow1 start];</span><br><span class="line">    [<span class="keyword">self</span>.ticketSaleWindow2 start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å”®å–ç«è½¦ç¥¨(éçº¿ç¨‹å®‰å…¨)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)saleTicketNotSafe &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">@synchronized</span>(<span class="keyword">self</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœè¿˜æœ‰ç¥¨ï¼Œç»§ç»­å”®å–</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.ticketSurplusCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">self</span>.ticketSurplusCount --;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"å‰©ä½™ç¥¨æ•°ï¼š%ld çª—å£ï¼š%@"</span>,<span class="keyword">self</span>.ticketSurplusCount, [<span class="built_in">NSThread</span> currentThread].name]);</span><br><span class="line">                [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">0.2</span>];</span><br><span class="line">                </span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;<span class="comment">//å¦‚æœå·²å–å®Œï¼Œå…³é—­å”®ç¥¨çª—å£</span></span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"æ‰€æœ‰ç«è½¦ç¥¨å‡å·²å”®å®Œ"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœä¸ºï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2018<span class="selector-tag">-05-21</span> 19<span class="selector-pseudo">:01</span><span class="selector-pseudo">:20.789485+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4378:480055]</span> å‰©ä½™ç¥¨æ•°ï¼š49 çª—å£ï¼šåŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 19<span class="selector-pseudo">:01</span><span class="selector-pseudo">:20.993775+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4378:480056]</span> å‰©ä½™ç¥¨æ•°ï¼š48 çª—å£ï¼šä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 19<span class="selector-pseudo">:01</span><span class="selector-pseudo">:21.196806+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4378:480055]</span> å‰©ä½™ç¥¨æ•°ï¼š47 çª—å£ï¼šåŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 19<span class="selector-pseudo">:01</span><span class="selector-pseudo">:21.401549+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4378:480056]</span> å‰©ä½™ç¥¨æ•°ï¼š46 çª—å£ï¼šä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 19<span class="selector-pseudo">:01</span><span class="selector-pseudo">:21.606336+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4378:480055]</span> å‰©ä½™ç¥¨æ•°ï¼š45 çª—å£ï¼šåŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 19<span class="selector-pseudo">:01</span><span class="selector-pseudo">:21.809718+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4378:480056]</span> å‰©ä½™ç¥¨æ•°ï¼š44 çª—å£ï¼šä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 19<span class="selector-pseudo">:01</span><span class="selector-pseudo">:22.015090+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4378:480055]</span> å‰©ä½™ç¥¨æ•°ï¼š43 çª—å£ï¼šåŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 19<span class="selector-pseudo">:01</span><span class="selector-pseudo">:22.219827+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4378:480056]</span> å‰©ä½™ç¥¨æ•°ï¼š42 çª—å£ï¼šä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 19<span class="selector-pseudo">:01</span><span class="selector-pseudo">:22.423403+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4378:480055]</span> å‰©ä½™ç¥¨æ•°ï¼š41 çª—å£ï¼šåŒ—äº¬ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br><span class="line">2018<span class="selector-tag">-05-21</span> 19<span class="selector-pseudo">:01</span><span class="selector-pseudo">:22.625025+0800</span> <span class="selector-tag">RunLoop</span><span class="selector-attr">[4378:480056]</span> å‰©ä½™ç¥¨æ•°ï¼š40 çª—å£ï¼šä¸Šæµ·ç«è½¦ç¥¨å”®ç¥¨çª—å£</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œåœ¨è€ƒè™‘äº†çº¿ç¨‹å®‰å…¨çš„æƒ…å†µä¸‹ï¼ŒåŠ é”ä¹‹åï¼Œå¾—åˆ°çš„ç¥¨æ•°æ˜¯æ­£ç¡®çš„ï¼Œæ²¡æœ‰å‡ºç°æ··ä¹±çš„æƒ…å†µã€‚æˆ‘ä»¬ä¹Ÿå°±è§£å†³äº†å¤šä¸ªçº¿ç¨‹åŒæ­¥çš„é—®é¢˜ã€‚</p><h3 id="2-6-çº¿ç¨‹çš„çŠ¶æ€è½¬æ¢"><a href="#2-6-çº¿ç¨‹çš„çŠ¶æ€è½¬æ¢" class="headerlink" title="2.6 çº¿ç¨‹çš„çŠ¶æ€è½¬æ¢"></a>2.6 çº¿ç¨‹çš„çŠ¶æ€è½¬æ¢</h3><p>å½“æˆ‘ä»¬æ–°å»ºä¸€æ¡çº¿ç¨‹<code>NSThread *thread = [[NSThread alloc] initWithTarget:self selector:@selector(run) object:nil];</code>ï¼Œåœ¨å†…å­˜ä¸­çš„è¡¨ç°ä¸ºï¼š</p><p><img src="https://ysc-demo-1254961422.file.myqcloud.com/YSC-phread-NSThread-demo-StatusChange.png" alt=""></p><p>å½“è°ƒç”¨<code>[thread start];</code>åï¼Œç³»ç»ŸæŠŠçº¿ç¨‹å¯¹è±¡æ”¾å…¥å¯è°ƒåº¦çº¿ç¨‹æ± ä¸­ï¼Œçº¿ç¨‹å¯¹è±¡è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://ysc-demo-1254961422.file.myqcloud.com/YSC-phread-NSThread-demo-StatusChange1.png" alt=""></p><p>å½“ç„¶ï¼Œå¯è°ƒåº¦çº¿ç¨‹æ± ä¸­ï¼Œä¼šæœ‰å…¶ä»–çš„çº¿ç¨‹å¯¹è±¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚åœ¨è¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒå·¦è¾¹çš„çº¿ç¨‹å¯¹è±¡ã€‚</p><p><img src="https://ysc-demo-1254961422.file.myqcloud.com/YSC-phread-NSThread-demo-StatusChange2.png" alt=""></p><p><strong>ä¸‹è¾¹æˆ‘ä»¬æ¥çœ‹çœ‹å½“å‰çº¿ç¨‹çš„çŠ¶æ€è½¬æ¢ï¼š</strong></p><ul><li>å¦‚æœCPUç°åœ¨è°ƒåº¦å½“å‰çº¿ç¨‹å¯¹è±¡ï¼Œåˆ™å½“å‰çº¿ç¨‹å¯¹è±¡è¿›å…¥è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœCPUè°ƒåº¦å…¶ä»–çº¿ç¨‹å¯¹è±¡ï¼Œåˆ™å½“å‰çº¿ç¨‹å¯¹è±¡å›åˆ°å°±ç»ªçŠ¶æ€ã€‚</li><li>å¦‚æœCPUåœ¨è¿è¡Œå½“å‰çº¿ç¨‹å¯¹è±¡çš„æ—¶å€™è°ƒç”¨äº†sleepæ–¹æ³•\ç­‰å¾…åŒæ­¥é”ï¼Œåˆ™å½“å‰çº¿ç¨‹å¯¹è±¡å°±è¿›å…¥äº†é˜»å¡çŠ¶æ€ï¼Œç­‰åˆ°sleepåˆ°æ—¶\å¾—åˆ°åŒæ­¥é”ï¼Œåˆ™å›åˆ°å°±ç»ªçŠ¶æ€ã€‚</li><li>å¦‚æœCPUåœ¨è¿è¡Œå½“å‰çº¿ç¨‹å¯¹è±¡çš„æ—¶å€™çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œå®Œæ¯•\å¼‚å¸¸å¼ºåˆ¶é€€å‡ºï¼Œåˆ™å½“å‰çº¿ç¨‹å¯¹è±¡è¿›å…¥æ­»äº¡çŠ¶æ€ã€‚</li></ul><p>åªçœ‹æ–‡å­—å¯èƒ½ä¸å¤ªå¥½ç†è§£ï¼Œå…·ä½“å½“å‰çº¿ç¨‹å¯¹è±¡çš„çŠ¶æ€å˜åŒ–å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://ysc-demo-1254961422.file.myqcloud.com/YSC-phread-NSThread-demo-StatusChange3.png" alt=""></p><p>æœ¬æ–‡ç³»è½¬è½½ï¼Œå¦‚æœ‰ä¾µæƒï¼Œå‘ŠçŸ¥æˆ‘åˆ é™¤ã€‚æ„Ÿè°¢åŸæ–‡ï¼š<a href="https://bujige.net/blog/iOS-Complete-learning-pthread-and-NSThread.html" target="_blank" rel="noopener">iOSå¤šçº¿ç¨‹ï¼šã€pthreadã€NSThreadã€è¯¦å°½æ€»ç»“</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-bdccfafe3fddebf5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOSå¤šçº¿ç¨‹ä¹‹pthreadã€NSThread.jpg&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡ç”¨æ¥ä»‹ç» iOS å¤šçº¿ç¨‹ä¸­ï¼Œpthreadã€NSThread çš„ä½¿ç”¨æ–¹æ³•åŠå®ç°ã€‚&lt;br&gt;ç¬¬ä¸€éƒ¨åˆ†ï¼špthread çš„ä½¿ç”¨ã€å…¶ä»–ç›¸å…³æ–¹æ³•ã€‚&lt;br&gt;ç¬¬äºŒéƒ¨åˆ†ï¼šNSThread çš„ä½¿ç”¨ã€çº¿ç¨‹ç›¸å…³ç”¨æ³•ã€çº¿ç¨‹çŠ¶æ€æ§åˆ¶æ–¹æ³•ã€çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€çº¿ç¨‹å®‰å…¨å’Œçº¿ç¨‹åŒæ­¥ï¼Œä»¥åŠçº¿ç¨‹çš„çŠ¶æ€è½¬æ¢ç›¸å…³çŸ¥è¯†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="å¤šçº¿ç¨‹" scheme="http://yoursite.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
      <category term="NSThread" scheme="http://yoursite.com/tags/NSThread/"/>
    
  </entry>
  
  <entry>
    <title>iOSå¤šçº¿ç¨‹ä¹‹RunLoop</title>
    <link href="http://yoursite.com/2018/05/10/iOS%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BRunLoop/"/>
    <id>http://yoursite.com/2018/05/10/iOSå¤šçº¿ç¨‹ä¹‹RunLoop/</id>
    <published>2018-05-10T14:32:42.000Z</published>
    <updated>2019-03-25T06:47:21.056Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://upload-images.jianshu.io/upload_images/1276164-2ece40106501a0ee.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="iOSå¤šçº¿ç¨‹ä¹‹RunLoop.jpg"></p><p><strong>æœ¬ç¯‡åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š</strong></p><ul><li>RunLoopç®€ä»‹</li><li>RunLoopç›¸å…³ç±»</li><li>RunLoopåŸç†</li><li>RunLoopå®æˆ˜åº”ç”¨</li></ul><a id="more"></a><h2 id="1-RunLoopç®€ä»‹"><a href="#1-RunLoopç®€ä»‹" class="headerlink" title="1. RunLoopç®€ä»‹"></a>1. RunLoopç®€ä»‹</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯RunLoopï¼Ÿ"><a href="#1-1-ä»€ä¹ˆæ˜¯RunLoopï¼Ÿ" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯RunLoopï¼Ÿ"></a>1.1 ä»€ä¹ˆæ˜¯RunLoopï¼Ÿ</h3><p>å¯ä»¥ç†è§£ä¸ºå­—é¢æ„æ€ï¼š<code>Run</code>è¡¨ç¤ºè¿è¡Œï¼Œ<code>Loop</code>è¡¨ç¤ºå¾ªç¯ã€‚ç»“åˆåœ¨ä¸€èµ·å°±æ˜¯è¿è¡Œçš„å¾ªç¯çš„æ„æ€ã€‚å“ˆå“ˆï¼Œæˆ‘æ›´æ„¿æ„ç¿»è¯‘ä¸ºã€è·‘åœˆã€ã€‚ç›´è§‚ç†è§£å°±åƒæ˜¯ä¸åœçš„è·‘åœˆã€‚</p><p><code>RunLoop</code>å®é™…ä¸Šæ˜¯ä¸€ä¸ª<code>å¯¹è±¡</code>ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨å¾ªç¯ä¸­ç”¨æ¥å¤„ç†ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°çš„å„ç§äº‹ä»¶ï¼ˆæ¯”å¦‚è¯´è§¦æ‘¸äº‹ä»¶ã€UIåˆ·æ–°äº‹ä»¶ã€å®šæ—¶å™¨äº‹ä»¶ã€Selectoräº‹ä»¶ï¼‰ï¼Œä»è€Œä¿æŒç¨‹åºçš„æŒç»­è¿è¡Œï¼›è€Œä¸”åœ¨æ²¡æœ‰äº‹ä»¶å¤„ç†çš„æ—¶å€™ï¼Œä¼šè¿›å…¥ç¡çœ æ¨¡å¼ï¼Œä»è€ŒèŠ‚çœCPUèµ„æºï¼Œæé«˜ç¨‹åºæ€§èƒ½ã€‚</p><h3 id="1-2-RunLoopå’Œçº¿ç¨‹"><a href="#1-2-RunLoopå’Œçº¿ç¨‹" class="headerlink" title="1.2 RunLoopå’Œçº¿ç¨‹"></a>1.2 RunLoopå’Œçº¿ç¨‹</h3><p><code>RunLoop</code>å’Œ<code>çº¿ç¨‹</code>æ˜¯æ¯æ¯ç›¸å…³çš„ï¼Œæˆ‘ä»¬çŸ¥é“çº¿ç¨‹çš„ä½œç”¨æ˜¯ç”¨æ¥æ‰§è¡Œç‰¹å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ï¼Œä½†æ˜¯åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ‰§è¡Œå®Œä¹‹åå°±ä¼šé€€å‡ºï¼Œå°±ä¸èƒ½å†æ‰§è¡Œä»»åŠ¡äº†ã€‚è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦é‡‡ç”¨ä¸€ç§æ–¹å¼æ¥è®©çº¿ç¨‹èƒ½å¤Ÿå¤„ç†ä»»åŠ¡ï¼Œå¹¶ä¸é€€å‡ºã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±æœ‰äº†RunLoopã€‚</p><p>ä¸€æ¡çº¿ç¨‹å¯¹åº”ä¸€ä¸ªRunLoopå¯¹è±¡ï¼Œæ¯æ¡çº¿ç¨‹éƒ½æœ‰å”¯ä¸€ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„RunLoopå¯¹è±¡ã€‚<br>æˆ‘ä»¬åªèƒ½åœ¨å½“å‰çº¿ç¨‹ä¸­æ“ä½œå½“å‰çº¿ç¨‹çš„RunLoopï¼Œè€Œä¸èƒ½å»æ“ä½œå…¶ä»–çº¿ç¨‹çš„RunLoopã€‚<br>RunLoopå¯¹è±¡åœ¨ç¬¬ä¸€æ¬¡è·å–RunLoopæ—¶åˆ›å»ºï¼Œé”€æ¯åˆ™æ˜¯åœ¨çº¿ç¨‹ç»“æŸçš„æ—¶å€™ã€‚<br>ä¸»çº¿ç¨‹çš„RunLoopå¯¹è±¡ç³»ç»Ÿè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬åˆ›å»ºå¥½äº†(åŸç†å¦‚ä¸‹)ï¼Œè€Œå­çº¿ç¨‹çš„RunLoopå¯¹è±¡éœ€è¦æˆ‘ä»¬ä¸»åŠ¨åˆ›å»ºã€‚</p><h3 id="1-3-é»˜è®¤æƒ…å†µä¸‹ä¸»çº¿ç¨‹çš„RunLoopåŸç†"><a href="#1-3-é»˜è®¤æƒ…å†µä¸‹ä¸»çº¿ç¨‹çš„RunLoopåŸç†" class="headerlink" title="1.3 é»˜è®¤æƒ…å†µä¸‹ä¸»çº¿ç¨‹çš„RunLoopåŸç†"></a>1.3 é»˜è®¤æƒ…å†µä¸‹ä¸»çº¿ç¨‹çš„RunLoopåŸç†</h3><p>æˆ‘ä»¬åœ¨å¯åŠ¨ä¸€ä¸ªiOSç¨‹åºçš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè°ƒç”¨åˆ›å»ºé¡¹ç›®æ—¶è‡ªåŠ¨ç”Ÿæˆçš„main.mçš„æ–‡ä»¶ã€‚main.mæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­UIApplicationMainå‡½æ•°å†…éƒ¨å¸®æˆ‘ä»¬å¼€å¯äº†ä¸»çº¿ç¨‹çš„RunLoopï¼Œ<code>UIApplicationMain</code>å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ªæ— çº¿å¾ªç¯çš„ä»£ç ã€‚ä¸Šè¾¹çš„ä»£ç ä¸­å¼€å¯RunLoopçš„è¿‡ç¨‹å¯ä»¥ç®€å•çš„ç†è§£ä¸ºå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;        </span><br><span class="line">    BOOL <span class="built_in">running</span> = YES;</span><br><span class="line">    <span class="built_in">do</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œå„ç§ä»»åŠ¡ï¼Œå¤„ç†å„ç§äº‹ä»¶</span></span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125; <span class="built_in">while</span> (<span class="built_in">running</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šè¾¹å¯çœ‹å‡ºï¼Œç¨‹åºä¸€ç›´åœ¨do-whileå¾ªç¯ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥UIApplicationMainå‡½æ•°ä¸€ç›´æ²¡æœ‰è¿”å›ï¼Œæˆ‘ä»¬åœ¨è¿è¡Œç¨‹åºä¹‹åç¨‹åºä¸ä¼šé©¬ä¸Šé€€å‡ºï¼Œä¼šä¿æŒæŒç»­è¿è¡ŒçŠ¶æ€ã€‚</p><p>ä¸‹å›¾æ˜¯è‹¹æœå®˜æ–¹ç»™å‡ºçš„RunLoopæ¨¡å‹å›¾ã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/1877784-6ab632fc118e31f3.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒRunLoopå°±æ˜¯çº¿ç¨‹ä¸­çš„ä¸€ä¸ªå¾ªç¯ï¼ŒRunLoopåœ¨å¾ªç¯ä¸­ä¼šä¸æ–­æ£€æµ‹ï¼Œé€šè¿‡Input sourcesï¼ˆè¾“å…¥æºï¼‰å’ŒTimer sourcesï¼ˆå®šæ—¶æºï¼‰ä¸¤ç§æ¥æºç­‰å¾…æ¥å—äº‹ä»¶ï¼›ç„¶åå¯¹æ¥å—åˆ°çš„äº‹ä»¶é€šçŸ¥çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¹¶åœ¨æ²¡æœ‰äº‹ä»¶çš„æ—¶å€™è¿›è¡Œä¼‘æ¯ã€‚</p><h2 id="2-RunLoopç›¸å…³ç±»"><a href="#2-RunLoopç›¸å…³ç±»" class="headerlink" title="2. RunLoopç›¸å…³ç±»"></a>2. RunLoopç›¸å…³ç±»</h2><p>ä¸‹é¢æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹Core Foundationæ¡†æ¶ä¸‹å…³äºRunLoopçš„5ä¸ªç±»ï¼Œåªæœ‰å¼„æ‡‚è¿™å‡ ä¸ªç±»çš„å«ä¹‰ï¼Œæˆ‘ä»¬æ‰èƒ½æ·±å…¥äº†è§£RunLoopè¿è¡Œæœºåˆ¶ã€‚</p><ul><li>CFRunLoopRefï¼šä»£è¡¨RunLoopçš„å¯¹è±¡</li><li>CFRunLoopModeRefï¼šRunLoopçš„è¿è¡Œæ¨¡å¼</li><li>CFRunLoopSourceRefï¼šå°±æ˜¯RunLoopæ¨¡å‹å›¾ä¸­æåˆ°çš„è¾“å…¥æº/äº‹ä»¶æº</li><li>CFRunLoopTimerRefï¼šå°±æ˜¯RunLoopæ¨¡å‹å›¾ä¸­æåˆ°çš„å®šæ—¶æº</li><li>CFRunLoopObserverRefï¼šè§‚å¯Ÿè€…ï¼Œèƒ½å¤Ÿç›‘å¬RunLoopçš„çŠ¶æ€æ”¹å˜</li></ul><p>ä¸‹è¾¹è¯¦ç»†è®²è§£ä¸‹å‡ ç§ç±»çš„å…·ä½“å«ä¹‰å’Œå…³ç³»ã€‚</p><p>å…ˆæ¥çœ‹ä¸€å¼ è¡¨ç¤ºè¿™5ä¸ªç±»çš„å…³ç³»å›¾ï¼ˆæ¥æºï¼š<a href="https://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="noopener">https://blog.ibireme.com/2015/05/18/runloop/</a>ï¼‰ã€‚<br><img src="https://blog.ibireme.com/wp-content/uploads/2015/05/RunLoop_0.png" alt=""></p><p>æ¥ç€æ¥è®²è§£è¿™5ä¸ªç±»çš„ç›¸äº’å…³ç³»ï¼ˆæ¥æºï¼š<a href="https://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="noopener">https://blog.ibireme.com/2015/05/18/runloop/</a>ï¼‰ï¼Œè¿™ç¯‡æ–‡ç« æ€»ç»“çš„ç‰¹åˆ«å¥½ï¼Œå°±æ‹¿æ¥å‚è€ƒä¸€ä¸‹ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥å»çœ‹çœ‹ï¼Œå†™çš„å¾ˆå¥½ã€‚</p><p>ä¸€ä¸ªRunLoopå¯¹è±¡ï¼ˆCFRunLoopRefï¼‰ä¸­åŒ…å«è‹¥å¹²ä¸ªè¿è¡Œæ¨¡å¼ï¼ˆCFRunLoopModeRefï¼‰ã€‚è€Œæ¯ä¸€ä¸ªè¿è¡Œæ¨¡å¼ä¸‹åˆåŒ…å«è‹¥å¹²ä¸ªè¾“å…¥æºï¼ˆCFRunLoopSourceRefï¼‰ã€å®šæ—¶æºï¼ˆCFRunLoopTimerRefï¼‰ã€è§‚å¯Ÿè€…ï¼ˆCFRunLoopObserverRefï¼‰ã€‚</p><ul><li>æ¯æ¬¡RunLoopå¯åŠ¨æ—¶ï¼Œåªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ªè¿è¡Œæ¨¡å¼ï¼ˆCFRunLoopModeRefï¼‰ï¼Œè¿™ä¸ªè¿è¡Œæ¨¡å¼ï¼ˆCFRunLoopModeRefï¼‰è¢«ç§°ä½œCurrentModeã€‚</li><li>å¦‚æœéœ€è¦åˆ‡æ¢è¿è¡Œæ¨¡å¼ï¼ˆCFRunLoopModeRefï¼‰ï¼Œåªèƒ½é€€å‡ºLoopï¼Œå†é‡æ–°æŒ‡å®šä¸€ä¸ªè¿è¡Œæ¨¡å¼ï¼ˆCFRunLoopModeRefï¼‰è¿›å…¥ã€‚</li><li>è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„çš„è¾“å…¥æºï¼ˆCFRunLoopSourceRefï¼‰ã€å®šæ—¶æºï¼ˆCFRunLoopTimerRefï¼‰ã€è§‚å¯Ÿè€…ï¼ˆCFRunLoopObserverRefï¼‰ï¼Œè®©å…¶äº’ä¸å½±å“ã€‚</li></ul><p><strong>ä¸‹è¾¹æˆ‘ä»¬æ¥è¯¦ç»†è®²è§£ä¸‹è¿™äº”ä¸ªç±»ï¼š</strong></p><h3 id="2-1-CFRunLoopRef"><a href="#2-1-CFRunLoopRef" class="headerlink" title="2.1 CFRunLoopRef"></a>2.1 CFRunLoopRef</h3><p>CFRunLoopRefå°±æ˜¯Core Foundationæ¡†æ¶ä¸‹RunLoopå¯¹è±¡ç±»ã€‚æˆ‘ä»¬å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥è·å–RunLoopå¯¹è±¡ï¼š</p><ul><li>Core Foundation<ul><li>CFRunLoopGetCurrent(); // è·å¾—å½“å‰çº¿ç¨‹çš„RunLoopå¯¹è±¡</li><li>CFRunLoopGetMain(); // è·å¾—ä¸»çº¿ç¨‹çš„RunLoopå¯¹è±¡</li></ul></li></ul><p>å½“ç„¶ï¼Œåœ¨Foundationæ¡†æ¶ä¸‹è·å–RunLoopå¯¹è±¡ç±»çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li>Foundation<ul><li>[NSRunLoop currentRunLoop]; // è·å¾—å½“å‰çº¿ç¨‹çš„RunLoopå¯¹è±¡</li><li>[NSRunLoop mainRunLoop]; // è·å¾—ä¸»çº¿ç¨‹çš„RunLoopå¯¹è±¡</li></ul></li></ul><h3 id="2-2-CFRunLoopModeRef"><a href="#2-2-CFRunLoopModeRef" class="headerlink" title="2.2 CFRunLoopModeRef"></a>2.2 CFRunLoopModeRef</h3><p>ç³»ç»Ÿé»˜è®¤å®šä¹‰äº†å¤šç§è¿è¡Œæ¨¡å¼ï¼ˆCFRunLoopModeRefï¼‰ï¼Œå¦‚ä¸‹ï¼š</p><ol><li><strong>kCFRunLoopDefaultMode</strong>ï¼šAppçš„é»˜è®¤è¿è¡Œæ¨¡å¼ï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ªè¿è¡Œæ¨¡å¼ä¸‹è¿è¡Œ</li><li><strong>UITrackingRunLoopMode</strong>ï¼šè·Ÿè¸ªç”¨æˆ·äº¤äº’äº‹ä»¶ï¼ˆç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»–Modeå½±å“ï¼‰</li><li>UIInitializationRunLoopModeï¼šåœ¨åˆšå¯åŠ¨Appæ—¶ç¬¬è¿›å…¥çš„ç¬¬ä¸€ä¸ª Modeï¼Œå¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨</li><li>GSEventReceiveRunLoopModeï¼šæ¥å—ç³»ç»Ÿå†…éƒ¨äº‹ä»¶ï¼Œé€šå¸¸ç”¨ä¸åˆ°</li><li><strong>kCFRunLoopCommonModes</strong>ï¼šä¼ªæ¨¡å¼ï¼Œä¸æ˜¯ä¸€ç§çœŸæ­£çš„è¿è¡Œæ¨¡å¼ï¼ˆåè¾¹ä¼šç”¨åˆ°ï¼‰</li></ol><p>å…¶ä¸­<strong>kCFRunLoopDefaultMode</strong>ã€<strong>UITrackingRunLoopMode</strong>ã€<strong>kCFRunLoopCommonModes</strong>æ˜¯æˆ‘ä»¬å¼€å‘ä¸­éœ€è¦ç”¨åˆ°çš„æ¨¡å¼ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•æˆ‘ä»¬åœ¨ <strong>2.3 CFRunLoopTimerRef</strong> ä¸­ç»“åˆCFRunLoopTimerRefæ¥æ¼”ç¤ºè¯´æ˜ã€‚</p><h3 id="2-3-CFRunLoopTimerRef"><a href="#2-3-CFRunLoopTimerRef" class="headerlink" title="2.3 CFRunLoopTimerRef"></a>2.3 CFRunLoopTimerRef</h3><p>CFRunLoopTimerRefæ˜¯å®šæ—¶æºï¼ˆRunLoopæ¨¡å‹å›¾ä¸­æåˆ°è¿‡ï¼‰ï¼Œç†è§£ä¸ºåŸºäºæ—¶é—´çš„è§¦å‘å™¨ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯NSTimerï¼ˆå“ˆå“ˆï¼Œè¿™ä¸ªç†è§£å°±ç®€å•äº†å§ï¼‰ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥æ¼”ç¤ºä¸‹CFRunLoopModeRefå’ŒCFRunLoopTimerRefç»“åˆçš„ä½¿ç”¨ç”¨æ³•ï¼Œä»è€ŒåŠ æ·±ç†è§£ã€‚</p><ol><li>é¦–å…ˆæˆ‘ä»¬æ–°å»ºä¸€ä¸ªiOSé¡¹ç›®ï¼Œåœ¨Main.storyboardä¸­æ‹–å…¥ä¸€ä¸ªText Viewã€‚</li><li>åœ¨ViewController.mæ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç ï¼Œæ¥æ¼”ç¤ºã€‚</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œçº¦å®šä¸¤ç§’ä¹‹åè°ƒç”¨selfçš„runæ–¹æ³•</span></span><br><span class="line">    <span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:<span class="number">2.0</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(run) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å®šæ—¶å™¨æ·»åŠ åˆ°å½“å‰RunLoopçš„NSDefaultRunLoopModeä¸‹</span></span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"---run"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>ç„¶åè¿è¡Œï¼Œè¿™æ—¶å€™æˆ‘ä»¬å‘ç°å¦‚æœæˆ‘ä»¬ä¸å¯¹æ¨¡æ‹Ÿå™¨è¿›è¡Œä»»ä½•æ“ä½œçš„è¯ï¼Œå®šæ—¶å™¨ä¼šç¨³å®šçš„æ¯éš”2ç§’è°ƒç”¨runæ–¹æ³•æ‰“å°ã€‚</li><li>ä½†æ˜¯å½“æˆ‘ä»¬æ‹–åŠ¨Text Viewæ»šåŠ¨æ—¶ï¼Œæˆ‘ä»¬å‘ç°ï¼šrunæ–¹æ³•ä¸æ‰“å°äº†ï¼Œä¹Ÿå°±æ˜¯è¯´NSTimerä¸å·¥ä½œäº†ã€‚è€Œå½“æˆ‘ä»¬æ¾å¼€é¼ æ ‡çš„æ—¶å€™ï¼ŒNSTimerå°±åˆå¼€å§‹æ­£å¸¸å·¥ä½œäº†ã€‚</li></ol><p>è¿™æ˜¯å› ä¸ºï¼š</p><ul><li>å½“æˆ‘ä»¬ä¸åšä»»ä½•æ“ä½œçš„æ—¶å€™ï¼ŒRunLoopå¤„äºNSDefaultRunLoopModeä¸‹ã€‚</li><li>è€Œå½“æˆ‘ä»¬æ‹–åŠ¨Text Viewçš„æ—¶å€™ï¼ŒRunLoopå°±ç»“æŸNSDefaultRunLoopModeï¼Œåˆ‡æ¢åˆ°äº†UITrackingRunLoopModeæ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªæ¨¡å¼ä¸‹æ²¡æœ‰æ·»åŠ NSTimerï¼Œæ‰€ä»¥æˆ‘ä»¬çš„NSTimerå°±ä¸å·¥ä½œäº†ã€‚</li><li>ä½†å½“æˆ‘ä»¬æ¾å¼€é¼ æ ‡çš„æ—¶å€™ï¼ŒRunLoopå°±ç»“æŸUITrackingRunLoopModeæ¨¡å¼ï¼Œåˆåˆ‡æ¢å›NSDefaultRunLoopModeæ¨¡å¼ï¼Œæ‰€ä»¥NSTimerå°±åˆå¼€å§‹æ­£å¸¸å·¥ä½œäº†ã€‚</li></ul><p>ä½ å¯ä»¥è¯•ç€å°†ä¸Šè¿°ä»£ç ä¸­çš„<code>[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSDefaultRunLoopMode];</code>è¯­å¥æ¢ä¸º<code>[[NSRunLoop currentRunLoop] addTimer:timer forMode:UITrackingRunLoopMode];</code>ï¼Œä¹Ÿå°±æ˜¯å°†å®šæ—¶å™¨æ·»åŠ åˆ°å½“å‰RunLoopçš„UITrackingRunLoopModeä¸‹ï¼Œä½ å°±ä¼šå‘ç°å®šæ—¶å™¨åªä¼šåœ¨æ‹–åŠ¨Text Viewçš„æ¨¡å¼ä¸‹å·¥ä½œï¼Œè€Œä¸åšæ“ä½œçš„æ—¶å€™å®šæ—¶å™¨å°±ä¸å·¥ä½œã€‚</p><p>é‚£éš¾é“æˆ‘ä»¬å°±ä¸èƒ½åœ¨è¿™ä¸¤ç§æ¨¡å¼ä¸‹è®©NSTimeréƒ½èƒ½æ­£å¸¸å·¥ä½œå—ï¼Ÿ</p><p>å½“ç„¶å¯ä»¥ï¼Œè¿™å°±ç”¨åˆ°äº†æˆ‘ä»¬ä¹‹å‰è¯´è¿‡çš„<strong>ä¼ªæ¨¡å¼ï¼ˆkCFRunLoopCommonModesï¼‰</strong>ï¼Œè¿™å…¶å®ä¸æ˜¯ä¸€ç§çœŸå®çš„æ¨¡å¼ï¼Œè€Œæ˜¯ä¸€ç§æ ‡è®°æ¨¡å¼ï¼Œæ„æ€å°±æ˜¯å¯ä»¥åœ¨æ‰“ä¸ŠCommon Modesæ ‡è®°çš„æ¨¡å¼ä¸‹è¿è¡Œã€‚</p><p>é‚£ä¹ˆå“ªäº›æ¨¡å¼è¢«æ ‡è®°ä¸Šäº†Common Modeså‘¢ï¼Ÿ</p><p><strong>NSDefaultRunLoopMode</strong> å’Œ <strong>UITrackingRunLoopMode</strong>ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åªè¦æˆ‘ä»¬å°†NSTimeræ·»åŠ åˆ°å½“å‰RunLoopçš„kCFRunLoopCommonModesï¼ˆFoundationæ¡†æ¶ä¸‹ä¸ºNSRunLoopCommonModesï¼‰ä¸‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©NSTimeråœ¨ä¸åšæ“ä½œå’Œæ‹–åŠ¨Text Viewä¸¤ç§æƒ…å†µä¸‹æ„‰å¿«çš„æ­£å¸¸å·¥ä½œäº†ã€‚</p><p>å…·ä½“åšæ³•å°±æ˜¯è®²æ·»åŠ è¯­å¥æ”¹ä¸º<code>[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];</code></p><p>æ—¢ç„¶è®²åˆ°äº†NSTimerï¼Œè¿™é‡Œé¡ºä¾¿è®²ä¸‹NSTimerä¸­çš„<code>scheduledTimerWithTimeInterval</code>æ–¹æ³•å’ŒRunLoopçš„å…³ç³»ã€‚æ·»åŠ ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NSTimer <span class="string">scheduledTimerWithTimeInterval:</span><span class="number">2.0</span> <span class="string">target:</span>self <span class="string">selector:</span><span class="meta">@selector</span>(run) <span class="string">userInfo:</span>nil <span class="string">repeats:</span>YES];</span><br></pre></td></tr></table></figure><p>è¿™å¥ä»£ç è°ƒç”¨äº†scheduledTimerè¿”å›çš„å®šæ—¶å™¨ï¼ŒNSTimerä¼šè‡ªåŠ¨è¢«åŠ å…¥åˆ°äº†RunLoopçš„NSDefaultRunLoopModeæ¨¡å¼ä¸‹ã€‚è¿™å¥ä»£ç ç›¸å½“äºä¸‹é¢ä¸¤å¥ä»£ç ï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NSTimer *timer = [NSTimer <span class="string">timerWithTimeInterval:</span><span class="number">2.0</span> <span class="string">target:</span>self <span class="string">selector:</span><span class="meta">@selector</span>(run) <span class="string">userInfo:</span>nil <span class="string">repeats:</span>YES];</span><br><span class="line">[[NSRunLoop currentRunLoop] <span class="string">addTimer:</span>timer <span class="string">forMode:</span>NSDefaultRunLoopMode];</span><br></pre></td></tr></table></figure><h3 id="2-4-CFRunLoopSourceRef"><a href="#2-4-CFRunLoopSourceRef" class="headerlink" title="2.4 CFRunLoopSourceRef"></a>2.4 CFRunLoopSourceRef</h3><p>CFRunLoopSourceRefæ˜¯äº‹ä»¶æºï¼ˆRunLoopæ¨¡å‹å›¾ä¸­æåˆ°è¿‡ï¼‰ï¼ŒCFRunLoopSourceRefæœ‰ä¸¤ç§åˆ†ç±»æ–¹æ³•ã€‚</p><ul><li><p>ç¬¬ä¸€ç§æŒ‰ç…§å®˜æ–¹æ–‡æ¡£æ¥åˆ†ç±»ï¼ˆå°±åƒRunLoopæ¨¡å‹å›¾ä¸­é‚£æ ·ï¼‰ï¼š</p><ul><li>Port-Based Sourcesï¼ˆåŸºäºç«¯å£ï¼‰</li><li>Custom Input Sourcesï¼ˆè‡ªå®šä¹‰ï¼‰</li><li>Cocoa Perform Selector Sources</li></ul></li><li><p>ç¬¬äºŒç§æŒ‰ç…§å‡½æ•°è°ƒç”¨æ ˆæ¥åˆ†ç±»ï¼š</p><ul><li>Source0 ï¼šéåŸºäºPort</li><li>Source1ï¼šåŸºäºPortï¼Œé€šè¿‡å†…æ ¸å’Œå…¶ä»–çº¿ç¨‹é€šä¿¡ï¼Œæ¥æ”¶ã€åˆ†å‘ç³»ç»Ÿäº‹ä»¶</li></ul></li></ul><p>è¿™ä¸¤ç§åˆ†ç±»æ–¹å¼å…¶å®æ²¡æœ‰åŒºåˆ«ï¼Œåªä¸è¿‡ç¬¬ä¸€ç§æ˜¯é€šè¿‡å®˜æ–¹ç†è®ºæ¥åˆ†ç±»ï¼Œç¬¬äºŒç§æ˜¯åœ¨å®é™…åº”ç”¨ä¸­é€šè¿‡è°ƒç”¨å‡½æ•°æ¥åˆ†ç±»ã€‚</p><p>ä¸‹è¾¹æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­å¤§è‡´æ¥äº†è§£ä¸€ä¸‹å‡½æ•°è°ƒç”¨æ ˆå’ŒSourceã€‚</p><ol><li>åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­çš„Main.storyboardä¸­æ·»åŠ ä¸€ä¸ªButtonæŒ‰é’®ï¼Œå¹¶æ·»åŠ ç‚¹å‡»åŠ¨ä½œã€‚</li><li>ç„¶ååœ¨ç‚¹å‡»åŠ¨ä½œçš„ä»£ç ä¸­åŠ å…¥ä¸€å¥è¾“å‡ºè¯­å¥ï¼Œå¹¶æ‰“ä¸Šæ–­ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://upload-images.jianshu.io/upload_images/1877784-f801715c95de19f4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></li><li>ç„¶åè¿è¡Œç¨‹åºï¼Œå¹¶ç‚¹å‡»æŒ‰é’®ã€‚</li><li>ç„¶ååœ¨é¡¹ç›®ä¸­å•å‡»ä¸‹å›¾çº¢è‰²éƒ¨åˆ†ã€‚<br><img src="https://upload-images.jianshu.io/upload_images/1877784-970c15ff611d4d6d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></li><li>å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„å°±æ˜¯ç‚¹å‡»äº‹ä»¶äº§ç”Ÿçš„å‡½æ•°è°ƒç”¨æ ˆã€‚<br><img src="https://upload-images.jianshu.io/upload_images/1877784-c014e77adce248c6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></li></ol><p>æ‰€ä»¥ï¼Œç‚¹å‡»äº‹ä»¶æ˜¯è¿™æ ·æ¥çš„ï¼š</p><ol><li><p>é¦–å…ˆå¯åŠ¨ç¨‹åºï¼Œè°ƒç”¨16è¡Œçš„mainå‡½æ•°ï¼Œmainå‡½æ•°è°ƒç”¨15è¡Œçš„UIApplicationMainå‡½æ•°ï¼Œç„¶åä¸€ç›´å¾€ä¸Šè°ƒç”¨å‡½æ•°ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°0è¡Œçš„BtnClickå‡½æ•°ï¼Œå³ç‚¹å‡»å‡½æ•°ã€‚</p></li><li><p>åŒæ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°11è¡Œä¸­æœ‰Source0ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ç‚¹å‡»å‡½æ•°æ˜¯å±äºSource0å‡½æ•°çš„ï¼Œç‚¹å‡»äº‹ä»¶å°±æ˜¯åœ¨Source0ä¸­å¤„ç†çš„ã€‚</p></li><li><p>è€Œè‡³äºSource1ï¼Œåˆ™æ˜¯ç”¨æ¥æ¥æ”¶ã€åˆ†å‘ç³»ç»Ÿäº‹ä»¶ï¼Œç„¶ååœ¨åˆ†å‘åˆ°Source0ä¸­å¤„ç†çš„ã€‚</p></li></ol><h3 id="2-5-CFRunLoopObserverRef"><a href="#2-5-CFRunLoopObserverRef" class="headerlink" title="2.5 CFRunLoopObserverRef"></a>2.5 CFRunLoopObserverRef</h3><p>CFRunLoopObserveræ˜¯è§‚å¯Ÿè€…ï¼Œç”¨æ¥ç›‘å¬RunLoopçš„çŠ¶æ€æ”¹å˜ã€‚</p><p>CFRunLoopObserverå¯ä»¥ç›‘å¬çš„çŠ¶æ€æ”¹å˜æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;</span><br><span class="line">    kCFRunLoopEntry = (<span class="number">1</span>UL &lt;&lt; <span class="number">0</span>),               <span class="comment">// å³å°†è¿›å…¥Loopï¼š1</span></span><br><span class="line">    kCFRunLoopBeforeTimers = (<span class="number">1</span>UL &lt;&lt; <span class="number">1</span>),        <span class="comment">// å³å°†å¤„ç†Timerï¼š2    </span></span><br><span class="line">    kCFRunLoopBeforeSources = (<span class="number">1</span>UL &lt;&lt; <span class="number">2</span>),       <span class="comment">// å³å°†å¤„ç†Sourceï¼š4</span></span><br><span class="line">    kCFRunLoopBeforeWaiting = (<span class="number">1</span>UL &lt;&lt; <span class="number">5</span>),       <span class="comment">// å³å°†è¿›å…¥ä¼‘çœ ï¼š32</span></span><br><span class="line">    kCFRunLoopAfterWaiting = (<span class="number">1</span>UL &lt;&lt; <span class="number">6</span>),        <span class="comment">// å³å°†ä»ä¼‘çœ ä¸­å”¤é†’ï¼š64</span></span><br><span class="line">    kCFRunLoopExit = (<span class="number">1</span>UL &lt;&lt; <span class="number">7</span>),                <span class="comment">// å³å°†ä»Loopä¸­é€€å‡ºï¼š128</span></span><br><span class="line">    kCFRunLoopAllActivities = <span class="number">0x0FFFFFFF</span>U       <span class="comment">// ç›‘å¬å…¨éƒ¨çŠ¶æ€æ”¹å˜  </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸‹è¾¹æˆ‘ä»¬é€šè¿‡ä»£ç æ¥ç›‘å¬ä¸‹RunLoopä¸­çš„çŠ¶æ€æ”¹å˜ã€‚</p><ol><li>åœ¨viewController.mä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ã€‚</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºè§‚å¯Ÿè€…</span></span><br><span class="line">    <span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreateWithHandler</span>(<span class="built_in">CFAllocatorGetDefault</span>(), kCFRunLoopAllActivities, <span class="literal">YES</span>, <span class="number">0</span>, ^(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜---%zd"</span>,activity);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ è§‚å¯Ÿè€…åˆ°å½“å‰RunLoopä¸­</span></span><br><span class="line">    <span class="built_in">CFRunLoopAddObserver</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), observer, kCFRunLoopDefaultMode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾observerï¼Œæœ€åæ·»åŠ å®Œéœ€è¦é‡Šæ”¾æ‰</span></span><br><span class="line">    <span class="built_in">CFRelease</span>(observer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>ç„¶åè¿è¡Œï¼Œçœ‹ä¸‹æ‰“å°ç»“æœ:</li></ol><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.694917<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-2</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.695057<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-4</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.695230<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-2</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.695338<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-4</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.696426<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-2</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.696564<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-4</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.696686<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-2</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.696784<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-4</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.696904<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-32</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.713356<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-64</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.713527<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-2</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.713655<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-4</span></span><br><span class="line">2018<span class="string">-05</span><span class="string">-21</span> 14:10:18.713759<span class="string">+0800</span> RunLoop[2305:184915] ç›‘å¬åˆ°RunLoopå‘ç”Ÿæ”¹å˜--<span class="string">-32</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°RunLoopçŠ¶æ€åœ¨ä¸æ–­çš„å˜åŒ–ï¼Œæœ€ç»ˆå˜æˆäº†çŠ¶æ€32ï¼Œä¹Ÿå°±æ˜¯å³å°†è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œè¯´æ˜RunLoopä¹‹åå°±ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ã€‚</p><h2 id="3-RunLoopåŸç†"><a href="#3-RunLoopåŸç†" class="headerlink" title="3.RunLoopåŸç†"></a>3.RunLoopåŸç†</h2><iframe name="iframe_a"></iframe><p>å¥½äº†ï¼Œäº”ä¸ªç±»éƒ½è®²è§£å®Œäº†ï¼Œä¸‹è¾¹å¼€å§‹æ”¾å¤§æ‹›äº†ã€‚è¿™ä¸‹æˆ‘ä»¬å°±å¯ä»¥æ¥ç†è§£RunLoopçš„è¿è¡Œé€»è¾‘äº†ã€‚</p><p>ä¸‹è¾¹ä¸Šä¸€å¼ ä¹‹å‰æåˆ°çš„æ–‡ç« ä¸­åšä¸»æä¾›çš„è¿è¡Œé€»è¾‘å›¾<br><img src="https://upload-images.jianshu.io/upload_images/1877784-94c6cdb3a7864593.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>è¿™å¼ å›¾å¯¹äºæˆ‘ä»¬ç†è§£RunLoopæ¥è¯´å¤ªæœ‰å¸®åŠ©äº†ï¼Œä¸‹è¾¹æˆ‘ä»¬å¯ä»¥æ¥è¯´ä¸‹å®˜æ–¹æ–‡æ¡£ç»™æˆ‘ä»¬çš„RunLoopé€»è¾‘ã€‚</p><p>åœ¨æ¯æ¬¡è¿è¡Œå¼€å¯RunLoopçš„æ—¶å€™ï¼Œæ‰€åœ¨çº¿ç¨‹çš„RunLoopä¼šè‡ªåŠ¨å¤„ç†ä¹‹å‰æœªå¤„ç†çš„äº‹ä»¶ï¼Œå¹¶ä¸”é€šçŸ¥ç›¸å…³çš„è§‚å¯Ÿè€…ã€‚</p><p>å…·ä½“é¡ºåºå¦‚ä¸‹ï¼š</p><ol><li>é€šçŸ¥è§‚å¯Ÿè€…RunLoopå·²ç»å¯åŠ¨</li><li>é€šçŸ¥è§‚å¯Ÿè€…å³å°†è¦å¼€å§‹çš„å®šæ—¶å™¨</li><li>é€šçŸ¥è§‚å¯Ÿè€…ä»»ä½•å³å°†è¦å¯åŠ¨çš„éåŸºäºç«¯å£çš„æº</li><li>å¯åŠ¨ä»»ä½•å‡†å¤‡å¥½çš„éåŸºäºç«¯å£çš„æº</li><li>å¦‚æœåŸºäºç«¯å£çš„æºå‡†å¤‡å¥½å¹¶å¤„äºç­‰å¾…çŠ¶æ€ï¼Œç«‹å³å¯åŠ¨ï¼Œå¹¶è¿›å…¥æ­¥éª¤9</li><li>é€šçŸ¥è§‚å¯Ÿè€…çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€</li><li>å°†çº¿ç¨‹ç½®äºä¼‘çœ ç›´åˆ°ä»»ä¸€ä¸‹é¢çš„æ—¶é—´å‘ç”Ÿï¼š<ul><li>æŸä¸€äº‹ä»¶åˆ°è¾¾åŸºäºç«¯å£çš„æº</li><li>å®šæ—¶å™¨å¯åŠ¨</li><li>RunLoopè®¾ç½®çš„æ—¶é—´å·²ç»è¶…æ—¶</li><li>RunLoopè¢«æ˜¾ç¤ºå”¤é†’</li></ul></li><li>é€šçŸ¥è§‚å¯Ÿè€…çº¿ç¨‹å³å°†è¢«å”¤é†’</li><li>å¤„ç†æœªå¤„ç†çš„äº‹ä»¶<ul><li>å¦‚æœç”¨æˆ·å®šä¹‰çš„å®šæ—¶å™¨å¯åŠ¨ï¼Œå¤„ç†å®šæ—¶å™¨äº‹ä»¶å¹¶é‡å¯RunLoopã€‚è¿›å…¥æ­¥éª¤2</li><li>å¦‚æœè¾“å…¥æºå¯åŠ¨ï¼Œä¼ é€’ç›¸åº”çš„æ¶ˆæ¯</li><li>å¦‚æœRunLoopè¢«æ˜¾ç¤ºå”¤é†’ä¸”äº‹ä»¶è¿˜æ²¡è¶…æ—¶ï¼Œé‡å¯RunLoopã€‚è¿›å…¥æ­¥éª¤2</li></ul></li><li>é€šçŸ¥è§‚å¯Ÿè€…RunLoopç»“æŸ</li></ol><h2 id="4-RunLoopå®æˆ˜åº”ç”¨"><a href="#4-RunLoopå®æˆ˜åº”ç”¨" class="headerlink" title="4. RunLoopå®æˆ˜åº”ç”¨"></a>4. RunLoopå®æˆ˜åº”ç”¨</h2><p>ä¸‹é¢è®²ä¸€ä¸‹RunLoopçš„å‡ ç§åº”ç”¨ã€‚</p><h3 id="4-1-NSTimerçš„ä½¿ç”¨"><a href="#4-1-NSTimerçš„ä½¿ç”¨" class="headerlink" title="4.1 NSTimerçš„ä½¿ç”¨"></a>4.1 NSTimerçš„ä½¿ç”¨</h3><p>NSTimerçš„ä½¿ç”¨æ–¹æ³•åœ¨è®²è§£CFRunLoopTimerRefç±»çš„æ—¶å€™è¯¦ç»†è®²è§£è¿‡ï¼Œå…·ä½“å‚è€ƒä¸Šè¾¹ <strong>2.3 CFRunLoopTimerRef</strong>ã€‚</p><h3 id="4-2-ImageViewæ¨è¿Ÿæ˜¾ç¤º"><a href="#4-2-ImageViewæ¨è¿Ÿæ˜¾ç¤º" class="headerlink" title="4.2 ImageViewæ¨è¿Ÿæ˜¾ç¤º"></a>4.2 ImageViewæ¨è¿Ÿæ˜¾ç¤º</h3><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°è¿™ç§æƒ…å†µï¼š<br>å½“ç•Œé¢ä¸­å«æœ‰UITableViewï¼Œè€Œä¸”æ¯ä¸ªUITableViewCellé‡Œè¾¹éƒ½æœ‰å›¾ç‰‡ã€‚è¿™æ—¶å€™å½“æˆ‘ä»¬æ»šåŠ¨UITableViewçš„æ—¶å€™ï¼Œå¦‚æœæœ‰ä¸€å †çš„å›¾ç‰‡éœ€è¦æ˜¾ç¤ºï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå‡ºç°å¡é¡¿çš„ç°è±¡ã€‚</p><p>æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ¨è¿Ÿå›¾ç‰‡çš„æ˜¾ç¤ºï¼Œä¹Ÿå°±æ˜¯ImageViewæ¨è¿Ÿæ˜¾ç¤ºå›¾ç‰‡ã€‚æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ol><li><strong>ç›‘å¬UIScrollViewçš„æ»šåŠ¨</strong></li></ol><p>å› ä¸ºUITableViewç»§æ‰¿è‡ªUIScrollViewï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›‘å¬UIScrollViewçš„æ»šåŠ¨ï¼Œå®ç°UIScrollViewç›¸å…³delegateå³å¯ã€‚</p><ol start="2"><li><strong>åˆ©ç”¨PerformSelectorè®¾ç½®å½“å‰çº¿ç¨‹çš„RunLoopçš„è¿è¡Œæ¨¡å¼</strong></li></ol><p>åˆ©ç”¨performSelectoræ–¹æ³•ä¸ºUIImageViewè°ƒç”¨setImage:æ–¹æ³•ï¼Œå¹¶åˆ©ç”¨inModeså°†å…¶è®¾ç½®ä¸ºRunLoopä¸‹NSDefaultRunLoopModeè¿è¡Œæ¨¡å¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[self.imageView <span class="string">performSelector:</span><span class="meta">@selector</span>(<span class="string">setImage:</span>) <span class="string">withObject:</span>[UIImage <span class="string">imageNamed:</span>@<span class="string">"tupian"</span>] <span class="string">afterDelay:</span><span class="number">4.0</span> <span class="string">inModes:</span>NSDefaultRunLoopMode];</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ç”¨Demoæ¼”ç¤ºä¸€ä¸‹ï¼š</p><ol><li>åœ¨é¡¹ç›®ä¸­çš„Main.storyboardä¸­æ·»åŠ ä¸€ä¸ªUIImageViewï¼Œå¹¶æ·»åŠ å±æ€§ï¼Œå¹¶ç®€å•æ·»åŠ ä¸€ä¸‹çº¦æŸï¼ˆä¸ç„¶æ— æ³•æ˜¾ç¤ºï¼‰å¦‚ä¸‹å›¾æ‰€ç¤º</li></ol><p><img src="https://upload-images.jianshu.io/upload_images/1877784-8253c4b57f1b674e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><ol start="2"><li>åœ¨é¡¹ç›®ä¸­æ‹–å…¥ä¸€å¼ å›¾ç‰‡ï¼Œå¦‚ä¸‹å›¾</li></ol><p><img src="https://upload-images.jianshu.io/upload_images/1877784-b4777f945878a0b9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><ol start="3"><li>ç„¶åæˆ‘ä»¬åœ¨touchesBeganæ–¹æ³•ä¸­æ·»åŠ ä¸‹é¢çš„ä»£ç </li></ol><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">touchesBegan:</span>(NSSet&lt;UITouch *&gt; *)touches <span class="string">withEvent:</span>(UIEvent *)event</span><br><span class="line">&#123;</span><br><span class="line">    [self.imageView <span class="string">performSelector:</span><span class="meta">@selector</span>(<span class="string">setImage:</span>) <span class="string">withObject:</span>[UIImage <span class="string">imageNamed:</span>@<span class="string">"tupian"</span>] <span class="string">afterDelay:</span><span class="number">4.0</span> <span class="string">inModes:</span>@[NSDefaultRunLoopMode]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>è¿è¡Œç¨‹åºï¼Œç‚¹å‡»ä¸€ä¸‹å±å¹•ï¼Œç„¶åæ‹–åŠ¨UIText Viewï¼Œæ‹–åŠ¨4ç§’ä»¥ä¸Šï¼Œå‘ç°è¿‡äº†4ç§’ä¹‹åï¼ŒUIImageViewè¿˜æ²¡æœ‰æ˜¾ç¤ºå›¾ç‰‡ï¼Œå½“æˆ‘ä»¬æ¾å¼€çš„æ—¶å€™ï¼Œåˆ™æ˜¾ç¤ºå›¾ç‰‡ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</li></ol><p><img src="https://upload-images.jianshu.io/upload_images/1877784-13880540c8c89552.gif?imageMogr2/auto-orient/strip" alt=""></p><p>è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†åœ¨æ‹–åŠ¨å®Œä¹‹åï¼Œåœ¨å»¶è¿Ÿæ˜¾ç¤ºUIImageView.</p><h3 id="4-3-åå°å¸¸é©»çº¿ç¨‹ï¼ˆå¾ˆå¸¸ç”¨ï¼‰"><a href="#4-3-åå°å¸¸é©»çº¿ç¨‹ï¼ˆå¾ˆå¸¸ç”¨ï¼‰" class="headerlink" title="4.3 åå°å¸¸é©»çº¿ç¨‹ï¼ˆå¾ˆå¸¸ç”¨ï¼‰"></a>4.3 åå°å¸¸é©»çº¿ç¨‹ï¼ˆå¾ˆå¸¸ç”¨ï¼‰</h3><p>æˆ‘ä»¬åœ¨å¼€å‘åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œå¦‚æœåå°æ“ä½œç‰¹åˆ«é¢‘ç¹ï¼Œç»å¸¸ä¼šåœ¨å­çº¿ç¨‹åšä¸€äº›è€—æ—¶æ“ä½œï¼ˆä¸‹è½½æ–‡ä»¶ã€åå°æ’­æ”¾éŸ³ä¹ç­‰ï¼‰ï¼Œæˆ‘ä»¬æœ€å¥½è®©è¿™æ¡çº¿ç¨‹æ°¸è¿œå¸¸é©»å†…å­˜ã€‚</p><p>é‚£ä¹ˆæ€ä¹ˆåšå‘¢ï¼Ÿ</p><p>æ·»åŠ ä¸€æ¡ç”¨äºå¸¸é©»å†…å­˜å¼ºå¼•ç”¨çš„å­çº¿ç¨‹ï¼Œåœ¨è¯¥çº¿ç¨‹çš„RunLoopä¸‹æ·»åŠ ä¸€ä¸ªSourcesï¼Œå¼€å¯RunLoopã€‚</p><p>å…·ä½“å®ç°è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>åœ¨é¡¹ç›®çš„viewController.mä¸­æ·»åŠ ä¸€æ¡å¼ºå¼•ç”¨çš„threadçº¿ç¨‹å±æ€§ï¼Œå¦‚ä¸‹ï¼š</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"viewController.h"</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">viewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSThread</span> *thread;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><ol start="2"><li>åœ¨viewDidLoadä¸­åˆ›å»ºçº¿ç¨‹self.threadï¼Œä½¿çº¿ç¨‹å¯åŠ¨å¹¶æ‰§è¡Œrun1æ–¹æ³•</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶è°ƒç”¨run1æ–¹æ³•æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">self</span>.thread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(run1) object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="comment">// å¼€å¯çº¿ç¨‹</span></span><br><span class="line">    [<span class="keyword">self</span>.thread start];    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå†™ä»»åŠ¡</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----run1-----"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ ä¸‹è¾¹ä¸¤å¥ä»£ç ï¼Œå°±å¯ä»¥å¼€å¯RunLoopï¼Œä¹‹åself.threadå°±å˜æˆäº†å¸¸é©»çº¿ç¨‹ï¼Œå¯éšæ—¶æ·»åŠ ä»»åŠ¡ï¼Œå¹¶äº¤äºRunLoopå¤„ç†</span></span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] addPort:[<span class="built_in">NSPort</span> port] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] run];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµ‹è¯•æ˜¯å¦å¼€å¯äº†RunLoopï¼Œå¦‚æœå¼€å¯RunLoopï¼Œåˆ™æ¥ä¸äº†è¿™é‡Œï¼Œå› ä¸ºRunLoopå¼€å¯äº†å¾ªç¯ã€‚</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"æœªå¼€å¯RunLoop"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>è¿è¡Œä¹‹åå‘ç°æ‰“å°äº† <em>â€”-run1â€”-</em>ï¼Œè€Œ <em>æœªå¼€å¯RunLoop</em> åˆ™æœªæ‰“å°ã€‚</li></ol><p>è¿™æ—¶ï¼Œæˆ‘ä»¬å°±å¼€å¯äº†ä¸€æ¡å¸¸é©»çº¿ç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬æ¥è¯•ç€æ·»åŠ å…¶ä»–ä»»åŠ¡ï¼Œé™¤äº†ä¹‹å‰åˆ›å»ºçš„æ—¶å€™è°ƒç”¨äº†run1æ–¹æ³•ï¼Œæˆ‘ä»¬å¦å¤–åœ¨ç‚¹å‡»çš„æ—¶å€™è°ƒç”¨run2æ–¹æ³•</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨touchesBeganä¸­è°ƒç”¨PerformSelectorï¼Œä»è€Œå®ç°åœ¨ç‚¹å‡»å±å¹•çš„æ—¶å€™è°ƒç”¨run2æ–¹æ³•</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="comment">// åˆ©ç”¨performSelectorï¼Œåœ¨self.threadçš„çº¿ç¨‹ä¸­è°ƒç”¨run2æ–¹æ³•æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(run2) onThread:<span class="keyword">self</span>.thread withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"----run2------"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡è¿è¡Œæµ‹è¯•ï¼Œé™¤äº†ä¹‹å‰æ‰“å°çš„<em>â€”-run1â€”-</em>ï¼Œæ¯å½“æˆ‘ä»¬ç‚¹å‡»å±å¹•ï¼Œéƒ½èƒ½è°ƒç”¨<em>â€”-run2â€”-</em>ã€‚<br>è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†å¸¸é©»çº¿ç¨‹çš„éœ€æ±‚ã€‚</p><p>æœ¬æ–‡ç³»è½¬è½½ï¼Œå¦‚æœ‰ä¾µæƒï¼Œå‘ŠçŸ¥æˆ‘åˆ é™¤ã€‚ æ„Ÿè°¢åŸæ–‡ï¼š<a href="https://bujige.net/blog/iOS-Complete-learning-RunLoop.html" target="_blank" rel="noopener">å½»åº•å­¦ä¼šå¤šçº¿ç¨‹ä¹‹ã€RunLoopã€</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-2ece40106501a0ee.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOSå¤šçº¿ç¨‹ä¹‹RunLoop.jpg&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬ç¯‡åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;RunLoopç®€ä»‹&lt;/li&gt;
&lt;li&gt;RunLoopç›¸å…³ç±»&lt;/li&gt;
&lt;li&gt;RunLoopåŸç†&lt;/li&gt;
&lt;li&gt;RunLoopå®æˆ˜åº”ç”¨&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="å¤šçº¿ç¨‹" scheme="http://yoursite.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
      <category term="RunLoop" scheme="http://yoursite.com/tags/RunLoop/"/>
    
  </entry>
  
  <entry>
    <title>è¿½å¿†</title>
    <link href="http://yoursite.com/2017/06/09/%E8%BF%BD%E5%BF%86/"/>
    <id>http://yoursite.com/2017/06/09/è¿½å¿†/</id>
    <published>2017-06-09T09:52:21.000Z</published>
    <updated>2019-03-25T06:56:07.676Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://upload-images.jianshu.io/upload_images/1276164-87da9ec3903a1051.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="115"></p><p><del>ä¸€é¦–æ­Œï¼Œä¸€ä¸ªæ•…äº‹ï¼Œä¸€ä¸ªäººï¼Œä¸€ä¸ªä¸–ç•Œ</del></p><a id="more"></a><p>çªç„¶å¬åˆ°ä¸€é¦–æ­Œ<br>æƒ³èµ·æ˜¯ä½ æ›¾ç»å¾ˆå–œæ¬¢çš„æ­Œ<br>â€œä½ è¯´è¿‡ç‰µäº†æ‰‹å°±ç®—çº¦å®šâ€<br>â€œä½†äº²çˆ±çš„é‚£å¹¶ä¸æ˜¯çˆ±æƒ…â€</p><p>è™½ç„¶è¿™ä¹ˆå¤šå¹´è¿‡å»äº†<br>è™½ç„¶å¥½å‡ å¹´æ²¡è”ç³»äº†<br>ä½†å…³äºä½ çš„ä¸€åˆ‡éƒ½åœ¨é‡åˆ°ç†Ÿæ‚‰çš„ä¸œè¥¿æ—¶ä¸è‡ªç„¶çš„æƒ³èµ·</p><p>æŠŠä½ é€æˆ‘çš„ä¸œè¥¿æ•´ç†èµ·æ¥<br>å½“å¹´æ²¡å‹‡æ°”å¸¦åœ¨èº«è¾¹<br>ä½†åæ¥æœ‹å‹å‘Šè¯‰æˆ‘æŠŠä¸œè¥¿å¼„ä¸¢äº†<br>æˆ‘çš„å†…å¿ƒå‡ ä¹æ˜¯å´©æºƒçš„<br>ä»¿ä½›æ„Ÿè§‰æˆ‘çš„é’æ˜¥è¢«ç„šçƒ§äº†ä¸€èˆ¬<br>æ„Ÿè§‰è‡ªå·±æ°¸è¿œéƒ½ä¸ä¼šå†æ‹¥æœ‰é’æ˜¥</p><p>ç°åœ¨<br>æˆ‘ä»¬æˆäº†æ°¸è¿œçš„é™Œè·¯äºº<br>ä½†æˆ‘ä»¬ä¸€èµ·èµ°è¿‡çš„é’æ˜¥å²æœˆ<br>æˆ‘ä¼šä¸€ç›´è®°å¾—<br>é‚£æ˜¯ç”Ÿå‘½ä¸­æœ€ç¾å¥½çš„éƒ¨åˆ†</p><p>å…¶å®<br>æˆ‘ä¸€ç›´æƒ³å‘Šè¯‰ä½ <br>ç”·äººæ˜¯éœ€è¦æˆé•¿çš„<br>å¦‚æœå½“å¹´æˆ‘æœ‰ä½ é‚£æ ·æˆç†Ÿçš„é«˜åº¦<br>ä¸”ä¸é‚£ä¹ˆæ‡¦å¼±çš„é¢å¯¹ä¸€äº›ç°å®é—®é¢˜<br>ä¹Ÿè®¸â€¦<br>ç½¢äº†â€¦<br>å¦‚æœå°±æ˜¯å¦‚æœ<br>ä¹Ÿè®¸ä¹Ÿåªèƒ½æ˜¯ä¹Ÿè®¸<br>ç°åœ¨æƒ³èµ·é‚£å¥ä¸€ä¸ªç”·äººåœ¨æœ€æ— ç”¨çš„æ—¶å€™<br>é‡åˆ°æƒ³è¦ä¿æŠ¤ä¸€ç”Ÿçš„å¥³äºº<br>å¥ˆä½•å¥ˆä½•</p><p>ç°åœ¨æˆ‘æˆé•¿äº†<br>æˆ‘ä¸åœ¨æ¸´æ±‚é‚£æ ·çš„çˆ±æƒ…<br>æˆ‘ä¹Ÿä»ä¸è§‰å¾—å¹´è¿‘è€Œç«‹å°±å¾—æ‹çˆ±ç»“å©š<br>ä¸€ä¸ªäººçš„æ—¥å­æœ‰ç‚¹å­¤å•<br>ä½†ä¹Ÿè‡ªåœ¨å¿«ä¹</p><p>ç°åœ¨æˆ‘æ²¡æœ‰ä½ çš„æ¶ˆæ¯<br>ä½ ä¸éœ€è¦æˆ‘çš„æ¶ˆæ¯<br>ä½†æˆ‘æ°¸è¿œç¥ç¦ä½ è¿‡çš„æ¯”æˆ‘å¥½<br>ç¥ç¦ä½ ä¸€å®šè¦å¹¸ç¦</p><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=36841953&auto=1&height=66"></iframe>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-87da9ec3903a1051.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;115&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;del&gt;ä¸€é¦–æ­Œï¼Œä¸€ä¸ªæ•…äº‹ï¼Œä¸€ä¸ªäººï¼Œä¸€ä¸ªä¸–ç•Œ&lt;/del&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="æµé‡‘å²æœˆ" scheme="http://yoursite.com/categories/%E6%B5%81%E9%87%91%E5%B2%81%E6%9C%88/"/>
    
    
      <category term="å¿ƒæƒ…" scheme="http://yoursite.com/tags/%E5%BF%83%E6%83%85/"/>
    
  </entry>
  
  <entry>
    <title>swiftå…¥é—¨é¡¹ç›®å®æˆ˜ä¹‹é‡å‘å‡ºå‘</title>
    <link href="http://yoursite.com/2017/05/27/swift%E5%85%A5%E9%97%A8%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%B9%8B%E9%81%87%E5%9D%91%E5%87%BA%E5%9D%91/"/>
    <id>http://yoursite.com/2017/05/27/swiftå…¥é—¨é¡¹ç›®å®æˆ˜ä¹‹é‡å‘å‡ºå‘/</id>
    <published>2017-05-27T07:10:22.000Z</published>
    <updated>2019-03-25T06:58:25.500Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://upload-images.jianshu.io/upload_images/1276164-a15d7ec35d19f5e7.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="101"></p><p>æœ¬ç¯‡ä¸»è¦æ˜¯å…³äº</p><ol><li>åˆå­¦swiftæ—¶ï¼Œç»ƒæ‰‹çš„ä¸€ä¸ªdemo</li><li>é‡åˆ°çš„ä¸€ç‚¹å‘åŠå¦‚ä½•è§£å†³çš„</li></ol><p>æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥çœ‹çœ‹<a href="https://github.com/SPIREJ/XSLC_Swift" target="_blank" rel="noopener">demo</a></p><a id="more"></a><p><strong>ç¯å¢ƒï¼šswiftç‰ˆæœ¬3.0</strong></p><ul><li>é¦–é¡µï¼š<ul><li>é¦–é¡µä¸»è¦ç”±bannerã€collectionViewã€tableView ç»„æˆ</li></ul></li></ul><p><img src="http://upload-images.jianshu.io/upload_images/1276164-8dd445ec88ad80c9.gif?imageMogr2/auto-orient/strip" alt="é¦–é¡µ"></p><ul><li>ç†è´¢é¡µ<ul><li>ç†è´¢åˆ—è¡¨é¡µã€è®¡åˆ’è¯¦æƒ…é¡µä»¥åŠé”®ç›˜ç­‰</li></ul></li></ul><p><img src="http://upload-images.jianshu.io/upload_images/1276164-54ba71800d8ad53a.gif?imageMogr2/auto-orient/strip" alt="ç†è´¢"></p><ul><li>æˆ‘çš„é¡µ<ul><li>collectionView ã€webView</li></ul></li></ul><p><img src="http://upload-images.jianshu.io/upload_images/1276164-dc48d734c996f772.gif?imageMogr2/auto-orient/strip" alt="æˆ‘çš„"></p><ul><li>åˆå­¦è€…ï¼ŒUIå°±è¿™ä¹ˆå¤šï¼Œå°±è¯´è¯´é‡åˆ°çš„ä¸¤ä¸ªå‘å§~<h5 id="ç¬¬ä¸€ä¸ªå‘ï¼Œä½¿ç”¨podå»ºç«‹å·¥ç¨‹æ—¶ç»ˆç«¯å‡ºé”™"><a href="#ç¬¬ä¸€ä¸ªå‘ï¼Œä½¿ç”¨podå»ºç«‹å·¥ç¨‹æ—¶ç»ˆç«¯å‡ºé”™" class="headerlink" title="ç¬¬ä¸€ä¸ªå‘ï¼Œä½¿ç”¨podå»ºç«‹å·¥ç¨‹æ—¶ç»ˆç«¯å‡ºé”™"></a>ç¬¬ä¸€ä¸ªå‘ï¼Œä½¿ç”¨podå»ºç«‹å·¥ç¨‹æ—¶ç»ˆç«¯å‡ºé”™</h5><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pod[!] Unable <span class="built_in">to</span> <span class="built_in">add</span> <span class="keyword">a</span> source <span class="keyword">with</span> url `<span class="keyword">https</span>://github.com/CocoaPods/Specs.git` named `master`.You can</span><br><span class="line"> <span class="keyword">try</span> adding <span class="keyword">it</span> manually <span class="keyword">in</span> `~/.cocoapods/repos` <span class="keyword">or</span> via `pod repo <span class="built_in">add</span>`.</span><br></pre></td></tr></table></figure></li></ul><p>è§£å†³æ–¹æ¡ˆï¼šç»ˆç«¯è¾“å…¥ä»¥ä¸‹å‘½ä»¤<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod repo add <span class="keyword">master</span> <span class="title">https</span>://github.com/CocoaPods/Specs.git</span><br></pre></td></tr></table></figure></p><p>ç„¶åæç¤ºæ‰§è¡Œ<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod <span class="built_in">setup</span></span><br></pre></td></tr></table></figure></p><p>å¦‚æœå‡ºç°<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod[!] The `master` repo is <span class="literal">not</span> <span class="literal">a</span> git repo.</span><br></pre></td></tr></table></figure></p><p>è¿›å…¥/users/ä½ çš„ç”¨æˆ·å/.cocoapods/reposï¼Œåˆ é™¤masteræ–‡ä»¶å¤¹ç„¶åæ‰§è¡Œï¼Œå¦‚æˆ‘è¿™ä¹ˆè¿›å…¥<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> ~<span class="string">/.cocoapods/repos/</span></span><br></pre></td></tr></table></figure></p><p>masteræ–‡ä»¶å¤¹æ˜¯ä¸ªç›®å½•ï¼Œåˆ é™¤æ—¶éœ€è¦è¿ä¸‹é¢çš„åˆ†æ”¯ä¸€èµ·åˆ æ‰<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf ~<span class="regexp">/.cocoapods/</span>repos<span class="regexp">/master</span></span><br></pre></td></tr></table></figure></p><p>åˆ é™¤masterä¹‹åï¼Œå†<code>pod setup</code>,ä¹‹åé…ç½®å¥½ä½ çš„<code>Podfile</code>,æœ€å<code>pod install</code>å°±æˆåŠŸçš„å»ºç«‹äº† åŒåçš„<code>.xcworkspace</code>å·¥ç¨‹äº†<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pod setup</span><br><span class="line"><span class="meta">#</span><span class="bash">å…ˆ <span class="built_in">cd</span> åˆ°ä½ å·¥ç¨‹çš„ç›®å½•</span></span><br><span class="line">pod init</span><br><span class="line">open -a Xcode Podfile</span><br><span class="line"><span class="meta">#</span><span class="bash">æ·»åŠ ä½ éœ€è¦çš„ä¸‰æ–¹åº“</span></span><br><span class="line">pod install</span><br></pre></td></tr></table></figure></p><ul><li>è¿˜æœ‰ä»¥ä¸‹æƒ…å†µï¼š<br>å¦‚æœæ˜¯å®‰è£…å¤šä¸ªXcdoeï¼Œè¿˜éœ€è¦é€‰æ‹©Xcodeçš„è·¯å¾„,åé¢æ˜¯ä½ è‡ªå·±çš„Xcodeè·¯å¾„ï¼Œæ˜¾ç¤ºXcodeåŒ…å†…å®¹å¯æŸ¥çœ‹<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">sudo</span> xcode-<span class="keyword">select </span>-<span class="keyword">switch </span>/Applications/Xcode.app/</span><br></pre></td></tr></table></figure></li></ul><p>åœ¨ç»ˆç«¯é‡Œè¾“å…¥ä¸‹æ–¹å‘½ä»¤å¯ä»¥çŸ¥é“Xcodeçš„è·¯å¾„ï¼š<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcode-<span class="keyword">select</span> -p</span><br></pre></td></tr></table></figure></p><h5 id="ç¬¬äºŒä¸ªå‘ï¼ŒåŠ è½½åŸºäºXIBåˆ›å»ºçš„è‡ªå®šä¹‰æ§ä»¶æ—¶æŠ¥é”™"><a href="#ç¬¬äºŒä¸ªå‘ï¼ŒåŠ è½½åŸºäºXIBåˆ›å»ºçš„è‡ªå®šä¹‰æ§ä»¶æ—¶æŠ¥é”™" class="headerlink" title="ç¬¬äºŒä¸ªå‘ï¼ŒåŠ è½½åŸºäºXIBåˆ›å»ºçš„è‡ªå®šä¹‰æ§ä»¶æ—¶æŠ¥é”™"></a>ç¬¬äºŒä¸ªå‘ï¼ŒåŠ è½½åŸºäºXIBåˆ›å»ºçš„è‡ªå®šä¹‰æ§ä»¶æ—¶æŠ¥é”™</h5><ul><li><p>æˆ‘åƒå†™OCçš„åŸºäºXIBè‡ªå®šä¹‰æ§ä»¶ä¸€æ ·,åˆ›å»ºä¸€ä¸ªåŸºäº<code>UIView</code>çš„æ–°ç±»<code>XSCustomView</code><br><img src="http://upload-images.jianshu.io/upload_images/1276164-1b14c0c6d09230a0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="åˆ›å»ºåŸºäºUIViewçš„æ–°ç±»XSCustomView"></p></li><li><p>åˆ›å»ºä¸€ä¸ªåŒåçš„<code>XIB</code>æ–‡ä»¶<br><img src="http://upload-images.jianshu.io/upload_images/1276164-5cf6d8adcca145fc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="åˆ›å»ºä¸€ä¸ªåŒåçš„XIBæ–‡ä»¶"></p></li><li><p>åƒOCä¸€æ ·ç»™æ–‡ä»¶æŒ‡å®šç±»<br><img src="http://upload-images.jianshu.io/upload_images/1276164-c8a1c91da6af44f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="åƒOCä¸€æ ·ç»™æ–‡ä»¶è¿çº¿"></p></li><li><p>ç„¶ååŠ è½½Viewå°±ä¼šå‡ºé”™</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fatal <span class="keyword">error</span>: init(coder:) has not been implemented: <span class="keyword">file</span> </span><br><span class="line">/è·¯å¾„/XXX.swift, <span class="keyword">line</span> 43</span><br><span class="line">(lldb)</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">- è§£å†³åŠæ³•ï¼ŒæŸ¥äº†å¥½ä¹…èµ„æ–™ï¼Œæ‰¾åˆ°è§£å†³åŠæ³•</span><br><span class="line">swiftæŒ‡å®šç±»ä¸OCç•¥æœ‰ä¸åŒï¼Œswiftéœ€è¦çš„æ˜¯<span class="symbol">`File'</span>s Owner`å½’å±äºå’±ä»¬å®šä¹‰çš„å“ªä¸ªç±»,è€Œä¸‹é¢çš„<span class="keyword">View</span>æ˜¯ä¸éœ€è¦æŒ‡å®šç±»çš„</span><br><span class="line">![è§£å†³é—®é¢˜](http:<span class="comment">//upload-images.jianshu.io/upload_images/1276164-f09189b3807fa34b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span></span><br><span class="line"></span><br><span class="line">- æœ€åå’±ä»¬ä»XIBåŠ è½½<span class="keyword">View</span>å³å¯ï¼Œå¦‚åœ¨custom.swiftæ–‡ä»¶é‡Œæœ‰å¦‚ä¸‹ä»£ç </span><br></pre></td></tr></table></figure></li></ul><p>class XSCustomView: UIView {</p><pre><code>var contentView:UIView!override func awakeFromNib() {    super.awakeFromNib()}override init(frame: CGRect) {    super.init(frame: frame)    contentView = loadFromNib()    addSubview(contentView)}func loadFromNib() -&gt; UIView {    return Bundle.main.loadNibNamed(&quot;XSCustomView&quot;, owner: nil, options: nil)?.first as! UIView}override func layoutSubviews() {    contentView.frame = bounds}required init?(coder aDecoder: NSCoder) {    super.init(coder: aDecoder)    fatalError(&quot;init(coder:) has not been implemented&quot;)}</code></pre><p>}<br><code>`</code></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-a15d7ec35d19f5e7.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;101&quot;&gt;&lt;/p&gt;
&lt;p&gt;æœ¬ç¯‡ä¸»è¦æ˜¯å…³äº&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åˆå­¦swiftæ—¶ï¼Œç»ƒæ‰‹çš„ä¸€ä¸ªdemo&lt;/li&gt;
&lt;li&gt;é‡åˆ°çš„ä¸€ç‚¹å‘åŠå¦‚ä½•è§£å†³çš„&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥çœ‹çœ‹&lt;a href=&quot;https://github.com/SPIREJ/XSLC_Swift&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;demo&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="swift" scheme="http://yoursite.com/tags/swift/"/>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://yoursite.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨swiftä¸­å®ç°ocä¸­çš„åˆ†ç±»</title>
    <link href="http://yoursite.com/2017/05/22/%E5%A6%82%E4%BD%95%E5%9C%A8swift%E4%B8%AD%E5%AE%9E%E7%8E%B0oc%E4%B8%AD%E7%9A%84%E5%88%86%E7%B1%BB/"/>
    <id>http://yoursite.com/2017/05/22/å¦‚ä½•åœ¨swiftä¸­å®ç°ocä¸­çš„åˆ†ç±»/</id>
    <published>2017-05-22T09:02:24.000Z</published>
    <updated>2019-03-25T06:54:45.503Z</updated>
    
    <content type="html"><![CDATA[<p>å¦‚ä½•åœ¨swiftä¸­å®ç°ocçš„<code>category</code>ï¼Ÿ<br>ç¤ºä¾‹:<br>1ã€å¯¹<code>UIView</code>çš„æ‰©å±•<br>2ã€å¯¹<code>UIColor</code>çš„æ‰©å±•</p><a id="more"></a><h4 id="1-æ¦‚å¿µ"><a href="#1-æ¦‚å¿µ" class="headerlink" title="1.æ¦‚å¿µ"></a>1.æ¦‚å¿µ</h4><p>åœ¨ocä¸­ä¸ºäº†å¢å¼ºå·²æœ‰ç±»çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨<code>åˆ†ç±»</code>ã€‚ä½¿ç”¨åˆ†ç±»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸ç ´ååŸæœ‰ç±»çš„ç»“æ„çš„å‰æä¸‹ï¼Œå¯¹åŸæœ‰ç±»è¿›è¡Œæ¨¡å—åŒ–çš„æ‰©å±•ã€‚</p><p>ä½†æ˜¯åœ¨swiftä¸­æ²¡æœ‰åˆ†ç±»è¿™ç§å†™æ³•äº†ã€‚ç›¸å¯¹åº”çš„æ˜¯swiftä¸­åªæœ‰æ‰©å±•(<code>Extensions</code>)ã€‚</p><p>ä¸‹é¢æ˜¯swiftä¸­æ‰©å±•(<code>Extensions</code>)çš„è¯´æ˜:<br>æ‰©å±•å°±æ˜¯å‘ä¸€ä¸ªå·²æœ‰çš„ç±»ã€ç»“æ„ä½“ã€æšä¸¾ç±»å‹æˆ–è€…åè®®ç±»å‹æ·»åŠ æ–°åŠŸèƒ½ï¼ˆ<code>functionality</code>ï¼‰ã€‚è¿™åŒ…æ‹¬åœ¨æ²¡æœ‰æƒé™è·å–åŸå§‹æºä»£ç çš„æƒ…å†µä¸‹æ‰©å±•ç±»å‹çš„èƒ½åŠ›ï¼ˆå³é€†å‘å»ºæ¨¡ï¼‰ã€‚æ‰©å±•å’Œ Objective-C ä¸­çš„åˆ†ç±»ï¼ˆ<code>categories</code>ï¼‰ç±»ä¼¼ã€‚ï¼ˆä¸è¿‡ä¸ Objective-C ä¸åŒçš„æ˜¯ï¼ŒSwift çš„æ‰©å±•æ²¡æœ‰åå­—ã€‚ï¼‰</p><h4 id="2-å¯¹UIViewçš„æ‰©å±•"><a href="#2-å¯¹UIViewçš„æ‰©å±•" class="headerlink" title="2.å¯¹UIViewçš„æ‰©å±•"></a>2.å¯¹UIViewçš„æ‰©å±•</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">extension UIView &#123;</span><br><span class="line">    <span class="comment">// .x</span></span><br><span class="line">    public <span class="selector-tag">var</span> x: CGFloat &#123;</span><br><span class="line">        get &#123;</span><br><span class="line">            return self<span class="selector-class">.frame</span><span class="selector-class">.origin</span><span class="selector-class">.x</span></span><br><span class="line">        &#125;</span><br><span class="line">        set &#123;</span><br><span class="line">            <span class="selector-tag">var</span> rect = self.frame</span><br><span class="line">            rect<span class="selector-class">.origin</span><span class="selector-class">.x</span> = newValue</span><br><span class="line">            self<span class="selector-class">.frame</span> = rect</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// .y</span></span><br><span class="line">    public <span class="selector-tag">var</span> y: CGFloat &#123;</span><br><span class="line">        get &#123;</span><br><span class="line">            return self<span class="selector-class">.frame</span><span class="selector-class">.origin</span><span class="selector-class">.y</span></span><br><span class="line">        &#125;</span><br><span class="line">        set &#123;</span><br><span class="line">            <span class="selector-tag">var</span> rect = self.frame</span><br><span class="line">            rect<span class="selector-class">.origin</span><span class="selector-class">.y</span> = newValue</span><br><span class="line">            self<span class="selector-class">.frame</span> = rect</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// .maxX</span></span><br><span class="line">    public <span class="selector-tag">var</span> maxX: CGFloat &#123;</span><br><span class="line">        get &#123;</span><br><span class="line">            return self<span class="selector-class">.frame</span><span class="selector-class">.maxX</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// .maxY</span></span><br><span class="line">    public <span class="selector-tag">var</span> maxY: CGFloat &#123;</span><br><span class="line">        get &#123;</span><br><span class="line">            return self<span class="selector-class">.frame</span><span class="selector-class">.maxY</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// .centerX</span></span><br><span class="line">    public <span class="selector-tag">var</span> centerX: CGFloat &#123;</span><br><span class="line">        get &#123;</span><br><span class="line">            return self<span class="selector-class">.center</span><span class="selector-class">.x</span></span><br><span class="line">        &#125;</span><br><span class="line">        set &#123;</span><br><span class="line">            self<span class="selector-class">.center</span> = CGPoint(x: newValue, y: self<span class="selector-class">.center</span><span class="selector-class">.y</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// .centerY</span></span><br><span class="line">    public <span class="selector-tag">var</span> centerY: CGFloat &#123;</span><br><span class="line">        get &#123;</span><br><span class="line">            return self<span class="selector-class">.center</span><span class="selector-class">.y</span></span><br><span class="line">        &#125;</span><br><span class="line">        set &#123;</span><br><span class="line">            self<span class="selector-class">.center</span> = CGPoint(x: self<span class="selector-class">.center</span><span class="selector-class">.x</span>, y: newValue)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// .width</span></span><br><span class="line">    public <span class="selector-tag">var</span> <span class="attribute">width</span>: CGFloat &#123;</span><br><span class="line">        get &#123;</span><br><span class="line">            return self<span class="selector-class">.frame</span><span class="selector-class">.size</span><span class="selector-class">.width</span></span><br><span class="line">        &#125;</span><br><span class="line">        set &#123;</span><br><span class="line">            <span class="selector-tag">var</span> rect = self.frame</span><br><span class="line">            rect<span class="selector-class">.size</span><span class="selector-class">.width</span> = newValue</span><br><span class="line">            self<span class="selector-class">.frame</span> = rect</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// .height</span></span><br><span class="line">    public <span class="selector-tag">var</span> <span class="attribute">height</span>: CGFloat &#123;</span><br><span class="line">        get &#123;</span><br><span class="line">            return self<span class="selector-class">.frame</span><span class="selector-class">.size</span><span class="selector-class">.height</span></span><br><span class="line">        &#125;</span><br><span class="line">        set &#123;</span><br><span class="line">            <span class="selector-tag">var</span> rect = self.frame</span><br><span class="line">            rect<span class="selector-class">.size</span><span class="selector-class">.height</span> = newValue</span><br><span class="line">            self<span class="selector-class">.frame</span> = rect</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let <span class="selector-tag">label</span> = UILabel()</span><br><span class="line">        <span class="selector-tag">label</span>.x</span><br><span class="line">        <span class="selector-tag">label</span>.<span class="attribute">width</span></span><br><span class="line">        <span class="selector-tag">label</span>.centerX</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><h4 id="3-å¯¹UIColorçš„æ‰©å±•"><a href="#3-å¯¹UIColorçš„æ‰©å±•" class="headerlink" title="3.å¯¹UIColorçš„æ‰©å±•"></a>3.å¯¹UIColorçš„æ‰©å±•</h4><p>åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸ºrgb</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIColor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">colorWithHex</span><span class="params">(rgb:Int, alpha: CGFloat)</span></span> -&gt; <span class="type">UIColor</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="type">UIColor</span>(red: ((<span class="type">CGFloat</span>)((rgb &amp; <span class="number">0xFF0000</span>) &gt;&gt; <span class="number">16</span>))/<span class="number">255.0</span>, green: ((<span class="type">CGFloat</span>)((rgb &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span>))/<span class="number">255.0</span>, blue: ((<span class="type">CGFloat</span>)(rgb &amp; <span class="number">0xFF</span>)) / <span class="number">255.0</span>, alpha: alpha)        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">UIColor</span><span class="selector-class">.clear</span><span class="selector-class">.colorWithHex</span>(<span class="selector-tag">rgb</span>: 0<span class="selector-tag">x2588dd</span>, <span class="selector-tag">alpha</span>: 1<span class="selector-class">.0</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¦‚ä½•åœ¨swiftä¸­å®ç°ocçš„&lt;code&gt;category&lt;/code&gt;ï¼Ÿ&lt;br&gt;ç¤ºä¾‹:&lt;br&gt;1ã€å¯¹&lt;code&gt;UIView&lt;/code&gt;çš„æ‰©å±•&lt;br&gt;2ã€å¯¹&lt;code&gt;UIColor&lt;/code&gt;çš„æ‰©å±•&lt;/p&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="swift" scheme="http://yoursite.com/tags/swift/"/>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://yoursite.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>å½’æœŸä¸é‡</title>
    <link href="http://yoursite.com/2017/03/20/%E5%BD%92%E6%9C%9F%E4%B8%8D%E9%81%87/"/>
    <id>http://yoursite.com/2017/03/20/å½’æœŸä¸é‡/</id>
    <published>2017-03-20T14:46:40.000Z</published>
    <updated>2019-03-25T06:55:27.637Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://upload-images.jianshu.io/upload_images/1276164-396115787ba91829.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="116"></p><a id="more"></a><h4 id="ä¸´æ—¶å‡ºå‘"><a href="#ä¸´æ—¶å‡ºå‘" class="headerlink" title="ä¸´æ—¶å‡ºå‘"></a>ä¸´æ—¶å‡ºå‘</h4><p>æ­¤åˆ»æˆ‘ååœ¨ä»åŒ—äº¬å¼€å¾€è¥¿å®‰çš„ç«è½¦ä¸Šï¼Œç”±äºä¸´æ—¶å‡ºå‘æ²¡ä¹°åˆ°å§é“ºåªæœ‰ç¡¬åº§å°†å°±ä¸€ä¸‹ï¼Œè¯´â€œå°†å°±â€å¯èƒ½å¯¹æˆ‘æ¥è¯´è¿˜å¤ªç‰µå¼ºäº†ï¼Œæƒ³èµ·ä»¥å‰ç«™è¿‡çš„ç«è½¦ï¼Œæƒ³èµ·å½“å¹´é€ƒç¥¨çš„å…‰è¾‰å†å²ï¼Œæƒ³èµ·ä¸ºäº†çœç‚¹é’±ä¸ä¹°å§é“ºçš„æ—¥å­ï¼Œæƒ³èµ·å»æ­¦æ±‰ç«™13å°æ—¶çš„ä¿¡å¿µâ€¦â€¦æ­¤åˆ»ï¼Œæˆ‘è§‰å¾—äººæ´»ç€è¿˜æ˜¯ä¸èƒ½ç¼ºäº†ä¿¡å¿µçš„ã€‚</p><h4 id="ä¿¡å¿µæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ä¿¡å¿µæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä¿¡å¿µæ˜¯ä»€ä¹ˆï¼Ÿ"></a>ä¿¡å¿µæ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>ä½†æ˜¯ï¼Œå…³äºä¿¡å¿µåˆ°åº•æ˜¯ä¸€ç§ä»€ä¹ˆä¸œè¥¿æˆ‘åˆæ‘¸ä¸æ¸…çš„ï¼Œå¯èƒ½åœ¨æˆ‘è¿™å°±æ˜¯ä¸€ä¸ªä½ çœŸå¿ƒçˆ±çš„äººï¼Œä¸€ä¸ªä½ è§‰å¾—èˆ’é€‚çš„åŸï¼Œä¸€ä»½ä½ ä¸è®¨åŒçš„å·¥ä½œï¼Œä¸€ä¸ªå¯ä»¥å®ç°çš„ç›®æ ‡æˆ–è€…æ˜¯ä½ åº”å°½çš„ä¹‰åŠ¡ï¼Œæ¯”å¦‚ä½œä¸ºå­å¥³åº”è¯¥åƒçˆ¶æ¯æ— ç§æ— æ€¨å…»è‚²ä½ ä¸€æ ·äº²è¿‘çˆ¶æ¯ï¼Œå–„å¾…æœ‹å‹ï¼ŒçœŸè¯šå¾…äººä¸è™šä¼ªä¸é€ ä½œã€‚ä¸€ä¸ªäººçœŸæ­£æœ‰ä¿¡å¿µçš„æ—¶å€™ï¼Œé‚£æ—¶å€™ä»–æ˜¯å¼ºå¤§çš„ï¼Œæ‹¥æœ‰å¼ºå¤§çš„å†…å¿ƒåŠ›é‡å’Œç²¾ç¥åŠ›é‡ã€‚</p><h4 id="å‘å·¦å‘å³ï¼Ÿ"><a href="#å‘å·¦å‘å³ï¼Ÿ" class="headerlink" title="å‘å·¦å‘å³ï¼Ÿ"></a>å‘å·¦å‘å³ï¼Ÿ</h4><p>æœ‰æœ‹å‹é¢ä¸´æ¯•ä¸šå†ä¸ºå·¥ä½œçŠ¯æ„ï¼Œå¤§å¤šæ•°äººéƒ½æ˜¯è¿™ä¹ˆèµ°è¿‡æ¥çš„ï¼Œæˆ‘è§‰å¾—æ¯•ä¸šçš„æ—¶å€™åˆ†å‡ ç±»äººï¼Œå…¶ä»–çš„å¤–ç•Œæ¡ä»¶å°±éƒ½ä¸è€ƒè™‘äº†ï¼Œä¸€ç±»äººå®Œå…¨æ˜ç¡®è‡ªå·±æƒ³è¦åšä»€ä¹ˆä¸æ‹…å¿ƒåšä¸å¥½ï¼Œä¸€ç±»äººæƒ³åšè¿™ä¸ªä¹Ÿæƒ³åšé‚£ä¸ªä½†æ˜¯æ‹…å¿ƒè‡ªå·±åšä¸åšå¾—å¥½ï¼Œè¿˜æœ‰ä¸€ç±»äººä¸çŸ¥é“è‡ªå·±æƒ³è¦åšä»€ä¹ˆä¹Ÿè§‰å¾—è‡ªå·±åšä¸å¥½ã€‚å¾ˆä¸å¹¸å½“å¹´æˆ‘å°±æ˜¯å±äºæœ€åä¸€ç±»ï¼Œåæ¥æˆ‘å‘ç°å¤§å¤šæ•°äººæ¯•ä¸šçš„æ—¶å€™éƒ½æœ‰ç„¦è™‘ç—‡ï¼Œæˆ‘æŠŠè¿™ç»Ÿç§°ä¸ºâ€œæ¯•ä¸šç»¼åˆç—‡â€ã€‚è¿™ç»å¯¹ä¸æ˜¯ç—…ï¼Œæˆ‘ä»¬è¦ç¦»å¼€ä¸€ä¸ªç†Ÿæ‚‰çš„ç¯å¢ƒç†Ÿæ‚‰çš„äººå»æ¢çŸ¥ä¸ç¡®å®šçš„æœªæ¥ï¼Œæœ‰ç„¦è™‘æœ‰æ’æ–¥æœ‰ä¸èˆï¼Œè¿™ç§ä¸èˆåœ¨å°†æ¥çš„å‡ å¹´å†…ä¼šæ›´æµ“çƒˆå‘¢ã€‚æ€»ä¹‹ï¼Œå†æ²¡å¼€å§‹æ¢é™©ä¹‹å‰ï¼ŒæœªçŸ¥çš„å‰æ–¹æ€»æ˜¯å……æ»¡ä¼ å¥‡çš„è‰²å½©å’Œè¿·æ ·çš„ç²¾å½©ï¼Œæ‰€ä»¥åœ¨å‘å·¦è¿˜æ˜¯å‘å³çš„åå­—è·¯å£ï¼Œä¸è¦å®³æ€•è¿ˆå‡ºå“ªä¸€æ­¥æ˜¯é”™è¯¯çš„è¿˜æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºä¸ç®¡æ˜¯å‘å·¦è¿˜æ˜¯å‘å³ï¼Œæœ€ç»ˆéƒ½ä¼šåœ¨ä¸€ä¸ªè·¯å£ä¼šå’Œï¼Œè¿æ¥ä½ æƒ³è¦çš„ç”Ÿæ´»ã€‚</p><h4 id="æ›¾å¾ˆæ½‡æ´’"><a href="#æ›¾å¾ˆæ½‡æ´’" class="headerlink" title="æ›¾å¾ˆæ½‡æ´’"></a>æ›¾å¾ˆæ½‡æ´’</h4><p>å’Œæœ‹å‹èŠåˆ°æ¯•ä¸šæ—¶çš„æƒ…æ™¯ï¼Œåˆæƒ³åˆ°å»å¹´å¦ä¸€ä½æœ‹å‹å‘Šè¯‰æˆ‘ å½“å¹´æˆ‘è¯´â€œé‚£ä¸æ˜¯æˆ‘æƒ³è¦çš„ç”Ÿæ´»â€ï¼Œç„¶åæ¯…ç„¶å†³ç„¶å°±åŒ—æ¼‚äº†å¾ˆå¸…æ°”ï¼Œè§‰å¾—æˆ‘æ˜¯ä¸ªå¾ˆæœ‰ä¸»è§çš„äººã€‚æ—¶éš”ä¸¤å¹´å¬åˆ°åˆ«äººè¿™ä¹ˆèµç¾æˆ‘å¾ˆæ˜¯é«˜å…´ï¼Œæ²¡æƒ³åˆ°æˆ‘ä¹Ÿæ›¾å¦‚æ­¤æ½‡æ´’è¿‡ã€‚ä¸å¯å¦è®¤ï¼Œè™½ç„¶æ˜¯é¢ç›¸é•¿å¾—å¹´è½»äº†ç‚¹ï¼Œä½†å°æ—¶å€™çš„ç»å†ï¼ŒäºŒå¹´çº§å°±è‡ªå·±æŠ¥åä»¥åŠä¸€è·¯èµ°æ¥ååå·å·çš„æˆ‘å‘æ¥æ˜¯çŸ¥é“å¦‚ä½•ç”Ÿå­˜ï¼Œå¦‚ä½•ç‹¬ç«‹çš„ã€‚è¯´å®è¯æˆ‘å¹¶ä¸æ˜¯ä¸€ä¸ªæœ‰å¾ˆå¤šæ­£èƒ½åŠ›çš„äººï¼Œä¹Ÿå¶å°”ï¼ˆå¯èƒ½æ˜¯ç»å¸¸ï¼‰è´Ÿèƒ½é‡çˆ†æ£šï¼Œæ‰€ä»¥æˆ‘æ‰ä¸€ç›´ç§¯æä¹è§‚çš„ç”Ÿæ´»ï¼Œä¹Ÿå®³æ€•ç»™èº«è¾¹çš„äººå¸¦å»è´Ÿèƒ½é‡ï¼Œæˆ‘ä¸€ç›´ç›¸ä¿¡ç€è‡ªå·±ï¼Œç»å†é‚£ä¹ˆå¤šä¸æ˜¯è¢«æ‰“è´¥çš„ï¼Œè€Œæ˜¯çœŸæ­£çš„å¼ºå¤§èµ·æ¥ã€‚æˆ‘ç›¸ä¿¡äººç”Ÿæ²¡æœ‰å¦‚æœåªæœ‰åæœå’Œç»“æœï¼Œæˆ‘ä»ä¸åæ‚”è‡ªå·±åšçš„æ¯ä¸ªå†³å®šå’Œæ¯ä»¶äº‹ã€‚</p><h4 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h4><p>ç°åœ¨ä¸æ­¢æ˜¥èŠ‚çš„æ—¶å€™çˆ¶æ¯æ‰ä¼šè®²æˆ‘çš„ç»ˆç”Ÿå¤§äº‹äº†ï¼Œå·²ç»æˆä¸ºæ¯æ¬¡é€šè¯çš„ä¸å¯å°‘è¯é¢˜äº†ï¼Œå¥½åƒæ— è®ºèŠä»€ä¹ˆéƒ½èƒ½èŠåˆ°è¿™çš„æ ·å­ï¼Œæ¯æ¬¡å¤§æ¦‚æ˜¯è¿™æ ·â€œéƒ½äºŒåå…­ä¸ƒçš„äººäº†ï¼Œè¿˜ä¸æ‰“ç®—è¯´åª³å¦‡å„¿â€¦â€ã€‚è®²çœŸï¼Œä¸€ä¸ªäººçš„ç”Ÿæ´»æˆ‘ä¹Ÿè¿‡äº†å¥½å¤šå¹´äº†ï¼Œè°ä¸æƒ³æ‰¾ä¸€ä¸ªçˆ±çš„äººåœ¨ä¸€èµ·äº’ç›¸æ…°è—‰ï¼Œç„¶è€Œäººç”Ÿæ€»æ˜¯æœ‰å¾ˆå¤šä¸å¦‚æ„ï¼Œæ¯”å¦‚åœ¨ä½ ä¸æ‡‚çˆ±çš„å¹´çºªé‡åˆ°çˆ±ä½ çš„äººï¼Œä¸æ‡‚çˆ±çš„å¹´çºªé‡åˆ°ä½ çˆ±çš„ï¼Œæ‡‚çˆ±çš„å¹´çºªé‡åˆ°ä½ çˆ±çš„ä¸çˆ±ä½ çš„ï¼Œæ‡‚çˆ±çš„å¹´çºªé‡ä¸åˆ°ä½ çˆ±çš„ä¹Ÿé‡ä¸åˆ°çˆ±ä½ çš„ï¼Œæœ€ç¾å¥½çš„å¹´çºªæ²¡æœ‰èƒ½åŠ›ä¿æŠ¤æœ€æƒ³è¦ä¿æŠ¤çš„ï¼Œæœ‰èƒ½åŠ›çš„æ—¶å€™å·²ç»æ·¡ç„¶ã€‚çˆ¶æ¯æ€»è®¤ä¸ºè‡ªå·±çš„å­©å­æ˜¯æœ€å¥½çš„ï¼Œä¹Ÿè®¤ä¸ºç°åœ¨å¹´è½»äººé‚£ä¹ˆå¤šï¼Œç„¶è€Œä»–ä»¬å¹¶ä¸çŸ¥å…¶å®ç°åœ¨äººä¸äººä¹‹é—´çš„äº¤é›†æ—©å·²ç»ä¸å¦‚ä»–ä»¬é‚£ä¸ªå¹´ä»£äº†ï¼Œè€Œä¸”å¯¹äºæˆ‘è¿™ç±»äººæ¥è¯´ï¼Œå–œæ¬¢ä¸€ä¸ªäººæ˜¯å¤šä¹ˆçš„ä¸å®¹æ˜“çš„ä¸€ä»¶äº‹ã€‚</p><figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (someone == <span class="literal">I</span> loved) &#123;</span><br><span class="line"><span class="keyword">do</span> everything;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="literal">I</span> would like to sleeping alone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯èƒ½è¿™å°±æ˜¯æ‰€è°“çš„ä»¥å‰å–œæ¬¢ä¸€ä¸ªäººï¼Œç°åœ¨å–œæ¬¢ä¸€ä¸ªäººå§ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://upload-images.jianshu.io/upload_images/1276164-396115787ba91829.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;116&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="æµé‡‘å²æœˆ" scheme="http://yoursite.com/categories/%E6%B5%81%E9%87%91%E5%B2%81%E6%9C%88/"/>
    
    
      <category term="å¿ƒæƒ…" scheme="http://yoursite.com/tags/%E5%BF%83%E6%83%85/"/>
    
      <category term="æ€è€ƒ" scheme="http://yoursite.com/tags/%E6%80%9D%E8%80%83/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨CAShapeLayer &amp; UIBezierPathç”»å›¾</title>
    <link href="http://yoursite.com/2017/02/24/%E4%BD%BF%E7%94%A8CAShapeLayer&amp;UIBezierPath%E7%94%BB%E5%9B%BE/"/>
    <id>http://yoursite.com/2017/02/24/ä½¿ç”¨CAShapeLayer&amp;UIBezierPathç”»å›¾/</id>
    <published>2017-02-24T03:14:10.000Z</published>
    <updated>2019-03-25T06:56:40.362Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬ç¯‡ä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥å†™çš„ä¸€ç‚¹ä¸œè¥¿ï¼š</p><ul><li>çº¿æ®µ</li><li>æ›²çº¿</li><li>åŠ¨ç”»</li><li>ç®€å•çš„æŸ±çŠ¶å›¾</li><li>ç®€å•çš„æŠ˜çº¿å›¾</li></ul></blockquote><a id="more"></a><h3 id="çº¿æ®µ"><a href="#çº¿æ®µ" class="headerlink" title="çº¿æ®µ"></a>çº¿æ®µ</h3><p><img src="http://upload-images.jianshu.io/upload_images/1276164-8c6af273e49d1835.gif?imageMogr2/auto-orient/strip" alt="çº¿æ®µ"></p><ul><li>å•çº¿æ®µ<br>ä¸¤ç‚¹ç¡®å®šä¸€æ¡ç›´çº¿ï¼Œç»™è´å¡å°”æ›²çº¿ä¸€ä¸ªèµ·å§‹ç‚¹<code>moveToPoint</code>å†æ·»åŠ ä¸€æ¡çº¿çš„ç»ˆç‚¹<code>addLineToPoint</code>ï¼Œè¿™æ ·å°±ç¡®å®šäº†ä¸€æ¡ç›´çº¿ã€‚</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (void)drawLine &#123;</span><br><span class="line">    UIView *view = [self.view viewWithTag:<span class="number">1024</span>]<span class="comment">;</span></span><br><span class="line">    UILabel *label = [view viewWithTag:<span class="number">524</span>]<span class="comment">;</span></span><br><span class="line">    label<span class="meta">.text</span> = @<span class="string">"ç›´çº¿"</span><span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    CAShapeLayer *line = [CAShapeLayer layer]<span class="comment">;</span></span><br><span class="line">    line.lineWidth = <span class="number">2</span><span class="comment">;</span></span><br><span class="line">    line.strokeColor = [UIColor <span class="keyword">orangeColor].CGColor;</span></span><br><span class="line"><span class="keyword"> </span>   line.fillColor = nil<span class="comment">;</span></span><br><span class="line">    [view.layer <span class="keyword">addSublayer:line];</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line">    UIBezierPath *<span class="keyword">bezierPath </span>= [UIBezierPath <span class="keyword">bezierPath];</span></span><br><span class="line"><span class="keyword"> </span>   [<span class="keyword">bezierPath </span><span class="keyword">moveToPoint:CGPointMake(100, </span><span class="number">50</span>)]<span class="comment">;</span></span><br><span class="line">    [<span class="keyword">bezierPath </span><span class="keyword">addLineToPoint:CGPointMake(200, </span><span class="number">150</span>)]<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    line.path = <span class="keyword">bezierPath.CGPath;</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>å¤šçº¿æ®µ<br>å‰é¢çº¿æ®µçš„ç»ˆç‚¹æ˜¯åé¢çº¿æ®µçš„èµ·ç‚¹ã€‚ç»™ä¸€ä¸ªèµ·ç‚¹<code>moveToPoint</code>ï¼Œç„¶åæƒ³æ·»åŠ å‡ æ¡çº¿å°±ç»™å‡ ä¸ªçº¿çš„ç»ˆç‚¹<code>addLineToPoint</code>ã€‚</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (void)drawDoubleLine &#123;</span><br><span class="line">    UIView *view = [self.view viewWithTag:<span class="number">1025</span>]<span class="comment">;</span></span><br><span class="line">    UILabel *label = [view viewWithTag:<span class="number">525</span>]<span class="comment">;</span></span><br><span class="line">    label<span class="meta">.text</span> = @<span class="string">"æŠ˜çº¿"</span><span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    CAShapeLayer *line = [CAShapeLayer layer]<span class="comment">;</span></span><br><span class="line">    line.lineWidth = <span class="number">2</span><span class="comment">;</span></span><br><span class="line">    line.strokeColor = [UIColor <span class="keyword">orangeColor].CGColor;</span></span><br><span class="line"><span class="keyword"> </span>   line.fillColor = nil<span class="comment">;</span></span><br><span class="line">    [view.layer <span class="keyword">addSublayer:line];</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line">    UIBezierPath *<span class="keyword">bezierPath </span>= [UIBezierPath <span class="keyword">bezierPath];</span></span><br><span class="line"><span class="keyword"> </span>   [<span class="keyword">bezierPath </span><span class="keyword">moveToPoint:CGPointMake(100, </span><span class="number">50</span>)]<span class="comment">;</span></span><br><span class="line">    [<span class="keyword">bezierPath </span><span class="keyword">addLineToPoint:CGPointMake(200, </span><span class="number">150</span>)]<span class="comment">;</span></span><br><span class="line">    [<span class="keyword">bezierPath </span><span class="keyword">addLineToPoint:CGPointMake(200, </span><span class="number">100</span>)]<span class="comment">;</span></span><br><span class="line">    [<span class="keyword">bezierPath </span><span class="keyword">addLineToPoint:CGPointMake(250, </span><span class="number">150</span>)]<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    line.path = <span class="keyword">bezierPath.CGPath;</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>é—­åˆå¤šè¾¹å½¢<br>ä¹Ÿæ˜¯å¤šçº¿æ®µè¿èµ·æ¥çš„ï¼Œåªä¸è¿‡æœ€åä¸€æ¡çº¿çš„ç»ˆç‚¹ä¸ºç¬¬ä¸€æ¡çº¿æ®µçš„èµ·ç‚¹ã€‚</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (void)drawTriangle &#123;</span><br><span class="line">    UIView *view = [self.view viewWithTag:<span class="number">1026</span>]<span class="comment">;</span></span><br><span class="line">    UILabel *label = [view viewWithTag:<span class="number">526</span>]<span class="comment">;</span></span><br><span class="line">    label<span class="meta">.text</span> = @<span class="string">"é—­åˆå¤šè¾¹å½¢"</span><span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    CAShapeLayer *triangle = [CAShapeLayer layer]<span class="comment">;</span></span><br><span class="line">    triangle.lineWidth = <span class="number">2</span><span class="comment">;</span></span><br><span class="line">    triangle.strokeColor = [UIColor redColor].CGColor<span class="comment">;</span></span><br><span class="line">    triangle.fillColor = [UIColor clearColor].CGColor<span class="comment">;</span></span><br><span class="line">    [view.layer <span class="keyword">addSublayer:triangle];</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line">    UIBezierPath *<span class="keyword">bezierPath </span>= [UIBezierPath <span class="keyword">bezierPath];</span></span><br><span class="line"><span class="keyword"> </span>   [<span class="keyword">bezierPath </span><span class="keyword">moveToPoint:CGPointMake(kDeviceWidth/2.0, </span><span class="number">50</span>)]<span class="comment">;</span></span><br><span class="line">    [<span class="keyword">bezierPath </span><span class="keyword">addLineToPoint:CGPointMake(kDeviceWidth/2.0-100, </span><span class="number">150</span>)]<span class="comment">;</span></span><br><span class="line">    [<span class="keyword">bezierPath </span><span class="keyword">addLineToPoint:CGPointMake(kDeviceWidth/2.0+100, </span><span class="number">150</span>)]<span class="comment">;</span></span><br><span class="line">    [<span class="keyword">bezierPath </span><span class="keyword">addLineToPoint:CGPointMake(kDeviceWidth/2.0, </span><span class="number">50</span>)]<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    triangle.path = <span class="keyword">bezierPath.CGPath;</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure><ul><li><p>çº¿ç«¯ç‚¹æ ·å¼<br>CAShapeLayerçš„<code>lineCap</code>å±æ€§å†³å®šçº¿ç«¯ç‚¹æ ·å¼ï¼Œå¯é€‰æ ·å¼<code>kCALineCapButtï¼ˆé»˜è®¤ï¼‰</code>ï¼Œ<code>kCALineCapRoundï¼ˆåœ†è§’ï¼‰</code>ï¼Œ<code>kCALineCapSquareï¼ˆå¹³è§’ï¼‰</code>ã€‚é»˜è®¤ä¸º<code>kCALineCapButt</code>ä¹Ÿæ˜¯å¹³è§’ã€‚<br><img src="http://upload-images.jianshu.io/upload_images/1276164-3950101908ae9c06.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="çº¿ç«¯ç‚¹æ ·å¼ç¤ºä¾‹"></p></li><li><p>çº¿æ®µæ‹ç‚¹å¤„æ ·å¼<br>CAShapeLayerçš„<code>lineJoin</code>å±æ€§å†³å®šçº¿ç«¯ç‚¹æ ·å¼ï¼Œå¯é€‰æ ·å¼<code>kCALineJoinMiterï¼ˆå°–è§’ï¼‰</code>ï¼Œ<code>kCALineJoinRoundï¼ˆåœ†è§’ï¼‰</code>ï¼Œ<code>kCALineJoinBevelï¼ˆå¹³è§’ï¼‰</code>ã€‚é»˜è®¤ä¸º<code>kCALineJoinMiter</code>ã€‚<br><img src="http://upload-images.jianshu.io/upload_images/1276164-ae5278976c113bef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æ‹è§’æ ·å¼ç¤ºä¾‹"></p></li><li><p>è™šçº¿</p></li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">NSNumber</span> *&gt; *lineDashPattern;</span><br></pre></td></tr></table></figure><p>CAShapeLayerçš„<code>lineDashPattern</code>å±æ€§å†³å®šä½ ç”»å‡ºä¸€æ¡ä»€ä¹ˆæ ·çš„è™šçº¿ï¼Œè¿™ä¸ªå±æ€§è¿”å›ä¸€ç»„<code>NSNumber</code>ç±»å‹çš„æ•°ç»„ï¼Œå…¶å®å°±æ˜¯<code>å®è™šç›¸äº¤</code>æ¥è¡¨ç¤ºä½ çš„è™šçº¿ï¼Œæ•°ç»„çš„é•¿åº¦ç”±ä½ å†³å®šï¼ˆå½“ç„¶æœ€å¥½ä¸è¦ç¬¬ä¸€è½®å®è™šç›¸åŠ è¶…è¿‡çº¿æ®µé•¿åº¦ï¼‰ã€‚æ¯”å¦‚<code>line.lineDashPattern = @[@10,@5,@2,@8];</code>å°±æ˜¯è¡¨ç¤ºæ¯è½®éƒ½ä¸ºé•¿åº¦ä¸º10çš„å®çº¿ï¼Œé•¿åº¦ä¸º5çš„è™šçº¿ï¼Œé•¿åº¦ä¸º2çš„å®çº¿ï¼Œé•¿åº¦ä¸º8çš„è™šçº¿ï¼Œå¾ªç¯ç›´åˆ°çº¿æ®µç»“æŸã€‚</p><h3 id="æ›²çº¿"><a href="#æ›²çº¿" class="headerlink" title="æ›²çº¿"></a>æ›²çº¿</h3><p><img src="http://upload-images.jianshu.io/upload_images/1276164-6cbeb754f0ff140f.gif?imageMogr2/auto-orient/strip" alt="æ›²çº¿"></p><ul><li>äºŒæ¬¡è´å¡å°”æ›²çº¿<br><img src="http://upload-images.jianshu.io/upload_images/1276164-db1b50a659d63560.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="äºŒæ¬¡è´å¡å°”æ›²çº¿"><br>äºŒæ¬¡è´å¡å°”æ›²çº¿æœ‰ä¸€ä¸ªæ§åˆ¶ç‚¹ï¼Œæ§åˆ¶ç‚¹çš„ä½ç½®å†³å®šäº†æ˜¾ç¤ºä¸€æ¡æ€æ ·çš„æ›²çº¿ã€‚ä¸‹é¢çš„ä¾‹å­ï¼Œæˆ‘æŠŠèµ·ç‚¹pAã€ç»ˆç‚¹pBã€æ§åˆ¶ç‚¹pC éƒ½ç”»å‡ºæ¥æ–¹ä¾¿è§‚å¯Ÿã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¯‡å¹…é™åˆ¶ åªè´´ä¸»è¦ä»£ç </span></span><br><span class="line"><span class="comment">//æ›²çº¿</span></span><br><span class="line"><span class="built_in">CAShapeLayer</span> *layerOne = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">layerOne.fillColor = [<span class="built_in">UIColor</span> clearColor].CGColor;</span><br><span class="line">layerOne.strokeColor = [<span class="built_in">UIColor</span> blackColor].CGColor;</span><br><span class="line">layerOne.strokeStart = <span class="number">0</span>;</span><br><span class="line">layerOne.strokeEnd = <span class="number">1</span>;</span><br><span class="line">[view.layer addSublayer:layerOne];</span><br><span class="line">    </span><br><span class="line"><span class="comment">//è·¯å¾„</span></span><br><span class="line"><span class="built_in">UIBezierPath</span> *path = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line">[path moveToPoint:pA];</span><br><span class="line">[path addQuadCurveToPoint:pB controlPoint:pC];</span><br><span class="line">    </span><br><span class="line"><span class="comment">//å…³è”è·¯å¾„</span></span><br><span class="line">layerOne.path = path.CGPath;</span><br></pre></td></tr></table></figure><ul><li>ä¸‰æ¬¡è´å¡å°”æ›²çº¿<br>![Uploading Glass_å’Œ_iPhone_7_Plus_â€“_iOS_10_2__14C89__158499.png . . .]<br><img src="http://upload-images.jianshu.io/upload_images/1276164-3cfcc224f189e5a9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ä¸‰æ¬¡è´å¡å°”æ›²çº¿"><br>ä¸‰æ¬¡è´å¡å°”æ›²çº¿æœ‰ä¸¤ä¸ªæ§åˆ¶ç‚¹ï¼Œä¸¤ä¸ªæ§åˆ¶ç‚¹çš„ä½ç½®å†³å®šäº†æ˜¾ç¤ºä¸€æ¡æ€æ ·çš„æ›²çº¿ã€‚ä¸‹é¢çš„ä¾‹å­ï¼Œæˆ‘æŠŠèµ·ç‚¹pAã€ç»ˆç‚¹pBã€æ§åˆ¶ç‚¹pCã€pD éƒ½ç”»å‡ºæ¥æ–¹ä¾¿è§‚å¯Ÿã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¯‡å¹…é™åˆ¶ åªè´´ä¸»è¦ä»£ç </span></span><br><span class="line"><span class="comment">//æ›²çº¿</span></span><br><span class="line"><span class="built_in">CAShapeLayer</span> *layerTwo = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">layerTwo.fillColor = [<span class="built_in">UIColor</span> clearColor].CGColor;</span><br><span class="line">layerTwo.strokeColor = [<span class="built_in">UIColor</span> blackColor].CGColor;</span><br><span class="line">layerTwo.strokeStart = <span class="number">0</span>;</span><br><span class="line">layerTwo.strokeEnd = <span class="number">1</span>;</span><br><span class="line">[view.layer addSublayer:layerTwo];</span><br><span class="line">    </span><br><span class="line"><span class="comment">//è·¯å¾„</span></span><br><span class="line"><span class="built_in">UIBezierPath</span> *path = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line">[path moveToPoint:pA];</span><br><span class="line">[path addCurveToPoint:pB controlPoint1:pC controlPoint2:pD];</span><br><span class="line">    </span><br><span class="line"><span class="comment">//å…³è”è·¯å¾„</span></span><br><span class="line">layerTwo.path = path.CGPath;</span><br></pre></td></tr></table></figure><ul><li>åœ†è§’çŸ©å½¢</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)drawRectRound &#123;</span><br><span class="line">    <span class="built_in">UIView</span> *view = [<span class="keyword">self</span>.view viewWithTag:<span class="number">1028</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIBezierPath</span> *rectRound = [<span class="built_in">UIBezierPath</span> bezierPathWithRoundedRect:<span class="built_in">CGRectMake</span>(kDeviceWidth/<span class="number">2.0</span><span class="number">-100</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">100</span>) byRoundingCorners:<span class="built_in">UIRectCornerBottomLeft</span> | <span class="built_in">UIRectCornerBottomRight</span> cornerRadii:<span class="built_in">CGSizeMake</span>(<span class="number">20</span>, <span class="number">20</span>)];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CAShapeLayer</span> *layer = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">    layer.strokeColor = [<span class="built_in">UIColor</span> clearColor].CGColor;</span><br><span class="line">    layer.fillColor = [<span class="built_in">UIColor</span> whiteColor].CGColor;</span><br><span class="line">    layer.path = rectRound.CGPath;</span><br><span class="line">    </span><br><span class="line">    [view.layer addSublayer:layer];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://upload-images.jianshu.io/upload_images/1276164-7def553629daf890.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="åœ†è§’çŸ©å½¢"></p><ul><li>è™šçº¿åœ†<br>å¦‚æœæ˜¯é™æ€çš„(æ— åŠ¨ç”»)ï¼Œé‚£ä¹ˆéœ€è¦ä¸¤ä¸ªè´å¡å°”åœ†ç¯æ›²çº¿è¡¨ç¤ºå†…åœ†å’Œå¤–åœ†ï¼Œå†…åœ†ä¸€å‘¨ï¼Œå¤–åœ†å®æ—¶è¿›åº¦ã€‚<br>å¦‚æœæ˜¯åŠ¨æ€çš„(æœ‰åŠ¨ç”»)ï¼Œé‚£ä¹ˆå¯ä»¥ä¸€ä¸ªè´å¡å°”åœ†ç¯æ›²çº¿è¡¨ç¤ºå†…åœ†å’Œå¤–åœ†ï¼Œå†…ã€å¤–åœ†éƒ½ä¸€å‘¨ï¼Œå¤–åœ†æ·»åŠ åŠ¨ç”»ï¼ŒåŠ¨ç”»çš„<code>toValue</code>æ ‡å¿—å®æ—¶è¿›åº¦ã€‚<br><img src="http://upload-images.jianshu.io/upload_images/1276164-0e78eb5eaa0f4f1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="è™šçº¿åœ†"></li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)drawXuCircle &#123;</span><br><span class="line">    <span class="built_in">UIView</span> *view = [<span class="keyword">self</span>.view viewWithTag:<span class="number">1029</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åº•éƒ¨è™šåœ†</span></span><br><span class="line">    <span class="built_in">CAShapeLayer</span> *xuCircle = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">    xuCircle.lineWidth = <span class="number">10</span>;</span><br><span class="line">    xuCircle.strokeColor = ColorWithHex(<span class="number">0xbebebe</span>, <span class="number">1</span>).CGColor;</span><br><span class="line">    xuCircle.fillColor = <span class="literal">nil</span>;</span><br><span class="line">    xuCircle.lineJoin = kCALineJoinMiter;</span><br><span class="line">    xuCircle.lineDashPattern = @[@<span class="number">2</span>,@<span class="number">3</span>];</span><br><span class="line">    [view.layer addSublayer:xuCircle];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¤–éƒ¨è™šåœ†</span></span><br><span class="line">    <span class="built_in">CAShapeLayer</span> *circle = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">    circle.lineWidth = <span class="number">10</span>;</span><br><span class="line">    circle.strokeColor = ColorWithHex(<span class="number">0xa2d100</span>, <span class="number">1</span>).CGColor;</span><br><span class="line">    circle.fillColor = <span class="literal">nil</span>;</span><br><span class="line">    circle.lineJoin = kCALineJoinMiter;</span><br><span class="line">    circle.lineDashPattern = @[@<span class="number">2</span>,@<span class="number">3</span>];</span><br><span class="line">    [view.layer addSublayer:circle];</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIBezierPath</span> *xuBezierPath = [<span class="built_in">UIBezierPath</span> bezierPathWithArcCenter:<span class="built_in">CGPointMake</span>(kDeviceWidth/<span class="number">2.0</span>, <span class="number">100</span>) radius:<span class="number">55</span> startAngle:-M_PI_2 endAngle:<span class="number">3</span>*M_PI_2 clockwise:<span class="literal">YES</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIBezierPath</span> *bezierPath = [<span class="built_in">UIBezierPath</span> bezierPathWithArcCenter:<span class="built_in">CGPointMake</span>(kDeviceWidth/<span class="number">2.0</span>, <span class="number">100</span>) radius:<span class="number">55</span> startAngle:-M_PI_2 endAngle:M_PI_2 clockwise:<span class="literal">YES</span>];</span><br><span class="line">    </span><br><span class="line">    xuCircle.path = xuBezierPath.CGPath;</span><br><span class="line">    circle.path = bezierPath.CGPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŠ¨ç”»"><a href="#åŠ¨ç”»" class="headerlink" title="åŠ¨ç”»"></a>åŠ¨ç”»</h3><blockquote><p>ç°åœ¨æˆ‘ä»¬æ¥ç»™ä¸€äº›å›¾å½¢åŠ ä¸ŠåŠ¨ç”»ï¼Œä½¿è¿è¡Œèµ·æ¥æ›´ç¾è§‚ã€‚<br><img src="http://upload-images.jianshu.io/upload_images/1276164-879cf2a6c243266b.gif?imageMogr2/auto-orient/strip" alt="åŠ¨ç”»"></p></blockquote><ul><li>ä¸»è¦å†™äº†ä¸‰ç±»åŠ¨ç”»<br>1.æœ€å¸¸ç”¨çš„æ™®é€šåŠ¨ç”»<br>2.è¿›åº¦æ¡åŠ¨ç”»<br>3.å…¶ä»–å±æ€§çš„åŠ¨ç”»ï¼ˆæ¯”å¦‚è¿™é‡Œæœ‰é‡å¤æ¬¡æ•°å’Œé€†æ‰§è¡Œï¼‰</li></ul><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ™®é€šåŠ¨ç”»ï¼ŒstrokeEnd</span></span><br><span class="line">- (CABasicAnimation *)animComm &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_animComm</span> == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="variable">_animComm</span> = [CABasicAnimation animationWithKeyPath:@<span class="string">"strokeEnd"</span>];</span><br><span class="line">        <span class="variable">_animComm</span>.fromValue = @<span class="number">0.0</span>;</span><br><span class="line">        <span class="variable">_animComm</span>.toValue = @<span class="number">1.0</span>;</span><br><span class="line">        <span class="variable">_animComm</span>.duration = <span class="number">2.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="variable">_animComm</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿›åº¦æ¡åŠ¨ç”»</span></span><br><span class="line">- (CABasicAnimation *)animProgress &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_animProgress</span> == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="variable">_animProgress</span> = [CABasicAnimation animationWithKeyPath:@<span class="string">"strokeEnd"</span>];</span><br><span class="line">        <span class="variable">_animProgress</span>.fromValue = @<span class="number">0.0</span>;</span><br><span class="line">        <span class="variable">_animProgress</span>.toValue = @<span class="number">0.7</span>;</span><br><span class="line">        <span class="variable">_animProgress</span>.fillMode = kCAFillModeForwards;</span><br><span class="line">        <span class="variable">_animProgress</span>.removedOnCompletion = NO;</span><br><span class="line">        <span class="variable">_animProgress</span>.duration = <span class="number">2.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="variable">_animProgress</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//é‡å¤æ¬¡æ•°ï¼Œé€†æ‰§è¡Œè¯•ç”¨</span></span><br><span class="line">- (CABasicAnimation *)animRepeat &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_animRepeat</span> == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="variable">_animRepeat</span> = [CABasicAnimation animationWithKeyPath:@<span class="string">"strokeEnd"</span>];</span><br><span class="line">        <span class="variable">_animRepeat</span>.fromValue = @<span class="number">0.0</span>;</span><br><span class="line">        <span class="variable">_animRepeat</span>.toValue = @<span class="number">1.0</span>;</span><br><span class="line">        <span class="variable">_animRepeat</span>.duration = <span class="number">2.0</span>;</span><br><span class="line">        <span class="variable">_animRepeat</span>.autoreverses = YES;</span><br><span class="line">        <span class="variable">_animRepeat</span>.repeatCount = <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="variable">_animRepeat</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç®€å•çš„æŸ±çŠ¶å›¾"><a href="#ç®€å•çš„æŸ±çŠ¶å›¾" class="headerlink" title="ç®€å•çš„æŸ±çŠ¶å›¾"></a>ç®€å•çš„æŸ±çŠ¶å›¾</h3><p><img src="http://upload-images.jianshu.io/upload_images/1276164-452e7362dd44076b.gif?imageMogr2/auto-orient/strip" alt="ç®€å•æŸ±çŠ¶å›¾"></p><p>è¿™æ˜¯ä¸ªéå¸¸ç®€å•çš„æŸ±çŠ¶å›¾ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æŸ±å­çš„ä¸‰ä¸ªé‡è¦éƒ¨åˆ†ï¼Œèµ·ç‚¹ã€ç»ˆç‚¹ã€æŸ±å®½ã€‚æŸ±å­ç”±èµ·ç‚¹æ ¹æ®æŸ±å®½å‘å·¦å³ä¸¤è¾¹æ‰©å¼ ï¼Œå¦‚ä¸‹å›¾æŸ±å­çš„èµ·ç‚¹æ˜¯ä½ç½®2è€Œä¸æ˜¯ä½ç½®1ã€‚<br><img src="http://upload-images.jianshu.io/upload_images/1276164-f226f1e227c4c8f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æŸ±çŠ¶å›¾"></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"SJBarChart.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> lineWidth  = <span class="number">1.0</span>;      <span class="comment">//åæ ‡è½´çº¿å®½</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> distance   = <span class="number">20.0</span>;     <span class="comment">//è·å±å¹•è¾¹è·</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> cornerW    = <span class="number">10.0</span>f;    <span class="comment">//æ‹è§’é•¿åº¦</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> barWidth   = <span class="number">50.0</span>f;    <span class="comment">//æŸ±çŠ¶å®½åº¦</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> space      = <span class="number">30.0</span>f;    <span class="comment">//æŸ±çŠ¶ä¹‹é—´çš„é—´éš”</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> scale      = <span class="number">3.0</span>f;     <span class="comment">//æŸ±çŠ¶æ˜¾ç¤ºé«˜åº¦è®¡ç®—æ¯”ä¾‹ *scale</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SJBarChart</span> ()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGFloat</span> selfW, selfH;</span><br><span class="line">    <span class="built_in">NSArray</span> *source;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CAShapeLayer</span> *xAxis;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CAShapeLayer</span> *yAxis;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIScrollView</span> *barScrollView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CABasicAnimation</span> *animation;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SJBarChart</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithFrame:(<span class="built_in">CGRect</span>)frame &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithFrame:frame];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        selfW = frame.size.width;</span><br><span class="line">        selfH = frame.size.height;</span><br><span class="line">        <span class="keyword">self</span>.backgroundColor = [<span class="built_in">UIColor</span> lightGrayColor];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)showBarChart:(<span class="built_in">NSArray</span> *)sourceArray &#123;</span><br><span class="line">    source = sourceArray;</span><br><span class="line">    [<span class="keyword">self</span> addxyAxis];</span><br><span class="line">    [<span class="keyword">self</span> addSubview:<span class="keyword">self</span>.barScrollView];</span><br><span class="line">    _barScrollView.contentSize = <span class="built_in">CGSizeMake</span>(sourceArray.count*(space+barWidth) + space, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    [sourceArray enumerateObjectsUsingBlock:^(<span class="keyword">id</span>  _Nonnull obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        <span class="built_in">CAShapeLayer</span> *bar = [<span class="keyword">self</span> drawBar:idx];</span><br><span class="line">        [_barScrollView.layer addSublayer:bar];</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ±çŠ¶å›¾</span></span><br><span class="line">- (<span class="built_in">CAShapeLayer</span> *)drawBar:(<span class="built_in">NSInteger</span>)index &#123;</span><br><span class="line">    <span class="built_in">CAShapeLayer</span> *layer = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">    layer.fillColor = [<span class="built_in">UIColor</span> clearColor].CGColor;</span><br><span class="line">    layer.strokeColor = [<span class="built_in">UIColor</span> redColor].CGColor;</span><br><span class="line">    layer.lineWidth = barWidth;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ç»ˆç‚¹y</span></span><br><span class="line">    <span class="built_in">CGFloat</span> y = _barScrollView.frame.size.height<span class="number">-60</span> - lineWidth/<span class="number">2.0</span> - ([[source objectAtIndex:index] floatValue] * scale);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIBezierPath</span> *path = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line">    [path moveToPoint:<span class="built_in">CGPointMake</span>((space + barWidth)*index + (space+barWidth/<span class="number">2.0</span>), _barScrollView.frame.size.height<span class="number">-60</span>)];</span><br><span class="line">    [path addLineToPoint:<span class="built_in">CGPointMake</span>((space + barWidth)*index + (space+barWidth/<span class="number">2.0</span>), y)];</span><br><span class="line">    layer.path = path.CGPath;</span><br><span class="line">    </span><br><span class="line">    [layer addAnimation:<span class="keyword">self</span>.animation forKey:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">return</span> layer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ·»åŠ åæ ‡è½´</span></span><br><span class="line">- (<span class="keyword">void</span>)addxyAxis &#123;</span><br><span class="line">    <span class="keyword">self</span>.xAxis = [<span class="keyword">self</span> lineWithStartPoint:<span class="built_in">CGPointMake</span>(distance, selfH<span class="number">-30</span>) breakPoint:<span class="built_in">CGPointMake</span>(kDeviceWidth-distance, selfH<span class="number">-30</span>) endPoint:<span class="built_in">CGPointMake</span>(kDeviceWidth-distance-cornerW, selfH<span class="number">-30</span>-cornerW)];</span><br><span class="line">    <span class="keyword">self</span>.yAxis = [<span class="keyword">self</span> lineWithStartPoint:<span class="built_in">CGPointMake</span>(distance+lineWidth/<span class="number">2.0</span>, selfH<span class="number">-30</span>) breakPoint:<span class="built_in">CGPointMake</span>(distance, <span class="number">30</span>) endPoint:<span class="built_in">CGPointMake</span>(distance+cornerW, <span class="number">30</span>+cornerW)];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.layer addSublayer:<span class="keyword">self</span>.xAxis];</span><br><span class="line">    [<span class="keyword">self</span>.layer addSublayer:<span class="keyword">self</span>.yAxis];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”»åæ ‡è½´</span></span><br><span class="line">- (<span class="built_in">CAShapeLayer</span> *)lineWithStartPoint:(<span class="built_in">CGPoint</span>)startPoint breakPoint:(<span class="built_in">CGPoint</span>)breakPoint endPoint:(<span class="built_in">CGPoint</span>)endPoint &#123;</span><br><span class="line">    <span class="built_in">CAShapeLayer</span> *line = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">    line.fillColor = [<span class="built_in">UIColor</span> clearColor].CGColor;</span><br><span class="line">    line.strokeColor = [<span class="built_in">UIColor</span> blackColor].CGColor;</span><br><span class="line">    line.lineWidth = <span class="number">1.0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIBezierPath</span> *linePath = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line">    [linePath moveToPoint:startPoint];</span><br><span class="line">    [linePath addLineToPoint:breakPoint];</span><br><span class="line">    [linePath addLineToPoint:endPoint];</span><br><span class="line">    line.path = linePath.CGPath;</span><br><span class="line">    </span><br><span class="line">    [line addAnimation:<span class="keyword">self</span>.animation forKey:<span class="string">@"xyLineStrokeEndAnimation"</span>];</span><br><span class="line">    <span class="keyword">return</span> line;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIScrollView</span> *)barScrollView &#123;</span><br><span class="line">    <span class="keyword">if</span> (_barScrollView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _barScrollView = [[<span class="built_in">UIScrollView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(distance+lineWidth, <span class="number">30</span>, kDeviceWidth-distance*<span class="number">2</span>-lineWidth-cornerW, selfH<span class="number">-60</span>-lineWidth/<span class="number">2.0</span>)];</span><br><span class="line">        _barScrollView.bounces = <span class="literal">NO</span>;</span><br><span class="line">        _barScrollView.showsHorizontalScrollIndicator = <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _barScrollView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CABasicAnimation</span> *)animation &#123;</span><br><span class="line">    <span class="keyword">if</span> (_animation == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _animation = [<span class="built_in">CABasicAnimation</span> animationWithKeyPath:<span class="string">@"strokeEnd"</span>];</span><br><span class="line">        _animation.fromValue = @<span class="number">0.0</span>;</span><br><span class="line">        _animation.toValue = @<span class="number">1.0</span>;</span><br><span class="line">        _animation.duration = <span class="number">2.0</span>;</span><br><span class="line">        _animation.timingFunction = [<span class="built_in">CAMediaTimingFunction</span> functionWithName:kCAMediaTimingFunctionEaseOut];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _animation;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="æŠ˜çº¿å›¾"><a href="#æŠ˜çº¿å›¾" class="headerlink" title="æŠ˜çº¿å›¾"></a>æŠ˜çº¿å›¾</h3><p><img src="http://upload-images.jianshu.io/upload_images/1276164-927e70f03aad6179.gif?imageMogr2/auto-orient/strip" alt="æŠ˜çº¿å›¾"></p><p>æŸ±çŠ¶å›¾æ˜¯ä¸€æ¡æ¡å•ç‹¬çš„çº¿æ®µï¼ŒæŠ˜çº¿å›¾å°±æ˜¯ä¸€æ¡è¿èµ·æ¥çš„å®Œæ•´æŠ˜çº¿ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"SJLineChart.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> lineWidth  = <span class="number">1.0</span>;      <span class="comment">//åæ ‡è½´çº¿å®½</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> distance   = <span class="number">20.0</span>;     <span class="comment">//è·å±å¹•è¾¹è·</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> cornerW    = <span class="number">10.0</span>f;    <span class="comment">//æ‹è§’é•¿åº¦</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> space      = <span class="number">50.0</span>f;    <span class="comment">//æŸ±çŠ¶ä¹‹é—´çš„é—´éš”</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> scale      = <span class="number">3.0</span>f;     <span class="comment">//ç›´çº¿æ˜¾ç¤ºé«˜åº¦è®¡ç®—æ¯”ä¾‹ *scale</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> <span class="keyword">const</span> radius     = <span class="number">3.0</span>f;     <span class="comment">//æ ‡è®°æ¯ä¸ªç‚¹çš„å°åœ†åŠå¾„</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SJLineChart</span> ()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGFloat</span> selfW, selfH;</span><br><span class="line">    <span class="built_in">NSArray</span> *source;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CAShapeLayer</span> *xAxis;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CAShapeLayer</span> *yAxis;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIScrollView</span> *lineScrollView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CABasicAnimation</span> *animation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SJLineChart</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithFrame:(<span class="built_in">CGRect</span>)frame &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithFrame:frame];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        selfW = frame.size.width;</span><br><span class="line">        selfH = frame.size.height;</span><br><span class="line">        <span class="keyword">self</span>.backgroundColor = [<span class="built_in">UIColor</span> lightGrayColor];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)showLineChart:(<span class="built_in">NSArray</span> *)sourceArray &#123;</span><br><span class="line">    source = sourceArray;</span><br><span class="line">    [<span class="keyword">self</span> addxyAxis];</span><br><span class="line">    [<span class="keyword">self</span> addSubview:<span class="keyword">self</span>.lineScrollView];</span><br><span class="line">    _lineScrollView.contentSize = <span class="built_in">CGSizeMake</span>(sourceArray.count*(space+<span class="number">1</span>), <span class="number">0</span>);</span><br><span class="line">    [<span class="keyword">self</span> drawLineChart:sourceArray];</span><br><span class="line">    [<span class="keyword">self</span> drawPoint:sourceArray];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)drawLineChart:(<span class="built_in">NSArray</span> *)array &#123;</span><br><span class="line">    <span class="built_in">CAShapeLayer</span> *lineLayer = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">    lineLayer.fillColor = [<span class="built_in">UIColor</span> clearColor].CGColor;</span><br><span class="line">    lineLayer.strokeColor = [<span class="built_in">UIColor</span> redColor].CGColor;</span><br><span class="line">    lineLayer.lineWidth = <span class="number">2.0</span>;</span><br><span class="line">    <span class="comment">//è½¨è¿¹</span></span><br><span class="line">    <span class="built_in">UIBezierPath</span> *path = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line">    [path moveToPoint:<span class="built_in">CGPointMake</span>(space, _lineScrollView.frame.size.height - <span class="number">60</span> - lineWidth/<span class="number">2.0</span> - ([[array objectAtIndex:<span class="number">0</span>] floatValue] * scale))];</span><br><span class="line">    </span><br><span class="line">    [array enumerateObjectsUsingBlock:^(<span class="keyword">id</span>  _Nonnull obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (idx &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">CGFloat</span> y = _lineScrollView.frame.size.height<span class="number">-60</span> - lineWidth/<span class="number">2.0</span> - ([obj floatValue] * scale);</span><br><span class="line">            [path addLineToPoint:<span class="built_in">CGPointMake</span>(space*(idx+<span class="number">1</span>), y)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    lineLayer.path = path.CGPath;</span><br><span class="line">    [<span class="keyword">self</span>.lineScrollView.layer addSublayer:lineLayer];</span><br><span class="line">    [lineLayer addAnimation:<span class="keyword">self</span>.animation forKey:<span class="string">@"lineStrokeEndAnimation"</span>];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŠŠç‚¹æ ‡å‡ºæ¥</span></span><br><span class="line">- (<span class="keyword">void</span>)drawPoint:(<span class="built_in">NSArray</span> *)array &#123;</span><br><span class="line">    </span><br><span class="line">    [array enumerateObjectsUsingBlock:^(<span class="keyword">id</span>  _Nonnull obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="built_in">CGFloat</span> y = _lineScrollView.frame.size.height - <span class="number">60</span> - lineWidth/<span class="number">2.0</span> - [obj floatValue]*scale;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">UIBezierPath</span> *circlePath = [<span class="built_in">UIBezierPath</span> bezierPathWithArcCenter:<span class="built_in">CGPointMake</span>(space * (idx+<span class="number">1</span>), y) radius:radius startAngle:<span class="number">0</span> endAngle:(M_PI)*<span class="number">2</span> clockwise:<span class="literal">YES</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CAShapeLayer</span> *circleLayer = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">        circleLayer.fillColor = [<span class="built_in">UIColor</span> orangeColor].CGColor;</span><br><span class="line">        circleLayer.strokeColor = [<span class="built_in">UIColor</span> clearColor].CGColor;</span><br><span class="line">        circleLayer.path = circlePath.CGPath;</span><br><span class="line">        </span><br><span class="line">        [_lineScrollView.layer addSublayer:circleLayer];</span><br><span class="line">        </span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ·»åŠ åæ ‡è½´</span></span><br><span class="line">- (<span class="keyword">void</span>)addxyAxis &#123;</span><br><span class="line">    <span class="keyword">self</span>.xAxis = [<span class="keyword">self</span> lineWithStartPoint:<span class="built_in">CGPointMake</span>(distance, selfH<span class="number">-30</span>) breakPoint:<span class="built_in">CGPointMake</span>(kDeviceWidth-distance, selfH<span class="number">-30</span>) endPoint:<span class="built_in">CGPointMake</span>(kDeviceWidth-distance-cornerW, selfH<span class="number">-30</span>-cornerW)];</span><br><span class="line">    <span class="keyword">self</span>.yAxis = [<span class="keyword">self</span> lineWithStartPoint:<span class="built_in">CGPointMake</span>(distance+lineWidth/<span class="number">2.0</span>, selfH<span class="number">-30</span>) breakPoint:<span class="built_in">CGPointMake</span>(distance, <span class="number">30</span>) endPoint:<span class="built_in">CGPointMake</span>(distance+cornerW, <span class="number">30</span>+cornerW)];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.layer addSublayer:<span class="keyword">self</span>.xAxis];</span><br><span class="line">    [<span class="keyword">self</span>.layer addSublayer:<span class="keyword">self</span>.yAxis];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”»åæ ‡è½´</span></span><br><span class="line">- (<span class="built_in">CAShapeLayer</span> *)lineWithStartPoint:(<span class="built_in">CGPoint</span>)startPoint breakPoint:(<span class="built_in">CGPoint</span>)breakPoint endPoint:(<span class="built_in">CGPoint</span>)endPoint &#123;</span><br><span class="line">    <span class="built_in">CAShapeLayer</span> *line = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">    line.fillColor = [<span class="built_in">UIColor</span> clearColor].CGColor;</span><br><span class="line">    line.strokeColor = [<span class="built_in">UIColor</span> blackColor].CGColor;</span><br><span class="line">    line.lineWidth = <span class="number">1.0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIBezierPath</span> *linePath = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line">    [linePath moveToPoint:startPoint];</span><br><span class="line">    [linePath addLineToPoint:breakPoint];</span><br><span class="line">    [linePath addLineToPoint:endPoint];</span><br><span class="line">    line.path = linePath.CGPath;</span><br><span class="line">    </span><br><span class="line">    [line addAnimation:<span class="keyword">self</span>.animation forKey:<span class="string">@"xyLineStrokeEndAnimation"</span>];</span><br><span class="line">    <span class="keyword">return</span> line;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIScrollView</span> *)lineScrollView &#123;</span><br><span class="line">    <span class="keyword">if</span> (_lineScrollView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _lineScrollView = [[<span class="built_in">UIScrollView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(distance+lineWidth, <span class="number">30</span>, kDeviceWidth-distance*<span class="number">2</span>-lineWidth, selfH<span class="number">-60</span>-lineWidth/<span class="number">2.0</span>)];</span><br><span class="line">        _lineScrollView.bounces = <span class="literal">NO</span>;</span><br><span class="line">        _lineScrollView.showsHorizontalScrollIndicator = <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _lineScrollView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CABasicAnimation</span> *)animation &#123;</span><br><span class="line">    <span class="keyword">if</span> (_animation == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _animation = [<span class="built_in">CABasicAnimation</span> animationWithKeyPath:<span class="string">@"strokeEnd"</span>];</span><br><span class="line">        _animation.fromValue = @<span class="number">0.0</span>;</span><br><span class="line">        _animation.toValue = @<span class="number">1.0</span>;</span><br><span class="line">        _animation.duration = <span class="number">2.0</span>;</span><br><span class="line">        _animation.timingFunction = [<span class="built_in">CAMediaTimingFunction</span> functionWithName:kCAMediaTimingFunctionEaseOut];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _animation;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h3><p>æ„Ÿè°¢é˜…è¯»å…¨æ–‡çš„æœ‹å‹ã€‚<br>â˜demoåœ°å€ <a href="https://github.com/SPIREJ/SJCAShapeLayer" target="_blank" rel="noopener">https://github.com/SPIREJ/SJCAShapeLayer</a></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æœ¬ç¯‡ä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥å†™çš„ä¸€ç‚¹ä¸œè¥¿ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;çº¿æ®µ&lt;/li&gt;
&lt;li&gt;æ›²çº¿&lt;/li&gt;
&lt;li&gt;åŠ¨ç”»&lt;/li&gt;
&lt;li&gt;ç®€å•çš„æŸ±çŠ¶å›¾&lt;/li&gt;
&lt;li&gt;ç®€å•çš„æŠ˜çº¿å›¾&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="iOSæŠ€æœ¯å¼€å‘" scheme="http://yoursite.com/categories/iOS%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="Objective-C" scheme="http://yoursite.com/tags/Objective-C/"/>
    
      <category term="iOSåŠ¨ç”»" scheme="http://yoursite.com/tags/iOS%E5%8A%A8%E7%94%BB/"/>
    
      <category term="å›¾å½¢" scheme="http://yoursite.com/tags/%E5%9B%BE%E5%BD%A2/"/>
    
  </entry>
  
</feed>
